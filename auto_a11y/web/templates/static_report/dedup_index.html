<!DOCTYPE html>
<html lang="{{ language }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="deduplicated_report">{{ t['deduplicated_report'] }}</title>
    <style>
    /* Bootstrap CSS */
    {{ bootstrap_css|safe }}
    </style>
    <style>
    /* Bootstrap Icons CSS */
    {{ bootstrap_icons_css|safe }}
    </style>
    <style>
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1.5rem;
        text-align: center;
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        color: #6c757d;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .component-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .component-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }

    .component-info {
        flex: 1;
    }

    .component-type {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .component-label {
        color: #6c757d;
        margin-bottom: 0.5rem;
    }

    .component-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.875rem;
        color: #6c757d;
    }

    .component-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        font-size: 0.875rem;
        font-weight: 500;
        white-space: nowrap;
    }

    .component-badge.navigation { background-color: #cfe2ff; color: #084298; }
    .component-badge.header { background-color: #e2d9f3; color: #432874; }
    .component-badge.footer { background-color: #d1e7dd; color: #0f5132; }
    .component-badge.form { background-color: #ffe5d0; color: #984c0c; }
    .component-badge.aside { background-color: #f8d7da; color: #842029; }
    .component-badge.section { background-color: #d3f9d8; color: #0a3622; }

    .issue-summary {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .issue-count {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.875rem;
        font-weight: 600;
    }

    .issue-count.violations { background-color: #f8d7da; color: #842029; }
    .issue-count.warnings { background-color: #fff3cd; color: #856404; }
    .issue-count.info { background-color: #cfe2ff; color: #084298; }
    .issue-count.discovery { background-color: #e2d9f3; color: #432874; }

    .no-components {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }

    /* Language Switcher */
    .lang-switcher {
        display: inline-flex;
        background: #f8f9fa;
        border-radius: 6px;
        padding: 4px;
        gap: 4px;
    }

    .lang-switcher button {
        padding: 6px 14px;
        border: none;
        background: transparent;
        cursor: pointer;
        border-radius: 4px;
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.2s;
        color: #6c757d;
    }

    .lang-switcher button:hover {
        background: #e9ecef;
        color: #495057;
    }

    .lang-switcher button.active {
        background: #0d6efd;
        color: white;
    }

    .lang-inactive {
        display: none !important;
    }

    .lang-active {
        display: block;
    }

    span.lang-active {
        display: inline;
    }
    </style>
</head>
<body>
<div class="container py-4">
    <!-- Header with Language Switcher -->
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h1 data-i18n="deduplicated_report">{{ t['deduplicated_report'] }}</h1>
            <p class="text-muted">
                <span data-i18n="issues_grouped_by_components">{{ t['issues_grouped_by_components'] }}</span> â€¢ {{ report_date.strftime('%Y-%m-%d %H:%M') }}
            </p>
        </div>
        <div class="lang-switcher">
            <button onclick="switchLanguage('en')" id="lang-en" class="{{ 'active' if language == 'en' else '' }}" aria-label="Switch to English">EN</button>
            <button onclick="switchLanguage('fr')" id="lang-fr" class="{{ 'active' if language == 'fr' else '' }}" aria-label="Switch to French">FR</button>
        </div>
    </div>

    <!-- Statistics Dashboard -->
    <div class="summary-cards">
        <!-- Accessibility Score Card -->
        {% if overall_accessibility_score is defined %}
        <div class="stat-card">
            <div class="stat-value {% if overall_accessibility_score >= 90 %}text-success{% elif overall_accessibility_score >= 70 %}text-warning{% else %}text-danger{% endif %}">
                {{ "%.1f"|format(overall_accessibility_score) }}%
            </div>
            <div class="stat-label" data-i18n="accessibility_score">{{ t['accessibility_score'] }}</div>
        </div>
        {% endif %}

        <!-- Compliance Score Card -->
        {% if overall_compliance_score is defined %}
        <div class="stat-card">
            <div class="stat-value {% if overall_compliance_score >= 90 %}text-success{% elif overall_compliance_score >= 70 %}text-warning{% else %}text-danger{% endif %}">
                {{ "%.1f"|format(overall_compliance_score) }}%
            </div>
            <div class="stat-label" data-i18n="compliance_score">{{ t['compliance_score'] }}</div>
        </div>
        {% endif %}

        <div class="stat-card">
            <div class="stat-value text-danger">{{ total_violations }}</div>
            <div class="stat-label" data-i18n="violations">{{ t['violations'] }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-value text-warning">{{ total_warnings }}</div>
            <div class="stat-label" data-i18n="warnings">{{ t['warnings'] }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-value text-info">{{ total_info }}</div>
            <div class="stat-label" data-i18n="info_items">{{ t['info_items'] }}</div>
        </div>
        {% if total_discovery is defined and total_discovery > 0 %}
        <div class="stat-card">
            <div class="stat-value" style="color: #6f42c1;">{{ total_discovery }}</div>
            <div class="stat-label" data-i18n="discovery">{{ t.get('discovery', 'Discovery') }}</div>
        </div>
        {% endif %}
        <div class="stat-card">
            <div class="stat-value text-primary">{{ total_components }}</div>
            <div class="stat-label" data-i18n="components">{{ t['components'] }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-value text-secondary">{{ total_pages }}</div>
            <div class="stat-label" data-i18n="pages">{{ t['pages'] }}</div>
        </div>
    </div>

    <!-- Common Components List -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0" data-i18n="common_components">{{ t['common_components'] }}</h5>
            <small class="text-muted" data-i18n="click_component_to_view">{{ t['click_component_to_view'] }}</small>
        </div>
        <div class="card-body">
            {% if components_with_issues %}
                {% for comp_data in components_with_issues %}
                <a href="components/{{ comp_data.safe_signature }}.html" class="text-decoration-none component-link" data-component-lang="{{ comp_data.lang }}">
                    <div class="component-card">
                        <div class="component-info">
                            <div class="component-type">
                                <span class="component-badge {{ comp_data.type|lower }}" data-i18n="{{ comp_data.type|lower }}">{{ t.get(comp_data.type|lower, comp_data.type) }}</span>
                                {% if comp_data.type == 'Form' %}{{ comp_data.label }} <span data-i18n="fields">{{ t.get('fields', 'fields') }}</span>{% else %}{{ comp_data.label }}{% endif %}
                                <code class="ms-2 small text-muted">{{ comp_data.signature[:8] }}</code>
                            </div>
                            <div class="component-meta">
                                <span><i class="bi bi-file-earmark"></i> {{ comp_data.page_count }} <span data-i18n="page_s">{{ t['page_s'] }}</span></span>
                                {% if comp_data.score is defined %}
                                <span><i class="bi bi-graph-up"></i> <span data-i18n="score">{{ t['score'] }}</span>:
                                    <strong class="{% if comp_data.score >= 90 %}text-success{% elif comp_data.score >= 70 %}text-warning{% else %}text-danger{% endif %}">
                                        {{ "%.1f"|format(comp_data.score) }}%
                                    </strong>
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="issue-summary">
                            {% if comp_data.violations > 0 %}
                            <span class="issue-count violations">{{ comp_data.violations }} <span data-i18n="violation_s">{{ t['violation_s'] }}</span></span>
                            {% endif %}
                            {% if comp_data.warnings > 0 %}
                            <span class="issue-count warnings">{{ comp_data.warnings }} <span data-i18n="warning_s">{{ t['warning_s'] }}</span></span>
                            {% endif %}
                            {% if comp_data.info > 0 %}
                            <span class="issue-count info">{{ comp_data.info }} <span data-i18n="info">{{ t['info'] }}</span></span>
                            {% endif %}
                            {% if comp_data.discovery is defined and comp_data.discovery > 0 %}
                            <span class="issue-count discovery">{{ comp_data.discovery }} <span data-i18n="discovery">{{ t.get('discovery', 'Discovery') }}</span></span>
                            {% endif %}
                            <i class="bi bi-chevron-right"></i>
                        </div>
                    </div>
                </a>
                {% endfor %}
            {% else %}
                <div class="no-components">
                    <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p class="mt-3" data-i18n="no_common_components">{{ t['no_common_components'] }}</p>
                </div>
            {% endif %}

        </div>
    </div>

    <!-- Pages with Non-Component Issues -->
    {% if pages_with_unassigned %}
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0" data-i18n="pages_with_non_component_issues">{{ t['pages_with_non_component_issues'] }}</h5>
            <small class="text-muted" data-i18n="issues_not_in_components">{{ t['issues_not_in_components'] }}</small>
        </div>
        <div class="card-body">
            <div class="page-search-filter mb-3">
                <input type="text" class="form-control" id="pageSearch" data-i18n-placeholder="search_pages" placeholder="{{ t['search_pages'] }}">
            </div>

            {% for page_data in pages_with_unassigned %}
            <a href="pages/{{ page_data.safe_url }}.html" class="text-decoration-none">
                <div class="component-card">
                    <div class="component-info">
                        <div class="component-type">
                            <i class="bi bi-file-earmark-text"></i>
                            {{ page_data.title or page_data.url }}
                        </div>
                        <div class="component-meta">
                            <span><i class="bi bi-link-45deg"></i> {{ page_data.url }}</span>
                            {% if page_data.dedup_score is defined %}
                            <span><i class="bi bi-graph-up"></i> <span data-i18n="score">{{ t['score'] }}</span>:
                                <strong class="{% if page_data.dedup_score >= 90 %}text-success{% elif page_data.dedup_score >= 70 %}text-warning{% else %}text-danger{% endif %}">
                                    {{ "%.1f"|format(page_data.dedup_score) }}%
                                </strong>
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="issue-summary">
                        {% if page_data.violations > 0 %}
                        <span class="issue-count violations">{{ page_data.violations }} <span data-i18n="violation_s">{{ t['violation_s'] }}</span></span>
                        {% endif %}
                        {% if page_data.warnings > 0 %}
                        <span class="issue-count warnings">{{ page_data.warnings }} <span data-i18n="warning_s">{{ t['warning_s'] }}</span></span>
                        {% endif %}
                        {% if page_data.info > 0 %}
                        <span class="issue-count info">{{ page_data.info }} <span data-i18n="info">{{ t['info'] }}</span></span>
                        {% endif %}
                        {% if page_data.discovery is defined and page_data.discovery > 0 %}
                        <span class="issue-count discovery">{{ page_data.discovery }} <span data-i18n="discovery">{{ t.get('discovery', 'Discovery') }}</span></span>
                        {% endif %}
                        <i class="bi bi-chevron-right"></i>
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<script>
/* Bootstrap JS */
{{ bootstrap_js|safe }}
</script>
<script>
// All translations embedded in the report
const translations = {{ translations_json|safe }};

// Check localStorage for saved language preference, fallback to server language
let currentLang = localStorage.getItem('reportLanguage') || '{{ language }}';

// Language switching
function switchLanguage(lang) {
    currentLang = lang;

    // Save preference to localStorage
    localStorage.setItem('reportLanguage', lang);

    // Update active button
    document.querySelectorAll('.lang-switcher button').forEach(btn => {
        btn.classList.remove('active');
    });
    document.getElementById(`lang-${lang}`).classList.add('active');

    // Update HTML lang attribute
    document.documentElement.lang = lang;

    // Update all elements with data-i18n attribute
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (translations[lang] && translations[lang][key]) {
            element.textContent = translations[lang][key];
        }
    });

    // Update placeholders
    document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
        const key = element.getAttribute('data-i18n-placeholder');
        if (translations[lang] && translations[lang][key]) {
            element.placeholder = translations[lang][key];
        }
    });

    // Update document title
    if (translations[lang] && translations[lang]['deduplicated_report']) {
        document.title = translations[lang]['deduplicated_report'];
    }

    // Filter components by language
    filterComponentsByLanguage(lang);
}

// Function to filter components by language
function filterComponentsByLanguage(lang) {
    const componentLinks = document.querySelectorAll('.component-link');
    componentLinks.forEach(link => {
        const componentLang = link.getAttribute('data-component-lang');
        // Show component if its language matches current lang, or if lang is not specified
        if (!componentLang || componentLang === lang) {
            link.style.display = '';
        } else {
            link.style.display = 'none';
        }
    });
}

// Apply saved language on page load
if (currentLang !== '{{ language }}') {
    switchLanguage(currentLang);
} else {
    // Filter components for initial language
    filterComponentsByLanguage(currentLang);
}

// Simple page search filter
const pageSearch = document.getElementById('pageSearch');
if (pageSearch) {
    pageSearch.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const cards = document.querySelectorAll('.component-card');

        cards.forEach(card => {
            const text = card.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
                card.parentElement.style.display = '';
            } else {
                card.parentElement.style.display = 'none';
            }
        });
    });
}
</script>
</body>
</html>
