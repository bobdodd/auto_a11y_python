{% extends "base.html" %}

{% block title %}Create Project - Auto A11y{% endblock %}

{% block extra_css %}
<style>
    .test-disabled {
        opacity: 0.5;
        text-decoration: line-through;
    }
    
    .test-debug-override {
        opacity: 0.7;
    }
    
    .fixture-status-badge {
        font-size: 0.7rem;
        padding: 0.1rem 0.3rem;
        margin-left: 0.5rem;
    }
    
    .touchpoint-disabled .form-check-label {
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-8 col-lg-6 mx-auto">
            <h1 class="h2 mb-4">Create New Project</h1>
            
            <!-- Fixture Status Notice -->
            {% if debug_mode %}
            <div class="alert alert-warning mb-3">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <strong>Debug Mode Active:</strong> All tests are available regardless of fixture status.
                <a href="{{ url_for('testing.fixture_status') }}" class="alert-link float-end">View Fixture Status</a>
            </div>
            {% else %}
            <div class="alert alert-info mb-3">
                <i class="bi bi-info-circle-fill me-2"></i>
                <strong>Test Availability:</strong> Only tests that passed fixture validation are enabled.
                <a href="{{ url_for('testing.fixture_status') }}" class="alert-link float-end">View Fixture Status</a>
            </div>
            {% endif %}
            
            <div class="card">
                <div class="card-body">
                    <form method="POST" action="{{ url_for('projects.create_project') }}">
                        <div class="mb-3">
                            <label for="name" class="form-label">Project Name *</label>
                            <input type="text" class="form-control" id="name" name="name" 
                                   required autofocus maxlength="100">
                            <div class="form-text">Choose a unique name for your project</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" 
                                      rows="3" maxlength="500"></textarea>
                            <div class="form-text">Optional description of the project goals</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="wcag_level" class="form-label">WCAG Compliance Level *</label>
                            <select class="form-select" id="wcag_level" name="wcag_level" required>
                                <option value="AA" selected>Level AA (Recommended)</option>
                                <option value="AAA">Level AAA (Enhanced)</option>
                            </select>
                            <div class="form-text">
                                <strong>Level AA:</strong> Standard compliance (4.5:1 contrast for normal text, 3:1 for large text)<br>
                                <strong>Level AAA:</strong> Enhanced compliance (7:1 contrast for normal text, 4.5:1 for large text)
                            </div>
                        </div>
                        
                        <!-- Touchpoint Testing Configuration -->
                        <div class="mb-3">
                            <label class="form-label">Touchpoint Tests Configuration</label>
                            <div class="form-text mb-2">
                                Configure which accessibility tests to run. Tests are organized by touchpoint (testing category).
                            </div>
                            
                            <!-- Global Controls -->
                            <div class="btn-group mb-3" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllTests(true)">Enable All</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectAllTests(false)">Disable All</button>
                                <button type="button" class="btn btn-sm btn-outline-info" onclick="applyPreset('minimal')">Minimal</button>
                                <button type="button" class="btn btn-sm btn-outline-info" onclick="applyPreset('wcag-aa')">WCAG AA</button>
                            </div>
                            
                            <!-- Touchpoint Tree -->
                            <div class="touchpoint-tree border rounded p-3" style="max-height: 400px; overflow-y: auto;">
                                {% for touchpoint_id in touchpoint_names.keys()|sort %}
                                {% set touchpoint_name = touchpoint_names[touchpoint_id] %}
                                {% set test_ids = tests_by_touchpoint.get(touchpoint_id, []) %}
                                {% if test_ids %}
                                <div class="touchpoint-item mb-2">
                                    <div class="d-flex align-items-center">
                                        <!-- Expand/Collapse button -->
                                        <button class="btn btn-sm btn-link p-0 me-2" type="button" 
                                                data-bs-toggle="collapse" data-bs-target="#tests_{{ touchpoint_id }}"
                                                aria-expanded="false" aria-controls="tests_{{ touchpoint_id }}">
                                            <i class="bi bi-chevron-right" id="chevron_{{ touchpoint_id }}"></i>
                                        </button>
                                        
                                        <!-- Touchpoint checkbox -->
                                        <div class="form-check">
                                            <input class="form-check-input touchpoint-checkbox" type="checkbox" 
                                                   id="touchpoint_{{ touchpoint_id }}" name="touchpoint_{{ touchpoint_id }}"
                                                   checked
                                                   onchange="toggleTouchpoint('{{ touchpoint_id }}')">
                                            <label class="form-check-label fw-bold" for="touchpoint_{{ touchpoint_id }}">
                                                <i class="bi bi-folder2 me-1"></i>{{ touchpoint_name }}
                                                {% set available_count = test_ids|select('in', passing_tests)|list|length %}
                                                {% set total_count = test_ids|length %}
                                                {% if debug_mode %}
                                                    <span class="badge bg-warning ms-2" title="Debug mode - all tests available">{{ total_count }}</span>
                                                {% elif available_count == total_count %}
                                                    <span class="badge bg-success ms-2" title="All tests passed fixtures">{{ available_count }}</span>
                                                {% elif available_count == 0 %}
                                                    <span class="badge bg-danger ms-2" title="No tests available">0/{{ total_count }}</span>
                                                {% else %}
                                                    <span class="badge bg-warning ms-2" title="{{ available_count }} of {{ total_count }} tests available">{{ available_count }}/{{ total_count }}</span>
                                                {% endif %}
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- Individual tests under this touchpoint (collapsible) -->
                                    <div class="collapse ms-5 mt-1" id="tests_{{ touchpoint_id }}">
                                        {% for test_id in test_ids %}
                                        {% set test_passed = test_id in passing_tests %}
                                        {% set test_status = test_statuses.get(test_id, {}) %}
                                        {% set test_available = test_passed or debug_mode %}
                                        {% set is_debug_override = not test_passed and debug_mode %}
                                        
                                        <div class="form-check {% if not test_available %}test-disabled{% elif is_debug_override %}test-debug-override{% endif %}">
                                            <input class="form-check-input test-checkbox" type="checkbox" 
                                                   id="test_{{ touchpoint_id }}_{{ test_id }}" 
                                                   name="test_{{ touchpoint_id }}_{{ test_id }}"
                                                   data-touchpoint="{{ touchpoint_id }}"
                                                   {% if test_available %}checked{% else %}disabled{% endif %}>
                                            <label class="form-check-label small" for="test_{{ touchpoint_id }}_{{ test_id }}">
                                                <i class="bi bi-file-earmark-code me-1"></i>
                                                <code>{{ test_id }}</code>
                                                {% if not test_passed %}
                                                    {% if test_status %}
                                                        <span class="badge bg-danger fixture-status-badge" title="Failed fixture test">✗</span>
                                                    {% else %}
                                                        <span class="badge bg-warning fixture-status-badge" title="No fixture test">?</span>
                                                    {% endif %}
                                                    {% if is_debug_override %}
                                                        <span class="badge bg-info fixture-status-badge" title="Enabled in debug mode">DEBUG</span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="badge bg-success fixture-status-badge" title="Passed fixture test">✓</span>
                                                {% endif %}
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- AI Testing Configuration -->
                        <div class="mb-3">
                            <label class="form-label">AI-Assisted Testing</label>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enable_ai_testing" name="enable_ai_testing" onchange="toggleAITests()">
                                <label class="form-check-label" for="enable_ai_testing">
                                    Enable AI-assisted accessibility testing
                                </label>
                            </div>
                            <div class="form-text mb-3">
                                AI testing uses Claude to analyze screenshots and HTML for issues that automated tests might miss.
                                <strong>Note:</strong> AI testing incurs API costs based on usage.
                            </div>
                            
                            <div id="ai_tests_selection" style="display: none;">
                                <label class="form-label">Select AI Tests to Run:</label>
                                <div class="ms-3">
                                    <div class="form-check">
                                        <input class="form-check-input ai-test-checkbox" type="checkbox" id="ai_test_headings" name="ai_test_headings" value="headings">
                                        <label class="form-check-label" for="ai_test_headings">
                                            <strong>Heading Analysis</strong> - Detects visual headings not properly marked up
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input ai-test-checkbox" type="checkbox" id="ai_test_reading_order" name="ai_test_reading_order" value="reading_order">
                                        <label class="form-check-label" for="ai_test_reading_order">
                                            <strong>Reading Order</strong> - Verifies logical reading sequence matches visual layout
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input ai-test-checkbox" type="checkbox" id="ai_test_modals" name="ai_test_modals" value="modals">
                                        <label class="form-check-label" for="ai_test_modals">
                                            <strong>Modal Dialogs</strong> - Analyzes popup and overlay accessibility
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input ai-test-checkbox" type="checkbox" id="ai_test_language" name="ai_test_language" value="language">
                                        <label class="form-check-label" for="ai_test_language">
                                            <strong>Language Detection</strong> - Identifies mixed languages and missing declarations
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input ai-test-checkbox" type="checkbox" id="ai_test_animations" name="ai_test_animations" value="animations">
                                        <label class="form-check-label" for="ai_test_animations">
                                            <strong>Animations</strong> - Detects potentially problematic motion
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input ai-test-checkbox" type="checkbox" id="ai_test_interactive" name="ai_test_interactive" value="interactive">
                                        <label class="form-check-label" for="ai_test_interactive">
                                            <strong>Interactive Elements</strong> - Analyzes buttons, links, and form controls
                                        </label>
                                    </div>
                                </div>
                                <div class="form-text mt-2">
                                    <a href="#" onclick="selectAllAITests(event)">Select All</a> | 
                                    <a href="#" onclick="deselectAllAITests(event)">Deselect All</a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> Create Project
                            </button>
                            <a href="{{ url_for('projects.list_projects') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Handle collapse/expand chevron rotation
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(button => {
        button.addEventListener('click', function() {
            const chevron = this.querySelector('i');
            if (chevron) {
                chevron.classList.toggle('bi-chevron-right');
                chevron.classList.toggle('bi-chevron-down');
            }
        });
    });
});

// Toggle all tests within a touchpoint
function toggleTouchpoint(touchpointId) {
    const touchpointCheckbox = document.getElementById('touchpoint_' + touchpointId);
    const testCheckboxes = document.querySelectorAll(`[data-touchpoint="${touchpointId}"]`);
    
    testCheckboxes.forEach(checkbox => {
        // Only toggle if not disabled
        if (!checkbox.disabled) {
            checkbox.checked = touchpointCheckbox.checked;
        }
    });
}

// Select or deselect all tests
function selectAllTests(enable) {
    document.querySelectorAll('.touchpoint-checkbox').forEach(cb => {
        cb.checked = enable;
    });
    document.querySelectorAll('.test-checkbox').forEach(cb => {
        // Only toggle if not disabled
        if (!cb.disabled) {
            cb.checked = enable;
        }
    });
}

// Apply test presets
function applyPreset(preset) {
    // First disable all
    selectAllTests(false);
    
    if (preset === 'minimal') {
        // Enable only critical error tests
        const minimalTouchpoints = ['headings', 'images', 'forms', 'colors_contrast', 'keyboard_navigation'];
        minimalTouchpoints.forEach(tp => {
            const checkbox = document.getElementById('touchpoint_' + tp);
            if (checkbox) {
                checkbox.checked = true;
                toggleTouchpoint(tp);
            }
        });
    } else if (preset === 'wcag-aa') {
        // Enable all touchpoints for WCAG AA compliance
        selectAllTests(true);
    }
}

function toggleAITests() {
    const enabled = document.getElementById('enable_ai_testing').checked;
    const selection = document.getElementById('ai_tests_selection');
    selection.style.display = enabled ? 'block' : 'none';
    
    // If disabling, uncheck all tests
    if (!enabled) {
        document.querySelectorAll('.ai-test-checkbox').forEach(cb => {
            cb.checked = false;
        });
    }
}

function selectAllAITests(event) {
    event.preventDefault();
    document.querySelectorAll('.ai-test-checkbox').forEach(cb => {
        cb.checked = true;
    });
}

function deselectAllAITests(event) {
    event.preventDefault();
    document.querySelectorAll('.ai-test-checkbox').forEach(cb => {
        cb.checked = false;
    });
}
</script>
{% endblock %}