{% extends "base.html" %}

{% block title %}{{ recording.title }} - Recordings{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('recordings.list_recordings') }}">Recordings</a></li>
                    <li class="breadcrumb-item active">{{ recording.recording_id }}</li>
                </ol>
            </nav>
            <h1 class="h2 mb-0">{{ recording.title }}</h1>
        </div>
        <div>
            <button type="button" class="btn btn-outline-primary" id="editBtn" onclick="toggleEditMode()">
                <i class="bi bi-pencil"></i> Edit
            </button>
            <button type="button" class="btn btn-success" id="saveBtn" style="display: none;" onclick="saveRecording()">
                <i class="bi bi-check-lg"></i> Save
            </button>
            <button type="button" class="btn btn-outline-secondary" id="cancelBtn" style="display: none;" onclick="cancelEdit()">
                Cancel
            </button>
            <form method="post" action="{{ url_for('recordings.delete_recording', recording_id=recording.id) }}"
                  onsubmit="return confirm('Are you sure you want to delete this recording?')" class="d-inline">
                <button type="submit" class="btn btn-outline-danger">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </form>
        </div>
    </div>

    <!-- Recording Metadata -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted mb-1">Recording ID</h6>
                            <p class="mb-0">{{ recording.recording_id }}</p>
                        </div>
                        {% if recording.recording_type.value == 'audit' %}
                            {% if recording.auditor_name %}
                            <div class="col-md-6 mb-3">
                                <h6 class="text-muted mb-1">Auditor</h6>
                                <p class="mb-0">
                                    {{ recording.auditor_name }}
                                    {% if recording.auditor_role %}
                                    <span class="text-muted">({{ recording.auditor_role }})</span>
                                    {% endif %}
                                </p>
                            </div>
                            {% endif %}
                        {% else %}
                            {# Lived Experience Recording - Show Tester and Supervisor #}
                            {% if recording.auditor_name %}
                            <div class="col-md-6 mb-3">
                                <h6 class="text-muted mb-1">Tester</h6>
                                <p class="mb-0">{{ recording.auditor_name }}</p>
                            </div>
                            {% endif %}
                            {% if recording.test_supervisor_id and project %}
                                {% for supervisor in project.test_supervisors %}
                                    {% if supervisor._id == recording.test_supervisor_id %}
                                    <div class="col-md-6 mb-3">
                                        <h6 class="text-muted mb-1">Test Supervisor</h6>
                                        <p class="mb-0">{{ supervisor.name }}</p>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        {% endif %}
                        {% if recording.test_user_account %}
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted mb-1">Test User Account</h6>
                            <p class="mb-0">
                                <i class="bi bi-person-circle"></i> {{ recording.test_user_account }}
                            </p>
                        </div>
                        {% endif %}
                        {% if recording.recorded_date %}
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted mb-1">Recording Date</h6>
                            <p class="mb-0">{{ recording.recorded_date.strftime('%B %d, %Y') }}</p>
                        </div>
                        {% endif %}
                        {% if recording.duration %}
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted mb-1">Duration</h6>
                            <p class="mb-0">{{ recording.duration }}</p>
                        </div>
                        {% endif %}
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted mb-1">Recording Type</h6>
                            <span class="badge bg-info">
                                {{ recording.recording_type.value|replace('_', ' ')|title }}
                            </span>
                        </div>
                        {% if project %}
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted mb-1">Project</h6>
                            <p class="mb-0">
                                <a href="{{ url_for('projects.view_project', project_id=project.id) }}">
                                    {{ project.name }}
                                </a>
                            </p>
                        </div>
                        {% endif %}
                    </div>

                    {% if recording.description %}
                    <div class="mt-3 pt-3 border-top">
                        <h6 class="text-muted mb-1">Description</h6>
                        <p class="mb-0">{{ recording.description }}</p>
                    </div>
                    {% endif %}

                    <!-- Page URLs - View and Edit Mode -->
                    <div class="mt-3 pt-3 border-top">
                        <h6 class="text-muted mb-2">Pages Covered</h6>

                        <!-- View Mode -->
                        <div id="pageUrlsViewMode">
                            {% if recording.page_urls %}
                            <ul class="list-unstyled mb-0">
                                {% for url in recording.page_urls %}
                                <li><i class="bi bi-link-45deg"></i> {{ url }}</li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <p class="text-muted small mb-0">No pages specified</p>
                            {% endif %}
                        </div>

                        <!-- Edit Mode -->
                        <div id="pageUrlsEditMode" style="display: none;">
                            <textarea class="form-control" id="editPageUrls" rows="3" placeholder="Enter one URL per line">{{ recording.page_urls|join('\n') }}</textarea>
                            <small class="form-text text-muted">Enter one URL per line</small>
                        </div>
                    </div>

                    <!-- Discovered Pages - View and Edit Mode -->
                    <div class="mt-3 pt-3 border-top">
                        <h6 class="text-muted mb-2">Discovered Pages</h6>

                        <!-- View Mode -->
                        <div id="discoveredPagesViewMode">
                            {% if discovered_pages and discovered_pages|length > 0 %}
                            <ul class="list-unstyled mb-0">
                                {% for page in discovered_pages %}
                                <li>
                                    <i class="bi bi-compass"></i>
                                    <a href="{{ url_for('discovered_pages.view_discovered_page', page_id=page._id) }}">
                                        {{ page.title }}
                                    </a>
                                    {% if page.url %}
                                    <br><small class="text-muted ms-4">{{ page.url }}</small>
                                    {% endif %}
                                </li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <p class="text-muted small mb-0">No discovered pages selected</p>
                            {% endif %}
                        </div>

                        <!-- Edit Mode -->
                        <div id="discoveredPagesEditMode" style="display: none;">
                            <div id="discoveredPagesCheckboxContainer" style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.25rem; padding: 0.5rem;">
                                <p class="text-muted small mb-0">Loading discovered pages...</p>
                            </div>
                            <small class="form-text text-muted">Select discovered pages related to this recording</small>
                        </div>
                    </div>

                    {% if recording.component_names %}
                    <div class="mt-3 pt-3 border-top">
                        <h6 class="text-muted mb-2">Common Components</h6>
                        <div class="d-flex flex-wrap gap-2">
                            {% for component in recording.component_names %}
                            <span class="badge bg-secondary">{{ component }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% if recording.app_screens %}
                    <div class="mt-3 pt-3 border-top">
                        <h6 class="text-muted mb-2">App Screens / Views</h6>
                        <div class="d-flex flex-wrap gap-2">
                            {% for screen in recording.app_screens %}
                            <span class="badge bg-primary">{{ screen }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% if recording.device_sections %}
                    <div class="mt-3 pt-3 border-top">
                        <h6 class="text-muted mb-2">Device Sections</h6>
                        <div class="d-flex flex-wrap gap-2">
                            {% for section in recording.device_sections %}
                            <span class="badge bg-warning">{{ section }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% if recording.task_description %}
                    <div class="mt-3 pt-3 border-top">
                        <h6 class="text-muted mb-2">Task Context</h6>
                        <p class="mb-0"><i class="bi bi-clipboard-check"></i> {{ recording.task_description }}</p>
                    </div>
                    {% endif %}

                    {% if recording.media_file_path %}
                    <div class="mt-3 pt-3 border-top">
                        <h6 class="text-muted mb-2">Media File</h6>
                        <p class="mb-0">
                            <i class="bi bi-film"></i> {{ recording.media_file_path }}
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Statistics Card -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Issue Summary</h5>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="h3 mb-0">{{ recording.total_issues }}</span>
                        <span class="text-muted">Total Issues</span>
                    </div>

                    <div class="mb-2">
                        <div class="d-flex justify-content-between mb-1">
                            <span>High Impact</span>
                            <span class="badge bg-danger">{{ recording.high_impact_count }}</span>
                        </div>
                        {% if recording.total_issues > 0 %}
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-danger" role="progressbar"
                                 style="width: {{ (recording.high_impact_count / recording.total_issues * 100)|round|int }}%"></div>
                        </div>
                        {% endif %}
                    </div>

                    <div class="mb-2">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Medium Impact</span>
                            <span class="badge bg-warning text-dark">{{ recording.medium_impact_count }}</span>
                        </div>
                        {% if recording.total_issues > 0 %}
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-warning" role="progressbar"
                                 style="width: {{ (recording.medium_impact_count / recording.total_issues * 100)|round|int }}%"></div>
                        </div>
                        {% endif %}
                    </div>

                    <div class="mb-2">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Low Impact</span>
                            <span class="badge bg-secondary">{{ recording.low_impact_count }}</span>
                        </div>
                        {% if recording.total_issues > 0 %}
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-secondary" role="progressbar"
                                 style="width: {{ (recording.low_impact_count / recording.total_issues * 100)|round|int }}%"></div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Manual Testing Scores Card -->
            {% if scores %}
            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="bi bi-person-check"></i> Manual Testing Scores
                    </h5>

                    <!-- Manual Accessibility Score -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-bold">Manual Accessibility Score</span>
                            <span class="badge {% if scores.accessibility_score >= 90 %}bg-success{% elif scores.accessibility_score >= 70 %}bg-warning text-dark{% else %}bg-danger{% endif %} fs-6">
                                {{ scores.accessibility_score|round(1) }}%
                            </span>
                        </div>
                        <div class="progress" style="height: 12px;">
                            <div class="progress-bar {% if scores.accessibility_score >= 90 %}bg-success{% elif scores.accessibility_score >= 70 %}bg-warning{% else %}bg-danger{% endif %}"
                                 role="progressbar"
                                 style="width: {{ scores.accessibility_score }}%"
                                 aria-valuenow="{{ scores.accessibility_score }}"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <small class="text-muted">Based on manually identified issue severity and impact</small>
                    </div>

                    <!-- Manual Compliance Score -->
                    {% if scores.compliance_score is not none %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-bold">Manual WCAG Compliance Score</span>
                            <span class="badge {% if scores.compliance_score >= 90 %}bg-success{% elif scores.compliance_score >= 70 %}bg-warning text-dark{% else %}bg-danger{% endif %} fs-6">
                                {{ scores.compliance_score|round(1) }}%
                            </span>
                        </div>
                        <div class="progress" style="height: 12px;">
                            <div class="progress-bar {% if scores.compliance_score >= 90 %}bg-success{% elif scores.compliance_score >= 70 %}bg-warning{% else %}bg-danger{% endif %}"
                                 role="progressbar"
                                 style="width: {{ scores.compliance_score }}%"
                                 aria-valuenow="{{ scores.compliance_score }}"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <small class="text-muted">Level AA conformance based on manual testing scope</small>
                    </div>

                    <!-- WCAG Criteria Breakdown -->
                    <div class="mt-3 pt-3 border-top">
                        <div class="row g-2 text-center">
                            <div class="col-4">
                                <div class="small text-muted">Applicable</div>
                                <div class="fw-bold">{{ scores.total_applicable_criteria }}</div>
                            </div>
                            <div class="col-4">
                                <div class="small text-muted">Passed</div>
                                <div class="fw-bold text-success">{{ scores.passed_criteria }}</div>
                            </div>
                            <div class="col-4">
                                <div class="small text-muted">Failed</div>
                                <div class="fw-bold text-danger">{{ scores.failed_criteria }}</div>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#criteriaBreakdownModal">
                                <i class="bi bi-list-check"></i> View Criteria Details
                            </button>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-info mb-0">
                        <small>
                            <i class="bi bi-info-circle"></i>
                            Manual compliance score requires testing scope to be defined during upload.
                        </small>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Recording Content Accordion (Key Takeaways, Painpoints, Assertions, Issues) -->
    <div class="accordion mb-4" id="recordingContentAccordion">
        <!-- Key Takeaways -->
        {% if recording.key_takeaways %}
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingKeyTakeaways">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseKeyTakeaways" aria-expanded="false" aria-controls="collapseKeyTakeaways">
                    <i class="bi bi-list-ol me-2"></i> <strong>Key Takeaways ({{ recording.key_takeaways|length }})</strong>
                </button>
            </h2>
            <div id="collapseKeyTakeaways" class="accordion-collapse collapse"
                 aria-labelledby="headingKeyTakeaways" data-bs-parent="#recordingContentAccordion">
                <div class="accordion-body">
                    <div class="recording-content">
                        {% for takeaway in recording.key_takeaways %}
                        <div class="takeaway-item mb-4{% if not loop.last %} pb-3 border-bottom{% endif %}">
                            <h4>{{ takeaway.number }}. {{ takeaway.topic }}</h4>
                            <p>{{ takeaway.description }}</p>
                            {% if takeaway.timecodes %}
                            <p class="text-muted small mb-0">
                                <i class="bi bi-clock"></i>
                                {% for tc in takeaway.timecodes %}
                                    <code>{{ tc.start }} - {{ tc.end }}</code>{% if not loop.last %}, {% endif %}
                                {% endfor %}
                            </p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- User Painpoints -->
        {% if recording.user_painpoints %}
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingPainpoints">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapsePainpoints" aria-expanded="false" aria-controls="collapsePainpoints">
                    <i class="bi bi-exclamation-triangle me-2"></i> <strong>User Painpoints ({{ recording.user_painpoints|length }})</strong>
                </button>
            </h2>
            <div id="collapsePainpoints" class="accordion-collapse collapse"
                 aria-labelledby="headingPainpoints" data-bs-parent="#recordingContentAccordion">
                <div class="accordion-body">
                    <div class="recording-content">
                        {% for painpoint in recording.user_painpoints %}
                        <div class="painpoint-item mb-4{% if not loop.last %} pb-3 border-bottom{% endif %}">
                            <h4>
                                {% if painpoint.impact %}
                                <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'secondary'}[painpoint.impact|lower] or 'secondary' }} me-2">
                                    {{ painpoint.impact|upper }}
                                </span>
                                {% endif %}
                                {{ painpoint.title }}
                            </h4>
                            {% if painpoint.user_quote %}
                            <div class="mb-3">
                                <strong class="text-primary">User Quote:</strong>
                                <p class="fst-italic ms-3">"{{ painpoint.user_quote }}"</p>
                            </div>
                            {% endif %}
                            {% if painpoint.timecodes %}
                            <div>
                                <strong class="text-primary">Timecode{% if painpoint.timecodes|length > 1 %}s{% endif %}:</strong>
                                {% for timecode in painpoint.timecodes %}
                                <div class="ms-3 mb-2">
                                    <i class="bi bi-clock"></i>
                                    <span class="text-muted small">
                                        Start: <code>{{ timecode.start }}</code> |
                                        End: <code>{{ timecode.end }}</code> |
                                        Duration: <code>{{ timecode.duration }}</code>
                                    </span>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- User Assertions -->
        {% if recording.user_assertions %}
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingAssertions">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseAssertions" aria-expanded="false" aria-controls="collapseAssertions">
                    <i class="bi bi-chat-quote me-2"></i> <strong>User Assertions ({{ recording.user_assertions|length }})</strong>
                </button>
            </h2>
            <div id="collapseAssertions" class="accordion-collapse collapse"
                 aria-labelledby="headingAssertions" data-bs-parent="#recordingContentAccordion">
                <div class="accordion-body">
                    <div class="recording-content">
                        {% for assertion in recording.user_assertions %}
                        <div class="assertion-item mb-4{% if not loop.last %} pb-3 border-bottom{% endif %}">
                            <h4>{{ assertion.number }}. {{ assertion.assertion }}</h4>
                            {% if assertion.user_quote %}
                            <div class="mb-3">
                                <strong class="text-primary">User Quote:</strong>
                                <p class="fst-italic ms-3">"{{ assertion.user_quote }}"</p>
                            </div>
                            {% endif %}
                            {% if assertion.timecodes %}
                            <div>
                                <strong class="text-primary">Timecode{% if assertion.timecodes|length > 1 %}s{% endif %}:</strong>
                                {% for timecode in assertion.timecodes %}
                                <div class="ms-3 mb-2">
                                    <i class="bi bi-clock"></i>
                                    <span class="text-muted small">
                                        <code>{{ timecode.start }}</code> - <code>{{ timecode.end }}</code>
                                        (Duration: <code>{{ timecode.duration }}</code>)
                                    </span>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            {% if assertion.context %}
                            <div class="mt-2">
                                <strong class="text-primary">Context:</strong>
                                <p class="ms-3">{{ assertion.context }}</p>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Accessibility Issues (Expanded by default) -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingIssues">
                <button class="accordion-button" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseIssues" aria-expanded="true" aria-controls="collapseIssues">
                    <i class="bi bi-bug me-2"></i> <strong>Accessibility Issues ({{ recording.total_issues }})</strong>
                </button>
            </h2>
            <div id="collapseIssues" class="accordion-collapse collapse show"
                 aria-labelledby="headingIssues" data-bs-parent="#recordingContentAccordion">
                <div class="accordion-body">
            {% if issues %}
                {% for touchpoint, touchpoint_issues in issues_by_touchpoint.items()|sort %}
                <div class="mb-4">
                    <h5 class="border-bottom pb-2 mb-3">
                        <i class="bi bi-folder"></i> {{ touchpoint }}
                        <span class="badge bg-secondary">{{ touchpoint_issues|length }}</span>
                    </h5>

                    <div class="accordion" id="accordion-{{ touchpoint|replace(' ', '-') }}">
                        {% for issue in touchpoint_issues %}
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#issue-{{ loop.index }}-{{ touchpoint|replace(' ', '-') }}">
                                    <div class="w-100 d-flex justify-content-between align-items-center me-2">
                                        <span>
                                            <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'secondary'}[issue.impact.value] }} me-2">
                                                {{ issue.impact.value|upper }}
                                            </span>
                                            {{ issue.title }}
                                        </span>
                                        {% if issue.timecodes %}
                                        <span class="badge bg-info">
                                            <i class="bi bi-clock"></i> {{ issue.timecodes|length }} timecode(s)
                                        </span>
                                        {% endif %}
                                    </div>
                                </button>
                            </h2>
                            <div id="issue-{{ loop.index }}-{{ touchpoint|replace(' ', '-') }}" class="accordion-collapse collapse"
                                 data-bs-parent="#accordion-{{ touchpoint|replace(' ', '-') }}">
                                <div class="accordion-body">
                                    {% if issue.short_title %}
                                    <p class="text-muted fst-italic">{{ issue.short_title }}</p>
                                    {% endif %}

                                    {% if issue.timecodes %}
                                    <div class="mb-3">
                                        <strong>Timecodes:</strong>
                                        <div class="mt-1">
                                            {% for tc in issue.timecodes %}
                                            <span class="badge bg-secondary me-2">
                                                {{ tc.start }} - {{ tc.end }} ({{ tc.duration }})
                                            </span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}

                                    {% if issue.what %}
                                    <div class="mb-3">
                                        <strong>What:</strong>
                                        <p class="mb-0">{{ issue.what }}</p>
                                    </div>
                                    {% endif %}

                                    {% if issue.why %}
                                    <div class="mb-3">
                                        <strong>Why:</strong>
                                        <p class="mb-0">{{ issue.why }}</p>
                                    </div>
                                    {% endif %}

                                    {% if issue.who %}
                                    <div class="mb-3">
                                        <strong>Who is affected:</strong>
                                        <p class="mb-0">{{ issue.who }}</p>
                                    </div>
                                    {% endif %}

                                    {% if issue.remediation %}
                                    <div class="mb-3">
                                        <strong>How to fix:</strong>
                                        <p class="mb-0">{{ issue.remediation }}</p>
                                    </div>
                                    {% endif %}

                                    {% if issue.wcag %}
                                    <div class="mb-3">
                                        <strong>WCAG:</strong>
                                        <div class="mt-1">
                                            {% for wcag_ref in issue.wcag %}
                                            <span class="badge bg-primary me-1">
                                                {{ wcag_ref.criteria }} (Level {{ wcag_ref.level }})
                                            </span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}

                                    <div class="mt-3">
                                        <strong>Status:</strong>
                                        <select class="form-select form-select-sm d-inline-block w-auto"
                                                onchange="updateIssueStatus('{{ issue.id }}', this.value)">
                                            <option value="open" {{ 'selected' if issue.status == 'open' }}>Open</option>
                                            <option value="in_progress" {{ 'selected' if issue.status == 'in_progress' }}>In Progress</option>
                                            <option value="resolved" {{ 'selected' if issue.status == 'resolved' }}>Resolved</option>
                                            <option value="verified" {{ 'selected' if issue.status == 'verified' }}>Verified</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <p class="text-muted">No issues found in this recording.</p>
            {% endif %}
                </div> <!-- Close accordion-body -->
            </div> <!-- Close accordion-collapse -->
        </div> <!-- Close accordion-item -->
    </div> <!-- Close accordion #recordingContentAccordion -->
</div>

<script>
function updateIssueStatus(issueId, status) {
    fetch(`/recordings/api/issue/${issueId}/status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message (optional)
            console.log('Status updated successfully');
        } else {
            alert('Failed to update status');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating status');
    });
}
</script>

<!-- WCAG Criteria Breakdown Modal -->
{% if scores and scores.compliance_score is not none %}
<div class="modal fade" id="criteriaBreakdownModal" tabindex="-1" aria-labelledby="criteriaBreakdownModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="criteriaBreakdownModalLabel">
                    <i class="bi bi-list-check"></i> WCAG Success Criteria Breakdown
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Summary -->
                <div class="alert alert-info mb-4">
                    <h6 class="alert-heading"><i class="bi bi-info-circle"></i> How Criteria Are Determined</h6>
                    <p class="mb-0">
                        The compliance score is calculated based on WCAG 2.2 Level AA criteria ({{ all_criteria|length }} total).
                        Criteria are excluded based on the testing scope selected during upload. Only criteria relevant to the
                        tested content types remain applicable ({{ applicable_criteria|length }} criteria).
                    </p>
                </div>

                <!-- Testing Scope Summary -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="bi bi-check-circle"></i> Testing Scope</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for scope_key, is_tested in recording.testing_scope.items() %}
                            <div class="col-md-4 mb-2">
                                <span class="badge {% if is_tested %}bg-success{% else %}bg-secondary{% endif %}">
                                    {% if is_tested %}<i class="bi bi-check"></i>{% else %}<i class="bi bi-x"></i>{% endif %}
                                    {{ scope_key|replace('_', ' ')|title }}
                                </span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Tabs for Applicable vs Removed -->
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="applicable-tab" data-bs-toggle="tab" data-bs-target="#applicable-criteria" type="button" role="tab">
                            <i class="bi bi-check-circle text-success"></i> Applicable Criteria ({{ applicable_criteria|length }})
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="removed-tab" data-bs-toggle="tab" data-bs-target="#removed-criteria" type="button" role="tab">
                            <i class="bi bi-x-circle text-secondary"></i> Excluded Criteria ({{ removed_criteria|length }})
                        </button>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- Applicable Criteria Tab -->
                    <div class="tab-pane fade show active" id="applicable-criteria" role="tabpanel">
                        <p class="text-muted">These {{ applicable_criteria|length }} criteria are applicable based on your testing scope and are used to calculate the compliance score.</p>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th style="width: 10%;">Number</th>
                                        <th style="width: 10%;">Level</th>
                                        <th>Success Criterion</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for criterion in applicable_criteria %}
                                    <tr>
                                        <td><code>{{ criterion.num }}</code></td>
                                        <td>
                                            <span class="badge
                                                {% if criterion.level == 'A' %}bg-success
                                                {% elif criterion.level == 'AA' %}bg-primary
                                                {% else %}bg-info{% endif %}">
                                                {{ criterion.level }}
                                            </span>
                                        </td>
                                        <td>
                                            <strong>{{ criterion.handle }}</strong>
                                            <br>
                                            <small class="text-muted">{{ criterion.title }}</small>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Removed Criteria Tab -->
                    <div class="tab-pane fade" id="removed-criteria" role="tabpanel">
                        <p class="text-muted">These {{ removed_criteria|length }} criteria were excluded because they relate only to content types that were not tested.</p>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th style="width: 10%;">Number</th>
                                        <th style="width: 10%;">Level</th>
                                        <th>Success Criterion</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for criterion in removed_criteria %}
                                    <tr>
                                        <td><code>{{ criterion.num }}</code></td>
                                        <td>
                                            <span class="badge bg-secondary">
                                                {{ criterion.level }}
                                            </span>
                                        </td>
                                        <td>
                                            <strong>{{ criterion.handle }}</strong>
                                            <br>
                                            <small class="text-muted">{{ criterion.title }}</small>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="https://www.w3.org/WAI/WCAG22/quickref/" target="_blank" class="btn btn-primary">
                    <i class="bi bi-box-arrow-up-right"></i> View WCAG Quick Reference
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
    /* Styling for recording content (key takeaways, painpoints, assertions) */
    .recording-content {
        font-size: 0.95rem;
        line-height: 1.6;
    }

    .recording-content h4 {
        color: #2c3e50;
        font-size: 1.1rem;
        font-weight: 600;
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 0.5rem;
    }

    .recording-content h4:first-child {
        margin-top: 0;
    }

    .recording-content h5 {
        color: #495057;
        font-size: 0.9rem;
        font-weight: 600;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .recording-content p {
        margin-bottom: 0.75rem;
        color: #333;
    }

    .recording-content code,
    .recording-content p:contains("00:") {
        font-family: 'Courier New', monospace;
        background-color: #f8f9fa;
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
        font-size: 0.85rem;
        color: #0056b3;
    }

    /* Add visual separation between items */
    .recording-content h4 + h5 {
        margin-top: 0.5rem;
    }
</style>

<script>
let originalData = {};
let allDiscoveredPages = [];

function toggleEditMode() {
    // Store original values
    originalData = {
        page_urls: document.getElementById('editPageUrls').value,
        discovered_page_ids: getCheckedValues('discovered-page-checkbox')
    };

    // Toggle visibility
    document.getElementById('pageUrlsViewMode').style.display = 'none';
    document.getElementById('pageUrlsEditMode').style.display = 'block';
    document.getElementById('discoveredPagesViewMode').style.display = 'none';
    document.getElementById('discoveredPagesEditMode').style.display = 'block';

    // Toggle buttons
    document.getElementById('editBtn').style.display = 'none';
    document.getElementById('saveBtn').style.display = 'inline-block';
    document.getElementById('cancelBtn').style.display = 'inline-block';

    // Load discovered pages for selection
    loadDiscoveredPagesForEdit();
}

function cancelEdit() {
    // Restore original values
    document.getElementById('editPageUrls').value = originalData.page_urls;
    setCheckboxValues('discovered-page-checkbox', originalData.discovered_page_ids);

    // Toggle back to view mode
    document.getElementById('pageUrlsViewMode').style.display = 'block';
    document.getElementById('pageUrlsEditMode').style.display = 'none';
    document.getElementById('discoveredPagesViewMode').style.display = 'block';
    document.getElementById('discoveredPagesEditMode').style.display = 'none';

    // Toggle buttons
    document.getElementById('editBtn').style.display = 'inline-block';
    document.getElementById('saveBtn').style.display = 'none';
    document.getElementById('cancelBtn').style.display = 'none';
}

async function saveRecording() {
    const data = {
        page_urls: document.getElementById('editPageUrls').value,
        discovered_page_ids: getCheckedValues('discovered-page-checkbox')
    };

    try {
        const response = await fetch('{{ url_for("recordings.edit_recording", recording_id=recording.id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            // Reload the page to show updated data
            window.location.reload();
        } else {
            alert('Error saving recording: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error saving recording:', error);
        alert('Error saving recording: ' + error.message);
    }
}

function loadDiscoveredPagesForEdit() {
    const projectId = '{{ project.id if project else "" }}';
    const container = document.getElementById('discoveredPagesCheckboxContainer');

    if (!projectId) {
        container.innerHTML = '<p class="text-muted small mb-0">No project associated with this recording.</p>';
        return;
    }

    // Fetch discovered pages for this project
    fetch(`/projects/api/${projectId}/discovered-pages`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.discovered_pages && data.discovered_pages.length > 0) {
                allDiscoveredPages = data.discovered_pages;
                container.innerHTML = '';

                // Get currently selected page IDs
                const selectedIds = {{ recording.discovered_page_ids|tojson }};

                data.discovered_pages.forEach(page => {
                    const div = document.createElement('div');
                    div.className = 'form-check';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'form-check-input discovered-page-checkbox';
                    checkbox.value = page._id;
                    checkbox.id = `dp_edit_${page._id}`;
                    checkbox.checked = selectedIds.includes(page._id);

                    const label = document.createElement('label');
                    label.className = 'form-check-label';
                    label.htmlFor = `dp_edit_${page._id}`;
                    label.textContent = page.title;

                    if (page.url) {
                        const urlSmall = document.createElement('small');
                        urlSmall.className = 'text-muted d-block';
                        urlSmall.textContent = page.url;
                        label.appendChild(urlSmall);
                    }

                    div.appendChild(checkbox);
                    div.appendChild(label);
                    container.appendChild(div);
                });
            } else {
                container.innerHTML = '<p class="text-muted small mb-0">No discovered pages found for this project.</p>';
            }
        })
        .catch(error => {
            console.error('Error fetching discovered pages:', error);
            container.innerHTML = '<p class="text-muted small mb-0">Error loading discovered pages.</p>';
        });
}

function getCheckedValues(checkboxClass) {
    const checkboxes = document.querySelectorAll('.' + checkboxClass + ':checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

function setCheckboxValues(checkboxClass, values) {
    const checkboxes = document.querySelectorAll('.' + checkboxClass);
    checkboxes.forEach(cb => {
        cb.checked = values.includes(cb.value);
    });
}
</script>
{% endblock %}
