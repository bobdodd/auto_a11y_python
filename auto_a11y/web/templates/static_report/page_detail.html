<!DOCTYPE html>
<html lang="{{ language }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page.title }} - Page Report - Auto A11y</title>

    <!-- Inlined Bootstrap CSS -->
    <style>
    {{ bootstrap_css|safe }}
    </style>

    <!-- Inlined Bootstrap Icons CSS -->
    <style>
    {{ bootstrap_icons_css|safe }}
    </style>

    <!-- Page-specific styles -->
    <style>
    /* Language switching classes */
    .lang-inactive {
        display: none !important;
    }

    .lang-active {
        display: block;
    }

    span.lang-active {
        display: inline;
    }

    /* Match online view styling exactly */
    .impact-badge {
        min-width: 75px;
        display: inline-block;
        text-align: center;
    }

    /* Move accordion indicators to the left for accessibility */
    .accordion-button {
        padding-left: 2.5rem;
        padding-right: 1.25rem;
    }

    .accordion-button::after {
        position: absolute;
        left: 1rem;
        right: auto;
        transform: rotate(-90deg);
        transition: transform 0.2s ease-in-out;
    }

    .accordion-button:not(.collapsed)::after {
        transform: rotate(0deg);
    }

    /* Ensure proper spacing for content */
    .accordion-button > * {
        margin-left: 0.5rem;
    }

    .accordion-button > *:first-child {
        margin-left: 0;
    }

    .test-results-card {
        margin-bottom: 2rem;
    }

    .touchpoint-header {
        background-color: #f8f9fa;
        padding: 8px;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
        padding-left: 0.5rem;
    }

    /* Filter Panel Styling */
    .filter-panel {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .filter-group {
        margin-bottom: 1rem;
    }

    .filter-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .filter-chip {
        padding: 0.25rem 0.75rem;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.875rem;
    }

    .filter-chip:hover {
        background: #e9ecef;
    }

    .filter-chip.active {
        background: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }

    .active-filters {
        padding: 1rem;
        background: #e7f3ff;
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .active-filter-tag {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        background: #0d6efd;
        color: white;
        border-radius: 15px;
        margin: 0.25rem;
        font-size: 0.875rem;
    }

    .active-filter-tag .remove-filter {
        margin-left: 0.5rem;
        cursor: pointer;
    }

    .filter-stats {
        padding: 0.75rem;
        background: white;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        margin-bottom: 1rem;
    }

    .issue-item {
        transition: opacity 0.3s;
    }

    .issue-item.filtered-out {
        display: none;
    }

    /* State selector button text contrast */
    .state-selector.btn-outline-primary.active .state-counts,
    .state-selector.btn-outline-primary:hover .state-counts,
    .state-selector.btn-outline-primary:focus .state-counts,
    .state-selector.btn-outline-primary:active .state-counts {
        color: white !important;
    }

    .state-selector.btn-outline-primary .state-counts {
        color: #6c757d;
    }

    .state-content {
        display: none;
    }

    .state-content.active {
        display: block;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    main {
        flex: 1;
    }

    .navbar-brand {
        font-weight: 600;
    }

    /* Language Switcher */
    .lang-switcher {
        display: inline-flex;
        background: #f8f9fa;
        border-radius: 6px;
        padding: 4px;
        gap: 4px;
    }

    .lang-switcher button {
        padding: 6px 14px;
        border: none;
        background: transparent;
        cursor: pointer;
        border-radius: 4px;
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.2s;
        color: #6c757d;
    }

    .lang-switcher button:hover {
        background: #e9ecef;
        color: #495057;
    }

    .lang-switcher button.active {
        background: #0d6efd;
        color: white;
    }
    </style>
</head>
<body>

{% macro render_instance_accordion(violation, instance_id, parent_id, alert_type, loop_index) %}
<div class="accordion-item">
    <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button"
                data-bs-toggle="collapse"
                data-bs-target="#{{ instance_id }}">
            <strong data-i18n="instance">{{ t.get('instance', 'Instance') }}</strong> {{ loop_index }}:
            {% if violation.metadata and violation.metadata.authenticated_user %}
                <span class="badge bg-secondary ms-2">
                    <i class="bi bi-person-fill"></i> {{ violation.metadata.authenticated_user.display_name }}
                    {% if violation.metadata.authenticated_user.roles %}
                        ({{ violation.metadata.authenticated_user.roles|join(', ') }})
                    {% endif %}
                </span>
            {% else %}
                <span class="badge bg-secondary ms-2">
                    <i class="bi bi-person"></i> <span data-i18n="guest">{{ t.get('guest', 'Guest') }}</span>
                </span>
            {% endif %}
            {% if violation.xpath %}
            <code class="ms-2">{{ violation.xpath }}</code>
            {% endif %}
        </button>
    </h2>
    <div id="{{ instance_id }}"
         class="accordion-collapse collapse"
         data-bs-parent="#{{ parent_id }}">
        <div class="accordion-body">
            {{ render_violation_details(violation, alert_type) }}
        </div>
    </div>
</div>
{% endmacro %}

{% macro render_violation_details(violation, alert_type) %}
<!-- Issue Details -->
{% if violation.metadata and (violation.metadata.what_en or violation.metadata.what_fr) %}
<!-- Enhanced description available -->
<div class="alert alert-{{ alert_type }} mb-3">
    <h6 class="alert-heading">
        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ violation.description_en }}</span>
        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ violation.description_fr }}</span>
    </h6>
</div>

<h6 class="text-{{ alert_type }} mb-2">
    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ t.get('about_this_issue', 'About this issue:') }}</span>
    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get('about_this_issue', 'À propos de ce problème :') }}</span>
</h6>

<div class="mb-3">
    <strong>
        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ t.get('what_the_issue_is', 'What the issue is:') }}</span>
        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get('what_the_issue_is', 'En quoi consiste le problème :') }}</span>
    </strong>
    {% if violation.metadata.what_en %}<p data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ violation.metadata.what_en }}</p>{% endif %}
    {% if violation.metadata.what_fr %}<p data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ violation.metadata.what_fr }}</p>{% endif %}
</div>

{% if violation.metadata.why_en or violation.metadata.why_fr %}
<div class="mb-3">
    <strong>
        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ t.get('why_this_is_important', 'Why this is important:') }}</span>
        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get('why_this_is_important', 'Pourquoi c\'est important :') }}</span>
    </strong>
    {% if violation.metadata.why_en %}<p data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ violation.metadata.why_en }}</p>{% endif %}
    {% if violation.metadata.why_fr %}<p data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ violation.metadata.why_fr }}</p>{% endif %}
</div>
{% endif %}

{% if violation.metadata.who_en or violation.metadata.who_fr %}
<div class="mb-3">
    <strong>
        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ t.get('who_it_affects', 'Who it affects:') }}</span>
        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get('who_it_affects', 'Qui est affecté :') }}</span>
    </strong>
    {% if violation.metadata.who_en %}<p data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ violation.metadata.who_en }}</p>{% endif %}
    {% if violation.metadata.who_fr %}<p data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ violation.metadata.who_fr }}</p>{% endif %}
</div>
{% endif %}

{% if violation.metadata.full_remediation_en or violation.metadata.full_remediation_fr %}
<div class="mb-3">
    <strong>
        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ t.get('how_to_remediate', 'How to remediate:') }}</span>
        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get('how_to_remediate', 'Comment corriger :') }}</span>
    </strong>
    {% if violation.metadata.full_remediation_en %}<div class="bg-light p-3 rounded {{ 'lang-active' if language == 'en' else 'lang-inactive' }}" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace;" data-lang="en">{{ violation.metadata.full_remediation_en }}</div>{% endif %}
    {% if violation.metadata.full_remediation_fr %}<div class="bg-light p-3 rounded {{ 'lang-active' if language == 'fr' else 'lang-inactive' }}" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace;" data-lang="fr">{{ violation.metadata.full_remediation_fr }}</div>{% endif %}
</div>
{% endif %}

{% if violation.metadata.wcag_full %}
<h6 class="text-{{ alert_type }} mb-2 mt-4">
    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get('relevant_test_criteria', 'Relevant test criteria:') }}</span>
    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get('relevant_test_criteria', 'Critères de test pertinents :') }}</span>
</h6>
<div class="mb-3">
    <strong>
        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">WCAG {{ translations_en.get('success_criteria', 'Success Criteria:') }}</span>
        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get('success_criteria', 'Critères de succès WCAG :') }}</span>
    </strong>
    <ul>
    {% for criterion in violation.metadata.wcag_full %}
        <li>
            <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ criterion|translate_wcag('en')|safe }}</span>
            <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ criterion|translate_wcag('fr')|safe }}</span>
        </li>
    {% endfor %}
    </ul>
</div>
{% endif %}
{% else %}
<!-- Standard description -->
<p><strong data-i18n="rule">{{ t.get('rule', 'Rule:') }}</strong> {{ violation.id }}</p>
<p><strong data-i18n="help">{{ t.get('help', 'Help:') }}</strong>
    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ violation.description_en if violation.description_en else (violation.description if violation.description else violation.id) }}</span>
    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ violation.description_fr if violation.description_fr else (violation.description if violation.description else violation.id) }}</span>
</p>
{% if violation.failure_summary %}
<p><strong data-i18n="how_to_fix">{{ t.get('how_to_fix', 'How to fix:') }}</strong> {{ violation.failure_summary }}</p>
{% endif %}
{% endif %}

<hr>
<div class="row">
    <div class="col-md-6">
        <p><strong data-i18n="touchpoint">{{ t.get('touchpoint', 'Touchpoint:') }}</strong>
            <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get(violation.touchpoint|lower, violation.touchpoint|replace('_', ' ')|title) }}</span>
            <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get(violation.touchpoint|lower, violation.touchpoint|replace('_', ' ')|title) }}</span>
        </p>
        <p><strong data-i18n="impact">{{ t.get('impact', 'Impact:') }}</strong>
            {% set impact_clean = violation.impact|string|replace('IMPACT_LEVEL.', '')|replace('ImpactLevel.', '') %}
            <span class="badge bg-{{ {'high': 'danger', 'serious': 'danger', 'critical': 'danger', 'medium': 'warning', 'moderate': 'warning', 'low': 'info', 'minor': 'info'}[impact_clean|lower] or 'secondary' }} impact-badge">
                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get(impact_clean|lower, impact_clean|upper) }}</span>
                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get(impact_clean|lower, impact_clean|upper) }}</span>
            </span>
        </p>
    </div>
    <div class="col-md-6">
        {% if violation.metadata and violation.metadata.wcag_full %}
            {% for criterion in violation.metadata.wcag_full|sort %}
            <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-left: 3px solid #0066cc;">
                <p style="margin: 0 0 8px 0; font-weight: bold;">
                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">WCAG {{ criterion|translate_wcag('en')|safe }}</span>
                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">WCAG {{ criterion|translate_wcag('fr')|safe }}</span>
                </p>

                {% set criterion_code = criterion.split()[0] %}
                <p style="margin: 0 0 5px 0;">
                    <a href="{{ criterion_code|wcag_understanding_url }}" target="_blank">
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">
                            {{ translations_en.get('more_about', 'More about') }} {{ criterion_code }}
                        </span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">
                            {{ translations_fr.get('more_about', 'En savoir plus sur') }} {{ criterion_code }} (en anglais)
                        </span>
                        <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                </p>
                <p style="margin: 0;">
                    <a href="{{ criterion_code|wcag_quickref_url }}" target="_blank">
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">
                            {{ translations_en.get('ways_to_meet', 'Ways to meet') }} {{ criterion_code }}
                        </span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">
                            {{ translations_fr.get('ways_to_meet', 'Comment satisfaire') }} {{ criterion_code }} (en anglais)
                        </span>
                        <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                </p>
            </div>
            {% endfor %}
        {% endif %}
    </div>
</div>

{% if violation.xpath %}
<p class="mt-3">
    <strong data-i18n="location">{{ t.get('location', 'Location:') }}</strong>
    <code>{{ violation.xpath }}</code>
    <button class="btn btn-sm btn-link p-0 ms-2"
            onclick="copyXpathToClipboard('{{ violation.xpath|e }}', this)"
            title="Copy XPath to clipboard">
        <i class="bi bi-clipboard"></i>
    </button>
</p>
{% endif %}

{% if violation.metadata and violation.metadata.breakpoint %}
<p>
    <strong data-i18n="responsive_breakpoint">{{ t.get('responsive_breakpoint', 'Responsive Breakpoint:') }}</strong> <span class="badge bg-info">{{ violation.metadata.breakpoint }}px width</span>
</p>
{% endif %}

{% if violation.metadata and violation.metadata.pseudoclass %}
<p>
    <strong data-i18n="css_state">{{ t.get('css_state', 'CSS State:') }}</strong>
    {% if '@' in violation.metadata.pseudoclass %}
        {% set parts = violation.metadata.pseudoclass.split('@') %}
        <span class="badge bg-warning">{{ parts[0] }}</span>
        <span class="badge bg-secondary">{{ parts[1] }}</span>
    {% else %}
        <span class="badge bg-warning">{{ violation.metadata.pseudoclass }}</span>
    {% endif %}
</p>
{% endif %}

{% if violation.html_snippet %}
<h6 class="mt-3" data-i18n="code_snippet">{{ t.get('code_snippet', 'Code Snippet') }}</h6>
<pre class="bg-dark text-light p-3 rounded"><code>{{ violation.html_snippet|e }}</code></pre>
{% endif %}
{% endmacro %}

    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary no-print">
        <div class="container-fluid">
            <a class="navbar-brand" href="../index.html">
                <i class="bi bi-universal-access-circle"></i>
                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get('auto_a11y_report', 'Auto A11y Report') }}</span>
                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get('auto_a11y_report', 'Rapport Auto A11y') }}</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">
                            <i class="bi bi-house"></i>
                            <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['index'] }}</span>
                            <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['index'] }}</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container-fluid py-4">
<div class="container-fluid">
    <!-- Page Navigation -->
    {% if navigation %}
    <nav aria-label="breadcrumb" class="mb-3 no-print">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="../index.html">
                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['index'] }}</span>
                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['index'] }}</span>
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">{{ page.title }}</li>
        </ol>
    </nav>
    {% endif %}

    <!-- Page Header with Language Switcher -->
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h1 class="h2">{{ page.title|default('Untitled Page') }}</h1>
            <p class="text-muted">
                <a href="{{ page.url }}" target="_blank">
                    {{ page.url }} <i class="bi bi-box-arrow-up-right"></i>
                </a>
            </p>
        </div>
        <div class="lang-switcher">
            <button onclick="switchLanguage('en')" id="lang-en" class="{{ 'active' if language == 'en' else '' }}" aria-label="Switch to English">EN</button>
            <button onclick="switchLanguage('fr')" id="lang-fr" class="{{ 'active' if language == 'fr' else '' }}" aria-label="Switch to French">FR</button>
        </div>
    </div>

    <!-- Page Status Cards -->
    <div class="row mb-4 g-3">
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['status'] }}</span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['status'] }}</span>
                    </h6>
                    <p class="mb-0">
                        <span class="badge bg-success">
                            <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['tested'] }}</span>
                            <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['tested'] }}</span>
                        </span>
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['last_tested'] }}</span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['last_tested'] }}</span>
                    </h6>
                    <p class="mb-0">
                        {{ page.test_date|default('Recently') }}
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['issues_found'] }}</span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['issues_found'] }}</span>
                    </h6>
                    <p class="mb-0">
                        <span class="text-danger fw-bold">{{ errors_count|default(0) }}</span>
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['errors'] }}</span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['errors'] }}</span>,
                        <span class="text-warning fw-bold">{{ warnings_count|default(0) }}</span>
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['warnings'] }}</span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['warnings'] }}</span>
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['score'] }}</span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['score'] }}</span>
                    </h6>
                    <p class="mb-0">
                        {% set score = page.score|default(0) %}
                        <span class="fw-bold {% if score >= 90 %}text-success{% elif score >= 70 %}text-warning{% else %}text-danger{% endif %}">
                            {{ "%.0f"|format(score) }}%
                        </span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Accessibility & Compliance Scores -->
    {% if page.score is defined %}
    <div class="row mb-4">
        <!-- Accessibility Score Card -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body text-center">
                    {% set score = page.score|default(0) %}
                    <h6 class="card-title">
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['accessibility_score'] }}</span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['accessibility_score'] }}</span>
                    </h6>
                    <div class="display-4 fw-bold {% if score >= 90 %}text-success{% elif score >= 70 %}text-warning{% else %}text-danger{% endif %}">
                        {{ "%.1f"|format(score) }}%
                    </div>
                    <p class="text-muted small mb-0">
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get('based_on_automated_checks', 'Based on automated checks') }}</span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get('based_on_automated_checks', 'Basé sur des vérifications automatisées') }}</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Compliance Score Card -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body text-center">
                    <h6 class="card-title">
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['compliance_score'] }}</span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['compliance_score'] }}</span>
                    </h6>
                    {% if compliance_score %}
                    <div class="display-4 fw-bold {% if compliance_score.score >= 90 %}text-success{% elif compliance_score.score >= 70 %}text-warning{% else %}text-danger{% endif %}">
                        {{ "%.1f"|format(compliance_score.score) }}%
                    </div>
                    <p class="text-muted small mb-0">
                        {{ compliance_score.passed_tests }} / {{ compliance_score.total_tests }}
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['tests_passed'] }}</span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['tests_passed'] }}</span>
                    </p>
                    {% else %}
                    <div class="display-4 fw-bold text-muted">N/A</div>
                    <p class="text-muted small mb-0">
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get('no_data_available', 'No data available') }}</span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get('no_data_available', 'Aucune donnée disponible') }}</span>
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Issue Breakdown -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-bug"></i>
                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['issues_found'] }}</span>
                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['issues_found'] }}</span>
            </h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-6 col-lg-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-x-circle text-danger me-2 fs-4"></i>
                        <div>
                            <div class="fw-bold">{{ errors_count|default(0) }}</div>
                            <small class="text-muted">
                                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['errors'] }}</span>
                                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['errors'] }}</span>
                            </small>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle text-warning me-2 fs-4"></i>
                        <div>
                            <div class="fw-bold">{{ warnings_count|default(0) }}</div>
                            <small class="text-muted">
                                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['warnings'] }}</span>
                                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['warnings'] }}</span>
                            </small>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-info-circle text-info me-2 fs-4"></i>
                        <div>
                            <div class="fw-bold">{{ info_count|default(0) }}</div>
                            <small class="text-muted">
                                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['info'] }}</span>
                                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['info'] }}</span>
                            </small>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-search" style="color: #6f42c1;" class="me-2 fs-4"></i>
                        <div>
                            <div class="fw-bold">{{ discovery_count|default(0) }}</div>
                            <small class="text-muted">
                                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['discovery'] }}</span>
                                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['discovery'] }}</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Filter Panel -->
    {% if violations or warnings or informational or discovery %}
    <div class="filter-panel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
                <i class="bi bi-funnel"></i>
                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get('filter_test_results', 'Filter Test Results') }}</span>
                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get('filter_test_results', 'Filtrer les résultats de test') }}</span>
            </h5>
            <button class="btn btn-sm btn-outline-secondary" id="clearFilters">
                <i class="bi bi-x-circle"></i>
                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get('clear_all_filters', 'Clear All Filters') }}</span>
                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get('clear_all_filters', 'Effacer tous les filtres') }}</span>
            </button>
        </div>

        <!-- Active Filters Display -->
        <div id="activeFilters" class="active-filters" style="display: none;">
            <strong data-i18n="active_filters">{{ t.get('active_filters', 'Active Filters:') }}</strong>
            <div id="activeFilterTags"></div>
        </div>

        <!-- Filter Statistics -->
        <div class="filter-stats">
            <strong data-i18n="showing">{{ t.get('showing', 'Showing:') }}</strong>
            <span id="visibleCount">0</span>
            <span data-i18n="of">{{ t.get('of', 'of') }}</span>
            <span id="totalCount">0</span>
            <span data-i18n="items">{{ t.get('items', 'items') }}</span>
            | <span id="filterSummary"></span>
        </div>

        <!-- Filter Groups -->
        <div class="row">
            <!-- Issue Type Filter -->
            <div class="col-md-3">
                <div class="filter-group">
                    <label class="form-label fw-bold">
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get('issue_type', 'Issue Type') }}</span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get('issue_type', 'Type de problème') }}</span>
                    </label>
                    <div class="filter-chips">
                        <div class="filter-chip" data-filter-type="type" data-filter-value="error">
                            <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['errors'] }}</span>
                            <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['errors'] }}</span>
                            ({{ violations|length }})
                        </div>
                        <div class="filter-chip" data-filter-type="type" data-filter-value="warning">
                            <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['warnings'] }}</span>
                            <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['warnings'] }}</span>
                            ({{ warnings|length }})
                        </div>
                        <div class="filter-chip" data-filter-type="type" data-filter-value="info">
                            <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['info'] }}</span>
                            <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['info'] }}</span>
                            ({{ informational|length }})
                        </div>
                        <div class="filter-chip" data-filter-type="type" data-filter-value="discovery">
                            <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['discovery'] }}</span>
                            <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['discovery'] }}</span>
                            ({{ discovery|length }})
                        </div>
                    </div>
                </div>
            </div>

            <!-- Impact Level Filter -->
            <div class="col-md-3">
                <div class="filter-group">
                    <label class="form-label fw-bold">
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get('impact_level', 'Impact Level') }}</span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get('impact_level', 'Niveau d\'impact') }}</span>
                    </label>
                    <div class="filter-chips">
                        <div class="filter-chip" data-filter-type="impact" data-filter-value="high">
                            <span class="badge bg-danger me-1">
                                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['high'] }}</span>
                                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['high'] }}</span>
                            </span>
                            <span id="highImpactCount">0</span>
                        </div>
                        <div class="filter-chip" data-filter-type="impact" data-filter-value="medium">
                            <span class="badge bg-warning text-dark me-1">
                                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['medium'] }}</span>
                                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['medium'] }}</span>
                            </span>
                            <span id="mediumImpactCount">0</span>
                        </div>
                        <div class="filter-chip" data-filter-type="impact" data-filter-value="low">
                            <span class="badge bg-info me-1">
                                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['low'] }}</span>
                                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['low'] }}</span>
                            </span>
                            <span id="lowImpactCount">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Touchpoint Filter -->
            <div class="col-md-6">
                <div class="filter-group">
                    <label class="form-label fw-bold">
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get('issue_touchpoint', 'Issue Touchpoint') }}</span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get('issue_touchpoint', 'Point de contact du problème') }}</span>
                    </label>
                    <select class="form-select form-select-sm" id="touchpointFilter" multiple size="3">
                        <option value="" data-i18n="all_touchpoints">{{ t.get('all_touchpoints', 'All Touchpoints') }}</option>
                        {% for touchpoint in all_touchpoints %}
                        <option value="{{ touchpoint }}" data-touchpoint-key="{{ touchpoint|lower }}" data-en="{{ translations_en.get(touchpoint|lower, touchpoint|replace('_', ' ')|title) }}" data-fr="{{ translations_fr.get(touchpoint|lower, touchpoint|replace('_', ' ')|title) }}">{% if language == 'fr' %}{{ translations_fr.get(touchpoint|lower, touchpoint|replace('_', ' ')|title) }}{% else %}{{ translations_en.get(touchpoint|lower, touchpoint|replace('_', ' ')|title) }}{% endif %}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- Quick Search -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="quickSearch"
                           data-i18n-placeholder="search_placeholder"
                           placeholder="{{ t.get('search_placeholder', 'Search in issue descriptions, error codes, or XPaths...') }}">
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Test Results Card - Match online view exactly -->
    {% if violations or warnings or informational or discovery %}
    <div class="card test-results-card">
        <div class="card-header">
            <h5 class="mb-0">
                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">Latest Test Results</span>
                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Derniers résultats de test</span>
            </h5>
            <small class="text-muted">
                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">Tested on</span>
                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Testé le</span>
                {{ page.test_date|default('Recently') }}
            </small>
        </div>

        <!-- Multi-State Selector -->
        {% if page.states and page.states|length > 1 %}
        <div class="card-body border-bottom bg-light">
            <h6 class="mb-3">
                <i class="bi bi-layers"></i>
                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">Page States Tested</span>
                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">États de page testés</span>
            </h6>
            <p class="text-muted small mb-3">
                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">This page was tested in multiple states. Select a state below to view its test results.</span>
                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Cette page a été testée dans plusieurs états. Sélectionnez un état ci-dessous pour voir ses résultats de test.</span>
            </p>
            <div class="btn-group flex-wrap" role="group" aria-label="Page states">
                {% for state in page.states %}
                    <button type="button"
                            class="btn btn-outline-primary state-selector {% if loop.index0 == 0 %}active{% endif %}"
                            data-state-index="{{ loop.index0 }}"
                            onclick="showState({{ loop.index0 }})">
                        <i class="bi bi-circle-fill" style="font-size: 8px;"></i>
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ state.description_en or state.description }}</span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ state.description_fr or state.description }}</span>
                        {% if state.script_info %}
                        <br>
                        <small class="text-muted">
                            <i class="bi bi-code-square"></i>
                            {{ state.script_info.script_name }}
                        </small>
                        {% endif %}
                        {% if state.auth_user %}
                        <br>
                        <small class="text-info">
                            <i class="bi bi-person-check"></i>
                            {{ state.auth_user.display_name or state.auth_user.username }}
                            {% if state.auth_user.roles %}({{ state.auth_user.roles|join(', ') }}){% endif %}
                        </small>
                        {% endif %}
                        <br>
                        <small class="state-counts">
                            <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">Errors: {{ state.issues.errors }} | Warnings: {{ state.issues.warnings }}</span>
                            <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Erreurs: {{ state.issues.errors }} | Avertissements: {{ state.issues.warnings }}</span>
                        </small>
                    </button>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="card-body">

            {% if page.states and page.states|length > 1 %}
                {# Multi-state: Render each state's results separately #}
                {% for state in page.states %}
                <div class="state-content {% if loop.index0 == 0 %}active{% endif %}" data-state-index="{{ loop.index0 }}">
                    <!-- Errors (Violations) for {{ state.description }} -->
                    {% if state.violations %}
                    <div class="section-panel errors-section mb-4" style="border: 2px solid #dc3545; border-radius: 8px; overflow: hidden;">
                        <div class="section-header" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; padding: 12px 16px;">
                            <h5 class="mb-0">
                                <i class="bi bi-x-circle-fill me-2"></i>
                                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['errors'] }}</span>
                                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['errors'] }}</span>
                                <span class="badge bg-light text-danger ms-2">{{ state.violations|length }}</span>
                            </h5>
                            <small class="opacity-75">
                                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">Issues that must be fixed for WCAG compliance</span>
                                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Problèmes à corriger pour la conformité WCAG</span>
                            </small>
                        </div>
                        <div class="section-body" style="padding: 16px; background: #fff5f5;">
                    <div class="accordion mb-4" id="violationsAccordion_{{ loop.index0 }}">
                        {% set viol_counter = namespace(value=0) %}
                        {% for touchpoint, touchpoint_violations in state.violations|groupby('touchpoint') %}
                            <div class="touchpoint-header mt-3 mb-2 ps-2" style="background-color: #f8f9fa; padding: 8px; border-left: 4px solid #dc3545;">
                                <strong>
                                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get(touchpoint|lower, touchpoint|replace('_', ' ')|title if touchpoint else 'General') }}</span>
                                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get(touchpoint|lower, touchpoint|replace('_', ' ')|title if touchpoint else 'Général') }}</span>
                                </strong>
                            </div>

                            {% for error_code, description_group in touchpoint_violations|groupby('id') %}
                                {% set group_list = description_group|list %}
                                {% set viol_counter.value = viol_counter.value + 1 %}
                                {% set first_violation = group_list[0] %}

                                <div class="accordion-item issue-item"
                                     data-type="error"
                                     data-impact="{{ first_violation.impact|lower }}"
                                     data-touchpoint="{{ first_violation.touchpoint|lower }}"
                                     data-id="{{ error_code }}"
                                     data-description="{{ first_violation.metadata.what_generic|lower if first_violation.metadata.what_generic else first_violation.description|lower }}"
                                     data-xpath="{{ first_violation.xpath|lower if first_violation.xpath else '' }}">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#viol_state{{ loop.index0 }}_group_{{ viol_counter.value }}">
                                            {% if group_list|length > 1 %}
                                            <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[first_violation.impact|lower] or 'secondary' }} me-2">{{ group_list|length }}</span>
                                            {% endif %}
                                            <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[first_violation.impact|lower] or 'secondary' }} me-2 impact-badge">
                                                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get(first_violation.impact|lower, first_violation.impact|upper) }}</span>
                                                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get(first_violation.impact|lower, first_violation.impact|upper) }}</span>
                                            </span>
                                            {% if show_error_codes %}<code class="me-2">{{ error_code }}</code>{% endif %}
                                            <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ first_violation.metadata.what_generic_en if first_violation.metadata and first_violation.metadata.what_generic_en else (first_violation.description_en if first_violation.description_en else first_violation.description) }}</span>
                                            <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ first_violation.metadata.what_generic_fr if first_violation.metadata and first_violation.metadata.what_generic_fr else (first_violation.description_fr if first_violation.description_fr else first_violation.description) }}</span>
                                        </button>
                                    </h2>
                                    <div id="viol_state{{ loop.index0 }}_group_{{ viol_counter.value }}"
                                         class="accordion-collapse collapse">
                                        <div class="accordion-body">
                                            {% if first_violation.metadata and (first_violation.metadata.what_en or first_violation.metadata.what_fr) %}
                                            <div class="alert alert-danger mb-3">
                                                <h6 class="alert-heading">
                                                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ first_violation.metadata.title_en or first_violation.metadata.what_en or first_violation.description }}</span>
                                                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ first_violation.metadata.title_fr or first_violation.metadata.what_fr or first_violation.description }}</span>
                                                </h6>
                                            </div>
                                            
                                            <h6 class="text-danger mb-2">
                                                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">About this issue:</span>
                                                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">À propos de ce problème :</span>
                                            </h6>
                                            
                                            <div class="mb-3">
                                                <strong>
                                                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">What the issue is:</span>
                                                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Quel est le problème :</span>
                                                </strong>
                                                <p>
                                                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ first_violation.metadata.what_en or first_violation.description }}</span>
                                                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ first_violation.metadata.what_fr or first_violation.description }}</span>
                                                </p>
                                            </div>
                                            
                                            {% if first_violation.metadata.why_en or first_violation.metadata.why_fr %}
                                            <div class="mb-3">
                                                <strong>
                                                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">Why this is important:</span>
                                                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Pourquoi c'est important :</span>
                                                </strong>
                                                <p>
                                                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ first_violation.metadata.why_en }}</span>
                                                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ first_violation.metadata.why_fr }}</span>
                                                </p>
                                            </div>
                                            {% endif %}
                                            
                                            {% if first_violation.metadata.who_en or first_violation.metadata.who_fr %}
                                            <div class="mb-3">
                                                <strong>
                                                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">Who it affects:</span>
                                                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Qui est affecté :</span>
                                                </strong>
                                                <p>
                                                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ first_violation.metadata.who_en }}</span>
                                                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ first_violation.metadata.who_fr }}</span>
                                                </p>
                                            </div>
                                            {% endif %}
                                            
                                            {% if first_violation.metadata.full_remediation_en or first_violation.metadata.full_remediation_fr %}
                                            <div class="mb-3">
                                                <strong>
                                                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">How to remediate:</span>
                                                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Comment corriger :</span>
                                                </strong>
                                                <div class="bg-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace;">
                                                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ first_violation.metadata.full_remediation_en }}</span>
                                                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ first_violation.metadata.full_remediation_fr }}</span>
                                                </div>
                                            </div>
                                            {% endif %}
                                            {% else %}
                                            <p><strong>
                                                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">Description:</span>
                                                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Description :</span>
                                            </strong> {{ first_violation.description }}</p>
                                            {% endif %}
                                            
                                            {% if first_violation.html_snippet %}
                                            <p><strong>HTML:</strong> <code>{{ first_violation.html_snippet }}</code></p>
                                            {% endif %}
                                            {% if first_violation.xpath %}
                                            <p><strong>XPath:</strong> <code>{{ first_violation.xpath }}</code></p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endfor %}
                    </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Warnings for {{ state.description }} -->
                    {% if state.warnings %}
                    <div class="section-panel warnings-section mb-4" style="border: 2px solid #ffc107; border-radius: 8px; overflow: hidden;">
                        <div class="section-header" style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #212529; padding: 12px 16px;">
                            <h5 class="mb-0">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['warnings'] }}</span>
                                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['warnings'] }}</span>
                                <span class="badge bg-light text-warning ms-2">{{ state.warnings|length }}</span>
                            </h5>
                            <small class="opacity-75">
                                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">Potential issues that should be reviewed</span>
                                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Problèmes potentiels à examiner</span>
                            </small>
                        </div>
                        <div class="section-body" style="padding: 16px; background: #fffbeb;">
                    <div class="accordion mb-4" id="warningsAccordion_{{ loop.index0 }}">
                        {% set warn_counter = namespace(value=0) %}
                        {% for touchpoint, touchpoint_warnings in state.warnings|groupby('touchpoint') %}
                            <div class="touchpoint-header mt-3 mb-2 ps-2" style="background-color: #f8f9fa; padding: 8px; border-left: 4px solid #ffc107;">
                                <strong>
                                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get(touchpoint|lower, touchpoint|replace('_', ' ')|title if touchpoint else 'General') }}</span>
                                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get(touchpoint|lower, touchpoint|replace('_', ' ')|title if touchpoint else 'Général') }}</span>
                                </strong>
                            </div>

                            {% for warning_code, description_group in touchpoint_warnings|groupby('id') %}
                                {% set group_list = description_group|list %}
                                {% set warn_counter.value = warn_counter.value + 1 %}
                                {% set first_warning = group_list[0] %}

                                <div class="accordion-item issue-item"
                                     data-type="warning"
                                     data-impact="{{ first_warning.impact|lower }}"
                                     data-touchpoint="{{ first_warning.touchpoint|lower }}"
                                     data-id="{{ warning_code }}"
                                     data-description="{{ first_warning.metadata.what_generic|lower if first_warning.metadata.what_generic else first_warning.description|lower }}"
                                     data-xpath="{{ first_warning.xpath|lower if first_warning.xpath else '' }}">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#warn_state{{ loop.index0 }}_group_{{ warn_counter.value }}">
                                            {% if group_list|length > 1 %}
                                            <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[first_warning.impact|lower] or 'secondary' }} me-2">{{ group_list|length }}</span>
                                            {% endif %}
                                            <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[first_warning.impact|lower] or 'secondary' }} me-2 impact-badge">
                                                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get(first_warning.impact|lower, first_warning.impact|upper) }}</span>
                                                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get(first_warning.impact|lower, first_warning.impact|upper) }}</span>
                                            </span>
                                            <code class="me-2">{{ warning_code }}</code>
                                            <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ first_warning.metadata.what_generic_en if first_warning.metadata and first_warning.metadata.what_generic_en else (first_warning.description_en if first_warning.description_en else first_warning.description) }}</span>
                                            <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ first_warning.metadata.what_generic_fr if first_warning.metadata and first_warning.metadata.what_generic_fr else (first_warning.description_fr if first_warning.description_fr else first_warning.description) }}</span>
                                        </button>
                                    </h2>
                                    <div id="warn_state{{ loop.index0 }}_group_{{ warn_counter.value }}"
                                         class="accordion-collapse collapse">
                                        <div class="accordion-body">
                                            {% if first_warning.metadata and (first_warning.metadata.what_en or first_warning.metadata.what_fr) %}
                                            <div class="alert alert-warning mb-3">
                                                <h6 class="alert-heading">
                                                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ first_warning.metadata.title_en or first_warning.metadata.what_en or first_warning.description }}</span>
                                                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ first_warning.metadata.title_fr or first_warning.metadata.what_fr or first_warning.description }}</span>
                                                </h6>
                                            </div>
                                            
                                            <h6 class="text-warning mb-2">
                                                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">About this issue:</span>
                                                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">À propos de ce problème :</span>
                                            </h6>
                                            
                                            <div class="mb-3">
                                                <strong>
                                                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">What the issue is:</span>
                                                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Quel est le problème :</span>
                                                </strong>
                                                <p>
                                                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ first_warning.metadata.what_en or first_warning.description }}</span>
                                                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ first_warning.metadata.what_fr or first_warning.description }}</span>
                                                </p>
                                            </div>
                                            
                                            {% if first_warning.metadata.why_en or first_warning.metadata.why_fr %}
                                            <div class="mb-3">
                                                <strong>
                                                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">Why this is important:</span>
                                                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Pourquoi c'est important :</span>
                                                </strong>
                                                <p>
                                                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ first_warning.metadata.why_en }}</span>
                                                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ first_warning.metadata.why_fr }}</span>
                                                </p>
                                            </div>
                                            {% endif %}
                                            
                                            {% if first_warning.metadata.who_en or first_warning.metadata.who_fr %}
                                            <div class="mb-3">
                                                <strong>
                                                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">Who it affects:</span>
                                                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Qui est affecté :</span>
                                                </strong>
                                                <p>
                                                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ first_warning.metadata.who_en }}</span>
                                                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ first_warning.metadata.who_fr }}</span>
                                                </p>
                                            </div>
                                            {% endif %}
                                            
                                            {% if first_warning.metadata.full_remediation_en or first_warning.metadata.full_remediation_fr %}
                                            <div class="mb-3">
                                                <strong>
                                                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">How to remediate:</span>
                                                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Comment corriger :</span>
                                                </strong>
                                                <div class="bg-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace;">
                                                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ first_warning.metadata.full_remediation_en }}</span>
                                                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ first_warning.metadata.full_remediation_fr }}</span>
                                                </div>
                                            </div>
                                            {% endif %}
                                            {% else %}
                                            <p><strong>
                                                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">Description:</span>
                                                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Description :</span>
                                            </strong> {{ first_warning.description }}</p>
                                            {% endif %}
                                            
                                            {% if first_warning.html_snippet %}
                                            <p><strong>HTML:</strong> <code>{{ first_warning.html_snippet }}</code></p>
                                            {% endif %}
                                            {% if first_warning.xpath %}
                                            <p><strong>XPath:</strong> <code>{{ first_warning.xpath }}</code></p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endfor %}
                    </div>
                        </div>
                    </div>
                    {% endif %}

                    {# Informational items for this state #}
                    {% if state.informational %}
                    <div class="section-panel info-section mb-4" style="border: 2px solid #0e7490; border-radius: 8px; overflow: hidden;">
                        <div class="section-header" style="background: linear-gradient(135deg, #0e7490 0%, #0aa2c0 100%); color: white; padding: 12px 16px;">
                            <h5 class="mb-0">
                                <i class="bi bi-info-circle-fill me-2"></i>
                                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['info'] }}</span>
                                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['info'] }}</span>
                                <span class="badge bg-light text-info ms-2">{{ state.informational|length }}</span>
                            </h5>
                            <small class="opacity-75">
                                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">Informational notes for review</span>
                                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Notes d'information à examiner</span>
                            </small>
                        </div>
                        <div class="section-body" style="padding: 16px; background: #e8f9fd;">
                    <div class="accordion mb-4" id="informationalAccordion_{{ loop.index0 }}">
                        {% set info_counter = namespace(value=0) %}
                        {% for touchpoint, touchpoint_info in state.informational|groupby('touchpoint') %}
                            <div class="touchpoint-header mt-3 mb-2 ps-2" style="background-color: #f8f9fa; padding: 8px; border-left: 4px solid #0e7490;">
                                <strong>
                                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get(touchpoint|lower, touchpoint|replace('_', ' ')|title if touchpoint else 'General') }}</span>
                                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get(touchpoint|lower, touchpoint|replace('_', ' ')|title if touchpoint else 'Général') }}</span>
                                </strong>
                            </div>

                            {% for info_code, description_group in touchpoint_info|groupby('id') %}
                                {% set group_list = description_group|list %}
                                {% set info_counter.value = info_counter.value + 1 %}
                                {% set first_info = group_list[0] %}

                                <div class="accordion-item issue-item"
                                     data-type="info"
                                     data-touchpoint="{{ first_info.touchpoint|lower }}"
                                     data-id="{{ info_code }}">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#info_state{{ loop.index0 }}_group_{{ info_counter.value }}">
                                            {% if group_list|length > 1 %}
                                            <span class="badge bg-info me-2">{{ group_list|length }}</span>
                                            {% endif %}
                                            <code class="me-2">{{ info_code }}</code>
                                            <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ first_info.metadata.what_generic_en if first_info.metadata and first_info.metadata.what_generic_en else (first_info.description_en if first_info.description_en else first_info.description) }}</span>
                                            <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ first_info.metadata.what_generic_fr if first_info.metadata and first_info.metadata.what_generic_fr else (first_info.description_fr if first_info.description_fr else first_info.description) }}</span>
                                        </button>
                                    </h2>
                                    <div id="info_state{{ loop.index0 }}_group_{{ info_counter.value }}"
                                         class="accordion-collapse collapse">
                                        <div class="accordion-body">
                                            <p>{{ first_info.description }}</p>
                                            {% if first_info.html_snippet %}
                                            <p><strong>HTML:</strong> <code>{{ first_info.html_snippet }}</code></p>
                                            {% endif %}
                                            {% if first_info.xpath %}
                                            <p><strong>XPath:</strong> <code>{{ first_info.xpath }}</code></p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endfor %}
                    </div>
                        </div>
                    </div>
                    {% endif %}

                    {# Discovery items for this state #}
                    {% if state.discovery %}
                    <div class="section-panel discovery-section mb-4" style="border: 2px solid #6f42c1; border-radius: 8px; overflow: hidden;">
                        <div class="section-header" style="background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%); color: white; padding: 12px 16px;">
                            <h5 class="mb-0">
                                <i class="bi bi-binoculars-fill me-2"></i>
                                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['discovery'] }}</span>
                                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['discovery'] }}</span>
                                <span class="badge bg-light text-secondary ms-2">{{ state.discovery|length }}</span>
                            </h5>
                            <small class="opacity-75">
                                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">Items discovered for manual review</span>
                                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Éléments découverts à examiner manuellement</span>
                            </small>
                        </div>
                        <div class="section-body" style="padding: 16px; background: #f3eefa;">
                    <div class="accordion mb-4" id="discoveryAccordion_{{ loop.index0 }}">
                        {% set disco_counter = namespace(value=0) %}
                        {% for touchpoint, touchpoint_discovery in state.discovery|groupby('touchpoint') %}
                            <div class="touchpoint-header mt-3 mb-2 ps-2" style="background-color: #f8f9fa; padding: 8px; border-left: 4px solid #6f42c1;">
                                <strong>
                                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get(touchpoint|lower, touchpoint|replace('_', ' ')|title if touchpoint else 'General') }}</span>
                                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get(touchpoint|lower, touchpoint|replace('_', ' ')|title if touchpoint else 'Général') }}</span>
                                </strong>
                            </div>

                            {% for disco_code, description_group in touchpoint_discovery|groupby('id') %}
                                {% set group_list = description_group|list %}
                                {% set disco_counter.value = disco_counter.value + 1 %}
                                {% set first_disco = group_list[0] %}

                                <div class="accordion-item issue-item"
                                     data-type="discovery"
                                     data-touchpoint="{{ first_disco.touchpoint|lower }}"
                                     data-id="{{ disco_code }}">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#disco_state{{ loop.index0 }}_group_{{ disco_counter.value }}">
                                            {% if group_list|length > 1 %}
                                            <span class="badge bg-secondary me-2">{{ group_list|length }}</span>
                                            {% endif %}
                                            <code class="me-2">{{ disco_code }}</code>
                                            <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ first_disco.metadata.what_generic_en if first_disco.metadata and first_disco.metadata.what_generic_en else (first_disco.description_en if first_disco.description_en else first_disco.description) }}</span>
                                            <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ first_disco.metadata.what_generic_fr if first_disco.metadata and first_disco.metadata.what_generic_fr else (first_disco.description_fr if first_disco.description_fr else first_disco.description) }}</span>
                                        </button>
                                    </h2>
                                    <div id="disco_state{{ loop.index0 }}_group_{{ disco_counter.value }}"
                                         class="accordion-collapse collapse">
                                        <div class="accordion-body">
                                            <p>{{ first_disco.description }}</p>
                                            {% if first_disco.html_snippet %}
                                            <p><strong>HTML:</strong> <code>{{ first_disco.html_snippet }}</code></p>
                                            {% endif %}
                                            {% if first_disco.xpath %}
                                            <p><strong>XPath:</strong> <code>{{ first_disco.xpath }}</code></p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endfor %}
                    </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if not state.violations and not state.warnings and not state.informational and not state.discovery %}
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i>
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">No issues found in this state!</span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Aucun problème détecté dans cet état !</span>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                {# Single state: Render normally - This section needs to be continued below due to length #}
                <!-- Errors (Violations) -->
                {% if violations %}
            <div class="section-panel errors-section mb-4" style="border: 2px solid #dc3545; border-radius: 8px; overflow: hidden;">
                <div class="section-header" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; padding: 12px 16px;">
                    <h5 class="mb-0">
                        <i class="bi bi-x-circle-fill me-2"></i>
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['errors'] }}</span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['errors'] }}</span>
                        <span class="badge bg-light text-danger ms-2">{{ violations|length }}</span>
                    </h5>
                    <small class="opacity-75">
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">Issues to fix for WCAG compliance</span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Problèmes à corriger pour la conformité WCAG</span>
                    </small>
                </div>
                <div class="section-body" style="padding: 16px; background: #fff5f5;">
            <div class="accordion" id="violationsAccordion">
                {% set viol_counter = namespace(value=0) %}
                {% for touchpoint, touchpoint_violations in violations|groupby('touchpoint') %}
                    <div class="touchpoint-header mt-3 mb-2 ps-2" style="border-left: 4px solid #dc3545;">
                        <strong>
                            <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get(touchpoint|lower, touchpoint|replace('_', ' ')|title if touchpoint else 'General') }}</span>
                            <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get(touchpoint|lower, touchpoint|replace('_', ' ')|title if touchpoint else 'General') }}</span>
                        </strong>
                    </div>

                    {% for error_code, description_group in touchpoint_violations|groupby('id') %}
                        {% set group_list = description_group|list %}
                        {% set viol_counter.value = viol_counter.value + 1 %}
                        {% set first_violation = group_list[0] %}
                        {% set impact_text = first_violation.impact|string|replace('IMPACT_LEVEL.', '')|replace('ImpactLevel.', '') %}

                        <div class="accordion-item issue-item"
                             data-type="error"
                             data-impact="{{ impact_text|lower }}"
                             data-touchpoint="{{ touchpoint|lower }}"
                             data-id="{{ error_code }}"
                             data-instance-count="{{ group_list|length }}"
                             data-description="{{ first_violation.metadata.what_generic_en|lower if first_violation.metadata and first_violation.metadata.what_generic_en else first_violation.description_en|lower if first_violation.description_en else first_violation.description|lower }}"
                             data-xpath="{{ first_violation.xpath|lower if first_violation.xpath else '' }}">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#viol-group-{{ viol_counter.value }}">
                                    {% if group_list|length > 1 %}
                                    <span class="badge bg-{{ {'high': 'danger', 'serious': 'danger', 'critical': 'danger', 'medium': 'warning', 'moderate': 'warning', 'low': 'info', 'minor': 'info'}[impact_text|lower] or 'secondary' }} me-2">{{ group_list|length }}</span>
                                    {% endif %}
                                    <span class="badge bg-{{ {'high': 'danger', 'serious': 'danger', 'critical': 'danger', 'medium': 'warning', 'moderate': 'warning', 'low': 'info', 'minor': 'info'}[impact_text|lower] or 'secondary' }} me-2 impact-badge">
                                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get(impact_text|lower, impact_text|upper) }}</span>
                                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get(impact_text|lower, impact_text|upper) }}</span>
                                    </span>
                                    {% if group_list|length == 1 %}
                                        {# Show user badge for single violations #}
                                        {% if first_violation.metadata and first_violation.metadata.authenticated_user %}
                                            <span class="badge bg-secondary me-2">
                                                <i class="bi bi-person-fill"></i> {{ first_violation.metadata.authenticated_user.display_name }}
                                                {% if first_violation.metadata.authenticated_user.roles %}
                                                    ({{ first_violation.metadata.authenticated_user.roles|join(', ') }})
                                                {% endif %}
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary me-2">
                                                <i class="bi bi-person"></i>
                                                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">Guest</span>
                                                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Invité</span>
                                            </span>
                                        {% endif %}
                                    {% endif %}
                                    {% if show_error_codes %}<code class="me-2">{{ error_code }}</code>{% endif %}
                                    {% if group_list|length > 1 %}
                                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ first_violation.metadata.what_generic_en if first_violation.metadata and first_violation.metadata.what_generic_en else (first_violation.metadata.what_en if first_violation.metadata and first_violation.metadata.what_en else error_code) }}</span>
                                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ first_violation.metadata.what_generic_fr if first_violation.metadata and first_violation.metadata.what_generic_fr else (first_violation.metadata.what_fr if first_violation.metadata and first_violation.metadata.what_fr else error_code) }}</span>
                                    {% else %}
                                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ first_violation.metadata.title_en if first_violation.metadata and first_violation.metadata.title_en else (first_violation.metadata.what_en if first_violation.metadata and first_violation.metadata.what_en else first_violation.description_en if first_violation.description_en else first_violation.description) }}</span>
                                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ first_violation.metadata.title_fr if first_violation.metadata and first_violation.metadata.title_fr else (first_violation.metadata.what_fr if first_violation.metadata and first_violation.metadata.what_fr else first_violation.description_fr if first_violation.description_fr else first_violation.description) }}</span>
                                        {% if first_violation.xpath %}
                                        <span class="text-muted ms-2" style="font-size: 0.9em;"> • {{ first_violation.xpath }}</span>
                                        {% endif %}
                                    {% endif %}
                                </button>
                            </h2>
                            <div id="viol-group-{{ viol_counter.value }}"
                                 class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    {% if group_list|length > 1 %}
                                        <!-- Multiple instances - check if we should group by breakpoint -->
                                        {% set has_breakpoints = group_list[0].metadata and group_list[0].metadata.get('breakpoint') is not none %}

                                        {% if has_breakpoints %}
                                            {# Group by breakpoint for contrast violations #}
                                            {% set breakpoint_groups = group_list|groupby('metadata.breakpoint') %}
                                            <div class="accordion" id="viol-group-breakpoints-{{ viol_counter.value }}">
                                            {% for breakpoint, breakpoint_violations in breakpoint_groups %}
                                                {% set breakpoint_list = breakpoint_violations|list %}
                                                {% set breakpoint_id = viol_counter.value ~ '-bp-' ~ (breakpoint if breakpoint else 'none') %}
                                                <div class="accordion-item">
                                                    <h2 class="accordion-header">
                                                        <button class="accordion-button collapsed" type="button"
                                                                data-bs-toggle="collapse"
                                                                data-bs-target="#viol-breakpoint-{{ breakpoint_id }}">
                                                            <span class="badge bg-info me-2">{{ breakpoint_list|length }}</span>
                                                            <strong>
                                                                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">Breakpoint: {{ breakpoint }}px width</span>
                                                                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Point de rupture : {{ breakpoint }}px de largeur</span>
                                                            </strong>
                                                        </button>
                                                    </h2>
                                                    <div id="viol-breakpoint-{{ breakpoint_id }}"
                                                         class="accordion-collapse collapse"
                                                         data-bs-parent="#viol-group-breakpoints-{{ viol_counter.value }}">
                                                        <div class="accordion-body">
                                                            <div class="accordion" id="viol-breakpoint-instances-{{ breakpoint_id }}">
                                                            {% for violation in breakpoint_list %}
                                                            {% set instance_id = 'viol-instance-' ~ breakpoint_id ~ '-' ~ loop.index %}
                                                            {% set parent_id = 'viol-breakpoint-instances-' ~ breakpoint_id %}
                                                            {{ render_instance_accordion(violation, instance_id, parent_id, 'danger', loop.index) }}
                                                            {% endfor %}
                                                            </div> {# Close viol-breakpoint-instances #}
                                                        </div> {# Close accordion-body #}
                                                    </div> {# Close viol-breakpoint collapse #}
                                                </div> {# Close accordion-item #}
                                            {% endfor %} {# End breakpoint loop #}
                                            </div> {# Close viol-group-breakpoints #}
                                        {% else %}
                                            {# No breakpoints - use regular instance grouping #}
                                            <div class="accordion" id="viol-group-instances-{{ viol_counter.value }}">
                                            {% for violation in group_list %}
                                            {% set instance_id = 'viol-instance-' ~ viol_counter.value ~ '-' ~ loop.index %}
                                            {% set parent_id = 'viol-group-instances-' ~ viol_counter.value %}
                                            {{ render_instance_accordion(violation, instance_id, parent_id, 'danger', loop.index) }}
                                            {% endfor %}
                                            </div> {# Close viol-group-instances #}
                                        {% endif %}
                                    {% else %}
                                        <!-- Single instance - show directly -->
                                        {{ render_violation_details(group_list[0], 'danger') }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% endfor %}
            </div>
                </div>
            </div>
            {% endif %}

            <!-- Warnings -->
            {% if warnings %}
            <div class="section-panel warnings-section mb-4" style="border: 2px solid #ffc107; border-radius: 8px; overflow: hidden;">
                <div class="section-header" style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #212529; padding: 12px 16px;">
                    <h5 class="mb-0">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['warnings'] }}</span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['warnings'] }}</span>
                        <span class="badge bg-light text-warning ms-2">{{ warnings|length }}</span>
                    </h5>
                    <small>
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">Potential issues to review</span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Problèmes potentiels à examiner</span>
                    </small>
                </div>
                <div class="section-body" style="padding: 16px; background: #fffbeb;">
            <div class="accordion" id="warningsAccordion">
                {% set warn_counter = namespace(value=0) %}
                {% for touchpoint, touchpoint_warnings in warnings|groupby('touchpoint') %}
                    <div class="touchpoint-header mt-3 mb-2 ps-2" style="border-left: 4px solid #ffc107;">
                        <strong>
                            <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get(touchpoint|lower, touchpoint|replace('_', ' ')|title if touchpoint else 'General') }}</span>
                            <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get(touchpoint|lower, touchpoint|replace('_', ' ')|title if touchpoint else 'General') }}</span>
                        </strong>
                    </div>

                    {% for error_code, description_group in touchpoint_warnings|groupby('id') %}
                        {% set group_list = description_group|list %}
                        {% set warn_counter.value = warn_counter.value + 1 %}
                        {% set first_warning = group_list[0] %}
                        {% set impact_text = first_warning.impact|string|replace('IMPACT_LEVEL.', '')|replace('ImpactLevel.', '') %}

                        <div class="accordion-item issue-item"
                             data-type="warning"
                             data-impact="{{ impact_text|lower }}"
                             data-touchpoint="{{ touchpoint|lower }}"
                             data-id="{{ error_code }}"
                             data-instance-count="{{ group_list|length }}"
                             data-description="{{ first_warning.metadata.what_generic_en|lower if first_warning.metadata and first_warning.metadata.what_generic_en else first_warning.description_en|lower if first_warning.description_en else first_warning.description|lower }}"
                             data-xpath="{{ first_warning.xpath|lower if first_warning.xpath else '' }}">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#warn-group-{{ warn_counter.value }}">
                                    {% if group_list|length > 1 %}
                                    <span class="badge bg-warning me-2">{{ group_list|length }}</span>
                                    {% endif %}
                                    <span class="badge bg-{{ {'high': 'danger', 'serious': 'danger', 'critical': 'danger', 'medium': 'warning', 'moderate': 'warning', 'low': 'info', 'minor': 'info'}[impact_text|lower] or 'secondary' }} me-2 impact-badge">
                                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get(impact_text|lower, impact_text|upper) }}</span>
                                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get(impact_text|lower, impact_text|upper) }}</span>
                                    </span>
                                    {% if group_list|length == 1 %}
                                        {# Show user badge for single warnings #}
                                        {% if first_warning.metadata and first_warning.metadata.authenticated_user %}
                                            <span class="badge bg-secondary me-2">
                                                <i class="bi bi-person-fill"></i> {{ first_warning.metadata.authenticated_user.display_name }}
                                                {% if first_warning.metadata.authenticated_user.roles %}
                                                    ({{ first_warning.metadata.authenticated_user.roles|join(', ') }})
                                                {% endif %}
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary me-2">
                                                <i class="bi bi-person"></i>
                                                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">Guest</span>
                                                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Invité</span>
                                            </span>
                                        {% endif %}
                                    {% endif %}
                                    {% if show_error_codes %}<code class="me-2">{{ error_code }}</code>{% endif %}
                                    {% if group_list|length > 1 %}
                                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ first_warning.metadata.what_generic_en if first_warning.metadata and first_warning.metadata.what_generic_en else (first_warning.metadata.what_en if first_warning.metadata and first_warning.metadata.what_en else error_code) }}</span>
                                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ first_warning.metadata.what_generic_fr if first_warning.metadata and first_warning.metadata.what_generic_fr else (first_warning.metadata.what_fr if first_warning.metadata and first_warning.metadata.what_fr else error_code) }}</span>
                                    {% else %}
                                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ first_warning.metadata.title_en if first_warning.metadata and first_warning.metadata.title_en else (first_warning.metadata.what_en if first_warning.metadata and first_warning.metadata.what_en else first_warning.description_en if first_warning.description_en else first_warning.description) }}</span>
                                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ first_warning.metadata.title_fr if first_warning.metadata and first_warning.metadata.title_fr else (first_warning.metadata.what_fr if first_warning.metadata and first_warning.metadata.what_fr else first_warning.description_fr if first_warning.description_fr else first_warning.description) }}</span>
                                        {% if first_warning.xpath %}
                                        <span class="text-muted ms-2" style="font-size: 0.9em;"> • {{ first_warning.xpath }}</span>
                                        {% endif %}
                                    {% endif %}
                                </button>
                            </h2>
                            <div id="warn-group-{{ warn_counter.value }}"
                                 class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    {% if group_list|length > 1 %}
                                        {% set has_breakpoints = group_list[0].metadata and group_list[0].metadata.get('breakpoint') is not none %}

                                        {% if has_breakpoints %}
                                            {# Group by breakpoint for contrast violations #}
                                            {% set breakpoint_groups = group_list|groupby('metadata.breakpoint') %}
                                            <div class="accordion" id="warn-group-breakpoints-{{ warn_counter.value }}">
                                            {% for breakpoint, breakpoint_violations in breakpoint_groups %}
                                                {% set breakpoint_list = breakpoint_violations|list %}
                                                {% set breakpoint_id = warn_counter.value ~ '-bp-' ~ (breakpoint if breakpoint else 'none') %}
                                                <div class="accordion-item">
                                                    <h2 class="accordion-header">
                                                        <button class="accordion-button collapsed" type="button"
                                                                data-bs-toggle="collapse"
                                                                data-bs-target="#warn-breakpoint-{{ breakpoint_id }}">
                                                            <span class="badge bg-info me-2">{{ breakpoint_list|length }}</span>
                                                            <strong>
                                                                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">Breakpoint: {{ breakpoint }}px width</span>
                                                                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Point de rupture : {{ breakpoint }}px de largeur</span>
                                                            </strong>
                                                        </button>
                                                    </h2>
                                                    <div id="warn-breakpoint-{{ breakpoint_id }}"
                                                         class="accordion-collapse collapse"
                                                         data-bs-parent="#warn-group-breakpoints-{{ warn_counter.value }}">
                                                        <div class="accordion-body">
                                                            <div class="accordion" id="warn-breakpoint-instances-{{ breakpoint_id }}">
                                                            {% for warning in breakpoint_list %}
                                                            {% set instance_id = 'warn-instance-' ~ breakpoint_id ~ '-' ~ loop.index %}
                                                            {% set parent_id = 'warn-breakpoint-instances-' ~ breakpoint_id %}
                                                            {{ render_instance_accordion(warning, instance_id, parent_id, 'warning', loop.index) }}
                                                            {% endfor %}
                                                            </div> {# Close warn-breakpoint-instances #}
                                                        </div> {# Close accordion-body #}
                                                    </div> {# Close warn-breakpoint collapse #}
                                                </div> {# Close accordion-item #}
                                            {% endfor %} {# End breakpoint loop #}
                                            </div> {# Close warn-group-breakpoints #}
                                        {% else %}
                                            {# No breakpoints - use regular instance grouping #}
                                            <div class="accordion" id="warn-group-instances-{{ warn_counter.value }}">
                                            {% for warning in group_list %}
                                            {% set instance_id = 'warn-instance-' ~ warn_counter.value ~ '-' ~ loop.index %}
                                            {% set parent_id = 'warn-group-instances-' ~ warn_counter.value %}
                                            {{ render_instance_accordion(warning, instance_id, parent_id, 'warning', loop.index) }}
                                            {% endfor %}
                                            </div> {# Close warn-group-instances #}
                                        {% endif %}
                                    {% else %}
                                        {{ render_violation_details(group_list[0], 'warning') }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% endfor %}
            </div>
                </div>
            </div>
            {% endif %}

            <!-- Informational Items -->
            {% if informational %}
            <div class="section-panel info-section mb-4" style="border: 2px solid #0e7490; border-radius: 8px; overflow: hidden;">
                <div class="section-header" style="background: linear-gradient(135deg, #0e7490 0%, #0aa2c0 100%); color: white; padding: 12px 16px;">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['info'] }}</span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['info'] }}</span>
                        <span class="badge bg-light text-info ms-2">{{ informational|length }}</span>
                    </h5>
                    <small class="opacity-75">
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">Informational items for reference</span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Éléments informatifs pour référence</span>
                    </small>
                </div>
                <div class="section-body" style="padding: 16px; background: #e8f9fd;">
            <div class="accordion" id="informationalAccordion">
                {% set info_counter = namespace(value=0) %}
                {% for touchpoint, touchpoint_info in informational|groupby('touchpoint') %}
                    <div class="touchpoint-header mt-3 mb-2 ps-2" style="border-left: 4px solid #0e7490;">
                        <strong>
                            <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get(touchpoint|lower, touchpoint|replace('_', ' ')|title if touchpoint else 'General') }}</span>
                            <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get(touchpoint|lower, touchpoint|replace('_', ' ')|title if touchpoint else 'General') }}</span>
                        </strong>
                    </div>

                    {% for info_code, description_group in touchpoint_info|groupby('id') %}
                        {% set group_list = description_group|list %}
                        {% set info_counter.value = info_counter.value + 1 %}
                        {% set first_info = group_list[0] %}

                        <div class="accordion-item issue-item"
                             data-type="info"
                             data-touchpoint="{{ touchpoint|lower }}"
                             data-id="{{ info_code }}"
                             data-instance-count="{{ group_list|length }}"
                             data-description="{{ first_info.description_en|lower if first_info.description_en else first_info.description|lower }}">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#info-group-{{ info_counter.value }}">
                                    {% if group_list|length > 1 %}
                                    <span class="badge bg-info me-2">{{ group_list|length }}</span>
                                    {% endif %}
                                    <code class="me-2">{{ info_code }}</code>
                                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ first_info.description_en if first_info.description_en else first_info.description }}</span>
                                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ first_info.description_fr if first_info.description_fr else first_info.description }}</span>
                                </button>
                            </h2>
                            <div id="info-group-{{ info_counter.value }}"
                                 class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    {% if group_list|length > 1 %}
                                        <div class="accordion" id="info-group-instances-{{ info_counter.value }}">
                                        {% for info_item in group_list %}
                                        {% set instance_id = 'info-instance-' ~ info_counter.value ~ '-' ~ loop.index %}
                                        {% set parent_id = 'info-group-instances-' ~ info_counter.value %}
                                        {{ render_instance_accordion(info_item, instance_id, parent_id, 'info', loop.index) }}
                                        {% endfor %}
                                        </div>
                                    {% else %}
                                        {{ render_violation_details(group_list[0], 'info') }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% endfor %}
            </div>
                </div>
            </div>
            {% endif %}

            <!-- Discovery Items -->
            {% if discovery %}
            <div class="section-panel discovery-section mb-4" style="border: 2px solid #6f42c1; border-radius: 8px; overflow: hidden;">
                <div class="section-header" style="background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%); color: white; padding: 12px 16px;">
                    <h5 class="mb-0">
                        <i class="bi bi-binoculars-fill me-2"></i>
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en['discovery'] }}</span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr['discovery'] }}</span>
                        <span class="badge bg-light text-secondary ms-2">{{ discovery|length }}</span>
                    </h5>
                    <small class="opacity-75">
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">Items discovered for manual review</span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Éléments découverts à examiner manuellement</span>
                    </small>
                </div>
                <div class="section-body" style="padding: 16px; background: #f3eefa;">
            <div class="accordion" id="discoveryAccordion">
                {% set disc_counter = namespace(value=0) %}
                {% for touchpoint, touchpoint_discovery in discovery|groupby('touchpoint') %}
                    <div class="touchpoint-header mt-3 mb-2 ps-2" style="border-left: 4px solid #6f42c1;">
                        <strong>
                            <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get(touchpoint|lower, touchpoint|replace('_', ' ')|title if touchpoint else 'General') }}</span>
                            <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get(touchpoint|lower, touchpoint|replace('_', ' ')|title if touchpoint else 'General') }}</span>
                        </strong>
                    </div>

                    {% for disc_code, description_group in touchpoint_discovery|groupby('id') %}
                        {% set group_list = description_group|list %}
                        {% set disc_counter.value = disc_counter.value + 1 %}
                        {% set first_disc = group_list[0] %}

                        <div class="accordion-item issue-item"
                             data-type="discovery"
                             data-touchpoint="{{ touchpoint|lower }}"
                             data-id="{{ disc_code }}"
                             data-instance-count="{{ group_list|length }}"
                             data-description="{{ first_disc.description_en|lower if first_disc.description_en else first_disc.description|lower }}">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#disc-group-{{ disc_counter.value }}">
                                    {% if group_list|length > 1 %}
                                    <span class="badge bg-secondary me-2">{{ group_list|length }}</span>
                                    {% endif %}
                                    <code class="me-2">{{ disc_code }}</code>
                                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ first_disc.description_en if first_disc.description_en else first_disc.description }}</span>
                                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ first_disc.description_fr if first_disc.description_fr else first_disc.description }}</span>
                                </button>
                            </h2>
                            <div id="disc-group-{{ disc_counter.value }}"
                                 class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    {% if group_list|length > 1 %}
                                        <div class="accordion" id="disc-group-instances-{{ disc_counter.value }}">
                                        {% for disc_item in group_list %}
                                        {% set instance_id = 'disc-instance-' ~ disc_counter.value ~ '-' ~ loop.index %}
                                        {% set parent_id = 'disc-group-instances-' ~ disc_counter.value %}
                                        {{ render_instance_accordion(disc_item, instance_id, parent_id, 'discovery', loop.index) }}
                                        {% endfor %}
                                        </div>
                                    {% else %}
                                        {{ render_violation_details(group_list[0], 'discovery') }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% endfor %}
            </div>
                </div>
            </div>
            {% endif %}
            {% endif %} {# End of single-state / multi-state conditional #}

        </div>
    </div>
    {% else %}
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
            <h3 class="mt-3">
                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">No Issues Found</span>
                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Aucun problème détecté</span>
            </h3>
            <p class="text-muted">
                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">This page passed all automated accessibility tests.</span>
                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Cette page a réussi tous les tests d'accessibilité automatisés.</span>
            </p>
        </div>
    </div>
    {% endif %}

    <!-- Page Screenshot Thumbnail -->
    {% if page.screenshot_path %}
    <div class="card mt-4">
        <div class="card-body">
            <h6 class="mb-3">
                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">Page Thumbnail (at time of test)</span>
                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Vignette de la page (au moment du test)</span>
            </h6>
            <a href="../assets/images/screenshots/{{ page.screenshot_path.split('/')[-1] }}" target="_blank">
                <img src="../assets/images/screenshots/{{ page.screenshot_path.split('/')[-1] }}"
                     alt="Screenshot of {{ page.url }}"
                     class="img-thumbnail"
                     style="max-width: 300px; height: auto; cursor: pointer;"
                     onerror="this.parentElement.innerHTML='<span class=\'text-muted\'><span data-lang=\'en\' class=\'lang-active\'>Screenshot not available</span><span data-lang=\'fr\' class=\'lang-inactive\'>Capture d\'écran non disponible</span></span>'">
            </a>
        </div>
    </div>
    {% endif %}
</div>

</div>
</main>

<!-- Footer -->
<footer class="mt-auto bg-light border-top py-3">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-6">
                <p class="text-muted mb-0">
                    <strong>
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get('generated', 'Generated:') }}</span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get('generated', 'Généré :') }}</span>
                    </strong> {{ generation_date|default('N/A') }}
                </p>
                <p class="text-muted mb-0">
                    <strong>
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get('project', 'Project:') }}</span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get('project', 'Projet :') }}</span>
                    </strong> {{ project_name|default('Unknown') }}
                </p>
            </div>
            <div class="col-md-6 text-md-end">
                <p class="text-muted mb-0">
                    <strong>
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get('wcag_level', 'WCAG Level:') }}</span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get('wcag_level', 'Niveau WCAG :') }}</span>
                    </strong> {{ wcag_level|default('AA') }}
                </p>
                <p class="text-muted mb-0">
                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get('generated_by', 'Generated by') }}</span>
                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get('generated_by', 'Généré par') }}</span>
                    <strong>Auto A11y</strong>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- Inlined Bootstrap JavaScript -->
<script>
{{ bootstrap_js|safe }}
</script>

<!-- Inlined Filters JavaScript -->
<script>
{{ filters_js|safe }}
</script>

<!-- Page-specific JavaScript -->
<script>
// Copy XPath to clipboard
function copyXpathToClipboard(xpath, button) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(xpath).then(function() {
            const icon = button.querySelector('i');
            const originalClass = icon.className;
            icon.className = 'bi bi-check';
            button.classList.add('text-success');

            setTimeout(function() {
                icon.className = originalClass;
                button.classList.remove('text-success');
            }, 2000);
        }).catch(function(err) {
            alert('Could not copy to clipboard');
        });
    } else {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = xpath;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            alert('XPath copied to clipboard');
        } catch (err) {
            alert('Could not copy to clipboard');
        }
        document.body.removeChild(textArea);
    }
}

// Multi-state result switcher
function showState(stateIndex) {
    // Hide all state content sections
    document.querySelectorAll('.state-content').forEach(function(content) {
        content.classList.remove('active');
    });

    // Show selected state content
    const selectedContent = document.querySelector(`.state-content[data-state-index="${stateIndex}"]`);
    if (selectedContent) {
        selectedContent.classList.add('active');
    }

    // Update button states
    document.querySelectorAll('.state-selector').forEach(function(btn) {
        btn.classList.remove('active');
    });
    document.querySelector(`.state-selector[data-state-index="${stateIndex}"]`)?.classList.add('active');
}

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Embedded translations
const translations = {{ translations_json|safe }};
// Check localStorage for saved language preference, fallback to server language
let currentLanguage = localStorage.getItem('reportLanguage') || '{{ language }}';

// Language switching
function switchLanguage(lang) {
    currentLanguage = lang;

    // Save preference to localStorage
    localStorage.setItem('reportLanguage', lang);

    // Update active button
    document.querySelectorAll('.lang-switcher button').forEach(btn => {
        btn.classList.remove('active');
    });
    document.getElementById(`lang-${lang}`).classList.add('active');

    // Update HTML lang attribute
    document.documentElement.lang = lang;

    // Toggle visibility of language-specific content using classes
    document.querySelectorAll('[data-lang]').forEach(element => {
        const elementLang = element.getAttribute('data-lang');
        if (elementLang === lang) {
            element.classList.remove('lang-inactive');
            element.classList.add('lang-active');
        } else {
            element.classList.remove('lang-active');
            element.classList.add('lang-inactive');
        }
    });

    // Update translatable text elements
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (translations[lang] && translations[lang][key]) {
            // Only update text content for non-input elements
            if (element.tagName !== 'INPUT' && element.tagName !== 'TEXTAREA') {
                element.textContent = translations[lang][key];
            }
        }
    });

    // Update placeholder text for input elements
    document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
        const key = element.getAttribute('data-i18n-placeholder');
        if (translations[lang] && translations[lang][key]) {
            element.placeholder = translations[lang][key];
        }
    });

    // Update touchpoint filter options
    document.querySelectorAll('#touchpointFilter option[data-en][data-fr]').forEach(option => {
        const textEn = option.getAttribute('data-en');
        const textFr = option.getAttribute('data-fr');
        option.textContent = lang === 'fr' ? textFr : textEn;
    });
}

// Apply saved language on page load
if (currentLanguage !== '{{ language }}') {
    switchLanguage(currentLanguage);
}
</script>

</body>
</html>
