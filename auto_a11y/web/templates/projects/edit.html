{% extends "base.html" %}

{% block title %}{{ _('Edit') }} {{ project.name }} - {{ _('Auto A11y') }}{% endblock %}

{% block extra_css %}
<style>
    .test-help-btn {
        font-size: 0.85rem;
        padding: 0.1rem 0.4rem;
        margin-left: 0.5rem;
        opacity: 0.7;
        transition: opacity 0.2s;
    }

    .test-help-btn:hover {
        opacity: 1;
    }

    .test-details-modal .modal-header {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
    }

    .test-details-section {
        margin-bottom: 1.5rem;
    }

    .test-details-section h6 {
        color: #495057;
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }

    .test-details-section p {
        margin-bottom: 0;
        line-height: 1.6;
    }

    .impact-badge {
        font-size: 0.85rem;
        padding: 0.3rem 0.6rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-8 col-lg-6 mx-auto">
            <h1 class="h2 mb-4">{{ _('Edit Project') }}</h1>
            
            <div class="card">
                <div class="card-body">
                    <form method="POST" action="{{ url_for('projects.edit_project', project_id=project.id) }}">
                        <div class="mb-3">
                            <label for="name" class="form-label">{{ _('Project Name') }} *</label>
                            <input type="text" class="form-control" id="name" name="name"
                                   value="{{ project.name }}" required maxlength="100">
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">{{ _('Description') }}</label>
                            <textarea class="form-control" id="description" name="description"
                                      rows="3" maxlength="500">{{ project.description or '' }}</textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="status" class="form-label">{{ _('Status') }}</label>
                            <select class="form-select" id="status" name="status">
                                <option value="active" {% if project.status.value == 'active' %}selected{% endif %}>{{ _('Active') }}</option>
                                <option value="paused" {% if project.status.value == 'paused' %}selected{% endif %}>{{ _('Paused') }}</option>
                                <option value="completed" {% if project.status.value == 'completed' %}selected{% endif %}>{{ _('Completed') }}</option>
                                <option value="archived" {% if project.status.value == 'archived' %}selected{% endif %}>{{ _('Archived') }}</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="drupal_audit_name" class="form-label">{{ _('Drupal Audit (Optional)') }}</label>
                            <select class="form-select" id="drupal_audit_name" name="drupal_audit_name">
                                <option value="">{{ _('Auto-match by project name') }}</option>
                                <option value="" disabled>{{ _('Loading audits...') }}</option>
                            </select>
                            <div class="form-text">
                                {{ _('Select the corresponding audit in Drupal for synchronization. Leave as "Auto-match" to use the project name.') }}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="wcag_level" class="form-label">{{ _('WCAG Compliance Level') }}</label>
                            <select class="form-select" id="wcag_level" name="wcag_level">
                                <option value="AA" {% if project.config.get('wcag_level', 'AA') == 'AA' %}selected{% endif %}>{{ _('Level AA (Recommended)') }}</option>
                                <option value="AAA" {% if project.config.get('wcag_level', 'AA') == 'AAA' %}selected{% endif %}>{{ _('Level AAA (Enhanced)') }}</option>
                            </select>
                            <div class="form-text">
                                <strong>{{ _('Level AA:') }}</strong> {{ _('Standard compliance (4.5:1 contrast for normal text, 3:1 for large text)') }}<br>
                                <strong>{{ _('Level AAA:') }}</strong> {{ _('Enhanced compliance (7:1 contrast for normal text, 4.5:1 for large text)') }}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="page_load_strategy" class="form-label">{{ _('Page Load Strategy') }}</label>
                            <select class="form-select" id="page_load_strategy" name="page_load_strategy">
                                <option value="networkidle2" {% if project.config.get('page_load_strategy', 'networkidle2') == 'networkidle2' %}selected{% endif %}>{{ _('Network Idle 2 (Default - Best for most sites)') }}</option>
                                <option value="networkidle0" {% if project.config.get('page_load_strategy', 'networkidle2') == 'networkidle0' %}selected{% endif %}>{{ _('Network Idle 0 (Very thorough, slowest)') }}</option>
                                <option value="domcontentloaded" {% if project.config.get('page_load_strategy', 'networkidle2') == 'domcontentloaded' %}selected{% endif %}>{{ _('DOM Content Loaded (Fast, for sites with heavy background activity)') }}</option>
                                <option value="load" {% if project.config.get('page_load_strategy', 'networkidle2') == 'load' %}selected{% endif %}>{{ _('Load Event (Middle ground)') }}</option>
                            </select>
                            <div class="form-text">
                                {{ _('Controls when testing begins after navigating to a page:') }}<br>
                                • <strong>{{ _('Network Idle 2') }}</strong>: {{ _('Wait until network has ≤2 connections (best for dynamic sites)') }}<br>
                                • <strong>{{ _('Network Idle 0') }}</strong>: {{ _('Wait until network is completely idle (very thorough but slow)') }}<br>
                                • <strong>{{ _('DOM Content Loaded') }}</strong>: {{ _('Test as soon as DOM is ready (use for BBC News, sites with continuous ads/analytics)') }}<br>
                                • <strong>{{ _('Load Event') }}</strong>: {{ _('Wait for load event (faster than network idle)') }}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="headless_browser" class="form-label">{{ _('Browser Display Mode') }}</label>
                            <select class="form-select" id="headless_browser" name="headless_browser">
                                <option value="true" {% if project.config.get('headless_browser', 'true') == 'true' %}selected{% endif %}>{{ _('Headless (No visible browser)') }}</option>
                                <option value="false" {% if project.config.get('headless_browser', 'true') == 'false' %}selected{% endif %}>{{ _('Visible Browser (Show Chrome window)') }}</option>
                            </select>
                            <div class="form-text">
                                • <strong>{{ _('Headless') }}</strong>: {{ _('Run browser invisibly (faster, less resource intensive)') }}<br>
                                • <strong>{{ _('Visible Browser') }}</strong>: {{ _('Show the Chrome window (useful for debugging)') }}
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="stealth_mode" name="stealth_mode" value="true"
                                       {% if project.config.get('stealth_mode', False) %}checked{% endif %}>
                                <label class="form-check-label" for="stealth_mode">
                                    {{ _('Enable Stealth Mode (for Cloudflare-protected sites)') }}
                                </label>
                            </div>
                            <div class="form-text">
                                {{ _('Enables advanced bot detection bypass techniques. Use for sites protected by Cloudflare or similar services.') }}
                                <strong>{{ _('Note:') }}</strong> {{ _('Stealth mode significantly slows down page discovery and testing (~5-15 seconds per page).') }}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="title_length_limit" class="form-label">{{ _('Page Title Length Limit') }}</label>
                            <input type="number" class="form-control" id="title_length_limit" name="title_length_limit"
                                   value="{{ project.config.get('titleLengthLimit', 60) }}" min="30" max="120">
                            <div class="form-text">
                                {{ _('Maximum recommended characters for page titles. Default is 60. Titles longer than this will generate a warning.') }}
                                {{ _('Browser tabs typically show ~30 characters, search results show ~50-60 characters.') }}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="heading_length_limit" class="form-label">{{ _('Heading Length Limit') }}</label>
                            <input type="number" class="form-control" id="heading_length_limit" name="heading_length_limit"
                                   value="{{ project.config.get('headingLengthLimit', 60) }}" min="30" max="120">
                            <div class="form-text">
                                {{ _('Maximum recommended characters for headings (h1-h6). Default is 60. Headings longer than this will generate a warning.') }}
                                {{ _('Headings approaching this limit (above 67% of the limit) will generate an info message.') }}
                            </div>
                        </div>

                        <!-- Font Accessibility Configuration -->
                        <div class="mb-3">
                            <label class="form-label">{{ _('Inaccessible Fonts Configuration') }}</label>
                            <div class="form-text mb-2">
                                {{ _('Configure which fonts should be flagged as inaccessible for this project.') }}
                                {{ _('The system includes a research-backed default list of 50+ problematic fonts.') }}
                            </div>

                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="use_default_fonts" name="use_default_fonts"
                                       {% if project.config.get('font_accessibility', {}).get('use_defaults', True) %}checked{% endif %}>
                                <label class="form-check-label" for="use_default_fonts">
                                    {{ _('Use system default inaccessible fonts list') }}
                                </label>
                            </div>
                            <div class="form-text mb-3">
                                {{ _('Includes script/cursive fonts (Comic Sans, Papyrus), decorative fonts (Curlz, Jokerman), narrow fonts (Arial Narrow, Impact), and blackletter fonts (Old English).') }}
                            </div>

                            <div class="mb-3">
                                <label for="additional_inaccessible_fonts" class="form-label">{{ _('Additional Fonts to Flag') }}</label>
                                <textarea class="form-control font-monospace" id="additional_inaccessible_fonts" name="additional_inaccessible_fonts"
                                          rows="3" placeholder="{{ _('Enter font names, one per line (e.g., \'Custom Font Name\')') }}">{% if project.config.get('font_accessibility', {}).get('additional_inaccessible_fonts') %}{{ project.config.get('font_accessibility', {}).get('additional_inaccessible_fonts', [])|join('\n') }}{% endif %}</textarea>
                                <div class="form-text">
                                    {{ _('Add project-specific fonts that should be flagged as inaccessible. One font name per line, lowercase.') }}
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="excluded_fonts" class="form-label">{{ _('Fonts to Exclude from Checking') }}</label>
                                <textarea class="form-control font-monospace" id="excluded_fonts" name="excluded_fonts"
                                          rows="3" placeholder="{{ _('Enter font names, one per line (e.g., \'comic sans ms\')') }}">{% if project.config.get('font_accessibility', {}).get('excluded_fonts') %}{{ project.config.get('font_accessibility', {}).get('excluded_fonts', [])|join('\n') }}{% endif %}</textarea>
                                <div class="form-text">
                                    {{ _('Remove specific fonts from the default list if your project requires them. One font name per line, lowercase.') }}
                                </div>
                            </div>

                            <div class="accordion mb-3" id="fontDefaultsAccordion">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                                data-bs-target="#fontDefaultsList" aria-expanded="false">
                                            {{ _('View System Default Inaccessible Fonts List') }}
                                        </button>
                                    </h2>
                                    <div id="fontDefaultsList" class="accordion-collapse collapse" data-bs-parent="#fontDefaultsAccordion">
                                        <div class="accordion-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <h6>{{ _('Script/Cursive Fonts (17 fonts)') }}</h6>
                                                    <ul class="small mb-3" style="list-style-type: none; padding-left: 0;">
                                                        <li>• Brush Script, Brush Script MT, Brushscript</li>
                                                        <li>• Lucida Handwriting, Lucida Calligraphy</li>
                                                        <li>• Comic Sans, Comic Sans MS</li>
                                                        <li>• Bradley Hand, Bradley Hand ITC</li>
                                                        <li>• Freestyle Script, French Script</li>
                                                        <li>• Edwardian Script, Mistral</li>
                                                        <li>
                                                            <details class="mt-1">
                                                                <summary style="cursor: pointer; color: #0d6efd;">{{ _('Show all 17 fonts...') }}</summary>
                                                                <ul class="small mt-2" style="list-style-type: none; padding-left: 1em;">
                                                                    <li>• Script MT Bold</li>
                                                                    <li>• Vivaldi</li>
                                                                    <li>• Vladimir Script</li>
                                                                    <li>• Lobster</li>
                                                                </ul>
                                                            </details>
                                                        </li>
                                                    </ul>

                                                    <h6>{{ _('Decorative Fonts (16 fonts)') }}</h6>
                                                    <ul class="small mb-3" style="list-style-type: none; padding-left: 0;">
                                                        <li>• Curlz, Curlz MT</li>
                                                        <li>• Jokerman, Papyrus</li>
                                                        <li>• Chiller, Stencil, Ravie</li>
                                                        <li>• Magneto, Algerian</li>
                                                        <li>
                                                            <details class="mt-1">
                                                                <summary style="cursor: pointer; color: #0d6efd;">{{ _('Show all 16 fonts...') }}</summary>
                                                                <ul class="small mt-2" style="list-style-type: none; padding-left: 1em;">
                                                                    <li>• Showcard Gothic</li>
                                                                    <li>• Broadway</li>
                                                                    <li>• Bauhaus 93</li>
                                                                    <li>• Harrington</li>
                                                                    <li>• Snap ITC</li>
                                                                    <li>• Gigi</li>
                                                                    <li>• Juice ITC</li>
                                                                </ul>
                                                            </details>
                                                        </li>
                                                    </ul>
                                                </div>
                                                <div class="col-md-6">
                                                    <h6>{{ _('Narrow/Condensed Fonts (2 fonts)') }}</h6>
                                                    <ul class="small mb-3" style="list-style-type: none; padding-left: 0;">
                                                        <li>• Arial Narrow</li>
                                                        <li>• Impact</li>
                                                    </ul>

                                                    <h6>{{ _('Blackletter/Gothic Fonts (5 fonts)') }}</h6>
                                                    <ul class="small mb-3" style="list-style-type: none; padding-left: 0;">
                                                        <li>• Old English, Old English Text MT</li>
                                                        <li>• Blackletter</li>
                                                        <li>• Fraktur</li>
                                                        <li>• Blackadder ITC</li>
                                                    </ul>

                                                    <div class="alert alert-info small mb-0">
                                                        <strong>{{ _('Total:') }}</strong> {{ _('40 fonts across 4 categories') }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="alert alert-warning small mt-3 mb-0">
                                                <strong>{{ _('Note:') }}</strong> {{ _('This list is based on accessibility research from dyslexichelp.org, section508.gov, and webaim.org. These fonts are difficult to read for users with dyslexia, low vision, or reading disabilities.') }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Touchpoint Testing Configuration -->
                        <div class="mb-3">
                            <label class="form-label">{{ _('Touchpoint Tests Configuration') }}</label>
                            <div class="form-text mb-2">
                                {{ _('Configure which accessibility tests to run. Tests are organized by touchpoint (testing category).') }}
                            </div>

                            <!-- Global Controls -->
                            <div class="btn-group mb-3" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllTests(true)">{{ _('Enable All') }}</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectAllTests(false)">{{ _('Disable All') }}</button>
                                <button type="button" class="btn btn-sm btn-outline-info" onclick="applyPreset('minimal')">{{ _('Minimal') }}</button>
                                <button type="button" class="btn btn-sm btn-outline-info" onclick="applyPreset('wcag-aa')">{{ _('WCAG AA') }}</button>
                            </div>
                            
                            <!-- Touchpoint Tree -->
                            <div class="touchpoint-tree border rounded p-3" style="max-height: 400px; overflow-y: auto;">
                                {% for touchpoint_id, test_ids in touchpoint_test_mapping.items()|sort %}
                                {% set touchpoint_name = touchpoint_names.get(touchpoint_id, touchpoint_id|title) %}
                                <div class="touchpoint-item mb-2">
                                    <div class="d-flex align-items-center">
                                        <!-- Expand/Collapse button -->
                                        <button class="btn btn-sm btn-link p-0 me-2" type="button" 
                                                data-bs-toggle="collapse" data-bs-target="#tests_{{ touchpoint_id }}"
                                                aria-expanded="false" aria-controls="tests_{{ touchpoint_id }}">
                                            <i class="bi bi-chevron-right" id="chevron_{{ touchpoint_id }}"></i>
                                        </button>
                                        
                                        <!-- Touchpoint checkbox -->
                                        <div class="form-check">
                                            <input class="form-check-input touchpoint-checkbox" type="checkbox" 
                                                   id="touchpoint_{{ touchpoint_id }}" name="touchpoint_{{ touchpoint_id }}"
                                                   {% if project.config.get('touchpoints', {}).get(touchpoint_id, {}).get('enabled', True) %}checked{% endif %}
                                                   onchange="toggleTouchpoint('{{ touchpoint_id }}')">
                                            <label class="form-check-label fw-bold" for="touchpoint_{{ touchpoint_id }}">
                                                <i class="bi bi-folder2 me-1"></i>{{ touchpoint_name }}
                                                <span class="badge bg-secondary ms-2">{{ test_ids|length }}</span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- Individual tests under this touchpoint (collapsible) -->
                                    <div class="collapse ms-5 mt-1" id="tests_{{ touchpoint_id }}">
                                        {% for test_id in test_ids %}
                                        <div class="form-check">
                                            <input class="form-check-input test-checkbox" type="checkbox"
                                                   id="test_{{ touchpoint_id }}_{{ test_id }}"
                                                   name="test_{{ touchpoint_id }}_{{ test_id }}"
                                                   data-touchpoint="{{ touchpoint_id }}"
                                                   {% if project.config.get('touchpoints', {}).get(touchpoint_id, {}).get('tests', {}).get(test_id, True) %}checked{% endif %}>
                                            <label class="form-check-label small" for="test_{{ touchpoint_id }}_{{ test_id }}">
                                                <i class="bi bi-file-earmark-code me-1"></i>
                                                <code>{{ test_id }}</code>
                                                <button type="button" class="btn btn-sm btn-outline-info test-help-btn"
                                                        onclick="showTestDetails('{{ test_id }}')"
                                                        title="View test details">
                                                    <i class="bi bi-question-circle"></i>
                                                </button>
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- AI Testing Configuration -->
                        <div class="mb-3">
                            <label class="form-label">{{ _('AI-Assisted Testing') }}</label>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enable_ai_testing" name="enable_ai_testing"
                                       {% if project.config.get('enable_ai_testing', False) %}checked{% endif %} onchange="toggleAITests()">
                                <label class="form-check-label" for="enable_ai_testing">
                                    {{ _('Enable AI-assisted accessibility testing') }}
                                </label>
                            </div>
                            <div class="form-text mb-3">
                                {{ _('AI testing uses Claude to analyze screenshots and HTML for issues that automated tests might miss.') }}
                                <strong>{{ _('Note:') }}</strong> {{ _('AI testing incurs API costs based on usage.') }}
                            </div>
                            
                            <div id="ai_tests_selection" style="display: {% if project.config.get('enable_ai_testing', False) %}block{% else %}none{% endif %};">
                                <label class="form-label">{{ _('Select AI Tests to Run:') }}</label>
                                <div class="ms-3">
                                    <div class="form-check">
                                        <input class="form-check-input ai-test-checkbox" type="checkbox" id="ai_test_headings"
                                               name="ai_test_headings" value="headings"
                                               {% if 'headings' in project.config.get('ai_tests', []) %}checked{% endif %}>
                                        <label class="form-check-label" for="ai_test_headings">
                                            <strong>{{ _('Heading Analysis') }}</strong> - {{ _('Detects visual headings not properly marked up') }}
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input ai-test-checkbox" type="checkbox" id="ai_test_reading_order"
                                               name="ai_test_reading_order" value="reading_order"
                                               {% if 'reading_order' in project.config.get('ai_tests', []) %}checked{% endif %}>
                                        <label class="form-check-label" for="ai_test_reading_order">
                                            <strong>{{ _('Reading Order') }}</strong> - {{ _('Verifies logical reading sequence matches visual layout') }}
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input ai-test-checkbox" type="checkbox" id="ai_test_modals"
                                               name="ai_test_modals" value="modals"
                                               {% if 'modals' in project.config.get('ai_tests', []) %}checked{% endif %}>
                                        <label class="form-check-label" for="ai_test_modals">
                                            <strong>{{ _('Modal Dialogs') }}</strong> - {{ _('Analyzes popup and overlay accessibility') }}
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input ai-test-checkbox" type="checkbox" id="ai_test_language"
                                               name="ai_test_language" value="language"
                                               {% if 'language' in project.config.get('ai_tests', []) %}checked{% endif %}>
                                        <label class="form-check-label" for="ai_test_language">
                                            <strong>{{ _('Language Detection') }}</strong> - {{ _('Identifies mixed languages and missing declarations') }}
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input ai-test-checkbox" type="checkbox" id="ai_test_animations"
                                               name="ai_test_animations" value="animations"
                                               {% if 'animations' in project.config.get('ai_tests', []) %}checked{% endif %}>
                                        <label class="form-check-label" for="ai_test_animations">
                                            <strong>{{ _('Animations') }}</strong> - {{ _('Detects potentially problematic motion') }}
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input ai-test-checkbox" type="checkbox" id="ai_test_interactive"
                                               name="ai_test_interactive" value="interactive"
                                               {% if 'interactive' in project.config.get('ai_tests', []) %}checked{% endif %}>
                                        <label class="form-check-label" for="ai_test_interactive">
                                            <strong>{{ _('Interactive Elements') }}</strong> - {{ _('Analyzes buttons, links, and form controls') }}
                                        </label>
                                    </div>
                                </div>
                                <div class="form-text mt-2">
                                    <a href="#" onclick="selectAllAITests(event)">{{ _('Select All') }}</a> |
                                    <a href="#" onclick="deselectAllAITests(event)">{{ _('Deselect All') }}</a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> {{ _('Update Project') }}
                            </button>
                            <a href="{{ url_for('projects.view_project', project_id=project.id) }}"
                               class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> {{ _('Cancel') }}
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Test Details Modal -->
<div class="modal fade test-details-modal" id="testDetailsModal" tabindex="-1" aria-labelledby="testDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="testDetailsModalLabel">
                    <i class="bi bi-info-circle me-2"></i>
                    <span id="testDetailsTitle">{{ _('Test Details') }}</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
            </div>
            <div class="modal-body" id="testDetailsBody">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{{ _('Loading...') }}</span>
                    </div>
                    <p class="mt-2 text-muted">{{ _('Loading test details...') }}</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Close') }}</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function toggleAITests() {
    const enabled = document.getElementById('enable_ai_testing').checked;
    const selection = document.getElementById('ai_tests_selection');
    selection.style.display = enabled ? 'block' : 'none';
    
    // If disabling, uncheck all tests
    if (!enabled) {
        document.querySelectorAll('.ai-test-checkbox').forEach(cb => {
            cb.checked = false;
        });
    }
}

function selectAllAITests(event) {
    event.preventDefault();
    document.querySelectorAll('.ai-test-checkbox').forEach(cb => {
        cb.checked = true;
    });
}

function deselectAllAITests(event) {
    event.preventDefault();
    document.querySelectorAll('.ai-test-checkbox').forEach(cb => {
        cb.checked = false;
    });
}

// Touchpoint test functions
function selectAllTests(enable) {
    // Enable/disable all touchpoints
    document.querySelectorAll('.touchpoint-checkbox').forEach(cb => {
        cb.checked = enable;
    });
    // Enable/disable all individual tests
    document.querySelectorAll('.test-checkbox').forEach(cb => {
        cb.checked = enable;
    });
}

function toggleTouchpoint(touchpointId) {
    const touchpointCheckbox = document.getElementById('touchpoint_' + touchpointId);
    const enabled = touchpointCheckbox.checked;
    
    // Enable/disable all tests under this touchpoint
    document.querySelectorAll(`#tests_${touchpointId} .test-checkbox`).forEach(cb => {
        cb.checked = enabled;
    });
}

function applyPreset(presetName) {
    // First disable all
    document.querySelectorAll('.touchpoint-checkbox').forEach(cb => {
        cb.checked = false;
    });
    
    // Then enable based on preset
    if (presetName === 'minimal') {
        // Enable only critical touchpoints
        const critical = ['headings', 'images', 'forms', 'keyboard_navigation', 'colors_contrast', 'semantic_structure'];
        critical.forEach(id => {
            const cb = document.getElementById('touchpoint_' + id);
            if (cb) cb.checked = true;
        });
    } else if (presetName === 'wcag-aa') {
        // Enable WCAG AA relevant touchpoints
        const wcagAA = [
            'headings', 'images', 'forms', 'buttons', 'links',
            'keyboard_navigation', 'colors_contrast', 'landmarks',
            'language', 'semantic_structure', 'tables', 'media'
        ];
        wcagAA.forEach(id => {
            const cb = document.getElementById('touchpoint_' + id);
            if (cb) cb.checked = true;
        });
    }
}

// Handle collapse/expand events for chevron rotation and load Drupal audits
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(button => {
        const targetId = button.getAttribute('data-bs-target');
        const target = document.querySelector(targetId);
        const chevron = button.querySelector('i');

        if (target) {
            target.addEventListener('show.bs.collapse', function() {
                chevron.classList.remove('bi-chevron-right');
                chevron.classList.add('bi-chevron-down');
            });

            target.addEventListener('hide.bs.collapse', function() {
                chevron.classList.remove('bi-chevron-down');
                chevron.classList.add('bi-chevron-right');
            });
        }
    });
    
    // Update touchpoint checkboxes based on individual test states
    document.querySelectorAll('.test-checkbox').forEach(cb => {
        cb.addEventListener('change', function() {
            const touchpointId = this.getAttribute('data-touchpoint');
            updateTouchpointCheckbox(touchpointId);
        });
    });

    // Load Drupal audits for the dropdown
    loadDrupalAudits();
});

function updateTouchpointCheckbox(touchpointId) {
    const allTests = document.querySelectorAll(`#tests_${touchpointId} .test-checkbox`);
    const checkedTests = document.querySelectorAll(`#tests_${touchpointId} .test-checkbox:checked`);
    const touchpointCheckbox = document.getElementById('touchpoint_' + touchpointId);
    
    if (checkedTests.length === 0) {
        touchpointCheckbox.checked = false;
        touchpointCheckbox.indeterminate = false;
    } else if (checkedTests.length === allTests.length) {
        touchpointCheckbox.checked = true;
        touchpointCheckbox.indeterminate = false;
    } else {
        touchpointCheckbox.checked = true;
        touchpointCheckbox.indeterminate = true;
    }
}

// Show test details in modal
function showTestDetails(testId) {
    const modal = new bootstrap.Modal(document.getElementById('testDetailsModal'));
    const titleEl = document.getElementById('testDetailsTitle');
    const bodyEl = document.getElementById('testDetailsBody');

    // Set title
    titleEl.textContent = testId;

    // Show loading state
    bodyEl.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">{{ _('Loading...') }}</span>
            </div>
            <p class="mt-2 text-muted">{{ _('Loading test details...') }}</p>
        </div>
    `;

    // Show modal
    modal.show();

    // Fetch test details
    fetch(`/projects/api/test-details/${testId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const test = data.test;

                // Build impact badge
                let impactClass = 'secondary';
                if (test.impact === 'High' || test.impact === 'Critical') impactClass = 'danger';
                else if (test.impact === 'Medium') impactClass = 'warning';
                else if (test.impact === 'Low') impactClass = 'info';

                // Build WCAG badges
                let wcagBadges = '';
                if (test.wcag && test.wcag.length > 0) {
                    wcagBadges = test.wcag.map(w => `<span class="badge bg-primary me-1">${w}</span>`).join('');
                }

                // Build modal content
                bodyEl.innerHTML = `
                    <div class="mb-3">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-${impactClass} impact-badge me-2">${test.impact} Impact</span>
                            <span class="badge bg-secondary me-2">${test.type}</span>
                            ${wcagBadges}
                        </div>
                        ${test.wcag_full ? `<small class="text-muted">${test.wcag_full}</small>` : ''}
                    </div>

                    <div class="test-details-section">
                        <h6><i class="bi bi-info-circle me-2"></i>What This Test Detects</h6>
                        <p>${test.description}</p>
                    </div>

                    ${test.why_it_matters ? `
                    <div class="test-details-section">
                        <h6><i class="bi bi-exclamation-triangle me-2"></i>Why It Matters</h6>
                        <p>${test.why_it_matters}</p>
                    </div>
                    ` : ''}

                    ${test.who_it_affects ? `
                    <div class="test-details-section">
                        <h6><i class="bi bi-people me-2"></i>Who It Affects</h6>
                        <p>${test.who_it_affects}</p>
                    </div>
                    ` : ''}

                    ${test.how_to_fix ? `
                    <div class="test-details-section">
                        <h6><i class="bi bi-wrench me-2"></i>How to Fix</h6>
                        <p>${test.how_to_fix}</p>
                    </div>
                    ` : ''}
                `;
            } else {
                bodyEl.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>{{ _('Test Information Not Available') }}</strong>
                        <p class="mb-0 mt-2">{{ _('Details for test') }} <code>${testId}</code> {{ _('are not available in the catalog.') }}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error fetching test details:', error);
            bodyEl.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle me-2"></i>
                    <strong>{{ _('Error Loading Test Details') }}</strong>
                    <p class="mb-0 mt-2">{{ _('An error occurred while loading the test details. Please try again.') }}</p>
                </div>
            `;
        });
}

// Load Drupal audits for the dropdown
async function loadDrupalAudits() {
    const select = document.getElementById('drupal_audit_name');
    if (!select) {
        console.log('Drupal audit select not found');
        return;
    }

    const currentValue = '{{ project.drupal_audit_name or "" }}';
    console.log('Loading Drupal audits... Current value:', currentValue);

    try {
        const response = await fetch('/drupal/audits/list');
        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Received audits:', data);

        if (data.success && data.audits && data.audits.length > 0) {
            // Clear loading option
            select.innerHTML = '<option value="">Auto-match by project name</option>';

            // Add audit options
            data.audits.forEach(audit => {
                const option = document.createElement('option');
                option.value = audit.title;
                option.textContent = audit.title;
                if (audit.title === currentValue) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        } else if (!data.success && data.error) {
            // Show error but keep the auto-match option
            select.innerHTML = '<option value="">Auto-match by project name</option>';
            const option = document.createElement('option');
            option.disabled = true;
            option.textContent = `Error: ${data.error}`;
            select.appendChild(option);
        } else {
            // No audits available
            select.innerHTML = '<option value="">Auto-match by project name</option>';
            const option = document.createElement('option');
            option.disabled = true;
            option.textContent = 'No Drupal audits found';
            select.appendChild(option);
        }
    } catch (error) {
        console.error('Error loading Drupal audits:', error);
        // Keep the auto-match option on error
        select.innerHTML = '<option value="">{{ _('Auto-match by project name') }}</option>';
        const option = document.createElement('option');
        option.disabled = true;
        option.textContent = '{{ _('Could not load audits (Drupal may not be configured)') }}';
        select.appendChild(option);
    }
}
</script>
{% endblock %}