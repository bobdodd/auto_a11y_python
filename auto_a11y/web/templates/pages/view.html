{% extends "base.html" %}

{% block title %}{{ page.title or page.url }} - Auto A11y{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/help-system.css') }}">
<style>
    .impact-badge {
        min-width: 75px;
        display: inline-block;
        text-align: center;
    }
    
    /* Move accordion indicators to the left for accessibility */
    .accordion-button {
        padding-left: 2.5rem;
        padding-right: 1.25rem;
    }
    
    .accordion-button::after {
        position: absolute;
        left: 1rem;
        right: auto;
        transform: rotate(-90deg);
        transition: transform 0.2s ease-in-out;
    }
    
    .accordion-button:not(.collapsed)::after {
        transform: rotate(0deg);
    }
    
    /* Ensure proper spacing for content */
    .accordion-button > * {
        margin-left: 0.5rem;
    }
    
    .accordion-button > *:first-child {
        margin-left: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{{ url_for('projects.view_project', project_id=project.id) }}">{{ project.name }}</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{{ url_for('websites.view_website', website_id=website.id) }}">{{ website.display_name }}</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">{{ page.title or 'Page' }}</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2">{{ page.title or 'Untitled Page' }}</h1>
            <p class="text-muted">
                <a href="{{ page.url }}" target="_blank">
                    {{ page.url }} <i class="bi bi-box-arrow-up-right"></i>
                </a>
            </p>
        </div>
        <div>
            <button class="btn btn-primary" onclick="testPage('{{ page.id }}')">
                <i class="bi bi-play"></i> Run Test
            </button>
            <a href="{{ url_for('pages.edit_page', page_id=page.id) }}" class="btn btn-outline-primary">
                <i class="bi bi-pencil"></i> Edit
            </a>
        </div>
    </div>

    <!-- Test Progress Alert (shown during testing) -->
    <div id="test-progress-alert" class="alert alert-info d-none" role="alert">
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            <div>
                <strong>Test in Progress</strong> - The page will automatically refresh when testing completes.
            </div>
        </div>
    </div>
    
    <!-- Page Status -->
    <div class="row mb-4 g-3">
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Status</h6>
                    <p class="mb-0" id="page-status-container">
                        {% if page.status.value == 'discovered' %}
                            <span class="badge bg-secondary">Discovered</span>
                        {% elif page.status.value == 'queued' %}
                            <span class="badge bg-warning">
                                <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                Queued
                            </span>
                        {% elif page.status.value == 'testing' %}
                            <span class="badge bg-info">
                                <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                Testing
                            </span>
                        {% elif page.status.value == 'tested' %}
                            <span class="badge bg-success">Tested</span>
                        {% elif page.status.value == 'error' %}
                            <span class="badge bg-danger">Error</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ page.status.value|title }}</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Priority</h6>
                    <p class="mb-0">
                        {% if page.priority == 'critical' %}
                            <span class="badge bg-danger">Critical</span>
                        {% elif page.priority == 'high' %}
                            <span class="badge bg-warning">High</span>
                        {% elif page.priority == 'normal' %}
                            <span class="badge bg-info">Normal</span>
                        {% elif page.priority == 'low' %}
                            <span class="badge bg-secondary">Low</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ page.priority|title }}</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Last Tested</h6>
                    <p class="mb-0">
                        {{ page.last_tested.strftime('%Y-%m-%d %H:%M') if page.last_tested else 'Never' }}
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Test Duration</h6>
                    <p class="mb-0">
                        {% if page.test_duration_ms %}
                            {{ "%.2f"|format(page.test_duration_ms / 1000) }}s
                        {% else %}
                            N/A
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Accessibility Score (if available) -->
    {% if page.status.value == 'tested' and latest_result and latest_result.metadata %}
    {% set score_data = latest_result.metadata %}
    {% if score_data.applicable_checks and score_data.applicable_checks > 0 %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Accessibility Score <button class="help-icon" data-help="scoring.accessibility_score" aria-label="Get help about accessibility score">?</button></h5>
        </div>
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-3 text-center">
                    <div class="display-4 fw-bold 
                        {% if score_data.passed_checks / score_data.applicable_checks >= 0.9 %}text-success
                        {% elif score_data.passed_checks / score_data.applicable_checks >= 0.7 %}text-warning
                        {% else %}text-danger{% endif %}">
                        {{ ((score_data.passed_checks / score_data.applicable_checks) * 100)|round(1) }}%
                    </div>
                    <p class="text-muted">Accessibility Score <button class="help-icon" data-help="scoring.score_difference" aria-label="Understanding score differences">?</button></p>
                </div>
                <div class="col-md-9">
                    <div class="row g-3">
                        <div class="col-6 col-lg-3">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                <div>
                                    <div class="fw-bold">{{ score_data.passed_checks|default(0) }}</div>
                                    <small class="text-muted">Checks Passed</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-lg-3">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-x-circle text-danger me-2"></i>
                                <div>
                                    <div class="fw-bold">{{ score_data.failed_checks|default(0) }}</div>
                                    <small class="text-muted">Checks Failed</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-lg-3">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-dash-circle text-secondary me-2"></i>
                                <div>
                                    <div class="fw-bold">{{ score_data.not_applicable_tests|length|default(0) }}</div>
                                    <small class="text-muted">Not Applicable</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-lg-3">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-clipboard-check text-info me-2"></i>
                                <div>
                                    <div class="fw-bold">{{ score_data.passed_checks|default(0) + score_data.failed_checks|default(0) }}</div>
                                    <small class="text-muted">Total Tested</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {% if score_data.not_applicable_tests and score_data.not_applicable_tests|length > 0 %}
                    <div class="mt-3">
                        <small class="text-muted">
                            <strong>Not Applicable Tests:</strong>
                            {% for na_test in score_data.not_applicable_tests %}
                                {{ na_test.test_name }} ({{ na_test.reason }}){% if not loop.last %}, {% endif %}
                            {% endfor %}
                        </small>
                    </div>
                    {% endif %}
                    
                    <div class="progress mt-3" style="height: 30px;">
                        {% set pass_pct = ((score_data.passed_checks / score_data.applicable_checks) * 100)|round(1) %}
                        {% set fail_pct = ((score_data.failed_checks / score_data.applicable_checks) * 100)|round(1) %}
                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ pass_pct }}%" 
                             aria-valuenow="{{ pass_pct }}" aria-valuemin="0" aria-valuemax="100">
                            {{ pass_pct }}% Passed
                        </div>
                        <div class="progress-bar bg-danger" role="progressbar" style="width: {{ fail_pct }}%" 
                             aria-valuenow="{{ fail_pct }}" aria-valuemin="0" aria-valuemax="100">
                            {{ fail_pct }}% Failed
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- Test Results Summary -->
    {% if page.status.value == 'tested' %}
    <!-- Two-section layout for clarity -->
    <div class="mb-4">
        <!-- Section 1: Issue Types Found -->
        <div class="card mb-3">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="bi bi-bug"></i> Accessibility Issues Found
                    <button type="button" class="btn btn-sm btn-link p-0 ms-2" data-bs-toggle="tooltip" data-bs-placement="right"
                            title="Number of unique issue types discovered. Each type may have multiple instances throughout the page.">
                        <i class="bi bi-question-circle"></i>
                    </button>
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-6 col-md-3">
                        <div class="text-center">
                            <h6 class="text-danger mb-1">
                                <i class="bi bi-x-circle"></i> Errors
                            </h6>
                            <p class="display-6 mb-0 text-danger">{{ page.violation_count }}</p>
                            <small class="text-muted">types found</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="text-center">
                            <h6 class="text-warning mb-1">
                                <i class="bi bi-exclamation-triangle"></i> Warnings
                            </h6>
                            <p class="display-6 mb-0 text-warning">{{ page.warning_count }}</p>
                            <small class="text-muted">types found</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="text-center">
                            <h6 class="text-info mb-1">
                                <i class="bi bi-info-circle"></i> Info
                            </h6>
                            <p class="display-6 mb-0 text-info">{{ page.info_count|default(0) }}</p>
                            <small class="text-muted">types found</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="text-center">
                            <h6 class="mb-1" style="color: #6f42c1;">
                                <i class="bi bi-search"></i> Discovery
                            </h6>
                            <p class="display-6 mb-0" style="color: #6f42c1;">{{ page.discovery_count|default(0) }}</p>
                            <small class="text-muted">types found</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Section 2: Test Checks Performance -->
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="bi bi-check2-square"></i> Accessibility Checks Performance
                    <button type="button" class="btn btn-sm btn-link p-0 ms-2" data-bs-toggle="tooltip" data-bs-placement="right"
                            title="Total individual checks performed on all page elements. High pass rate is good but doesn't guarantee full compliance if critical issues exist.">
                        <i class="bi bi-question-circle"></i>
                    </button>
                </h5>
            </div>
            <div class="card-body">
                {# Calculate actual totals from metadata if available, otherwise use page counts #}
                {% if latest_result and latest_result.metadata and latest_result.metadata.checks %}
                    {# Use the accurate check counts from metadata #}
                    {% set actual_passed = latest_result.metadata.checks | map(attribute='passed') | map('default', 0) | sum %}
                    {% set actual_failed = latest_result.metadata.checks | map(attribute='failed') | map('default', 0) | sum %}
                    {% set actual_na = latest_result.metadata.checks | selectattr('total', 'equalto', 0) | list | length %}
                    {% set total_tested = actual_passed + actual_failed %}
                    {% set pass_rate = (actual_passed / total_tested * 100) if total_tested > 0 else 0 %}
                    {% set data_source = "checks" %}
                {% elif latest_result and latest_result.metadata %}
                    {# Use metadata counts if available (more accurate than page counts) #}
                    {% set actual_passed = latest_result.metadata.get('passed_checks', 0) %}
                    {% set actual_failed = latest_result.metadata.get('failed_checks', 0) %}
                    {% set actual_na = latest_result.metadata.get('not_applicable_tests', []) | length %}
                    {% set total_tested = actual_passed + actual_failed %}
                    {% set pass_rate = (actual_passed / total_tested * 100) if total_tested > 0 else 0 %}
                    {% set data_source = "metadata" %}
                {% else %}
                    {# Last resort: use page-level counts (least accurate - counts elements not checks) #}
                    {% set actual_passed = page.pass_count %}
                    {% set actual_failed = page.violation_count + page.warning_count + page.info_count|default(0) + page.discovery_count|default(0) %}
                    {% set actual_na = 0 %}
                    {% set total_tested = actual_passed + actual_failed %}
                    {% set pass_rate = (actual_passed / total_tested * 100) if total_tested > 0 else 0 %}
                    {% set data_source = "page" %}
                {% endif %}
                
                
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <!-- Progress bar visualization -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span><strong>Overall Pass Rate</strong></span>
                                <span class="{% if pass_rate >= 90 %}text-success{% elif pass_rate >= 70 %}text-warning{% else %}text-danger{% endif %}">
                                    <strong>{{ "%.1f"|format(pass_rate) }}%</strong>
                                </span>
                            </div>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar {% if pass_rate >= 90 %}bg-success{% elif pass_rate >= 70 %}bg-warning{% else %}bg-danger{% endif %}" 
                                     role="progressbar" style="width: {{ pass_rate }}%">
                                    {{ actual_passed }} passed
                                </div>
                                {% if actual_failed > 0 %}
                                <div class="progress-bar bg-secondary" role="progressbar" 
                                     style="width: {{ 100 - pass_rate }}%">
                                    {{ actual_failed }} failed
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row text-center">
                            <div class="col">
                                <h6 class="text-success">✓ Passed</h6>
                                <p class="mb-0 fs-4">{{ actual_passed }}</p>
                            </div>
                            <div class="col">
                                <h6 class="text-danger">✗ Failed</h6>
                                <p class="mb-0 fs-4">{{ actual_failed }}</p>
                            </div>
                            {% if actual_na > 0 %}
                            <div class="col">
                                <h6 class="text-secondary">N/A</h6>
                                <p class="mb-0 fs-4">{{ actual_na }}</p>
                                <small class="text-muted">tests</small>
                            </div>
                            {% endif %}
                            <div class="col">
                                <h6 class="text-muted">Total Tested</h6>
                                <p class="mb-0 fs-4">{{ total_tested }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-info mb-0">
                            <h6 class="alert-heading"><i class="bi bi-lightbulb"></i> Understanding the Numbers</h6>
                            <small>
                                <strong>Example:</strong> 95% pass rate (475/500 passed) might still mean critical issues exist. 
                                Those 25 failed checks could all be "missing alt text" affecting every image on the page.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Check Results Detail (if available) -->
    {% if latest_result and latest_result.metadata and latest_result.metadata.checks %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Test Check Details</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Test</th>
                            <th>Check</th>
                            <th>WCAG</th>
                            <th class="text-center">Tested</th>
                            <th class="text-center">Passed</th>
                            <th class="text-center">Failed</th>
                            <th class="text-end">Pass Rate</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for check in latest_result.metadata.checks %}
                        <tr>
                            <td>{{ check.test_name }}</td>
                            <td>{{ check.description }}</td>
                            <td>
                                {% for criterion in check.wcag %}
                                <span class="badge bg-secondary">{{ criterion }}</span>
                                {% endfor %}
                            </td>
                            <td class="text-center">{{ check.total }}</td>
                            <td class="text-center text-success">{{ check.passed }}</td>
                            <td class="text-center text-danger">{{ check.failed }}</td>
                            <td class="text-end">
                                {% if check.total > 0 %}
                                    {% set pass_rate = (check.passed / check.total * 100)|round(1) %}
                                    <span class="badge 
                                        {% if pass_rate == 100 %}bg-success
                                        {% elif pass_rate >= 80 %}bg-warning
                                        {% else %}bg-danger{% endif %}">
                                        {{ pass_rate }}%
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">N/A</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <th colspan="3">Totals</th>
                            {% set total_passed = latest_result.metadata.checks | map(attribute='passed') | map('default', 0) | sum %}
                            {% set total_failed = latest_result.metadata.checks | map(attribute='failed') | map('default', 0) | sum %}
                            {% set total_na = latest_result.metadata.checks | selectattr('total', 'equalto', 0) | list | length %}
                            {% set total_tested = total_passed + total_failed %}
                            {% set total_elements = latest_result.metadata.checks | map(attribute='total') | map('default', 0) | sum %}
                            <th class="text-center">
                                {{ total_tested }}
                                {% if total_na > 0 %}
                                    <br><small class="text-muted">({{ total_na }} N/A checks)</small>
                                {% endif %}
                                {% if total_elements != total_tested %}
                                    <br><small class="text-muted">({{ total_elements - total_tested }} skipped)</small>
                                {% endif %}
                            </th>
                            <th class="text-center text-success">{{ total_passed }}</th>
                            <th class="text-center text-danger">{{ total_failed }}</th>
                            <th class="text-end">
                                {% if total_tested > 0 %}
                                    {% set overall_rate = (total_passed / total_tested * 100)|round(1) %}
                                    <span class="badge 
                                        {% if overall_rate >= 90 %}bg-success
                                        {% elif overall_rate >= 70 %}bg-warning
                                        {% else %}bg-danger{% endif %}">
                                        {{ overall_rate }}%
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">N/A</span>
                                {% endif %}
                            </th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Test Results Detail -->
    {% if latest_result %}
    <div class="card test-results-card" data-filterable="true">
        <div class="card-header">
            <h5 class="mb-0">Latest Test Results</h5>
            <small class="text-muted">Tested on {{ latest_result.test_date.strftime('%Y-%m-%d %H:%M:%S') }}</small>
        </div>
        <div class="card-body">
            <!-- Errors (Violations) -->
            {% if latest_result.violations %}
            <h6 class="text-danger mb-3">
                <i class="bi bi-x-circle"></i> Errors ({{ latest_result.violations|length }})
            </h6>
            <div class="accordion mb-4" id="violationsAccordion">
                {% set viol_counter = namespace(value=0) %}
                {% for touchpoint, touchpoint_violations in latest_result.violations|groupby('touchpoint') %}
                    <div class="touchpoint-header mt-3 mb-2 ps-2" style="background-color: #f8f9fa; padding: 8px; border-left: 4px solid #dc3545;">
                        <strong>{{ touchpoint|replace('_', ' ')|title }}</strong>
                    </div>
                    
                    {% for description, description_group in touchpoint_violations|groupby('description') %}
                        {% set group_list = description_group|list %}
                        {% set viol_counter.value = viol_counter.value + 1 %}
                        {% if group_list|length > 1 %}
                            <!-- Multiple instances - create sub-accordion -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#viol-group-{{ viol_counter.value }}">
                                        <span class="badge bg-danger me-2">{{ group_list|length }}</span>
                                        {{ description }}
                                    </button>
                                </h2>
                                <div id="viol-group-{{ viol_counter.value }}" 
                                     class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <div class="accordion" id="viol-group-instances-{{ viol_counter.value }}">
                                            {% for violation in group_list %}
                                            {% set instance_id = viol_counter.value ~ '-' ~ loop.index %}
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed" type="button" 
                                                            data-bs-toggle="collapse" 
                                                            data-bs-target="#viol-instance-{{ instance_id }}">
                                                        <strong>Instance {{ loop.index }}:</strong>
                                                        {% if violation.xpath %}
                                                        <code class="ms-2">{{ violation.xpath }}</code>
                                                        {% endif %}
                                                    </button>
                                                </h2>
                                                <div id="viol-instance-{{ instance_id }}" 
                                                     class="accordion-collapse collapse"
                                                     data-bs-parent="#viol-group-instances-{{ viol_counter.value }}">
                                                    <div class="accordion-body">
                                                        <!-- Full violation details as before -->
                                                        {% if violation.metadata and violation.metadata.title %}
                                                        <!-- Enhanced description available -->
                                                        <div class="alert alert-danger mb-3">
                                                            <h6 class="alert-heading">{{ violation.metadata.title }}</h6>
                                                        </div>
                                                        
                                                        <h6 class="text-danger mb-2">About this issue:</h6>
                                                        
                                                        <div class="mb-3">
                                                            <strong>What the issue is:</strong>
                                                            <p>{{ violation.metadata.what|default(violation.description) }}</p>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <strong>Why this is important:</strong>
                                                            <p>{{ violation.metadata.why }}</p>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <strong>Who it affects:</strong>
                                                            <p>{{ violation.metadata.who }}</p>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <strong>How to remediate:</strong>
                                                            <div class="bg-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace;">{{ violation.metadata.full_remediation|default(violation.failure_summary) }}</div>
                                                        </div>
                                                        
                                                        <h6 class="text-danger mb-2 mt-4">Relevant test criteria:</h6>
                                                        <div class="mb-3">
                                                            {% if violation.metadata.wcag_full %}
                                                            <strong>WCAG Success Criteria:</strong>
                                                            <ul>
                                                            {% for criterion in violation.metadata.wcag_full %}
                                                                <li>{{ criterion }}</li>
                                                            {% endfor %}
                                                            </ul>
                                                            {% elif violation.wcag_criteria %}
                                                            <strong>WCAG Success Criteria:</strong>
                                                            <ul>
                                                            {% for criterion in violation.wcag_criteria %}
                                                                <li>
                                                                    <a href="https://www.w3.org/WAI/WCAG21/Understanding/" target="_blank" class="text-decoration-none">
                                                                        {{ criterion }}
                                                                    </a>
                                                                </li>
                                                            {% endfor %}
                                                            </ul>
                                                            {% endif %}
                                                        </div>
                                                        {% else %}
                                                        <!-- Standard description -->
                                                        <p><strong>Rule:</strong> {{ violation.rule_id|default(violation.id) }}</p>
                                                        <p><strong>Help:</strong> {{ violation.help_text|default(violation.description) }}</p>
                                                        {% if violation.failure_summary %}
                                                        <p><strong>How to fix:</strong> {{ violation.failure_summary }}</p>
                                                        {% endif %}
                                                        {% endif %}
                                                        
                                                        <hr>
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <p><strong>Touchpoint:</strong> {{ violation.touchpoint|default('General') }}</p>
                                                                <p><strong>Impact:</strong> 
                                                                    <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[violation.impact.value|lower if violation.impact.value else violation.impact|lower] or 'secondary' }} impact-badge">
                                                                        {{ violation.impact.value|upper if violation.impact.value else violation.impact|upper }}
                                                                    </span>
                                                                </p>
                                                            </div>
                                                            <div class="col-md-6">
                                                                {% if violation.wcag_criteria %}
                                                                <p><strong>WCAG Criteria:</strong> 
                                                                    {% for criterion in violation.wcag_criteria %}
                                                                    <a href="https://www.w3.org/WAI/WCAG21/Understanding/" target="_blank" class="badge bg-primary text-decoration-none">
                                                                        {{ criterion }}
                                                                    </a>
                                                                    {% endfor %}
                                                                </p>
                                                                {% endif %}
                                                                {% if violation.help_url %}
                                                                <p><strong>Learn More:</strong> 
                                                                    <a href="{{ violation.help_url }}" target="_blank">
                                                                        Documentation <i class="bi bi-box-arrow-up-right"></i>
                                                                    </a>
                                                                </p>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        
                                                        {% if violation.selector or violation.xpath %}
                                                        <p><strong>Location:</strong> <code>{{ violation.selector|default(violation.xpath) }}</code></p>
                                                        {% endif %}
                                                        
                                                        {% if violation.html %}
                                                        <h6 class="mt-3">Code Snippet</h6>
                                                        <pre class="bg-dark text-light p-3 rounded"><code>{{ violation.html|e }}</code></pre>
                                                        {% endif %}
                                                        
                                                        {% if violation.metadata.ai_detected %}
                                                        <div class="alert alert-info mt-3">
                                                            <i class="bi bi-robot"></i> <strong>AI Detection Note:</strong>
                                                            <p class="mb-0">This issue was detected through visual analysis.</p>
                                                            {% if violation.metadata.ai_confidence %}
                                                            <p><strong>Confidence:</strong> {{ (violation.metadata.ai_confidence * 100)|round }}%</p>
                                                            {% endif %}
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <!-- Single instance - show as before -->
                            {% for violation in group_list %}
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#viol-single-{{ viol_counter.value }}">
                                        <span class="badge bg-danger me-2 impact-badge">{{ violation.impact.value|upper if violation.impact.value else violation.impact|upper }}</span>
                                        {% if violation.metadata.ai_detected %}
                                        <span class="badge bg-info me-2" title="Detected by AI analysis">
                                            <i class="bi bi-robot"></i> AI
                                        </span>
                                        {% endif %}
                                        {% if violation.metadata and violation.metadata.what and violation.metadata.what != "Accessibility issue: " + violation.id.split('_')[1] %}
                                            {{ violation.metadata.what }}
                                        {% else %}
                                            {{ violation.description }}
                                        {% endif %}
                                        {% if violation.xpath %}
                                            <span class="text-muted ms-2" style="font-size: 0.9em;">• {{ violation.xpath }}</span>
                                        {% endif %}
                                    </button>
                                </h2>
                                <div id="viol-single-{{ viol_counter.value }}" 
                         class="accordion-collapse collapse" 
                         data-bs-parent="#violationsAccordion">
                        <div class="accordion-body">
                            {% if violation.metadata and violation.metadata.title %}
                            <!-- Enhanced description available -->
                            <div class="alert alert-danger mb-3">
                                <h6 class="alert-heading">{{ violation.metadata.title }}</h6>
                            </div>
                            
                            <h6 class="text-danger mb-2">About this issue:</h6>
                            
                            <div class="mb-3">
                                <strong>What the issue is:</strong>
                                <p>{{ violation.metadata.what|default(violation.description) }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Why this is important:</strong>
                                <p>{{ violation.metadata.why }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Who it affects:</strong>
                                <p>{{ violation.metadata.who }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>How to remediate:</strong>
                                <div class="bg-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace;">{{ violation.metadata.full_remediation|default(violation.failure_summary) }}</div>
                            </div>
                            
                            <h6 class="text-danger mb-2 mt-4">Relevant test criteria:</h6>
                            <div class="mb-3">
                                {% if violation.metadata.wcag_full %}
                                <strong>WCAG Success Criteria:</strong>
                                <ul>
                                {% for criterion in violation.metadata.wcag_full %}
                                    <li>{{ criterion }}</li>
                                {% endfor %}
                                </ul>
                                {% elif violation.wcag_criteria %}
                                <strong>WCAG Success Criteria:</strong>
                                <ul>
                                {% for criterion in violation.wcag_criteria %}
                                    <li>
                                        <a href="https://www.w3.org/WAI/WCAG21/Understanding/" target="_blank" class="text-decoration-none">
                                            {{ criterion }}
                                        </a>
                                    </li>
                                {% endfor %}
                                </ul>
                                {% endif %}
                            </div>
                            {% else %}
                            <!-- Standard description -->
                            <p><strong>Rule:</strong> {{ violation.rule_id|default(violation.id) }}</p>
                            <p><strong>Help:</strong> {{ violation.help_text|default(violation.description) }}</p>
                            {% if violation.failure_summary %}
                            <p><strong>How to fix:</strong> {{ violation.failure_summary }}</p>
                            {% endif %}
                            {% endif %}
                            
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Touchpoint:</strong> {{ violation.touchpoint|default('General') }}</p>
                                    <p><strong>Impact:</strong> 
                                        <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[violation.impact.value|lower if violation.impact.value else violation.impact|lower] or 'secondary' }} impact-badge">
                                            {{ violation.impact.value|upper if violation.impact.value else violation.impact|upper }}
                                        </span>
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    {% if violation.wcag_criteria %}
                                    <p><strong>WCAG Criteria:</strong> 
                                        {% for criterion in violation.wcag_criteria %}
                                        <a href="https://www.w3.org/WAI/WCAG21/Understanding/" target="_blank" class="badge bg-primary text-decoration-none">
                                            {{ criterion }}
                                        </a>
                                        {% endfor %}
                                    </p>
                                    {% endif %}
                                    {% if violation.help_url %}
                                    <p><strong>Learn More:</strong> 
                                        <a href="{{ violation.help_url }}" target="_blank">
                                            Documentation <i class="bi bi-box-arrow-up-right"></i>
                                        </a>
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                            
                            {% if violation.selector or violation.xpath %}
                            <p><strong>Location:</strong> <code>{{ violation.selector|default(violation.xpath) }}</code></p>
                            {% endif %}
                            
                            {% if violation.html %}
                            <div class="mt-3">
                                <h6>Code Snippet</h6>
                                <pre class="bg-dark text-light p-3 rounded"><code>{{ violation.html|e }}</code></pre>
                            </div>
                            {% endif %}
                            
                            {% if violation.metadata.ai_detected %}
                            <div class="mt-3">
                                <h6><i class="bi bi-robot"></i> AI Detection Details</h6>
                                <div class="small text-muted">
                                    {% if violation.metadata.visual_location %}
                                    <p><strong>Visual Location:</strong> {{ violation.metadata.visual_location }}</p>
                                    {% endif %}
                                    {% if violation.metadata.element_class %}
                                    <p><strong>CSS Classes:</strong> <code>{{ violation.metadata.element_class }}</code></p>
                                    {% endif %}
                                    {% if violation.metadata.element_id %}
                                    <p><strong>Element ID:</strong> <code>{{ violation.metadata.element_id }}</code></p>
                                    {% endif %}
                                    {% if violation.metadata.ai_confidence %}
                                    <p><strong>Confidence:</strong> {{ (violation.metadata.ai_confidence * 100)|round }}%</p>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            </div>
            {% endif %}

            <!-- Warnings -->
            {% if latest_result.warnings %}
            <h6 class="text-warning mb-3">
                <i class="bi bi-exclamation-triangle"></i> Warnings ({{ latest_result.warnings|length }})
            </h6>
            <div class="accordion mb-4" id="warningsAccordion">
                {% set warn_counter = namespace(value=0) %}
                {% for touchpoint, touchpoint_warnings in latest_result.warnings|groupby('touchpoint') %}
                    <div class="touchpoint-header mt-3 mb-2 ps-2" style="background-color: #f8f9fa; padding: 8px; border-left: 4px solid #ffc107;">
                        <strong>{{ touchpoint|replace('_', ' ')|title }}</strong>
                    </div>
                    
                    {% for description, description_group in touchpoint_warnings|groupby('description') %}
                        {% set group_list = description_group|list %}
                        {% set warn_counter.value = warn_counter.value + 1 %}
                        {% if group_list|length > 1 %}
                            <!-- Multiple instances - create sub-accordion -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#warn-group-{{ warn_counter.value }}">
                                        <span class="badge bg-warning text-dark me-2">{{ group_list|length }}</span>
                                        {{ description }}
                                    </button>
                                </h2>
                                <div id="warn-group-{{ warn_counter.value }}" 
                                     class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <div class="accordion" id="warn-instances-{{ warn_counter.value }}">
                                            {% for warning in group_list %}
                                            {% set warn_instance_id = warn_counter.value ~ '-' ~ loop.index %}
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed" type="button" 
                                                            data-bs-toggle="collapse" 
                                                            data-bs-target="#warn-instance-{{ warn_instance_id }}">
                                                        <strong>Instance {{ loop.index }}:</strong>
                                                        {% if warning.xpath %}
                                                        <code class="ms-2">{{ warning.xpath }}</code>
                                                        {% endif %}
                                                    </button>
                                                </h2>
                                                <div id="warn-instance-{{ warn_instance_id }}" 
                                                     class="accordion-collapse collapse"
                                                     data-bs-parent="#warn-instances-{{ warn_counter.value }}">
                                                    <div class="accordion-body">
                                                        <!-- Full warning details as before -->
                                                        {% if warning.metadata and warning.metadata.title %}
                                                        <!-- Enhanced description available -->
                                                        <div class="alert alert-warning mb-3">
                                                            <h6 class="alert-heading">{{ warning.metadata.title }}</h6>
                                                        </div>
                                                        
                                                        <h6 class="text-warning mb-2">About this issue:</h6>
                                                        
                                                        <div class="mb-3">
                                                            <strong>What the issue is:</strong>
                                                            <p>{{ warning.metadata.what|default(warning.description) }}</p>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <strong>Why this is important:</strong>
                                                            <p>{{ warning.metadata.why }}</p>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <strong>Who it affects:</strong>
                                                            <p>{{ warning.metadata.who }}</p>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <strong>How to remediate:</strong>
                                                            <div class="bg-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace;">{{ warning.metadata.full_remediation|default(warning.failure_summary) }}</div>
                                                        </div>
                                                        
                                                        <h6 class="text-warning mb-2 mt-4">Relevant test criteria:</h6>
                                                        <div class="mb-3">
                                                            {% if warning.metadata.wcag_full %}
                                                            <strong>WCAG Success Criteria:</strong>
                                                            <ul>
                                                            {% for criterion in warning.metadata.wcag_full %}
                                                                <li>{{ criterion }}</li>
                                                            {% endfor %}
                                                            </ul>
                                                            {% elif warning.wcag_criteria %}
                                                            <strong>WCAG Success Criteria:</strong>
                                                            <ul>
                                                            {% for criterion in warning.wcag_criteria %}
                                                                <li>
                                                                    <a href="https://www.w3.org/WAI/WCAG21/Understanding/" target="_blank" class="text-decoration-none">
                                                                        {{ criterion }}
                                                                    </a>
                                                                </li>
                                                            {% endfor %}
                                                            </ul>
                                                            {% endif %}
                                                        </div>
                                                        {% else %}
                                                        <!-- Standard description -->
                                                        <p><strong>Rule:</strong> {{ warning.rule_id|default(warning.id) }}</p>
                                                        <p><strong>Help:</strong> {{ warning.help_text|default(warning.description) }}</p>
                                                        {% if warning.failure_summary %}
                                                        <p><strong>How to fix:</strong> {{ warning.failure_summary }}</p>
                                                        {% endif %}
                                                        {% endif %}
                                                        
                                                        <hr>
                                                        <p><strong>Touchpoint:</strong> {{ warning.touchpoint|default('General') }}</p>
                                                        {% if warning.xpath %}
                                                        <p><strong>Location:</strong> <code>{{ warning.xpath }}</code></p>
                                                        {% endif %}
                                                        {% if warning.html %}
                                                        <h6 class="mt-3">Code Snippet</h6>
                                                        <pre class="bg-dark text-light p-3 rounded"><code>{{ warning.html|e }}</code></pre>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <!-- Single instance - show as before -->
                            {% for warning in group_list %}
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#warn-single-{{ warn_counter.value }}">
                                        <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[warning.impact.value|lower if warning.impact.value else warning.impact|lower] or 'warning' }} me-2 impact-badge">
                                            {{ warning.impact.value|upper if warning.impact.value else warning.impact|upper }}
                                        </span>
                                        {% if warning.metadata.ai_detected %}
                                        <span class="badge bg-info me-2" title="Detected by AI analysis">
                                            <i class="bi bi-robot"></i> AI
                                        </span>
                                        {% endif %}
                                        {% if warning.metadata and warning.metadata.what and warning.metadata.what != "Accessibility issue: " + warning.id.split('_')[1] %}
                                            {{ warning.metadata.what }}
                                        {% else %}
                                            {{ warning.description }}
                                        {% endif %}
                                        {% if warning.xpath %}
                                            <span class="text-muted ms-2" style="font-size: 0.9em;">• {{ warning.xpath }}</span>
                                        {% endif %}
                                    </button>
                                </h2>
                                <div id="warn-single-{{ warn_counter.value }}" 
                         class="accordion-collapse collapse" 
                         data-bs-parent="#warningsAccordion">
                        <div class="accordion-body">
                            {% if warning.metadata and warning.metadata.title %}
                            <!-- Enhanced description available -->
                            <div class="alert alert-warning mb-3">
                                <h6 class="alert-heading">{{ warning.metadata.title }}</h6>
                            </div>
                            
                            <h6 class="text-warning mb-2">About this issue:</h6>
                            
                            <div class="mb-3">
                                <strong>What the issue is:</strong>
                                <p>{{ warning.metadata.what|default(warning.description) }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Why this is important:</strong>
                                <p>{{ warning.metadata.why }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Who it affects:</strong>
                                <p>{{ warning.metadata.who }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>How to remediate:</strong>
                                <div class="bg-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace;">{{ warning.metadata.full_remediation|default(warning.failure_summary) }}</div>
                            </div>
                            
                            <h6 class="text-warning mb-2 mt-4">Relevant test criteria:</h6>
                            <div class="mb-3">
                                {% if warning.metadata.wcag_full %}
                                <strong>WCAG Success Criteria:</strong>
                                <ul>
                                {% for criterion in warning.metadata.wcag_full %}
                                    <li>{{ criterion }}</li>
                                {% endfor %}
                                </ul>
                                {% elif warning.wcag_criteria %}
                                <strong>WCAG Success Criteria:</strong>
                                <ul>
                                {% for criterion in warning.wcag_criteria %}
                                    <li>
                                        <a href="https://www.w3.org/WAI/WCAG21/Understanding/" target="_blank" class="text-decoration-none">
                                            {{ criterion }}
                                        </a>
                                    </li>
                                {% endfor %}
                                </ul>
                                {% endif %}
                            </div>
                            
                            <hr>
                            <p><strong>Touchpoint:</strong> {{ warning.touchpoint }}</p>
                            {% if warning.xpath %}
                            <p><strong>Location:</strong> <code>{{ warning.xpath }}</code></p>
                            {% endif %}
                            {% if warning.html %}
                            <div class="mt-3">
                                <h6>Code Snippet</h6>
                                <pre class="bg-dark text-light p-3 rounded"><code>{{ warning.html|e }}</code></pre>
                            </div>
                            {% endif %}
                            {% else %}
                            <!-- Standard description -->
                            <p><strong>Touchpoint:</strong> {{ warning.touchpoint }}</p>
                            {% if warning.help_url %}
                            <p><strong>Help:</strong> <a href="{{ warning.help_url }}" target="_blank">Learn more</a></p>
                            {% endif %}
                            {% if warning.xpath %}
                            <p><strong>XPath:</strong> <code>{{ warning.xpath }}</code></p>
                            {% endif %}
                            {% if warning.html %}
                            <pre><code>{{ warning.html|e }}</code></pre>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            </div>
            {% endif %}

            <!-- Info Notes -->
            {% if latest_result.info %}
            <h6 class="text-info mb-3">
                <i class="bi bi-info-circle"></i> Info Notes ({{ latest_result.info|length }})
            </h6>
            <div class="accordion mb-4" id="infoAccordion">
                {% set info_counter = namespace(value=0) %}
                {% for touchpoint, touchpoint_infos in latest_result.info|groupby('touchpoint') %}
                    <div class="touchpoint-header mt-3 mb-2 ps-2" style="background-color: #f8f9fa; padding: 8px; border-left: 4px solid #0dcaf0;">
                        <strong>{{ touchpoint|replace('_', ' ')|title }}</strong>
                    </div>
                    
                    {% for description, description_group in touchpoint_infos|groupby('description') %}
                        {% set group_list = description_group|list %}
                        {% set info_counter.value = info_counter.value + 1 %}
                        {% if group_list|length > 1 %}
                            <!-- Multiple instances - create sub-accordion -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#info-group-{{ info_counter.value }}">
                                        <span class="badge bg-info me-2">{{ group_list|length }}</span>
                                        {{ description }}
                                    </button>
                                </h2>
                                <div id="info-group-{{ info_counter.value }}" 
                                     class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <div class="accordion" id="info-instances-{{ info_counter.value }}">
                                            {% for info in group_list %}
                                            {% set info_instance_id = info_counter.value ~ '-' ~ loop.index %}
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed" type="button" 
                                                            data-bs-toggle="collapse" 
                                                            data-bs-target="#info-instance-{{ info_instance_id }}">
                                                        <strong>Instance {{ loop.index }}:</strong>
                                                        {% if info.xpath %}
                                                        <code class="ms-2">{{ info.xpath }}</code>
                                                        {% endif %}
                                                    </button>
                                                </h2>
                                                <div id="info-instance-{{ info_instance_id }}" 
                                                     class="accordion-collapse collapse"
                                                     data-bs-parent="#info-instances-{{ info_counter.value }}">
                                                    <div class="accordion-body">
                                                        <!-- Full info details -->
                                                        {% if info.metadata and info.metadata.title %}
                                                        <!-- Enhanced description available -->
                                                        <div class="alert alert-info mb-3">
                                                            <h6 class="alert-heading">{{ info.metadata.title }}</h6>
                                                        </div>
                                                        
                                                        <h6 class="text-info mb-2">About this issue:</h6>
                                                        
                                                        <div class="mb-3">
                                                            <strong>What the issue is:</strong>
                                                            <p>{{ info.metadata.what|default(info.description) }}</p>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <strong>Why this is important:</strong>
                                                            <p>{{ info.metadata.why }}</p>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <strong>Who it affects:</strong>
                                                            <p>{{ info.metadata.who }}</p>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <strong>How to remediate:</strong>
                                                            <div class="bg-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace;">{{ info.metadata.full_remediation|default(info.failure_summary) }}</div>
                                                        </div>
                                                        
                                                        <h6 class="text-info mb-2 mt-4">Relevant test criteria:</h6>
                                                        <div class="mb-3">
                                                            {% if info.metadata.wcag_full %}
                                                            <strong>WCAG Success Criteria:</strong>
                                                            <ul>
                                                            {% for criterion in info.metadata.wcag_full %}
                                                                <li>{{ criterion }}</li>
                                                            {% endfor %}
                                                            </ul>
                                                            {% elif info.wcag_criteria %}
                                                            <strong>WCAG Success Criteria:</strong>
                                                            <ul>
                                                            {% for criterion in info.wcag_criteria %}
                                                                <li>
                                                                    <a href="https://www.w3.org/WAI/WCAG21/Understanding/" target="_blank" class="text-decoration-none">
                                                                        {{ criterion }}
                                                                    </a>
                                                                </li>
                                                            {% endfor %}
                                                            </ul>
                                                            {% endif %}
                                                        </div>
                                                        {% else %}
                                                        <!-- Standard description -->
                                                        <p><strong>Touchpoint:</strong> {{ info.touchpoint|default('General') }}</p>
                                                        <p class="text-muted">
                                                            <i class="bi bi-info-circle"></i> This is an informational note.
                                                        </p>
                                                        {% endif %}
                                                        
                                                        {% if info.xpath %}
                                                        <p><strong>Location:</strong> <code>{{ info.xpath }}</code></p>
                                                        {% endif %}
                                                        {% if info.html %}
                                                        <h6 class="mt-3">Code Snippet</h6>
                                                        <pre class="bg-dark text-light p-3 rounded"><code>{{ info.html|e }}</code></pre>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <!-- Single instance - show as before -->
                            {% for info in group_list %}
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#info-single-{{ info_counter.value }}">
                            {% if info.metadata and info.metadata.what and info.metadata.what != "Accessibility issue: " + info.id.split('_')[1] %}
                                {{ info.metadata.what }}
                            {% else %}
                                {{ info.description }}
                            {% endif %}
                            {% if info.xpath %}
                                <span class="text-muted ms-2" style="font-size: 0.9em;">• {{ info.xpath }}</span>
                            {% endif %}
                                    </button>
                                </h2>
                                <div id="info-single-{{ info_counter.value }}" 
                         class="accordion-collapse collapse" 
                         data-bs-parent="#infoAccordion">
                        <div class="accordion-body">
                            {% if info.metadata and info.metadata.title %}
                            <!-- Enhanced description available -->
                            <div class="alert alert-info mb-3">
                                <h6 class="alert-heading">{{ info.metadata.title }}</h6>
                            </div>
                            
                            <h6 class="text-info mb-2">About this issue:</h6>
                            
                            <div class="mb-3">
                                <strong>What the issue is:</strong>
                                <p>{{ info.metadata.what|default(info.description) }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Why this is important:</strong>
                                <p>{{ info.metadata.why }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Who it affects:</strong>
                                <p>{{ info.metadata.who }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>How to remediate:</strong>
                                <div class="bg-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace;">{{ info.metadata.full_remediation|default(info.failure_summary) }}</div>
                            </div>
                            
                            <h6 class="text-info mb-2 mt-4">Relevant test criteria:</h6>
                            <div class="mb-3">
                                {% if info.metadata.wcag_full %}
                                <strong>WCAG Success Criteria:</strong>
                                <ul>
                                {% for criterion in info.metadata.wcag_full %}
                                    <li>{{ criterion }}</li>
                                {% endfor %}
                                </ul>
                                {% elif info.wcag_criteria %}
                                <strong>WCAG Success Criteria:</strong>
                                <ul>
                                {% for criterion in info.wcag_criteria %}
                                    <li>
                                        <a href="https://www.w3.org/WAI/WCAG21/Understanding/" target="_blank" class="text-decoration-none">
                                            {{ criterion }}
                                        </a>
                                    </li>
                                {% endfor %}
                                </ul>
                                {% endif %}
                            </div>
                            
                            <hr>
                            <p><strong>Touchpoint:</strong> {{ info.touchpoint }}</p>
                            {% if info.xpath %}
                            <p><strong>Location:</strong> <code>{{ info.xpath }}</code></p>
                            {% endif %}
                            {% if info.html %}
                            <div class="mt-3">
                                <h6>Code Snippet</h6>
                                <pre class="bg-dark text-light p-3 rounded"><code>{{ info.html|e }}</code></pre>
                            </div>
                            {% endif %}
                            {% else %}
                            <!-- Standard description -->
                            <p><strong>Touchpoint:</strong> {{ info.touchpoint }}</p>
                            {% if info.help_url %}
                            <p><strong>Help:</strong> <a href="{{ info.help_url }}" target="_blank">Learn more</a></p>
                            {% endif %}
                            {% if info.xpath %}
                            <p><strong>XPath:</strong> <code>{{ info.xpath }}</code></p>
                            {% endif %}
                            {% if info.html %}
                            <pre><code>{{ info.html|e }}</code></pre>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            </div>
            {% endif %}

            <!-- Discovery Items -->
            {% if latest_result.discovery %}
            <h6 class="mb-3" style="color: #6f42c1;">
                <i class="bi bi-search"></i> Discovery Items ({{ latest_result.discovery|length }})
            </h6>
            <div class="accordion mb-4" id="discoveryAccordion">
                {% set disc_counter = namespace(value=0) %}
                {% for touchpoint, touchpoint_discoveries in latest_result.discovery|groupby('touchpoint') %}
                    <div class="touchpoint-header mt-3 mb-2 ps-2" style="background-color: #f8f9fa; padding: 8px; border-left: 4px solid #6f42c1;">
                        <strong>{{ touchpoint|replace('_', ' ')|title }}</strong>
                    </div>
                    
                    {% for description, description_group in touchpoint_discoveries|groupby('description') %}
                        {% set group_list = description_group|list %}
                        {% set disc_counter.value = disc_counter.value + 1 %}
                        {% if group_list|length > 1 %}
                            <!-- Multiple instances - create sub-accordion -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#disc-group-{{ disc_counter.value }}">
                                        <span class="badge" style="background-color: #6f42c1; color: white;">{{ group_list|length }}</span>
                                        <span class="ms-2">{{ description }}</span>
                                    </button>
                                </h2>
                                <div id="disc-group-{{ disc_counter.value }}" 
                                     class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <div class="accordion" id="disc-instances-{{ disc_counter.value }}">
                                            {% for discovery in group_list %}
                                            {% set disc_instance_id = disc_counter.value ~ '-' ~ loop.index %}
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed" type="button" 
                                                            data-bs-toggle="collapse" 
                                                            data-bs-target="#disc-instance-{{ disc_instance_id }}">
                                                        <strong>Instance {{ loop.index }}:</strong>
                                                        {% if discovery.xpath %}
                                                        <code class="ms-2">{{ discovery.xpath }}</code>
                                                        {% endif %}
                                                    </button>
                                                </h2>
                                                <div id="disc-instance-{{ disc_instance_id }}" 
                                                     class="accordion-collapse collapse"
                                                     data-bs-parent="#disc-instances-{{ disc_counter.value }}">
                                                    <div class="accordion-body">
                                                        <!-- Full discovery details -->
                                                        {% if discovery.metadata and discovery.metadata.title %}
                                                        <!-- Enhanced description available -->
                                                        <div class="alert mb-3" style="background-color: #f3f0ff; border-color: #6f42c1;">
                                                            <h6 class="alert-heading" style="color: #6f42c1;">{{ discovery.metadata.title }}</h6>
                                                        </div>
                                                        
                                                        <h6 style="color: #6f42c1;" class="mb-2">About this discovery item:</h6>
                                                        
                                                        <div class="mb-3">
                                                            <strong>What was found:</strong>
                                                            <p>{{ discovery.metadata.what|default(discovery.description) }}</p>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <strong>Why manual review is needed:</strong>
                                                            <p>{{ discovery.metadata.why }}</p>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <strong>Who could be affected:</strong>
                                                            <p>{{ discovery.metadata.who }}</p>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <strong>What to check manually:</strong>
                                                            <div class="bg-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace;">{{ discovery.metadata.full_remediation|default(discovery.failure_summary) }}</div>
                                                        </div>
                                                        
                                                        <h6 style="color: #6f42c1;" class="mb-2 mt-4">Relevant test criteria:</h6>
                                                        <div class="mb-3">
                                                            {% if discovery.metadata.wcag_full %}
                                                            <strong>WCAG Success Criteria:</strong>
                                                            <ul>
                                                            {% for criterion in discovery.metadata.wcag_full %}
                                                                <li>{{ criterion }}</li>
                                                            {% endfor %}
                                                            </ul>
                                                            {% elif discovery.wcag_criteria %}
                                                            <strong>WCAG Success Criteria:</strong>
                                                            <ul>
                                                            {% for criterion in discovery.wcag_criteria %}
                                                                <li>
                                                                    <a href="https://www.w3.org/WAI/WCAG21/Understanding/" target="_blank" class="text-decoration-none">
                                                                        {{ criterion }}
                                                                    </a>
                                                                </li>
                                                            {% endfor %}
                                                            </ul>
                                                            {% endif %}
                                                        </div>
                                                        {% else %}
                                                        <!-- Standard description -->
                                                        <p><strong>Touchpoint:</strong> {{ discovery.touchpoint }}</p>
                                                        <p class="text-muted">
                                                            <i class="bi bi-info-circle"></i> This item requires manual inspection.
                                                        </p>
                                                        {% endif %}
                                                        
                                                        <hr>
                                                        <p><strong>Touchpoint:</strong> {{ discovery.touchpoint }}</p>
                                                        {% if discovery.xpath %}
                                                        <p><strong>Location:</strong> <code>{{ discovery.xpath }}</code></p>
                                                        {% endif %}
                                                        {% if discovery.html %}
                                                        <h6 class="mt-3">Code Snippet</h6>
                                                        <pre class="bg-dark text-light p-3 rounded"><code>{{ discovery.html|e }}</code></pre>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <!-- Single instance - show as before -->
                            {% for discovery in group_list %}
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#disc-single-{{ disc_counter.value }}">
                            {% if discovery.metadata and discovery.metadata.what and discovery.metadata.what != "Accessibility issue: " + discovery.id.split('_')[1] %}
                                {{ discovery.metadata.what }}
                            {% else %}
                                {{ discovery.description }}
                            {% endif %}
                            {% if discovery.xpath %}
                                <span class="text-muted ms-2" style="font-size: 0.9em;">• {{ discovery.xpath }}</span>
                            {% endif %}
                                    </button>
                                </h2>
                                <div id="disc-single-{{ disc_counter.value }}" 
                         class="accordion-collapse collapse" 
                         data-bs-parent="#discoveryAccordion">
                        <div class="accordion-body">
                            {% if discovery.metadata and discovery.metadata.title %}
                            <!-- Enhanced description available -->
                            <div class="alert mb-3" style="background-color: #f3f0ff; border-color: #6f42c1;">
                                <h6 class="alert-heading" style="color: #6f42c1;">{{ discovery.metadata.title }}</h6>
                            </div>
                            
                            <h6 style="color: #6f42c1;" class="mb-2">About this discovery item:</h6>
                            
                            <div class="mb-3">
                                <strong>What was found:</strong>
                                <p>{{ discovery.metadata.what|default(discovery.description) }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Why manual review is needed:</strong>
                                <p>{{ discovery.metadata.why }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Who could be affected:</strong>
                                <p>{{ discovery.metadata.who }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>What to check manually:</strong>
                                <div class="bg-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace;">{{ discovery.metadata.full_remediation|default(discovery.failure_summary) }}</div>
                            </div>
                            
                            <h6 style="color: #6f42c1;" class="mb-2 mt-4">Relevant test criteria:</h6>
                            <div class="mb-3">
                                {% if discovery.metadata.wcag_full %}
                                <strong>WCAG Success Criteria:</strong>
                                <ul>
                                {% for criterion in discovery.metadata.wcag_full %}
                                    <li>{{ criterion }}</li>
                                {% endfor %}
                                </ul>
                                {% elif discovery.wcag_criteria %}
                                <strong>WCAG Success Criteria:</strong>
                                <ul>
                                {% for criterion in discovery.wcag_criteria %}
                                    <li>
                                        <a href="https://www.w3.org/WAI/WCAG21/Understanding/" target="_blank" class="text-decoration-none">
                                            {{ criterion }}
                                        </a>
                                    </li>
                                {% endfor %}
                                </ul>
                                {% endif %}
                            </div>
                            
                            <hr>
                            <p><strong>Touchpoint:</strong> {{ discovery.touchpoint }}</p>
                            <p class="text-muted">
                                <i class="bi bi-info-circle"></i> This item requires manual inspection to ensure accessibility.
                            </p>
                            {% if discovery.xpath %}
                            <p><strong>Location:</strong> <code>{{ discovery.xpath }}</code></p>
                            {% endif %}
                            {% if discovery.html %}
                            <div class="mt-3">
                                <h6>Code Snippet</h6>
                                <pre class="bg-dark text-light p-3 rounded"><code>{{ discovery.html|e }}</code></pre>
                            </div>
                            {% endif %}
                            {% else %}
                            <!-- Standard description -->
                            <p><strong>Touchpoint:</strong> {{ discovery.touchpoint }}</p>
                            <p class="text-muted">
                                <i class="bi bi-info-circle"></i> This item requires manual inspection to ensure accessibility.
                            </p>
                            {% if discovery.help_url %}
                            <p><strong>Help:</strong> <a href="{{ discovery.help_url }}" target="_blank">Learn more</a></p>
                            {% endif %}
                            {% if discovery.xpath %}
                            <p><strong>XPath:</strong> <code>{{ discovery.xpath }}</code></p>
                            {% endif %}
                            {% if discovery.html %}
                            <pre><code>{{ discovery.html|e }}</code></pre>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            </div>
            {% endif %}

            <!-- AI findings are now integrated into violations/warnings/info above -->

            <!-- Summary Stats -->
            <div class="row text-center">
                <div class="col">
                    <small class="text-muted">
                        Test completed in {{ "%.2f"|format(latest_result.duration_ms / 1000) }} seconds
                        {% if latest_result.screenshot_path %}
                        | <a href="{{ url_for('static', filename='screenshots/' ~ latest_result.screenshot_path) }}" target="_blank">
                            View Screenshot <i class="bi bi-image"></i>
                        </a>
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
    </div>
    {% elif page.status.value != 'tested' %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> This page has not been tested yet. Click "Run Test" to start accessibility testing.
    </div>
    {% endif %}

    <!-- Test History -->
    {% if test_history %}
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0">Test History</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Errors</th>
                            <th>Warnings</th>
                            <th>Info</th>
                            <th>Discovery</th>
                            <th>Passed</th>
                            <th>Duration</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in test_history %}
                        <tr>
                            <td>{{ result.test_date.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td><span class="badge bg-danger">{{ result.violation_count }}</span></td>
                            <td><span class="badge bg-warning text-dark">{{ result.warning_count }}</span></td>
                            <td><span class="badge bg-info">{{ result.info_count|default(0) }}</span></td>
                            <td><span class="badge" style="background-color: #6f42c1;">{{ result.discovery_count|default(0) }}</span></td>
                            <td><span class="badge bg-success">{{ result.pass_count }}</span></td>
                            <td>{{ "%.2f"|format(result.duration_ms / 1000) }}s</td>
                            <td>
                                <a href="{{ url_for('testing.view_result', result_id=result.id) }}" 
                                   class="btn btn-sm btn-primary">
                                    <i class="bi bi-eye"></i> View
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Test Page Modal -->
<div class="modal fade" id="testModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Running Test</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Testing...</span>
                </div>
                <p>Running accessibility tests on this page...</p>
                <p class="text-muted">This may take a moment.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let statusPollInterval = null;
let testInProgress = false;

function updateStatusBadge(status) {
    const container = document.getElementById('page-status-container');
    const progressAlert = document.getElementById('test-progress-alert');
    let badgeHtml = '';
    
    switch(status) {
        case 'discovered':
            badgeHtml = '<span class="badge bg-secondary">Discovered</span>';
            progressAlert.classList.add('d-none');
            break;
        case 'queued':
            badgeHtml = '<span class="badge bg-warning"><span class="spinner-border spinner-border-sm me-1" role="status"></span>Queued</span>';
            progressAlert.classList.remove('d-none');
            break;
        case 'testing':
            badgeHtml = '<span class="badge bg-info"><span class="spinner-border spinner-border-sm me-1" role="status"></span>Testing</span>';
            progressAlert.classList.remove('d-none');
            break;
        case 'tested':
            badgeHtml = '<span class="badge bg-success">Tested</span>';
            progressAlert.classList.add('d-none');
            break;
        case 'error':
            badgeHtml = '<span class="badge bg-danger">Error</span>';
            progressAlert.classList.add('d-none');
            break;
        default:
            badgeHtml = `<span class="badge bg-secondary">${status.charAt(0).toUpperCase() + status.slice(1)}</span>`;
            progressAlert.classList.add('d-none');
    }
    
    container.innerHTML = badgeHtml;
}

function startStatusPolling(pageId) {
    let previousStatus = null;
    
    // Poll every 2 seconds
    statusPollInterval = setInterval(() => {
        $.get(`/pages/${pageId}/test-status`, function(data) {
            updateStatusBadge(data.status);
            
            // Check if test just completed (transitioned to tested/error)
            if ((data.status === 'tested' || data.status === 'error') && 
                previousStatus !== null && 
                previousStatus !== 'tested' && 
                previousStatus !== 'error') {
                
                // Test just completed - reload page to show new results
                stopStatusPolling();
                
                // Show notification before reload
                if (window.showNotification) {
                    showNotification('Test Complete', 'Refreshing page to show results...', 'success');
                }
                
                // Reload after a short delay to show the notification
                setTimeout(() => location.reload(), 1500);
            }
            // Stop polling if already in final state
            else if (data.status === 'tested' || data.status === 'error') {
                stopStatusPolling();
            }
            
            previousStatus = data.status;
        }).fail(function() {
            console.error('Failed to check test status');
        });
    }, 2000);
}

function stopStatusPolling() {
    if (statusPollInterval) {
        clearInterval(statusPollInterval);
        statusPollInterval = null;
    }
    testInProgress = false;
}

function testPage(pageId) {
    // Disable test button
    const testBtn = document.querySelector('button[onclick*="testPage"]');
    if (testBtn) {
        testBtn.disabled = true;
        testBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span> Starting Test...';
    }
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('testModal'));
    modal.show();
    
    testInProgress = true;
    
    // Run test
    $.post(`/pages/${pageId}/test`, function(data) {
        if (data.success) {
            // Hide modal
            modal.hide();
            
            // Update status immediately
            updateStatusBadge('queued');
            
            // Add to global tracking
            const pageTitle = '{{ page.title or page.url }}';
            if (typeof trackPageTest !== 'undefined') {
                trackPageTest(pageId, pageTitle);
            }
            
            // Start polling for status updates
            startStatusPolling(pageId);
            
            // Show progress notification
            if (window.showNotification) {
                showNotification('Test started', 'The accessibility test is running. The page will refresh when complete.', 'info');
            }
        } else {
            modal.hide();
            alert('Test failed: ' + (data.error || 'Unknown error'));
            
            // Re-enable button
            if (testBtn) {
                testBtn.disabled = false;
                testBtn.innerHTML = '<i class="bi bi-play"></i> Run Test';
            }
        }
    }).fail(function() {
        modal.hide();
        alert('Failed to start test');
        
        // Re-enable button
        if (testBtn) {
            testBtn.disabled = false;
            testBtn.innerHTML = '<i class="bi bi-play"></i> Run Test';
        }
    });
}

// Check if page is currently testing on load
document.addEventListener('DOMContentLoaded', function() {
    const pageStatus = '{{ page.status.value }}';
    const pageId = '{{ page.id }}';
    
    // Initialize Bootstrap tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // If page is queued or testing, start polling
    if (pageStatus === 'queued' || pageStatus === 'testing') {
        console.log('Page is currently being tested, starting status polling...');
        // Show the progress alert
        document.getElementById('test-progress-alert').classList.remove('d-none');
        startStatusPolling(pageId);
    }
});

// Clean up on page unload
window.addEventListener('beforeunload', function() {
    stopStatusPolling();
});
</script>

<!-- Include the issue filtering script -->
<script src="{{ url_for('static', filename='js/issue-filters.js') }}"></script>
<!-- Include the help system -->
<script src="{{ url_for('static', filename='js/help-system.js') }}"></script>
{% endblock %}