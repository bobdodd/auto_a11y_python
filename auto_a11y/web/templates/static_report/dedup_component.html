<!DOCTYPE html>
<html lang="{{ language }}" data-current-lang="{{ language }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="component_deduplicated_issues">{{ t['component_deduplicated_issues'] }}: {{ component_type }}: {{ component_label }}</title>
    <style>
    /* Bootstrap CSS */
    {{ bootstrap_css|safe }}
    </style>
    <style>
    /* Bootstrap Icons CSS */
    {{ bootstrap_icons_css|safe }}
    </style>
    <style>
    .component-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }

    .component-header.navigation { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .component-header.header { background: linear-gradient(135deg, #8e2de2 0%, #4a00e0 100%); }
    .component-header.footer { background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); }
    .component-header.form { background: linear-gradient(135deg, #f77062 0%, #fe5196 100%); }
    .component-header.aside { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
    .component-header.section { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }
    .component-header.none { background: linear-gradient(135deg, #757F9A 0%, #D7DDE8 100%); }

    .back-link {
        color: white;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        opacity: 0.9;
    }

    .back-link:hover {
        opacity: 1;
        text-decoration: underline;
    }

    .component-meta {
        display: flex;
        gap: 2rem;
        margin-top: 1rem;
        font-size: 0.95rem;
    }

    /* Issue Cards */
    .issue-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        overflow: hidden;
    }

    .issue-header {
        padding: 1.25rem;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: start;
        gap: 1rem;
    }

    .issue-title {
        flex: 1;
    }

    .issue-code {
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        color: #0d6efd;
        font-weight: 600;
    }

    .issue-description {
        font-size: 1.1rem;
        font-weight: 500;
        margin: 0.25rem 0 0.5rem 0;
    }

    .issue-badges {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .impact-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .impact-badge.critical, .impact-badge.high, .impact-badge.serious {
        background-color: #f8d7da;
        color: #842029;
    }

    .impact-badge.moderate, .impact-badge.medium {
        background-color: #fff3cd;
        color: #856404;
    }

    .impact-badge.low, .impact-badge.minor {
        background-color: #cfe2ff;
        color: #084298;
    }

    .type-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .type-badge.violation { background-color: #dc3545; color: white; }
    .type-badge.warning { background-color: #ffc107; color: #000; }
    .type-badge.info { background-color: #0dcaf0; color: #000; }

    .issue-body {
        padding: 1.25rem;
    }

    .issue-section {
        margin-bottom: 1.5rem;
    }

    .issue-section h6 {
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: #495057;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .wcag-links {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .wcag-link {
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        background: #e7f1ff;
        color: #004085;
        text-decoration: none;
        font-size: 0.875rem;
    }

    .wcag-link:hover {
        background: #cfe2ff;
    }

    .pages-list {
        background: #f8f9fa;
        border-radius: 4px;
        padding: 1rem;
    }

    .page-item {
        padding: 0.5rem;
        border-bottom: 1px solid #dee2e6;
        font-size: 0.9rem;
    }

    .page-item:last-child {
        border-bottom: none;
    }

    .page-item i {
        color: #6c757d;
        margin-right: 0.5rem;
    }

    .test-users {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .user-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        background: #e2e3e5;
        color: #383d41;
        font-size: 0.875rem;
    }

    .no-issues {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }

    .touchpoint-header {
        background-color: #f8f9fa;
        padding: 8px;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
        padding-left: 0.5rem;
    }

    /* Language Switcher */
    .lang-switcher {
        display: inline-flex;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        padding: 4px;
        gap: 4px;
    }

    .lang-switcher button {
        padding: 6px 14px;
        border: none;
        background: transparent;
        cursor: pointer;
        border-radius: 4px;
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.2s;
        color: rgba(255, 255, 255, 0.8);
    }

    .lang-switcher button:hover {
        background: rgba(255, 255, 255, 0.3);
        color: white;
    }

    .lang-switcher button.active {
        background: rgba(255, 255, 255, 0.9);
        color: #0d6efd;
    }

    .lang-inactive {
        display: none !important;
    }

    .lang-active {
        display: block;
    }

    span.lang-active {
        display: inline;
    }
    </style>
</head>
<body>
<div class="container py-4">
    <!-- Component Header with Language Switcher -->
    <div class="component-header {{ component_type|lower }}">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <a href="../index.html" class="back-link">
                <i class="bi bi-arrow-left"></i> <span data-i18n="back_to_index">{{ t['back_to_index'] }}</span>
            </a>
            <div class="lang-switcher">
                <button onclick="switchLanguage('en')" id="lang-en" class="{{ 'active' if language == 'en' else '' }}" aria-label="Switch to English">EN</button>
                <button onclick="switchLanguage('fr')" id="lang-fr" class="{{ 'active' if language == 'fr' else '' }}" aria-label="Switch to French">FR</button>
            </div>
        </div>
        <h1 class="h2 mb-0"><span data-i18n="{{ component_type|lower }}">{{ t.get(component_type|lower, component_type) }}</span>: {{ component_label }}</h1>
        <div class="component-meta">
            <span><i class="bi bi-file-earmark"></i> <span data-i18n="found_on">{{ t['found_on'] }}</span> {{ page_count }} <span data-i18n="page_s">{{ t['page_s'] }}</span></span>
            <span><i class="bi bi-bug"></i> {{ total_issues }} <span data-i18n="deduplicated_issue_s">{{ t['deduplicated_issue_s'] }}</span></span>
            {% if component_score is defined %}
            <span><i class="bi bi-graph-up"></i> <span data-i18n="accessibility_score">{{ t['accessibility_score'] }}</span>:
                <strong class="{% if component_score >= 90 %}text-success{% elif component_score >= 70 %}text-warning{% else %}text-danger{% endif %}">
                    {{ "%.1f"|format(component_score) }}%
                </strong>
            </span>
            {% endif %}
        </div>
    </div>

    <!-- Issues List -->
    {% if issues %}
        <div class="accordion" id="issuesAccordion">
        {% set issue_counter = namespace(value=0) %}
        {% for touchpoint, touchpoint_issues in issues|groupby('touchpoint') %}
            <!-- Touchpoint Header -->
            {% set border_color = {'violation': '#dc3545', 'warning': '#ffc107', 'info': '#0dcaf0'}[touchpoint_issues[0].type] or '#dc3545' %}
            {% set touchpoint_key = touchpoint|replace('_', ' ')|lower if touchpoint else 'general' %}
            <div class="touchpoint-header mt-3 mb-2 ps-2" style="border-left: 4px solid {{ border_color }};">
                <strong data-i18n="{{ touchpoint_key }}">{{ t.get(touchpoint_key, touchpoint|replace('_', ' ')|title if touchpoint else 'General') }}</strong>
            </div>

            {% for issue in touchpoint_issues %}
            {% set issue_counter.value = issue_counter.value + 1 %}
            {% set issue_id = issue_counter.value %}
            <div class="accordion-item mb-3">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#issue-{{ issue_id }}">
                        {% set impact_lower = issue.impact|lower %}
                        <span class="badge bg-{{ {'critical': 'danger', 'high': 'danger', 'serious': 'danger', 'moderate': 'warning', 'medium': 'warning', 'minor': 'info', 'low': 'info'}[impact_lower] or 'secondary' }} me-2 impact-badge" data-i18n="{{ impact_lower }}">
                            {{ t.get(impact_lower, issue.impact|upper) }}
                        </span>
                        <code class="me-2">{{ issue.rule_id }}</code>
                        {% if issue.description %}
                            {{ issue.description }}
                        {% endif %}
                        <span class="badge bg-secondary ms-auto me-2">{{ issue.page_count }} <span data-i18n="page_s">{{ t['page_s'] }}</span></span>
                        {% if issue.test_users %}
                        {% for user in issue.test_users %}
                        <span class="badge bg-secondary ms-1">
                            <i class="bi bi-person-fill"></i> {{ user }}
                            {% if issue.user_roles %}
                            ({% for role in issue.user_roles %}<span data-i18n="{{ role|lower }}">{{ t.get(role|lower, role) }}</span>{% if not loop.last %}, {% endif %}{% endfor %})
                            {% endif %}
                        </span>
                        {% endfor %}
                        {% endif %}
                    </button>
                </h2>
                <div id="issue-{{ issue_id }}" class="accordion-collapse collapse" data-bs-parent="#issuesAccordion">
                <div class="accordion-body">
                    {% set alert_type = {'violation': 'danger', 'warning': 'warning', 'info': 'info'}[issue.type] or 'secondary' %}

                    <!-- Issue Type Alert -->
                    <div class="alert alert-{{ alert_type }}">
                        <h6 class="alert-heading">
                            <span data-lang="en" style="display: {{ 'block' if language == 'en' else 'none' }}">{{ issue.description_en }}</span>
                            <span data-lang="fr" style="display: {{ 'block' if language == 'fr' else 'none' }}">{{ issue.description_fr }}</span>
                        </h6>
                    </div>

                    <h6 class="text-{{ alert_type }} mb-2" data-i18n="about_this_issue">{{ t['about_this_issue'] }}</h6>

                    <!-- What -->
                    <div class="mb-3">
                        <strong data-i18n="what_the_issue_is">{{ t['what_the_issue_is'] }}</strong>
                        <p data-lang="en" style="display: {{ 'block' if language == 'en' else 'none' }}">{{ issue.description_en }}</p>
                        <p data-lang="fr" style="display: {{ 'block' if language == 'fr' else 'none' }}">{{ issue.description_fr }}</p>
                    </div>

                    <!-- Why -->
                    {% if issue.why_en or issue.why_fr %}
                    <div class="mb-3">
                        <strong data-i18n="why_this_is_important">{{ t['why_this_is_important'] }}</strong>
                        {% if issue.why_en %}<p data-lang="en" style="display: {{ 'block' if language == 'en' else 'none' }}">{{ issue.why_en }}</p>{% endif %}
                        {% if issue.why_fr %}<p data-lang="fr" style="display: {{ 'block' if language == 'fr' else 'none' }}">{{ issue.why_fr }}</p>{% endif %}
                    </div>
                    {% endif %}

                    <!-- Who -->
                    {% if issue.who_en or issue.who_fr %}
                    <div class="mb-3">
                        <strong data-i18n="who_it_affects">{{ t['who_it_affects'] }}</strong>
                        {% if issue.who_en %}<p data-lang="en" style="display: {{ 'block' if language == 'en' else 'none' }}">{{ issue.who_en }}</p>{% endif %}
                        {% if issue.who_fr %}<p data-lang="fr" style="display: {{ 'block' if language == 'fr' else 'none' }}">{{ issue.who_fr }}</p>{% endif %}
                    </div>
                    {% endif %}

                    <!-- How to Fix -->
                    {% if issue.full_remediation_en or issue.full_remediation_fr %}
                    <div class="mb-3">
                        <strong data-i18n="how_to_remediate">{{ t['how_to_remediate'] }}</strong>
                        {% if issue.full_remediation_en %}<div data-lang="en" class="bg-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace; display: {{ 'block' if language == 'en' else 'none' }}">{{ issue.full_remediation_en }}</div>{% endif %}
                        {% if issue.full_remediation_fr %}<div data-lang="fr" class="bg-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace; display: {{ 'block' if language == 'fr' else 'none' }}">{{ issue.full_remediation_fr }}</div>{% endif %}
                    </div>
                    {% endif %}

                    <!-- WCAG Criteria -->
                    {% if issue.wcag_full %}
                    <h6 class="text-{{ alert_type }} mb-2 mt-4" data-i18n="relevant_test_criteria">{{ t['relevant_test_criteria'] }}</h6>
                    <div class="mb-3">
                        <strong data-i18n="wcag_success_criteria">{{ t['wcag_success_criteria'] }}</strong>
                        <ul>
                        {% for criterion in issue.wcag_full %}
                            <li>{{ criterion|safe }}</li>
                        {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <hr>

                    <!-- Touchpoint and Impact -->
                    <div class="row">
                        <div class="col-md-6">
                            {% if issue.touchpoint %}
                            <p><strong data-i18n="touchpoint">{{ t['touchpoint'] }}</strong> {{ issue.touchpoint|replace('_', ' ')|title }}</p>
                            {% endif %}
                            <p><strong data-i18n="impact">{{ t['impact'] }}</strong>
                                {% set impact_lower = issue.impact|lower %}
                                <span class="badge bg-{{ {'critical': 'danger', 'high': 'danger', 'serious': 'danger', 'moderate': 'warning', 'medium': 'warning', 'minor': 'info', 'low': 'info'}[impact_lower] or 'secondary' }} impact-badge" data-i18n="{{ impact_lower }}">
                                    {{ t.get(impact_lower, issue.impact|upper) }}
                                </span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <!-- WCAG Links -->
                            {% if issue.wcag_full %}
                                {% for criterion in issue.wcag_full|sort %}
                                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-left: 3px solid #0066cc;">
                                    <p style="margin: 0 0 8px 0; font-weight: bold;">
                                        WCAG {{ criterion|safe }}
                                    </p>

                                    {% set criterion_code = criterion.split()[0] %}
                                    <p style="margin: 0 0 5px 0;">
                                        <a href="https://www.w3.org/WAI/WCAG22/Understanding/{{ criterion_code }}" target="_blank">
                                            <span data-i18n="more_about">{{ t['more_about'] }}</span> {{ criterion_code }} <i class="bi bi-box-arrow-up-right"></i>
                                        </a>
                                    </p>
                                    <p style="margin: 0;">
                                        <a href="https://www.w3.org/WAI/WCAG22/quickref/#{{ criterion_code }}" target="_blank">
                                            <span data-i18n="ways_to_meet">{{ t['ways_to_meet'] }}</span> {{ criterion_code }} <i class="bi bi-box-arrow-up-right"></i>
                                        </a>
                                    </p>
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>

                    <!-- Affected Pages -->
                    <hr>
                    <div class="mb-3">
                        <strong data-i18n="affected_pages">{{ t['affected_pages'] }}</strong> ({{ issue.page_count }}):
                        <div class="mt-2">
                            <details>
                                <summary class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-chevron-down"></i> <span data-i18n="show_all">{{ t['show_all'] }}</span> {{ issue.page_count }} <span data-i18n="page_s">{{ t['page_s'] }}</span>
                                </summary>
                                <div class="mt-2 p-3 bg-light rounded">
                                    {% for page_url in issue.pages %}
                                    <div class="mb-2">
                                        <i class="bi bi-file-earmark-text text-muted"></i> <code>{{ page_url }}</code>
                                    </div>
                                    {% endfor %}
                                </div>
                            </details>
                        </div>
                    </div>

                    <!-- Element Details -->
                    {% if issue.element or issue.xpath %}
                    <hr>
                    <h6 class="text-{{ alert_type }} mb-2" data-i18n="element_details">{{ t['element_details'] }}</h6>
                    {% if issue.element %}
                    <p><strong data-i18n="element">{{ t['element'] }}</strong> <code>{{ issue.element }}</code></p>
                    {% endif %}
                    {% if issue.xpath %}
                    <p><strong>XPath:</strong></p>
                    <div class="bg-light p-2 rounded" style="font-family: monospace; font-size: 0.875rem; overflow-x: auto;">
                        {{ issue.xpath }}
                    </div>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %} {# End issue loop #}
        {% endfor %} {# End touchpoint loop #}
        </div>
    {% else %}
        <div class="no-issues">
            <i class="bi bi-check-circle" style="font-size: 3rem; opacity: 0.3;"></i>
            <p class="mt-3" data-i18n="no_issues_found">{{ t['no_issues_found'] }}</p>
        </div>
    {% endif %}
</div>

<script>
/* Bootstrap JS */
{{ bootstrap_js|safe }}
</script>
<script>
// All translations embedded in the report
const translations = {{ translations_json|safe }};

// Check localStorage for saved language preference, fallback to server language
let currentLang = localStorage.getItem('reportLanguage') || '{{ language }}';

// Language switching
function switchLanguage(lang) {
    currentLang = lang;

    // Save preference to localStorage
    localStorage.setItem('reportLanguage', lang);

    // Update active button
    document.querySelectorAll('.lang-switcher button').forEach(btn => {
        btn.classList.remove('active');
    });
    document.getElementById(`lang-${lang}`).classList.add('active');

    // Update HTML lang attribute
    document.documentElement.lang = lang;
    document.documentElement.setAttribute('data-current-lang', lang);

    // Update all elements with data-i18n attribute
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (translations[lang] && translations[lang][key]) {
            element.textContent = translations[lang][key];
        }
    });

    // Toggle visibility of language-specific content
    document.querySelectorAll('[data-lang]').forEach(element => {
        const elementLang = element.getAttribute('data-lang');
        element.style.display = (elementLang === lang) ? 'block' : 'none';
    });

    // Update document title
    if (translations[lang] && translations[lang]['component_deduplicated_issues']) {
        document.title = translations[lang]['component_deduplicated_issues'] + ': {{ component_type }}: {{ component_label }}';
    }
}

// Apply saved language on page load
if (currentLang !== '{{ language }}') {
    switchLanguage(currentLang);
}
</script>
</body>
</html>
