{% extends "base.html" %}

{% block title %}{{ _('Create Page Setup Script - Auto A11y') }}{% endblock %}

{% block extra_css %}
<style>
    .step-card {
        border-left: 4px solid #0d6efd;
        margin-bottom: 1rem;
    }
    .step-header {
        background-color: #f8f9fa;
        padding: 0.75rem 1rem;
        cursor: move;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .step-number {
        background-color: #0d6efd;
        color: white;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }
    .selector-help {
        font-size: 0.875rem;
        color: #6c757d;
    }
    .form-section {
        background-color: #f8f9fa;
        padding: 1.5rem;
        border-radius: 0.375rem;
        margin-bottom: 1.5rem;
    }
    .form-section h5 {
        color: #0d6efd;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{{ url_for('projects.view_project', project_id=project.id) }}">{{ project.name }}</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{{ url_for('websites.view_website', website_id=website.id) }}">{{ website.display_name }}</a>
            </li>
            {% if page %}
            <li class="breadcrumb-item">
                <a href="{{ url_for('pages.view_page', page_id=page.id) }}">{{ page.title or _('Page') }}</a>
            </li>
            {% endif %}
            <li class="breadcrumb-item active" aria-current="page">{{ _('Create %(type)s Script', type=(_('Website') if is_website_script else _('Page'))) }}</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-lg-10 col-xl-8">
            <h1 class="h2 mb-4">
                <i class="bi bi-code-square"></i> {{ _('Create %(level)s Setup Script', level=(_('Website-Level') if is_website_script else _('Page-Level'))) }}
            </h1>

            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                {% if is_website_script %}
                <strong>{{ _('What are Website-Level Scripts?') }}</strong><br>
                {{ _('Scripts that run for <strong>all pages</strong> in this website (e.g., dismiss cookie banners, handle login). Perfect for cookie notices that appear across the entire site!') }}
                {% else %}
                <strong>{{ _('What are Page-Level Scripts?') }}</strong><br>
                {{ _('Scripts that prepare a <strong>specific page</strong> for testing (e.g., open modals, navigate tabs).') }}
                {% endif %}
                {{ _('With <strong>multi-state testing</strong>, you can test pages both before and after the script runs.') }}
            </div>

            <form method="POST" id="script-form">

                <!-- Basic Information -->
                <div class="form-section">
                    <h5><i class="bi bi-info-circle"></i> {{ _('Basic Information') }}</h5>

                    <div class="mb-3">
                        <label for="name" class="form-label">{{ _('Script Name') }} <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="name" name="name" required
                               placeholder="{{ _('e.g., Dismiss Cookie Banner') }}">
                        <div class="form-text">{{ _('A descriptive name for this script') }}</div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">{{ _('Description') }}</label>
                        <textarea class="form-control" id="description" name="description" rows="2"
                                  placeholder="{{ _('Optional: Describe what this script does') }}"></textarea>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="enabled" name="enabled" checked>
                        <label class="form-check-label" for="enabled">
                            <strong>{{ _('Script Enabled') }}</strong>
                        </label>
                        <div class="form-text">{{ _('Uncheck to disable this script without deleting it') }}</div>
                    </div>
                </div>

                <!-- Multi-State Testing Configuration -->
                <div class="form-section">
                    <h5><i class="bi bi-layers"></i> {{ _('Multi-State Testing') }}</h5>

                    <div class="alert alert-success">
                        <i class="bi bi-lightbulb"></i>
                        <strong>{{ _('Example:') }}</strong> {{ _('For a cookie banner, check both boxes to test the page WITH the banner (before), then dismiss it, then test WITHOUT the banner (after). This creates 2 test results showing the difference.') }}
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="test_before_execution" name="test_before_execution">
                        <label class="form-check-label" for="test_before_execution">
                            <strong>{{ _('Test BEFORE executing script') }}</strong>
                        </label>
                        <div class="form-text">
                            <i class="bi bi-check-circle text-success"></i>
                            {{ _('Recommended for cookie banners, modals, and any element you want to test before dismissing') }}
                        </div>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="test_after_execution" name="test_after_execution" checked>
                        <label class="form-check-label" for="test_after_execution">
                            <strong>{{ _('Test AFTER executing script') }}</strong>
                        </label>
                        <div class="form-text">
                            <i class="bi bi-check-circle text-success"></i>
                            {{ _('Usually checked - test the page in its final state after setup') }}
                        </div>
                    </div>
                </div>

                <!-- Script Scope (only show for website scripts) -->
                {% if scope_options and scope_options|length > 1 %}
                <div class="form-section">
                    <h5><i class="bi bi-diagram-3"></i> {{ _('Script Scope') }}</h5>

                    <div class="mb-3">
                        <label for="scope" class="form-label">{{ _('Script Applies To:') }}</label>
                        <select class="form-select" id="scope" name="scope" disabled>
                            {% for option in scope_options %}
                            <option value="{{ option.value }}" selected>
                                {{ option.label }} - {{ option.description }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            {% if is_website_script %}
                            <i class="bi bi-globe"></i> <strong>{{ _('Website-Level:') }}</strong> {{ _('This script will run for all pages in the website') }}
                            {% else %}
                            <i class="bi bi-file-text"></i> <strong>{{ _('Page-Level:') }}</strong> {{ _('This script only runs on this specific page') }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Execution Trigger -->
                <div class="form-section">
                    <h5><i class="bi bi-play-circle"></i> {{ _('Execution Trigger') }}</h5>

                    <div class="mb-3">
                        <label for="trigger" class="form-label">{{ _('When should this script run?') }}</label>
                        <select class="form-select" id="trigger" name="trigger">
                            {% for option in trigger_options %}
                            <option value="{{ option.value }}"
                                    {% if (is_website_script and option.value == 'once_per_session') or (not is_website_script and option.value == 'always') %}selected{% endif %}
                                    data-description="{{ option.description }}">
                                {{ option.label }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text" id="trigger-help">
                            {{ _('Select when this script should execute during testing') }}
                        </div>
                    </div>

                    <!-- Conditional selector (shown when trigger is 'conditional') -->
                    <div class="mb-3" id="conditional-section" style="display: none;">
                        <label for="condition_selector" class="form-label">{{ _('Conditional Selector') }}</label>
                        <input type="text" class="form-control font-monospace" id="condition_selector" name="condition_selector"
                               placeholder=".cookie-banner, #cookie-notice">
                        <div class="form-text">{{ _('Script will only run if this element exists on the page') }}</div>

                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="wait_for_selector" name="wait_for_selector">
                            <label class="form-check-label" for="wait_for_selector">
                                {{ _('Wait for element to appear') }}
                            </label>
                        </div>

                        <div class="mt-2" id="wait-timeout-section" style="display: none;">
                            <label for="wait_timeout" class="form-label">{{ _('Wait Timeout (ms)') }}</label>
                            <input type="number" class="form-control" id="wait_timeout" name="wait_timeout" value="5000" min="0" max="30000">
                            <div class="form-text">{{ _('Maximum time to wait for element (milliseconds)') }}</div>
                        </div>
                    </div>
                </div>

                <!-- Clean State Options (especially useful for website-level scripts) -->
                {% if is_website_script %}
                <div class="form-section">
                    <h5><i class="bi bi-trash"></i> {{ _('Clean State Options') }}</h5>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        {{ _('Clear cookies and storage before testing to ensure a clean starting state') }}
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="clear_cookies_before" name="clear_cookies_before">
                        <label class="form-check-label" for="clear_cookies_before">
                            <strong>{{ _('Clear Cookies Before Script') }}</strong>
                        </label>
                        <div class="form-text">
                            <i class="bi bi-check-circle text-success"></i>
                            {{ _('Recommended for cookie banner testing - ensures banner appears') }}
                        </div>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="clear_local_storage_before" name="clear_local_storage_before">
                        <label class="form-check-label" for="clear_local_storage_before">
                            <strong>{{ _('Clear Local Storage Before Script') }}</strong>
                        </label>
                        <div class="form-text">
                            {{ _('Clear localStorage and sessionStorage before running') }}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- State Validation -->
                <div class="form-section">
                    <h5><i class="bi bi-check2-square"></i> {{ _('State Validation (Optional)') }}</h5>

                    <p class="text-muted">
                        {{ _('Specify elements that should be visible or hidden after the script runs. The system will report violations if expectations aren\'t met.') }}
                    </p>

                    <div class="mb-3">
                        <label for="expect_visible_after" class="form-label">
                            {{ _('Elements That Should Be <strong>Visible</strong> After Script') }}
                        </label>
                        <textarea class="form-control font-monospace" id="expect_visible_after" name="expect_visible_after" rows="3"
                                  placeholder=".modal-dialog&#10;#settings-panel&#10;//*[@id='modal']"></textarea>
                        <div class="form-text">{{ _('CSS selectors or XPath, one per line. Example: After opening a modal, you\'d expect ".modal-dialog" to be visible') }}</div>
                    </div>

                    <div class="mb-3">
                        <label for="expect_hidden_after" class="form-label">
                            {{ _('Elements That Should Be <strong>Hidden</strong> After Script') }}
                        </label>
                        <textarea class="form-control font-monospace" id="expect_hidden_after" name="expect_hidden_after" rows="3"
                                  placeholder=".cookie-banner&#10;#cookie-notice&#10;//*[@id='cookie-banner']"></textarea>
                        <div class="form-text">{{ _('CSS selectors or XPath, one per line. Example: After dismissing cookies, you\'d expect ".cookie-banner" to be hidden') }}</div>
                    </div>
                </div>

                <!-- Script Steps -->
                <div class="form-section">
                    <h5><i class="bi bi-list-ol"></i> {{ _('Script Steps') }}</h5>

                    <p class="text-muted">
                        {{ _('Define the actions to perform. Steps execute in order from top to bottom.') }}
                    </p>

                    <div id="steps-container">
                        <!-- Steps will be added here dynamically -->
                    </div>

                    <button type="button" class="btn btn-outline-primary" onclick="addStep()">
                        <i class="bi bi-plus-circle"></i> {{ _('Add Step') }}
                    </button>
                </div>

                <!-- Form Actions -->
                <div class="d-flex justify-content-between mt-4">
                    <a href="{{ url_for('scripts.list_page_scripts', page_id=page.id) }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> {{ _('Cancel') }}
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> {{ _('Create Script') }}
                    </button>
                </div>

            </form>
        </div>

        <!-- Help Sidebar -->
        <div class="col-lg-2 col-xl-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <i class="bi bi-question-circle"></i> {{ _('Quick Help') }}
                </div>
                <div class="card-body">
                    <h6>{{ _('Common Selectors') }}</h6>
                    <ul class="small">
                        <li><code>.cookie-banner</code> - {{ _('Class name') }}</li>
                        <li><code>#accept-btn</code> - {{ _('ID') }}</li>
                        <li><code>button[data-action="accept"]</code> - {{ _('Attribute') }}</li>
                        <li><code>.modal .close-button</code> - {{ _('Nested') }}</li>
                    </ul>

                    <h6>{{ _('Step Types') }}</h6>
                    <ul class="small">
                        <li><strong>{{ _('Click:') }}</strong> {{ _('Click a button/link') }}</li>
                        <li><strong>{{ _('Type:') }}</strong> {{ _('Enter text in field') }}</li>
                        <li><strong>{{ _('Wait for Element:') }}</strong> {{ _('Wait until element appears') }}</li>
                        <li><strong>{{ _('Wait (Fixed):') }}</strong> {{ _('Pause for X milliseconds') }}</li>
                    </ul>

                    <h6>{{ _('Examples') }}</h6>
                    <p class="small"><strong>{{ _('Cookie Banner:') }}</strong></p>
                    <ol class="small">
                        <li>{{ _('Wait for:') }} <code>.cookie-banner</code></li>
                        <li>{{ _('Click:') }} <code>.accept-button</code></li>
                    </ol>

                    <p class="small"><strong>{{ _('Modal:') }}</strong></p>
                    <ol class="small">
                        <li>{{ _('Click:') }} <code>#open-modal</code></li>
                        <li>{{ _('Wait for:') }} <code>.modal-dialog</code></li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let stepCount = 0;
const actionTypes = {{ action_types | tojson }};

function addStep(stepData = null) {
    const stepIndex = stepCount++;
    const stepNum = stepIndex + 1;

    const stepHtml = `
        <div class="card step-card" id="step-${stepIndex}" data-step-index="${stepIndex}">
            <div class="step-header">
                <div>
                    <span class="step-number">${stepNum}</span>
                    <span class="ms-2"><strong>{{ _('Step') }} ${stepNum}</strong></span>
                </div>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeStep(${stepIndex})">
                        <i class="bi bi-trash"></i> {{ _('Remove') }}
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">{{ _('Action Type') }} <span class="text-danger">*</span></label>
                        <select class="form-select" name="step_${stepIndex}_action" id="step_${stepIndex}_action"
                                onchange="updateStepFields(${stepIndex})" required>
                            <option value="">{{ _('-- Select Action --') }}</option>
                            ${actionTypes.map(type => `
                                <option value="${type.value}" ${stepData && stepData.action === type.value ? 'selected' : ''}>
                                    ${type.label}
                                </option>
                            `).join('')}
                        </select>
                    </div>

                    <div class="col-md-8 mb-3" id="step_${stepIndex}_selector_container">
                        <label class="form-label">{{ _('Selector (CSS or XPath)') }}</label>
                        <input type="text" class="form-control font-monospace" name="step_${stepIndex}_selector"
                               id="step_${stepIndex}_selector"
                               placeholder="//*[@id='element-id'] or .cookie-banner or button[data-action='accept']">
                        <small class="form-text text-muted selector-help">
                            {{ _('CSS selector or XPath (XPath must start with / or //)') }}
                        </small>
                    </div>
                </div>

                <div class="row" id="step_${stepIndex}_value_row" style="display: none;">
                    <div class="col-12 mb-3">
                        <label class="form-label">{{ _('Value') }}</label>
                        <input type="text" class="form-control" name="step_${stepIndex}_value"
                               id="step_${stepIndex}_value"
                               placeholder="{{ _('Text to type or value to set') }}">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label class="form-label">{{ _('Description (Optional)') }}</label>
                        <input type="text" class="form-control" name="step_${stepIndex}_description"
                               id="step_${stepIndex}_description"
                               placeholder="{{ _('e.g., Wait for cookie banner to appear') }}">
                    </div>

                    <div class="col-md-2 mb-3">
                        <label class="form-label">{{ _('Timeout (ms)') }}</label>
                        <input type="number" class="form-control" name="step_${stepIndex}_timeout"
                               value="${stepData ? stepData.timeout || 5000 : 5000}" min="0" step="100">
                    </div>

                    <div class="col-md-2 mb-3">
                        <label class="form-label">{{ _('Wait After (ms)') }}</label>
                        <input type="number" class="form-control" name="step_${stepIndex}_wait_after"
                               value="${stepData ? stepData.wait_after || 0 : 0}" min="0" step="100">
                    </div>
                </div>
            </div>
        </div>
    `;

    document.getElementById('steps-container').insertAdjacentHTML('beforeend', stepHtml);

    // Set field values using DOM manipulation (safer than template literals for user input with special chars)
    if (stepData) {
        if (stepData.selector) {
            document.getElementById(`step_${stepIndex}_selector`).value = stepData.selector;
        }
        if (stepData.value) {
            document.getElementById(`step_${stepIndex}_value`).value = stepData.value;
        }
        if (stepData.description) {
            document.getElementById(`step_${stepIndex}_description`).value = stepData.description;
        }
    }

    // Update field visibility if step data provided
    if (stepData && stepData.action) {
        updateStepFields(stepIndex);
    }
}

function removeStep(stepIndex) {
    const step = document.getElementById(`step-${stepIndex}`);
    if (step) {
        step.remove();
        renumberSteps();
    }
}

function renumberSteps() {
    const steps = document.querySelectorAll('.step-card');
    steps.forEach((step, index) => {
        const stepNum = index + 1;
        step.querySelector('.step-number').textContent = stepNum;
        step.querySelector('.step-header strong').textContent = `{{ _('Step') }} ${stepNum}`;
    });
}

function updateStepFields(stepIndex) {
    const actionSelect = document.getElementById(`step_${stepIndex}_action`);
    const action = actionSelect.value;

    const selectorContainer = document.getElementById(`step_${stepIndex}_selector_container`);
    const valueRow = document.getElementById(`step_${stepIndex}_value_row`);
    const selectorInput = document.getElementById(`step_${stepIndex}_selector`);

    // Show/hide selector based on action type
    const noSelectorActions = ['wait', 'wait_for_network_idle'];
    if (noSelectorActions.includes(action)) {
        selectorContainer.style.display = 'none';
        selectorInput.required = false;
    } else {
        selectorContainer.style.display = 'block';
        selectorInput.required = true;
    }

    // Show/hide value field for type and select actions
    const valueActions = ['type', 'select'];
    if (valueActions.includes(action)) {
        valueRow.style.display = 'flex';
    } else {
        valueRow.style.display = 'none';
    }
}

// Handle trigger selection changes
document.getElementById('trigger').addEventListener('change', function() {
    const conditionalSection = document.getElementById('conditional-section');
    const triggerHelp = document.getElementById('trigger-help');
    const selectedOption = this.options[this.selectedIndex];
    const description = selectedOption.getAttribute('data-description');

    if (description) {
        triggerHelp.textContent = description;
    }

    // Show conditional section if trigger is 'conditional'
    if (this.value === 'conditional') {
        conditionalSection.style.display = 'block';
    } else {
        conditionalSection.style.display = 'none';
    }
});

// Handle wait_for_selector checkbox
document.getElementById('wait_for_selector').addEventListener('change', function() {
    const waitTimeoutSection = document.getElementById('wait-timeout-section');
    waitTimeoutSection.style.display = this.checked ? 'block' : 'none';
});

// Add initial step on page load
document.addEventListener('DOMContentLoaded', function() {
    // Add first step by default
    addStep();

    // Initialize trigger help text
    const triggerSelect = document.getElementById('trigger');
    const selectedOption = triggerSelect.options[triggerSelect.selectedIndex];
    const description = selectedOption.getAttribute('data-description');
    if (description) {
        document.getElementById('trigger-help').textContent = description;
    }

    // Check if trigger is conditional on load
    if (triggerSelect.value === 'conditional') {
        document.getElementById('conditional-section').style.display = 'block';
    }
});

// Form validation
document.getElementById('script-form').addEventListener('submit', function(e) {
    const steps = document.querySelectorAll('.step-card');
    if (steps.length === 0) {
        e.preventDefault();
        alert('{{ _('Please add at least one step to the script.') }}');
        return false;
    }
});
</script>
{% endblock %}
