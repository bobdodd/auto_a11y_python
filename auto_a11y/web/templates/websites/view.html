{% extends "base.html" %}

{% block title %}{{ website.display_name }} - Auto A11y{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('projects.list_projects') }}">Projects</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('projects.view_project', project_id=project.id) }}">{{ project.name }}</a></li>
            <li class="breadcrumb-item active">{{ website.display_name }}</li>
        </ol>
    </nav>

    <!-- Website Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2">{{ website.display_name }}</h1>
            <p class="text-muted">
                <a href="{{ website.url }}" target="_blank">
                    {{ website.url }} <i class="bi bi-box-arrow-up-right"></i>
                </a>
            </p>
        </div>
        <div>
            <button class="btn btn-success me-2" id="discoverBtn">
                <i class="bi bi-search"></i> Discover Pages
            </button>
            <button class="btn btn-primary me-2" id="testAllBtn">
                <i class="bi bi-play-fill"></i> Test All Pages
            </button>
            <a href="{{ url_for('websites.edit_website', website_id=website.id) }}" class="btn btn-outline-primary">
                <i class="bi bi-pencil"></i> Edit
            </a>
        </div>
    </div>

    <!-- Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Total Pages</h5>
                    <p class="display-6">{{ stats.total_pages }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Tested</h5>
                    <p class="display-6">{{ stats.tested_pages }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Violations</h5>
                    <p class="display-6 text-danger">{{ stats.total_violations }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Warnings</h5>
                    <p class="display-6 text-warning">{{ stats.total_warnings }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Pages Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Pages ({{ pages|length }})</h5>
            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addPageModal">
                <i class="bi bi-plus-circle"></i> Add Page
            </button>
        </div>
        <div class="card-body">
            {% if pages %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>URL</th>
                            <th>Status</th>
                            <th>Violations</th>
                            <th>Warnings</th>
                            <th>Last Tested</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for page in pages %}
                        <tr>
                            <td>
                                <a href="{{ page.url }}" target="_blank" class="text-truncate d-inline-block" style="max-width: 400px;">
                                    {{ page.url }}
                                </a>
                            </td>
                            <td>
                                <span class="badge bg-{{ {
                                    'discovered': 'secondary',
                                    'queued': 'info',
                                    'testing': 'warning',
                                    'tested': 'success',
                                    'error': 'danger',
                                    'skipped': 'secondary'
                                }[page.status.value] }}">
                                    {{ page.status.value|title }}
                                </span>
                            </td>
                            <td>
                                {% if page.violation_count > 0 %}
                                    <span class="text-danger">{{ page.violation_count }}</span>
                                {% else %}
                                    <span class="text-success">0</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if page.warning_count > 0 %}
                                    <span class="text-warning">{{ page.warning_count }}</span>
                                {% else %}
                                    <span class="text-muted">0</span>
                                {% endif %}
                            </td>
                            <td>
                                {{ page.last_tested.strftime('%Y-%m-%d %H:%M') if page.last_tested else 'Never' }}
                            </td>
                            <td>
                                <a href="{{ url_for('pages.view_page', page_id=page.id) }}" 
                                   class="btn btn-sm btn-primary">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <button class="btn btn-sm btn-success" onclick="testPage('{{ page.id }}')">
                                    <i class="bi bi-play"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">No pages discovered yet. Click "Discover Pages" to find pages automatically.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Page Modal -->
<div class="modal fade" id="addPageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Page Manually</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addPageForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="pageUrl" class="form-label">Page URL *</label>
                        <input type="url" class="form-control" id="pageUrl" required 
                               placeholder="https://example.com/page">
                    </div>
                    <div class="mb-3">
                        <label for="priority" class="form-label">Priority</label>
                        <select class="form-select" id="priority">
                            <option value="normal">Normal</option>
                            <option value="high">High</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Page</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    $('#discoverBtn').click(function() {
        $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Discovering...');
        
        $.post("{{ url_for('websites.discover_pages', website_id=website.id) }}", function(data) {
            if (data.success) {
                alert('Page discovery started. This may take a few minutes.');
                setTimeout(function() { location.reload(); }, 2000);
            }
        });
    });
    
    $('#testAllBtn').click(function() {
        if (!confirm('Test all pages? This may take some time.')) return;
        
        $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Queueing...');
        
        $.post("{{ url_for('websites.test_all_pages', website_id=website.id) }}", function(data) {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert(data.message || 'Failed to queue tests');
            }
        });
    });
    
    $('#addPageForm').submit(function(e) {
        e.preventDefault();
        
        $.post("{{ url_for('websites.add_page', website_id=website.id) }}", {
            url: $('#pageUrl').val(),
            priority: $('#priority').val()
        }, function(data) {
            if (data.success) {
                $('#addPageModal').modal('hide');
                location.reload();
            } else {
                alert(data.error || 'Failed to add page');
            }
        });
    });
});

function testPage(pageId) {
    $.post(`/pages/${pageId}/test`, function(data) {
        if (data.success) {
            alert('Page queued for testing');
            location.reload();
        }
    });
}
</script>
{% endblock %}