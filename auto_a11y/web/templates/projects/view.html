{% extends "base.html" %}

{% block title %}{{ project.name }} - {{ _('Auto A11y') }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Project Header -->
    <div class="mb-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-3">
            <div>
                <h1 class="h2 mb-2">
                    {{ project.name }}
                    <span class="badge bg-{{ {'active': 'success', 'paused': 'warning', 'completed': 'info', 'archived': 'secondary'}[project.status.value] }}">
                        {{ project.status.value|title }}
                    </span>
                </h1>
                <p class="text-muted mb-0">{{ project.description or _('No description') }}</p>
            </div>
        </div>
        <!-- Action Buttons - flex wrap for all screen sizes -->
        <div class="d-flex flex-wrap gap-2 mt-3">
            <button type="button" class="btn btn-success" onclick="testAllWebsites()">
                <i class="bi bi-play-fill"></i> {{ _('Test All Websites') }}
            </button>
            <a href="{{ url_for('project_users.list_users', project_id=project.id) }}" class="btn btn-outline-secondary">
                <i class="bi bi-people"></i> {{ _('Test Users') }}
            </a>
            <a href="{{ url_for('project_participants.list_participants', project_id=project.id) }}" class="btn btn-outline-info">
                <i class="bi bi-person-badge"></i> {{ _('Participants') }}
            </a>
            <a href="{{ url_for('automated_tests.project_automated_tests', project_id=project.id) }}" class="btn btn-outline-primary">
                <i class="bi bi-robot"></i> {{ _('Automated Tests') }}
            </a>
            <a href="{{ url_for('projects.edit_project', project_id=project.id) }}" class="btn btn-outline-primary">
                <i class="bi bi-pencil"></i> {{ _('Edit') }}
            </a>
            <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                <i class="bi bi-trash"></i> {{ _('Delete') }}
            </button>
        </div>
    </div>

    <!-- Statistics -->
    <div class="d-flex flex-wrap gap-3 mb-4">
        <div class="card text-center flex-fill" style="min-width: 140px;">
            <div class="card-body py-3">
                <h6 class="card-title text-muted mb-1">{{ _('Websites') }}</h6>
                <p class="display-6 mb-0">{{ stats.website_count }}</p>
            </div>
        </div>
        <div class="card text-center flex-fill" style="min-width: 140px;">
            <div class="card-body py-3">
                <h6 class="card-title text-muted mb-1">{{ _('Pages') }}</h6>
                <p class="display-6 mb-0">{{ stats.total_pages }}</p>
            </div>
        </div>
        <div class="card text-center flex-fill" style="min-width: 140px;">
            <div class="card-body py-3">
                <h6 class="card-title text-muted mb-1">{{ _('Tested') }}</h6>
                <p class="display-6 mb-0">{{ stats.tested_pages }}</p>
                <small class="text-muted">{{ "%.1f"|format(stats.test_coverage) }}% {{ _('coverage') }}</small>
            </div>
        </div>
        <div class="card text-center flex-fill" style="min-width: 140px;">
            <div class="card-body py-3">
                <h6 class="card-title text-muted mb-1">{{ _('Issues') }}</h6>
                <p class="display-6 mb-0 text-danger">{{ stats.total_violations }}</p>
                <small class="text-warning">{{ stats.total_warnings }} {{ _('warnings') }}</small>
            </div>
        </div>
    </div>

    <!-- Websites -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">{{ _('Websites') }}</h5>
            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addWebsiteModal">
                <i class="bi bi-plus-circle"></i> {{ _('Add Website') }}
            </button>
        </div>
        <div class="card-body">
            {% if websites %}
            {% for website in websites %}
            {% set ws_stats = website_stats.get(website.id, {'violations': 0, 'warnings': 0}) %}
            <div class="card mb-3 shadow-sm">
                <div class="card-body">
                    <div class="d-flex flex-wrap justify-content-between align-items-start gap-2 mb-2">
                        <div class="flex-grow-1" style="min-width: 200px;">
                            <h6 class="card-title mb-1">{{ website.display_name }}</h6>
                            <a href="{{ website.url }}" target="_blank" class="small text-muted text-break">
                                {{ website.url }} <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                        </div>
                        <div class="d-flex flex-wrap gap-2">
                            {% if ws_stats.violations > 0 %}
                            <span class="badge bg-danger">{{ ws_stats.violations }} {{ _('issues') }}</span>
                            {% endif %}
                            {% if ws_stats.warnings > 0 %}
                            <span class="badge bg-warning text-dark">{{ ws_stats.warnings }} {{ _('warnings') }}</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="d-flex flex-wrap gap-3 mb-3 small text-muted">
                        <span><i class="bi bi-files"></i> {{ website.page_count }} {{ _('pages') }}</span>
                        <span class="website-status" data-website-id="{{ website.id }}">
                            <span class="status-content">
                                <i class="bi bi-clock"></i> {{ website.last_tested.strftime('%Y-%m-%d %H:%M') if website.last_tested else _('Never tested') }}
                            </span>
                        </span>
                    </div>
                    
                    <div class="d-flex flex-wrap gap-2">
                        <a href="{{ url_for('websites.view_website', website_id=website.id) }}" class="btn btn-sm btn-primary">
                            <i class="bi bi-eye"></i> {{ _('View') }}
                        </a>
                        <button class="btn btn-sm btn-success" onclick="discoverPages('{{ website.id }}')">
                            <i class="bi bi-search"></i> {{ _('Discover') }}
                        </button>
                        <button class="btn btn-sm btn-info" onclick="testWebsite('{{ website.id }}')">
                            <i class="bi bi-play"></i> {{ _('Test') }}
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <p class="text-muted">{{ _('No websites added yet. Add a website to start testing.') }}</p>
            {% endif %}
        </div>
    </div>

    <!-- Discovered Pages -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-file-earmark-text"></i> {{ _('Discovered Pages') }}
            </h5>
            <span class="badge bg-primary">{{ discovered_pages|length }}</span>
        </div>
        <div class="card-body">
            {% if discovered_pages %}
            <!-- Desktop Table View -->
            <div class="table-responsive d-none d-lg-block">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>{{ _('Title') }}</th>
                            <th>{{ _('URL') }}</th>
                            <th>{{ _('Interested Because') }}</th>
                            <th>{{ _('Page Elements') }}</th>
                            <th>{{ _('Status') }}</th>
                            <th>{{ _('Sync Status') }}</th>
                            <th>{{ _('Actions') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for page in discovered_pages %}
                        <tr>
                            <td>{{ page.title }}</td>
                            <td>
                                <a href="{{ page.url }}" target="_blank" class="text-truncate d-inline-block" style="max-width: 300px;">
                                    {{ page.url }} <i class="bi bi-box-arrow-up-right"></i>
                                </a>
                            </td>
                            <td>
                                {% if page.interested_because %}
                                <small class="text-muted">{{ page.interested_because|length }} {{ _('reasons') }}</small>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if page.page_elements %}
                                <small class="text-muted">{{ page.page_elements|length }} {{ _('elements') }}</small>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if page.audited %}
                                <span class="badge bg-success">{{ _('Audited') }}</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ _('Not Audited') }}</span>
                                {% endif %}
                                {% if page.manual_audit %}
                                <span class="badge bg-info">{{ _('Manual') }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if page.drupal_uuid %}
                                    {% if page.drupal_sync_status == 'synced' %}
                                    <span class="badge bg-success">{{ _('Synced') }}</span>
                                    {% elif page.drupal_sync_status == 'sync_failed' %}
                                    <span class="badge bg-danger" title="{{ page.drupal_error_message }}">{{ _('Failed') }}</span>
                                    {% elif page.drupal_sync_status == 'pending' %}
                                    <span class="badge bg-warning">{{ _('Pending') }}</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ _('Not Synced') }}</span>
                                    {% endif %}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewPageDetails('{{ page._id }}')">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <!-- Mobile Card View -->
            <div class="d-lg-none">
                {% for page in discovered_pages %}
                <div class="card mb-2 shadow-sm">
                    <div class="card-body py-2 px-3">
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <h6 class="mb-0 text-break" style="font-size: 0.9rem;">{{ page.title or _('Untitled') }}</h6>
                            <div class="d-flex flex-wrap gap-1 ms-2">
                                {% if page.audited %}
                                <span class="badge bg-success" style="font-size: 0.7rem;">{{ _('Audited') }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <a href="{{ page.url }}" target="_blank" class="small text-muted text-break d-block mb-2">
                            {{ page.url|truncate(50) }}
                        </a>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                {% if page.interested_because %}{{ page.interested_because|length }} {{ _('reasons') }}{% endif %}
                                {% if page.page_elements %} | {{ page.page_elements|length }} {{ _('elements') }}{% endif %}
                            </small>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewPageDetails('{{ page._id }}')">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                {{ _('No discovered pages yet. Pull pages from Drupal using the synchronization page below.') }}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Drupal Sync -->
    {% include 'drupal_sync/sync_card.html' %}

    <!-- Recordings -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-mic"></i> {{ _('Recordings') }}
            </h5>
            <a href="{{ url_for('recordings.upload_recording') }}" class="btn btn-sm btn-primary">
                <i class="bi bi-plus-circle"></i> <span class="d-none d-sm-inline">{{ _('Add Recording') }}</span><span class="d-sm-none">{{ _('Add') }}</span>
            </a>
        </div>
        <div class="card-body">
            {% if recordings %}
            <!-- Desktop Table View -->
            <div class="table-responsive d-none d-md-block">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>{{ _('ID') }}</th>
                            <th>{{ _('Title') }}</th>
                            <th>{{ _('Type') }}</th>
                            <th>{{ _('Auditor/Tester') }}</th>
                            <th>{{ _('Date') }}</th>
                            <th>{{ _('Issues') }}</th>
                            <th>{{ _('Actions') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for recording in recordings %}
                        <tr>
                            <td>
                                <code>{{ recording.recording_id }}</code>
                            </td>
                            <td>{{ recording.title }}</td>
                            <td>
                                <span class="badge bg-secondary">
                                    {{ recording.recording_type.value|replace('_', ' ')|title }}
                                </span>
                            </td>
                            <td>{{ recording.auditor_name or '-' }}</td>
                            <td>
                                {{ recording.recorded_date.strftime('%Y-%m-%d') if recording.recorded_date else '-' }}
                            </td>
                            <td>
                                {% if recording.total_issues > 0 %}
                                <span class="badge bg-danger">{{ recording.total_issues }}</span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('recordings.view_recording', recording_id=recording.id) }}"
                                   class="btn btn-sm btn-primary">
                                    <i class="bi bi-eye"></i> {{ _('View') }}
                                </a>
                            </td>
                        </tr>
                        {% endfor %}

                        {# Summary row showing combined totals #}
                        {% if recordings|length > 1 %}
                        <tr class="table-secondary fw-bold">
                            <td colspan="2">{{ _('All Recordings Combined') }}</td>
                            <td>
                                <span class="badge bg-dark">{{ recordings|length }} {{ _('recordings') }}</span>
                            </td>
                            <td>-</td>
                            <td>-</td>
                            <td>
                                {% set total = namespace(issues=0) %}
                                {% for recording in recordings %}
                                    {% set total.issues = total.issues + recording.total_issues %}
                                {% endfor %}
                                {% if total.issues > 0 %}
                                <span class="badge bg-danger">{{ total.issues }}</span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('recordings.view_combined_recordings', project_id=project.id) }}"
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-list-ul"></i> {{ _('View Combined') }}
                                </a>
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            <!-- Mobile Card View -->
            <div class="d-md-none">
                {% for recording in recordings %}
                <div class="card mb-2 shadow-sm">
                    <div class="card-body py-2 px-3">
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <div class="flex-grow-1 me-2">
                                <h6 class="mb-0 text-break" style="font-size: 0.9rem;">{{ recording.title }}</h6>
                                <small class="text-muted">{{ recording.recording_id }}</small>
                            </div>
                            {% if recording.total_issues > 0 %}
                            <span class="badge bg-danger">{{ recording.total_issues }}</span>
                            {% endif %}
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge bg-secondary" style="font-size: 0.7rem;">{{ recording.recording_type.value|replace('_', ' ')|title }}</span>
                                {% if recording.recorded_date %}
                                <small class="text-muted ms-1">{{ recording.recorded_date.strftime('%m/%d') }}</small>
                                {% endif %}
                            </div>
                            <a href="{{ url_for('recordings.view_recording', recording_id=recording.id) }}" class="btn btn-sm btn-primary">
                                <i class="bi bi-eye"></i>
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% if recordings|length > 1 %}
                <a href="{{ url_for('recordings.view_combined_recordings', project_id=project.id) }}" class="btn btn-outline-primary w-100 mt-2">
                    <i class="bi bi-list-ul"></i> {{ _('View All Combined') }}
                </a>
                {% endif %}
            </div>
            {% else %}
            <p class="text-muted">{{ _('No recordings added yet.') }} <a href="{{ url_for('recordings.upload_recording') }}">{{ _('Upload a recording') }}</a> {{ _('to track manual accessibility audits.') }}</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Website Modal -->
<div class="modal fade" id="addWebsiteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Add Website') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('projects.add_website', project_id=project.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="url" class="form-label">{{ _('Website URL') }} *</label>
                        <input type="url" class="form-control" id="url" name="url" required
                               placeholder="{{ _('https://example.com') }}">
                    </div>
                    <div class="mb-3">
                        <label for="name" class="form-label">{{ _('Name (Optional)') }}</label>
                        <input type="text" class="form-control" id="name" name="name"
                               placeholder="{{ _('Main Website') }}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-primary">{{ _('Add Website') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Discovery Options Modal -->
<div class="modal fade" id="discoveryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Discovery Options') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="discoveryForm">
                <input type="hidden" id="discoveryWebsiteId" />
                <input type="hidden" id="discoveryWebsiteName" />
                <div class="modal-body">
                    <div class="mb-4">
                        <label class="form-label"><strong>{{ _('Select users for discovery:') }}</strong></label>
                        <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                            <div class="form-check mb-2">
                                <input class="form-check-input modal-discovery-user-checkbox" type="checkbox" value="" id="modal-discovery-user-guest" checked>
                                <label class="form-check-label" for="modal-discovery-user-guest">
                                    <strong>{{ _('Guest') }}</strong> ({{ _('no login') }})
                                </label>
                            </div>
                            <!-- Project test users -->
                            {% if project_users %}
                                {% for user in project_users %}
                                <div class="form-check mb-2">
                                    <input class="form-check-input modal-discovery-user-checkbox" type="checkbox" value="{{ user.id }}" id="modal-discovery-user-{{ user.id }}">
                                    <label class="form-check-label" for="modal-discovery-user-{{ user.id }}">
                                        <strong>{{ user.name_display }}</strong>
                                        {% if user.roles %}
                                        <span class="text-muted">({{ user.roles|join(', ') }})</span>
                                        {% endif %}
                                    </label>
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <small class="text-muted mt-2 d-block">
                            <i class="bi bi-info-circle"></i> {{ _('Discovery will run with the selected user(s).') }}
                            {% if project_users %}
                            <a href="{{ url_for('project_users.list_users', project_id=project.id) }}">{{ _('Manage test users') }}</a>
                            {% else %}
                            <a href="{{ url_for('project_users.list_users', project_id=project.id) }}">{{ _('Add test users') }}</a> {{ _('to discover pages requiring authentication.') }}
                            {% endif %}
                        </small>
                    </div>
                    <div class="mb-3">
                        <label for="maxPages" class="form-label">{{ _('Maximum Pages to Discover') }}</label>
                        <input type="number" class="form-control" id="maxPages" min="1" max="1000"
                               placeholder="{{ _('Leave empty for no limit') }}">
                        <small class="text-muted">{{ _('Limit the number of pages to discover (useful for large sites)') }}</small>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> {{ _('Discovery will crawl the website starting from the home page, following links to find all accessible pages.') }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-search"></i> {{ _('Start Discovery') }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Test All Websites Modal -->
<div class="modal fade" id="testAllModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Test All Websites in Project') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="testAllForm" method="POST" action="{{ url_for('projects.test_project', project_id=project.id) }}">
                <div class="modal-body">
                    <p>{{ _('This will test all websites in the project') }} "{{ project.name }}".</p>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>{{ websites|length }} {{ _('website(s)') }}</strong> {{ _('will be tested across multiple base URLs.') }}
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="testAllPages" name="test_all" value="true" checked>
                        <label class="form-check-label" for="testAllPages">
                            {{ _('Test all pages (unchecked = only untested pages)') }}
                        </label>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="takeScreenshots" name="take_screenshot" value="true" checked>
                        <label class="form-check-label" for="takeScreenshots">
                            {{ _('Take screenshots of issues') }}
                        </label>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="runAI" name="run_ai" value="true">
                        <label class="form-check-label" for="runAI">
                            {{ _('Run AI analysis (requires OpenAI API key)') }}
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-play-fill"></i> {{ _('Start Testing All Websites') }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Project Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Delete Project') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>{{ _('Are you sure you want to delete the project') }} "{{ project.name }}"?</p>
                <p class="text-danger">{{ _('This will permanently delete all websites, pages, and test results associated with this project.') }}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                <form method="POST" action="{{ url_for('projects.delete_project', project_id=project.id) }}" style="display: inline;">
                    <button type="submit" class="btn btn-danger">{{ _('Delete Project') }}</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let statusPollingIntervals = {};
let websitesBeingTested = new Set();
let discoveryPollingIntervals = {};
let discoveryJobs = {};

function updateWebsiteStatus(websiteId, statusHtml) {
    const statusCell = document.querySelector(`td[data-website-id="${websiteId}"] .status-content`);
    if (statusCell) {
        statusCell.innerHTML = statusHtml;
    }
}

function startWebsiteStatusPolling(websiteId) {
    // Don't start multiple pollers for the same website
    if (statusPollingIntervals[websiteId]) {
        return;
    }
    
    // Show testing status immediately
    updateWebsiteStatus(websiteId, '<span class="badge bg-info"><span class="spinner-border spinner-border-sm me-1" role="status"></span>{{ _("Testing...") }}</span>');
    websitesBeingTested.add(websiteId);
    
    // Poll for website testing status
    statusPollingIntervals[websiteId] = setInterval(() => {
        // Check website pages status
        $.get(`/websites/${websiteId}/test-status`, function(data) {
            if (data.all_complete) {
                // Testing complete - stop polling and refresh
                stopWebsiteStatusPolling(websiteId);
                
                // Update with completion time
                if (data.last_tested) {
                    updateWebsiteStatus(websiteId, data.last_tested);
                } else {
                    updateWebsiteStatus(websiteId, '{{ _("Just completed") }}');
                }
                
                // Refresh the page after a short delay to update all statistics
                setTimeout(() => location.reload(), 2000);
            } else {
                // Still testing - show progress
                const progressText = `{{ _("Testing") }}: ${data.tested_pages}/${data.total_pages} {{ _("pages") }}`;
                updateWebsiteStatus(websiteId,
                    `<span class="badge bg-info"><span class="spinner-border spinner-border-sm me-1" role="status"></span>${progressText}</span>`
                );
            }
        }).fail(function() {
            // On error, just show generic testing message
            updateWebsiteStatus(websiteId,
                '<span class="badge bg-info"><span class="spinner-border spinner-border-sm me-1" role="status"></span>{{ _("Testing...") }}</span>'
            );
        });
    }, 3000); // Poll every 3 seconds
}

function stopWebsiteStatusPolling(websiteId) {
    if (statusPollingIntervals[websiteId]) {
        clearInterval(statusPollingIntervals[websiteId]);
        delete statusPollingIntervals[websiteId];
        websitesBeingTested.delete(websiteId);
    }
}

function stopAllPolling() {
    for (const websiteId in statusPollingIntervals) {
        stopWebsiteStatusPolling(websiteId);
    }
}

function discoverPages(websiteId) {
    const btn = event.target.closest('button');
    
    // Check if discovery is already running for this website
    if (discoveryPollingIntervals[websiteId]) {
        if (confirm('{{ _("Discovery is already running for this website. Do you want to cancel it?") }}')) {
            cancelDiscovery(websiteId, btn);
        }
        return;
    }
    
    // Get website name for tracking
    const websiteRow = btn.closest('tr');
    const websiteName = websiteRow ? websiteRow.querySelector('td:first-child').textContent.trim() : 'website';
    
    // Store website info and show modal
    $('#discoveryWebsiteId').val(websiteId);
    $('#discoveryWebsiteName').val(websiteName);
    $('#discoveryModal').modal('show');
}

// Handle discovery form submission
$('#discoveryForm').submit(function(e) {
    e.preventDefault();

    const websiteId = $('#discoveryWebsiteId').val();
    const websiteName = $('#discoveryWebsiteName').val();
    const maxPages = $('#maxPages').val();

    // Get selected discovery users
    const selectedDiscoveryUserIds = [];
    document.querySelectorAll('.modal-discovery-user-checkbox:checked').forEach(checkbox => {
        selectedDiscoveryUserIds.push(checkbox.value);
    });

    if (selectedDiscoveryUserIds.length === 0) {
        alert('{{ _("Please select at least one user for discovery (or Guest).") }}');
        return;
    }

    // Find the button for this website
    const btn = document.querySelector(`button[onclick="discoverPages('${websiteId}')"]`);
    const originalHtml = btn ? btn.innerHTML : '<i class="bi bi-search"></i><span class="d-none d-lg-inline"> {{ _("Discover") }}</span>';

    // Hide modal
    $('#discoveryModal').modal('hide');

    // Prepare request data
    const requestData = {
        website_user_ids: selectedDiscoveryUserIds
    };
    if (maxPages && maxPages > 0) {
        requestData.max_pages = parseInt(maxPages);
    }

    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span> {{ _("Starting...") }}';
    }

    $.ajax({
        url: `/websites/${websiteId}/discover`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(requestData),
        success: function(data) {
            if (data.success) {
                discoveryJobs[websiteId] = data.job_id;

                // Add to global tracking
                if (typeof TestTracker !== 'undefined') {
                    let description = `{{ _("Discovering pages for") }} ${websiteName}`;
                    if (data.max_pages) {
                        description += ` ({{ _("max") }} ${data.max_pages} {{ _("pages") }})`;
                    }
                    TestTracker.addTest('discovery', websiteId, description);
                }

                // Show success message
                if (window.showNotification) {
                    showNotification('{{ _("Discovery Started") }}', data.message, 'info');
                } else {
                    alert(data.message);
                }

                // Start polling for discovery progress
                if (btn) {
                    startDiscoveryPolling(websiteId, btn);
                }
            } else {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                }
                alert(data.message || '{{ _("Failed to start discovery") }}');
            }
        }
    }).fail(function() {
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
        alert('{{ _("Failed to start page discovery") }}');
    });
});

function cancelDiscovery(websiteId, btn) {
    const jobId = discoveryJobs[websiteId];
    if (!jobId) {
        alert('{{ _("No discovery job to cancel") }}');
        return;
    }

    const originalHtml = '<i class="bi bi-search"></i><span class="d-none d-lg-inline"> {{ _("Discover") }}</span>';
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> {{ _("Cancelling...") }}';
    
    $.post(`/websites/${websiteId}/cancel-discovery`, { job_id: jobId }, function(data) {
        if (data.success) {
            stopDiscoveryPolling(websiteId);
            btn.disabled = false;
            btn.innerHTML = originalHtml;
            
            // Remove from global tracking
            if (typeof TestTracker !== 'undefined') {
                TestTracker.removeTest(`discovery_${websiteId}`);
            }
            
            if (window.showNotification) {
                showNotification('{{ _("Discovery Cancelled") }}', data.message, 'warning');
            } else {
                alert(data.message);
            }
        } else {
            alert('{{ _("Failed to cancel discovery:") }} ' + (data.message || '{{ _("Unknown error") }}'));
        }
    }).fail(function() {
        alert('{{ _("Failed to cancel discovery") }}');
    });
}

function startDiscoveryPolling(websiteId, btn) {
    // Don't start multiple pollers for the same website
    if (discoveryPollingIntervals[websiteId]) {
        return;
    }
    
    const originalHtml = '<i class="bi bi-search"></i><span class="d-none d-lg-inline"> {{ _("Discover") }}</span>';

    // Change button to show cancel option
    btn.disabled = false;
    btn.classList.remove('btn-success');
    btn.classList.add('btn-danger');
    btn.innerHTML = '<i class="bi bi-x-circle"></i><span class="d-none d-lg-inline"> {{ _("Cancel") }}</span>';
    btn.onclick = function() {
        if (confirm('{{ _("Cancel the discovery process?") }}')) {
            cancelDiscovery(websiteId, btn);
        }
    };
    
    discoveryPollingIntervals[websiteId] = setInterval(() => {
        const jobId = discoveryJobs[websiteId];
        const url = jobId 
            ? `/websites/${websiteId}/discovery-status?job_id=${jobId}`
            : `/websites/${websiteId}/discovery-status`;
            
        $.get(url, function(data) {
            if (data.status === 'running') {
                // Update button with progress
                const progressText = data.message || `{{ _("Found") }} ${data.pages_found} {{ _("pages") }}...`;
                // Truncate long messages
                const displayText = progressText.length > 40 ? progressText.substring(0, 37) + '...' : progressText;
                btn.innerHTML = `<span class="spinner-border spinner-border-sm me-1"></span><span class="d-none d-lg-inline"> ${displayText}</span>`;
            } else if (data.status === 'completed') {
                // Discovery complete
                stopDiscoveryPolling(websiteId);

                // Update button
                btn.innerHTML = `<i class="bi bi-check-circle"></i><span class="d-none d-lg-inline"> {{ _("Found") }} ${data.pages_found} {{ _("pages") }}</span>`;
                btn.disabled = false;
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-success');
                btn.onclick = function() { discoverPages(websiteId); };

                // Remove from global tracking
                if (typeof TestTracker !== 'undefined') {
                    TestTracker.removeTest(`discovery_${websiteId}`);
                }

                // Show completion notification
                if (window.showNotification) {
                    showNotification('{{ _("Discovery Complete") }}', `{{ _("Found") }} ${data.pages_found} {{ _("pages") }}. {{ _("Refreshing...") }}`, 'success');
                }

                // Refresh page to show new pages
                setTimeout(() => location.reload(), 2000);
            } else if (data.status === 'failed') {
                // Discovery failed
                stopDiscoveryPolling(websiteId);

                // Update button
                btn.innerHTML = '<i class="bi bi-x-circle"></i><span class="d-none d-lg-inline"> {{ _("Failed") }}</span>';
                btn.disabled = false;
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-warning');

                // Remove from global tracking
                if (typeof TestTracker !== 'undefined') {
                    TestTracker.removeTest(`discovery_${websiteId}`);
                }

                // Show error
                alert('{{ _("Discovery failed:") }} ' + (data.error || '{{ _("Unknown error") }}'));

                // Reset button after delay
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                }, 3000);
            }
        }).fail(function() {
            console.error('Failed to check discovery status for website:', websiteId);
        });
    }, 2000); // Poll every 2 seconds
}

function stopDiscoveryPolling(websiteId) {
    if (discoveryPollingIntervals[websiteId]) {
        clearInterval(discoveryPollingIntervals[websiteId]);
        delete discoveryPollingIntervals[websiteId];
        delete discoveryJobs[websiteId];
    }
}

function testAllWebsites() {
    // Open modal for project-level testing options
    const modal = new bootstrap.Modal(document.getElementById('testAllModal'));
    modal.show();
}

function testWebsite(websiteId) {
    const btn = event.target.closest('button');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span> Starting...';
    
    // Get website name for tracking
    const websiteRow = btn.closest('tr');
    const websiteName = websiteRow ? websiteRow.querySelector('td:first-child').textContent.trim() : 'website';
    
    $.post(`/websites/${websiteId}/test-all`, function(data) {
        if (data.success) {
            // Add to global tracking
            if (typeof trackWebsiteTest !== 'undefined') {
                trackWebsiteTest(websiteId, websiteName);
            }
            
            // Show notification
            if (window.showNotification) {
                showNotification('Testing Started', `Testing ${data.pages_queued} pages. The page will refresh when complete.`, 'info');
            } else {
                alert(`Testing queued for ${data.pages_queued} pages.`);
            }
            
            // Start polling for this website
            startWebsiteStatusPolling(websiteId);
            
            // Re-enable button but change text
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i><span class="d-none d-lg-inline"> Testing...</span>';
        } else {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-play"></i><span class="d-none d-lg-inline"> Test</span>';
            alert(data.message);
        }
    }).fail(function() {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-play"></i><span class="d-none d-lg-inline"> Test</span>';
        alert('Failed to start testing');
    });
}

// Clean up on page unload
window.addEventListener('beforeunload', function() {
    stopAllPolling();
    // Stop all discovery polling
    for (const websiteId in discoveryPollingIntervals) {
        stopDiscoveryPolling(websiteId);
    }
});

// View discovered page details
function viewPageDetails(pageId) {
    window.location.href = `/discovered-pages/${pageId}`;
}
</script>
{% endblock %}