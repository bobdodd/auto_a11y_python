{% extends "base.html" %}

{% block title %}{% if is_edit %}{{ _('Edit Schedule') }}{% else %}{{ _('Create Schedule') }}{% endif %} - {{ website.name }} - {{ _('Auto A11y') }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="{{ _('breadcrumb') }}">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{{ url_for('projects.view_project', project_id=project.id) }}">{{ project.name }}</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{{ url_for('websites.view_website', website_id=website.id) }}">{{ website.name }}</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{{ url_for('schedules.list_schedules', website_id=website.id) }}">{{ _('Schedules') }}</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                {% if is_edit %}{{ _('Edit') }}{% else %}{{ _('Create') }}{% endif %}
            </li>
        </ol>
    </nav>

    <h1 class="h2 mb-4">
        <i class="bi bi-calendar-event"></i>
        {% if is_edit %}{{ _('Edit Schedule') }}{% else %}{{ _('Create Schedule') }}{% endif %}
    </h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="POST" id="scheduleForm">
        <div class="row">
            <!-- Left Column - Basic Info & Schedule -->
            <div class="col-lg-6">
                <!-- Basic Info -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-info-circle"></i> {{ _('Basic Information') }}</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="name" class="form-label">{{ _('Schedule Name') }} <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" name="name" required
                                   value="{{ schedule.name if schedule else '' }}"
                                   placeholder="{{ _('e.g., Nightly Full Scan') }}">
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">{{ _('Description') }}</label>
                            <textarea class="form-control" id="description" name="description" rows="2"
                                      placeholder="{{ _('Optional description of this schedule') }}">{{ schedule.description if schedule else '' }}</textarea>
                        </div>

                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="enabled" name="enabled"
                                   {% if not schedule or schedule.enabled %}checked{% endif %}>
                            <label class="form-check-label" for="enabled">{{ _('Enable this schedule') }}</label>
                        </div>
                    </div>
                </div>

                <!-- Schedule Timing -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-clock"></i> {{ _('Schedule Timing') }}</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">{{ _('Schedule Type') }} <span class="text-danger">*</span></label>
                            <div class="btn-group d-flex flex-wrap" role="group">
                                <input type="radio" class="btn-check" name="schedule_type" id="type_one_time" value="one_time"
                                       {% if schedule and schedule.schedule_type.value == 'one_time' %}checked{% endif %}>
                                <label class="btn btn-outline-primary" for="type_one_time">{{ _('One-time') }}</label>

                                <input type="radio" class="btn-check" name="schedule_type" id="type_daily" value="daily"
                                       {% if not schedule or schedule.schedule_type.value == 'daily' %}checked{% endif %}>
                                <label class="btn btn-outline-primary" for="type_daily">{{ _('Daily') }}</label>

                                <input type="radio" class="btn-check" name="schedule_type" id="type_weekly" value="weekly"
                                       {% if schedule and schedule.schedule_type.value == 'weekly' %}checked{% endif %}>
                                <label class="btn btn-outline-primary" for="type_weekly">{{ _('Weekly') }}</label>

                                <input type="radio" class="btn-check" name="schedule_type" id="type_monthly" value="monthly"
                                       {% if schedule and schedule.schedule_type.value == 'monthly' %}checked{% endif %}>
                                <label class="btn btn-outline-primary" for="type_monthly">{{ _('Monthly') }}</label>

                                <input type="radio" class="btn-check" name="schedule_type" id="type_cron" value="cron"
                                       {% if schedule and schedule.schedule_type.value == 'cron' %}checked{% endif %}>
                                <label class="btn btn-outline-primary" for="type_cron">{{ _('Custom Cron') }}</label>
                            </div>
                        </div>

                        <!-- One-time Date/Time -->
                        <div id="oneTimeFields" class="schedule-fields" style="display: none;">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="scheduled_date" class="form-label">{{ _('Date') }}</label>
                                    <input type="date" class="form-control" id="scheduled_date" name="scheduled_date"
                                           value="{{ schedule.scheduled_datetime.strftime('%Y-%m-%d') if schedule and schedule.scheduled_datetime else '' }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="scheduled_time" class="form-label">{{ _('Time') }}</label>
                                    <input type="time" class="form-control" id="scheduled_time" name="scheduled_time"
                                           value="{{ schedule.scheduled_datetime.strftime('%H:%M') if schedule and schedule.scheduled_datetime else '02:00' }}">
                                </div>
                            </div>
                        </div>

                        <!-- Daily Time -->
                        <div id="dailyFields" class="schedule-fields">
                            <div class="mb-3">
                                <label for="time" class="form-label">{{ _('Time') }}</label>
                                <input type="time" class="form-control" id="time" name="time"
                                       value="{{ schedule.preset_config.time if schedule else '02:00' }}">
                            </div>
                        </div>

                        <!-- Weekly Day + Time -->
                        <div id="weeklyFields" class="schedule-fields" style="display: none;">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="day_of_week" class="form-label">{{ _('Day of Week') }}</label>
                                    <select class="form-select" id="day_of_week" name="day_of_week">
                                        <option value="0" {% if schedule and schedule.preset_config.day_of_week == 0 %}selected{% endif %}>{{ _('Monday') }}</option>
                                        <option value="1" {% if schedule and schedule.preset_config.day_of_week == 1 %}selected{% endif %}>{{ _('Tuesday') }}</option>
                                        <option value="2" {% if schedule and schedule.preset_config.day_of_week == 2 %}selected{% endif %}>{{ _('Wednesday') }}</option>
                                        <option value="3" {% if schedule and schedule.preset_config.day_of_week == 3 %}selected{% endif %}>{{ _('Thursday') }}</option>
                                        <option value="4" {% if schedule and schedule.preset_config.day_of_week == 4 %}selected{% endif %}>{{ _('Friday') }}</option>
                                        <option value="5" {% if schedule and schedule.preset_config.day_of_week == 5 %}selected{% endif %}>{{ _('Saturday') }}</option>
                                        <option value="6" {% if schedule and schedule.preset_config.day_of_week == 6 %}selected{% endif %}>{{ _('Sunday') }}</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="weekly_time" class="form-label">{{ _('Time') }}</label>
                                    <input type="time" class="form-control" id="weekly_time" name="time"
                                           value="{{ schedule.preset_config.time if schedule else '02:00' }}">
                                </div>
                            </div>
                        </div>

                        <!-- Monthly Day + Time -->
                        <div id="monthlyFields" class="schedule-fields" style="display: none;">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="day_of_month" class="form-label">{{ _('Day of Month') }}</label>
                                    <select class="form-select" id="day_of_month" name="day_of_month">
                                        {% for day in range(1, 29) %}
                                        <option value="{{ day }}" {% if schedule and schedule.preset_config.day_of_month == day %}selected{% endif %}>{{ day }}</option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted">{{ _('Note: For months with fewer days, test runs on the last day') }}</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="monthly_time" class="form-label">{{ _('Time') }}</label>
                                    <input type="time" class="form-control" id="monthly_time" name="time"
                                           value="{{ schedule.preset_config.time if schedule else '02:00' }}">
                                </div>
                            </div>
                        </div>

                        <!-- Cron Expression -->
                        <div id="cronFields" class="schedule-fields" style="display: none;">
                            <div class="mb-3">
                                <label for="cron_expression" class="form-label">{{ _('Cron Expression') }}</label>
                                <input type="text" class="form-control" id="cron_expression" name="cron_expression"
                                       value="{{ schedule.cron_expression if schedule else '' }}"
                                       placeholder="0 2 * * *">
                                <small class="form-text text-muted">
                                    {{ _('Format: minute hour day month weekday (e.g., "0 2 * * *" = daily at 2am)') }}
                                </small>
                            </div>
                        </div>

                        <!-- Timezone -->
                        <div class="mb-3">
                            <label for="timezone" class="form-label">{{ _('Timezone') }}</label>
                            <select class="form-select" id="timezone" name="timezone">
                                <option value="America/Toronto" {% if not schedule or schedule.preset_config.timezone == 'America/Toronto' %}selected{% endif %}>America/Toronto (EST/EDT)</option>
                                <option value="America/Vancouver" {% if schedule and schedule.preset_config.timezone == 'America/Vancouver' %}selected{% endif %}>America/Vancouver (PST/PDT)</option>
                                <option value="America/New_York" {% if schedule and schedule.preset_config.timezone == 'America/New_York' %}selected{% endif %}>America/New_York (EST/EDT)</option>
                                <option value="America/Chicago" {% if schedule and schedule.preset_config.timezone == 'America/Chicago' %}selected{% endif %}>America/Chicago (CST/CDT)</option>
                                <option value="UTC" {% if schedule and schedule.preset_config.timezone == 'UTC' %}selected{% endif %}>UTC</option>
                                <option value="Europe/London" {% if schedule and schedule.preset_config.timezone == 'Europe/London' %}selected{% endif %}>Europe/London (GMT/BST)</option>
                                <option value="Europe/Paris" {% if schedule and schedule.preset_config.timezone == 'Europe/Paris' %}selected{% endif %}>Europe/Paris (CET/CEST)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Test Configuration -->
            <div class="col-lg-6">
                <!-- AI Testing Configuration -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-robot"></i> {{ _('AI Testing') }}</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="run_ai_tests" name="run_ai_tests"
                                   {% if not schedule or schedule.test_config.run_ai_tests %}checked{% endif %}>
                            <label class="form-check-label" for="run_ai_tests">{{ _('Enable AI Testing') }}</label>
                        </div>

                        <div id="aiPagesConfig">
                            <label class="form-label">{{ _('AI Testing Scope') }}</label>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="ai_pages_mode" id="ai_all" value="all"
                                           {% if not schedule or schedule.test_config.ai_pages_mode.value == 'all' %}checked{% endif %}>
                                    <label class="form-check-label" for="ai_all">
                                        <strong>{{ _('All Pages') }}</strong>
                                        <small class="text-muted d-block">{{ _('Run AI analysis on every page (higher cost)') }}</small>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="ai_pages_mode" id="ai_selected" value="selected"
                                           {% if schedule and schedule.test_config.ai_pages_mode.value == 'selected' %}checked{% endif %}>
                                    <label class="form-check-label" for="ai_selected">
                                        <strong>{{ _('Selected Pages Only') }}</strong>
                                        <small class="text-muted d-block">{{ _('Choose specific pages for AI analysis') }}</small>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="ai_pages_mode" id="ai_none" value="none"
                                           {% if schedule and schedule.test_config.ai_pages_mode.value == 'none' %}checked{% endif %}>
                                    <label class="form-check-label" for="ai_none">
                                        <strong>{{ _('No AI Testing') }}</strong>
                                        <small class="text-muted d-block">{{ _('Run only automated JavaScript tests') }}</small>
                                    </label>
                                </div>
                            </div>

                            <!-- Page Selector (shown when 'selected' is chosen) -->
                            <div id="pageSelector" class="mb-3" style="display: none;">
                                <label class="form-label">{{ _('Select Pages for AI Testing') }}</label>
                                <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                                    {% for page in pages %}
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" name="ai_page_ids"
                                               id="page_{{ page.id }}" value="{{ page.id }}"
                                               {% if schedule and page.id in schedule.test_config.ai_page_ids %}checked{% endif %}>
                                        <label class="form-check-label" for="page_{{ page.id }}">
                                            <small>{{ page.url|truncate(60) }}</small>
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                                <small class="form-text text-muted">{{ pages|length }} {{ _('pages available') }}</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Other Test Settings -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-gear"></i> {{ _('Test Settings') }}</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check mb-2">
                            <input type="checkbox" class="form-check-input" id="run_javascript_tests" name="run_javascript_tests"
                                   {% if not schedule or schedule.test_config.run_javascript_tests %}checked{% endif %}>
                            <label class="form-check-label" for="run_javascript_tests">{{ _('Run JavaScript Tests') }}</label>
                        </div>
                        <div class="form-check mb-2">
                            <input type="checkbox" class="form-check-input" id="run_python_tests" name="run_python_tests"
                                   {% if not schedule or schedule.test_config.run_python_tests %}checked{% endif %}>
                            <label class="form-check-label" for="run_python_tests">{{ _('Run Python Tests') }}</label>
                        </div>
                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="take_screenshots" name="take_screenshots"
                                   {% if not schedule or schedule.test_config.take_screenshots %}checked{% endif %}>
                            <label class="form-check-label" for="take_screenshots">{{ _('Take Screenshots') }}</label>
                        </div>
                    </div>
                </div>

                <!-- Test Users -->
                {% if project_users %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-people"></i> {{ _('Test Users') }}</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small">{{ _('Select which users to test with. Leave unchecked to test as guest only.') }}</p>
                        {% for user in project_users %}
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="project_user_ids"
                                   id="user_{{ user.id }}" value="{{ user.id }}"
                                   {% if schedule and user.id in schedule.project_user_ids %}checked{% endif %}>
                            <label class="form-check-label" for="user_{{ user.id }}">
                                {{ user.name_display }}
                                {% if user.roles %}
                                <small class="text-muted">({{ user.roles|join(', ') }})</small>
                                {% endif %}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Actions -->
        <div class="d-flex justify-content-between mb-4">
            <a href="{{ url_for('schedules.list_schedules', website_id=website.id) }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> {{ _('Cancel') }}
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-lg"></i> {% if is_edit %}{{ _('Save Changes') }}{% else %}{{ _('Create Schedule') }}{% endif %}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Schedule type toggle
    const scheduleTypes = document.querySelectorAll('input[name="schedule_type"]');
    const fieldGroups = {
        'one_time': document.getElementById('oneTimeFields'),
        'daily': document.getElementById('dailyFields'),
        'weekly': document.getElementById('weeklyFields'),
        'monthly': document.getElementById('monthlyFields'),
        'cron': document.getElementById('cronFields')
    };

    function showScheduleFields() {
        const selected = document.querySelector('input[name="schedule_type"]:checked').value;
        Object.keys(fieldGroups).forEach(type => {
            if (fieldGroups[type]) {
                fieldGroups[type].style.display = (type === selected) ? 'block' : 'none';
            }
        });
    }

    scheduleTypes.forEach(radio => {
        radio.addEventListener('change', showScheduleFields);
    });
    showScheduleFields();

    // AI testing toggle
    const runAiTests = document.getElementById('run_ai_tests');
    const aiPagesConfig = document.getElementById('aiPagesConfig');

    function toggleAiConfig() {
        const radios = aiPagesConfig.querySelectorAll('input[type="radio"], #pageSelector');
        radios.forEach(el => {
            el.disabled = !runAiTests.checked;
        });
        if (!runAiTests.checked) {
            document.getElementById('pageSelector').style.display = 'none';
        } else {
            togglePageSelector();
        }
    }

    runAiTests.addEventListener('change', toggleAiConfig);

    // AI pages mode toggle
    const aiModes = document.querySelectorAll('input[name="ai_pages_mode"]');
    const pageSelector = document.getElementById('pageSelector');

    function togglePageSelector() {
        const selected = document.querySelector('input[name="ai_pages_mode"]:checked');
        if (selected && pageSelector) {
            pageSelector.style.display = (selected.value === 'selected') ? 'block' : 'none';
        }
    }

    aiModes.forEach(radio => {
        radio.addEventListener('change', togglePageSelector);
    });
    togglePageSelector();
    toggleAiConfig();
});
</script>
{% endblock %}
