{% extends "base.html" %}

{% block title %}Edit {{ project.name }} - Auto A11y{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-8 col-lg-6 mx-auto">
            <h1 class="h2 mb-4">Edit Project</h1>
            
            <div class="card">
                <div class="card-body">
                    <form method="POST" action="{{ url_for('projects.edit_project', project_id=project.id) }}">
                        <div class="mb-3">
                            <label for="name" class="form-label">Project Name *</label>
                            <input type="text" class="form-control" id="name" name="name" 
                                   value="{{ project.name }}" required maxlength="100">
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" 
                                      rows="3" maxlength="500">{{ project.description or '' }}</textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status" name="status">
                                <option value="active" {% if project.status.value == 'active' %}selected{% endif %}>Active</option>
                                <option value="paused" {% if project.status.value == 'paused' %}selected{% endif %}>Paused</option>
                                <option value="completed" {% if project.status.value == 'completed' %}selected{% endif %}>Completed</option>
                                <option value="archived" {% if project.status.value == 'archived' %}selected{% endif %}>Archived</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="wcag_level" class="form-label">WCAG Compliance Level</label>
                            <select class="form-select" id="wcag_level" name="wcag_level">
                                <option value="AA" {% if project.config.get('wcag_level', 'AA') == 'AA' %}selected{% endif %}>Level AA (Recommended)</option>
                                <option value="AAA" {% if project.config.get('wcag_level', 'AA') == 'AAA' %}selected{% endif %}>Level AAA (Enhanced)</option>
                            </select>
                            <div class="form-text">
                                <strong>Level AA:</strong> Standard compliance (4.5:1 contrast for normal text, 3:1 for large text)<br>
                                <strong>Level AAA:</strong> Enhanced compliance (7:1 contrast for normal text, 4.5:1 for large text)
                            </div>
                        </div>
                        
                        <!-- Touchpoint Testing Configuration -->
                        <div class="mb-3">
                            <label class="form-label">Touchpoint Tests Configuration</label>
                            <div class="form-text mb-2">
                                Configure which accessibility tests to run. Tests are organized by touchpoint (testing category).
                            </div>
                            
                            <!-- Global Controls -->
                            <div class="btn-group mb-3" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllTests(true)">Enable All</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectAllTests(false)">Disable All</button>
                                <button type="button" class="btn btn-sm btn-outline-info" onclick="applyPreset('minimal')">Minimal</button>
                                <button type="button" class="btn btn-sm btn-outline-info" onclick="applyPreset('wcag-aa')">WCAG AA</button>
                            </div>
                            
                            <!-- Touchpoint Tree -->
                            <div class="touchpoint-tree border rounded p-3" style="max-height: 400px; overflow-y: auto;">
                                {% set touchpoint_data = [
                                    ('accessible_names', 'Accessible Names', ['ErrMissingAccessibleName', 'WarnGenericAccessibleName']),
                                    ('animation', 'Animation', ['ErrAutoStartTimers', 'ErrInfiniteAnimation', 'ErrNoReducedMotionSupport', 'WarnFastInterval', 'WarnLongAnimation']),
                                    ('aria', 'ARIA', ['AI_ErrMissingInteractiveRole', 'ErrMapAriaHidden', 'WarnMissingAriaModal']),
                                    ('buttons', 'Buttons', ['ErrButtonEmpty', 'ErrButtonNoText', 'ErrMissingCloseButton', 'WarnButtonTextInsufficient']),
                                    ('colors_contrast', 'Colors & Contrast', ['ErrInsufficientContrast', 'ErrSmallText', 'InfoNoColorSchemeSupport', 'InfoNoContrastSupport', 'WarnColorOnlyLink']),
                                    ('dialogs', 'Dialogs & Modals', ['ErrModalMissingClose', 'ErrModalMissingHeading', 'ErrModalWithoutEscape', 'WarnMissingAriaModal', 'WarnModalMissingAriaLabelledby', 'WarnModalMissingAriaModal', 'WarnModalNoFocusableElements']),
                                    ('documents', 'Documents', ['ErrMissingDocumentType', 'WarnGenericDocumentLinkText', 'WarnMissingDocumentMetadata']),
                                    ('event_handling', 'Event Handling', ['ErrMouseOnlyHandler']),
                                    ('focus_management', 'Focus Management', ['ErrContentObscuring', 'ErrNoFocusIndicator', 'ErrNoOutlineOffsetDefined', 'ErrOutlineIsNoneOnInteractiveElement', 'WarnZeroOutlineOffset']),
                                    ('forms', 'Forms', ['ErrEmptyLabel', 'ErrNoLabel', 'ErrPlaceholderAsLabel', 'ErrUnlabelledField', 'WarnMissingAriaLabelledby', 'WarnMissingRequiredIndication', 'WarnNoFieldset', 'WarnNoLegend', 'WarnUnlabelledForm', 'WarnUnlabelledRegion']),
                                    ('headings', 'Headings', ['DiscoHeadingWithID', 'ErrEmptyHeading', 'ErrIncorrectHeadingLevel', 'ErrModalMissingHeading', 'ErrMultipleH1', 'ErrNoH1', 'ErrSkippedHeadingLevel', 'InfoHeadingNearLengthLimit', 'WarnHeadingInsideDisplayNone', 'WarnHeadingOver60CharsLong', 'WarnVisualHierarchy']),
                                    ('iframes', 'Iframes', ['ErrVideoIframeMissingTitle']),
                                    ('images', 'Images', ['DiscoFoundInlineSvg', 'DiscoFoundSvgImage', 'ErrAltOnElementThatDoesntTakeIt', 'ErrAltTooLong', 'ErrImageAltContainsHTML', 'ErrImageWithEmptyAlt', 'ErrImageWithImgFileExtensionAlt', 'ErrImageWithNoAlt', 'ErrImageWithURLAsAlt', 'ErrNoAlt', 'ErrRedundantAlt', 'ErrSVGNoAccessibleName', 'WarnSVGNoRole', 'WarnSvgPositiveTabindex']),
                                    ('keyboard_navigation', 'Keyboard Navigation', ['ErrMissingTabindex', 'ErrNonInteractiveZeroTabindex', 'ErrNoFocusIndicator', 'ErrPositiveTabindex', 'ErrTabOrderViolation', 'WarnHighTabindex', 'WarnMissingNegativeTabindex', 'WarnModalNoFocusableElements', 'WarnNegativeTabindex']),
                                    ('landmarks', 'Landmarks', ['ErrDuplicateLandmarkWithoutName', 'ErrMissingMainLandmark', 'WarnContentOutsideLandmarks', 'WarnMissingBannerLandmark', 'WarnMissingContentinfoLandmark']),
                                    ('language', 'Language', ['ErrHreflangAttrEmpty', 'ErrHreflangNotOnLink', 'ErrIncorrectlyFormattedPrimaryLang', 'ErrNoDocumentLanguage', 'WarnMissingDocumentMetadata']),
                                    ('links', 'Links', ['ErrInvalidGenericLinkName', 'WarnAnchorTargetTabindex', 'WarnColorOnlyLink', 'WarnGenericDocumentLinkText', 'WarnGenericLinkNoImprovement']),
                                    ('lists', 'Lists', ['ErrEmptyList', 'ErrFakeListImplementation', 'WarnCustomBulletStyling', 'WarnDeepListNesting']),
                                    ('maps', 'Maps', ['ErrDivMapMissingAttributes', 'ErrMapMissingTitle']),
                                    ('media', 'Media', ['ErrNativeVideoMissingControls', 'ErrVideoIframeMissingTitle', 'WarnVideoAutoplay']),
                                    ('navigation', 'Navigation', ['AI_ErrAccordionWithoutARIA', 'AI_ErrCarouselWithoutARIA', 'AI_ErrDropdownWithoutARIA', 'ErrDuplicateNavNames', 'ErrInappropriateMenuRole', 'ErrNavMissingAccessibleName', 'WarnNoCurrentPageIndicator']),
                                    ('reading_order', 'Reading Order', ['AI_InfoContentOrder', 'AI_WarnPossibleReadingOrderIssue']),
                                    ('semantic_structure', 'Semantic Structure', ['ErrEmptyPageTitle', 'ErrHeaderMissingScope', 'ErrImproperTitleAttribute', 'ErrMissingDocumentType', 'ErrMultiplePageTitles', 'ErrNoPageTitle', 'WarnPageTitleTooLong', 'WarnPageTitleTooShort', 'WarnVisualHierarchy']),
                                    ('tables', 'Tables', ['ErrHeaderMissingScope', 'ErrTableMissingCaption', 'ErrTableNoColumnHeaders', 'WarnTableMissingThead']),
                                    ('timing', 'Timing', ['ErrAutoStartTimers', 'ErrTimersWithoutControls', 'WarnFastInterval']),
                                    ('typography', 'Typography', ['ErrSmallText', 'WarnItalicText', 'WarnJustifiedText', 'WarnRightAlignedText', 'WarnSmallLineHeight'])
                                ] %}
                                
                                {% for touchpoint_id, touchpoint_name, test_ids in touchpoint_data %}
                                <div class="touchpoint-item mb-2">
                                    <div class="d-flex align-items-center">
                                        <!-- Expand/Collapse button -->
                                        <button class="btn btn-sm btn-link p-0 me-2" type="button" 
                                                data-bs-toggle="collapse" data-bs-target="#tests_{{ touchpoint_id }}"
                                                aria-expanded="false" aria-controls="tests_{{ touchpoint_id }}">
                                            <i class="bi bi-chevron-right" id="chevron_{{ touchpoint_id }}"></i>
                                        </button>
                                        
                                        <!-- Touchpoint checkbox -->
                                        <div class="form-check">
                                            <input class="form-check-input touchpoint-checkbox" type="checkbox" 
                                                   id="touchpoint_{{ touchpoint_id }}" name="touchpoint_{{ touchpoint_id }}"
                                                   {% if project.config.get('touchpoints', {}).get(touchpoint_id, {}).get('enabled', True) %}checked{% endif %}
                                                   onchange="toggleTouchpoint('{{ touchpoint_id }}')">
                                            <label class="form-check-label fw-bold" for="touchpoint_{{ touchpoint_id }}">
                                                <i class="bi bi-folder2 me-1"></i>{{ touchpoint_name }}
                                                <span class="badge bg-secondary ms-2">{{ test_ids|length }}</span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- Individual tests under this touchpoint (collapsible) -->
                                    <div class="collapse ms-5 mt-1" id="tests_{{ touchpoint_id }}">
                                        {% for test_id in test_ids %}
                                        <div class="form-check">
                                            <input class="form-check-input test-checkbox" type="checkbox" 
                                                   id="test_{{ touchpoint_id }}_{{ test_id }}" 
                                                   name="test_{{ touchpoint_id }}_{{ test_id }}"
                                                   data-touchpoint="{{ touchpoint_id }}"
                                                   {% if project.config.get('touchpoints', {}).get(touchpoint_id, {}).get('tests', {}).get(test_id, True) %}checked{% endif %}>
                                            <label class="form-check-label small" for="test_{{ touchpoint_id }}_{{ test_id }}">
                                                <i class="bi bi-file-earmark-code me-1"></i>
                                                <code>{{ test_id }}</code>
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- AI Testing Configuration -->
                        <div class="mb-3">
                            <label class="form-label">AI-Assisted Testing</label>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enable_ai_testing" name="enable_ai_testing" 
                                       {% if project.config.get('enable_ai_testing', False) %}checked{% endif %} onchange="toggleAITests()">
                                <label class="form-check-label" for="enable_ai_testing">
                                    Enable AI-assisted accessibility testing
                                </label>
                            </div>
                            <div class="form-text mb-3">
                                AI testing uses Claude to analyze screenshots and HTML for issues that automated tests might miss.
                                <strong>Note:</strong> AI testing incurs API costs based on usage.
                            </div>
                            
                            <div id="ai_tests_selection" style="display: {% if project.config.get('enable_ai_testing', False) %}block{% else %}none{% endif %};">
                                <label class="form-label">Select AI Tests to Run:</label>
                                <div class="ms-3">
                                    <div class="form-check">
                                        <input class="form-check-input ai-test-checkbox" type="checkbox" id="ai_test_headings" 
                                               name="ai_test_headings" value="headings"
                                               {% if 'headings' in project.config.get('ai_tests', []) %}checked{% endif %}>
                                        <label class="form-check-label" for="ai_test_headings">
                                            <strong>Heading Analysis</strong> - Detects visual headings not properly marked up
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input ai-test-checkbox" type="checkbox" id="ai_test_reading_order" 
                                               name="ai_test_reading_order" value="reading_order"
                                               {% if 'reading_order' in project.config.get('ai_tests', []) %}checked{% endif %}>
                                        <label class="form-check-label" for="ai_test_reading_order">
                                            <strong>Reading Order</strong> - Verifies logical reading sequence matches visual layout
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input ai-test-checkbox" type="checkbox" id="ai_test_modals" 
                                               name="ai_test_modals" value="modals"
                                               {% if 'modals' in project.config.get('ai_tests', []) %}checked{% endif %}>
                                        <label class="form-check-label" for="ai_test_modals">
                                            <strong>Modal Dialogs</strong> - Analyzes popup and overlay accessibility
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input ai-test-checkbox" type="checkbox" id="ai_test_language" 
                                               name="ai_test_language" value="language"
                                               {% if 'language' in project.config.get('ai_tests', []) %}checked{% endif %}>
                                        <label class="form-check-label" for="ai_test_language">
                                            <strong>Language Detection</strong> - Identifies mixed languages and missing declarations
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input ai-test-checkbox" type="checkbox" id="ai_test_animations" 
                                               name="ai_test_animations" value="animations"
                                               {% if 'animations' in project.config.get('ai_tests', []) %}checked{% endif %}>
                                        <label class="form-check-label" for="ai_test_animations">
                                            <strong>Animations</strong> - Detects potentially problematic motion
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input ai-test-checkbox" type="checkbox" id="ai_test_interactive" 
                                               name="ai_test_interactive" value="interactive"
                                               {% if 'interactive' in project.config.get('ai_tests', []) %}checked{% endif %}>
                                        <label class="form-check-label" for="ai_test_interactive">
                                            <strong>Interactive Elements</strong> - Analyzes buttons, links, and form controls
                                        </label>
                                    </div>
                                </div>
                                <div class="form-text mt-2">
                                    <a href="#" onclick="selectAllAITests(event)">Select All</a> | 
                                    <a href="#" onclick="deselectAllAITests(event)">Deselect All</a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> Update Project
                            </button>
                            <a href="{{ url_for('projects.view_project', project_id=project.id) }}" 
                               class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleAITests() {
    const enabled = document.getElementById('enable_ai_testing').checked;
    const selection = document.getElementById('ai_tests_selection');
    selection.style.display = enabled ? 'block' : 'none';
    
    // If disabling, uncheck all tests
    if (!enabled) {
        document.querySelectorAll('.ai-test-checkbox').forEach(cb => {
            cb.checked = false;
        });
    }
}

function selectAllAITests(event) {
    event.preventDefault();
    document.querySelectorAll('.ai-test-checkbox').forEach(cb => {
        cb.checked = true;
    });
}

function deselectAllAITests(event) {
    event.preventDefault();
    document.querySelectorAll('.ai-test-checkbox').forEach(cb => {
        cb.checked = false;
    });
}

// Touchpoint test functions
function selectAllTests(enable) {
    // Enable/disable all touchpoints
    document.querySelectorAll('.touchpoint-checkbox').forEach(cb => {
        cb.checked = enable;
    });
    // Enable/disable all individual tests
    document.querySelectorAll('.test-checkbox').forEach(cb => {
        cb.checked = enable;
    });
}

function toggleTouchpoint(touchpointId) {
    const touchpointCheckbox = document.getElementById('touchpoint_' + touchpointId);
    const enabled = touchpointCheckbox.checked;
    
    // Enable/disable all tests under this touchpoint
    document.querySelectorAll(`#tests_${touchpointId} .test-checkbox`).forEach(cb => {
        cb.checked = enabled;
    });
}

function applyPreset(presetName) {
    // First disable all
    document.querySelectorAll('.touchpoint-checkbox').forEach(cb => {
        cb.checked = false;
    });
    
    // Then enable based on preset
    if (presetName === 'minimal') {
        // Enable only critical touchpoints
        const critical = ['headings', 'images', 'forms', 'keyboard_navigation', 'colors_contrast', 'semantic_structure'];
        critical.forEach(id => {
            const cb = document.getElementById('touchpoint_' + id);
            if (cb) cb.checked = true;
        });
    } else if (presetName === 'wcag-aa') {
        // Enable WCAG AA relevant touchpoints
        const wcagAA = [
            'headings', 'images', 'forms', 'buttons', 'links',
            'keyboard_navigation', 'colors_contrast', 'landmarks',
            'language', 'semantic_structure', 'tables', 'media'
        ];
        wcagAA.forEach(id => {
            const cb = document.getElementById('touchpoint_' + id);
            if (cb) cb.checked = true;
        });
    }
}

// Handle collapse/expand events for chevron rotation
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(button => {
        const targetId = button.getAttribute('data-bs-target');
        const target = document.querySelector(targetId);
        const chevron = button.querySelector('i');
        
        if (target) {
            target.addEventListener('show.bs.collapse', function() {
                chevron.classList.remove('bi-chevron-right');
                chevron.classList.add('bi-chevron-down');
            });
            
            target.addEventListener('hide.bs.collapse', function() {
                chevron.classList.remove('bi-chevron-down');
                chevron.classList.add('bi-chevron-right');
            });
        }
    });
    
    // Update touchpoint checkboxes based on individual test states
    document.querySelectorAll('.test-checkbox').forEach(cb => {
        cb.addEventListener('change', function() {
            const touchpointId = this.getAttribute('data-touchpoint');
            updateTouchpointCheckbox(touchpointId);
        });
    });
});

function updateTouchpointCheckbox(touchpointId) {
    const allTests = document.querySelectorAll(`#tests_${touchpointId} .test-checkbox`);
    const checkedTests = document.querySelectorAll(`#tests_${touchpointId} .test-checkbox:checked`);
    const touchpointCheckbox = document.getElementById('touchpoint_' + touchpointId);
    
    if (checkedTests.length === 0) {
        touchpointCheckbox.checked = false;
        touchpointCheckbox.indeterminate = false;
    } else if (checkedTests.length === allTests.length) {
        touchpointCheckbox.checked = true;
        touchpointCheckbox.indeterminate = false;
    } else {
        touchpointCheckbox.checked = true;
        touchpointCheckbox.indeterminate = true;
    }
}
</script>
{% endblock %}