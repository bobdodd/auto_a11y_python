{% extends "static_report/base.html" %}

{% block title %}Issues Not in Common Components - Deduplicated Report{% endblock %}

<!-- Macro for rendering instance accordion -->
{% macro render_instance_accordion(violation, instance_id, parent_id, alert_type, loop_index) %}
<div class="accordion-item">
    <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button"
                data-bs-toggle="collapse"
                data-bs-target="#{{ instance_id }}">
            <strong>Instance {{ loop_index }}:</strong>
            {% if violation.metadata and violation.metadata.authenticated_user %}
                <span class="badge bg-secondary ms-2">
                    <i class="bi bi-person-fill"></i> {{ violation.metadata.authenticated_user.display_name }}
                    {% if violation.metadata.authenticated_user.roles %}
                        ({{ violation.metadata.authenticated_user.roles|join(', ') }})
                    {% endif %}
                </span>
            {% else %}
                <span class="badge bg-secondary ms-2">
                    <i class="bi bi-person"></i> Guest
                </span>
            {% endif %}
            {% if violation.xpath %}
            <code class="ms-2">{{ violation.xpath }}</code>
            {% endif %}
        </button>
    </h2>
    <div id="{{ instance_id }}"
         class="accordion-collapse collapse"
         data-bs-parent="#{{ parent_id }}">
        <div class="accordion-body">
            {{ render_violation_details(violation, alert_type) }}
        </div>
    </div>
</div>
{% endmacro %}

<!-- Macro for rendering violation details -->
{% macro render_violation_details(violation, alert_type) %}
<!-- Issue Details - Match online view exactly -->
{% if violation.metadata and violation.metadata.what %}
<!-- Enhanced description available -->
<div class="alert alert-{{ alert_type }} mb-3">
    <h6 class="alert-heading">{{ violation.description }}</h6>
</div>

<h6 class="text-{{ alert_type }} mb-2">About this issue:</h6>

<div class="mb-3">
    <strong>What the issue is:</strong>
    <p>{{ violation.description }}</p>
</div>

{% if violation.metadata.why %}
<div class="mb-3">
    <strong>Why this is important:</strong>
    <p>{{ violation.metadata.why }}</p>
</div>
{% endif %}

{% if violation.metadata.who %}
<div class="mb-3">
    <strong>Who it affects:</strong>
    <p>{{ violation.metadata.who }}</p>
</div>
{% endif %}

{% if violation.metadata.full_remediation %}
<div class="mb-3">
    <strong>How to remediate:</strong>
    <div class="bg-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace;">{{ violation.metadata.full_remediation|default(violation.failure_summary) }}</div>
</div>
{% endif %}

{% if violation.metadata.wcag_full %}
<h6 class="text-{{ alert_type }} mb-2 mt-4">Relevant test criteria:</h6>
<div class="mb-3">
    <strong>WCAG Success Criteria:</strong>
    <ul>
    {% for criterion in violation.metadata.wcag_full %}
        <li>{{ criterion|safe }}</li>
    {% endfor %}
    </ul>
</div>
{% endif %}
{% else %}
<!-- Standard description -->
<p><strong>Rule:</strong> {{ violation.id }}</p>
<p><strong>Help:</strong> {{ violation.description }}</p>
{% if violation.failure_summary %}
<p><strong>How to fix:</strong> {{ violation.failure_summary }}</p>
{% endif %}
{% endif %}

<hr>
<div class="row">
    <div class="col-md-6">
        <p><strong>Touchpoint:</strong> {{ violation.touchpoint|replace('_', ' ')|title }}</p>
        <p><strong>Impact:</strong>
            {% set impact_clean = violation.impact|string|replace('IMPACT_LEVEL.', '')|replace('ImpactLevel.', '') %}
            <span class="badge bg-{{ {'high': 'danger', 'serious': 'danger', 'critical': 'danger', 'medium': 'warning', 'moderate': 'warning', 'low': 'info', 'minor': 'info'}[impact_clean|lower] or 'secondary' }} impact-badge">
                {{ impact_clean|upper }}
            </span>
        </p>
    </div>
    <div class="col-md-6">
        {% if violation.metadata and violation.metadata.wcag_full %}
            {% for criterion in violation.metadata.wcag_full|sort %}
            <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-left: 3px solid #0066cc;">
                <p style="margin: 0 0 8px 0; font-weight: bold;">
                    WCAG {{ criterion|safe }}
                </p>

                {% set criterion_code = criterion.split()[0] %}
                <p style="margin: 0 0 5px 0;">
                    <a href="https://www.w3.org/WAI/WCAG22/Understanding/{{ criterion_code }}" target="_blank">
                        More about {{ criterion_code }} <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                </p>
                <p style="margin: 0;">
                    <a href="https://www.w3.org/WAI/WCAG22/quickref/#{{ criterion_code }}" target="_blank">
                        Ways to meet {{ criterion_code }} <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                </p>
            </div>
            {% endfor %}
        {% endif %}
    </div>
</div>

{% if violation.xpath %}
<p class="mt-3">
    <strong>Location:</strong>
    <code>{{ violation.xpath }}</code>
</p>
{% endif %}

{% if violation.metadata and violation.metadata.breakpoint %}
<p>
    <strong>Responsive Breakpoint:</strong> <span class="badge bg-info">{{ violation.metadata.breakpoint }}px width</span>
</p>
{% endif %}

{% if violation.metadata and violation.metadata.pseudoclass %}
<p>
    <strong>CSS State:</strong>
    {% if '@' in violation.metadata.pseudoclass %}
        {% set parts = violation.metadata.pseudoclass.split('@') %}
        <span class="badge bg-warning">{{ parts[0] }}</span>
        <span class="badge bg-secondary">{{ parts[1] }}</span>
    {% else %}
        <span class="badge bg-warning">{{ violation.metadata.pseudoclass }}</span>
    {% endif %}
</p>
{% endif %}

{% if violation.html_snippet %}
<h6 class="mt-3">Code Snippet</h6>
<pre class="bg-dark text-light p-3 rounded"><code>{{ violation.html_snippet|e }}</code></pre>
{% endif %}
{% endmacro %}

<!-- Macro for rendering issue details (legacy, for deduplicated view) -->
{% macro render_issue_details(issue, alert_type) %}
    <div class="alert alert-{{ alert_type }}">
        <h6 class="alert-heading">{{ issue.description }}</h6>
    </div>

    <h6 class="text-{{ alert_type }} mb-2">About this issue:</h6>

    <div class="mb-3">
        <strong>What the issue is:</strong>
        <p>{{ issue.description }}</p>
    </div>

    {% if issue.why %}
    <div class="mb-3">
        <strong>Why this is important:</strong>
        <p>{{ issue.why }}</p>
    </div>
    {% endif %}

    {% if issue.who %}
    <div class="mb-3">
        <strong>Who it affects:</strong>
        <p>{{ issue.who }}</p>
    </div>
    {% endif %}

    {% if issue.full_remediation %}
    <div class="mb-3">
        <strong>How to remediate:</strong>
        <div class="bg-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace;">{{ issue.full_remediation }}</div>
    </div>
    {% endif %}

    {% if issue.wcag_full %}
    <h6 class="text-{{ alert_type }} mb-2 mt-4">Relevant test criteria:</h6>
    <div class="mb-3">
        <strong>WCAG Success Criteria:</strong>
        <ul>
        {% for criterion in issue.wcag_full %}
            <li>{{ criterion|safe }}</li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}

    <hr>

    <div class="row">
        <div class="col-md-6">
            {% if issue.touchpoint %}
            <p><strong>Touchpoint:</strong> {{ issue.touchpoint|replace('_', ' ')|title }}</p>
            {% endif %}
            <p><strong>Impact:</strong>
                <span class="badge bg-{{ {'critical': 'danger', 'high': 'danger', 'serious': 'danger', 'moderate': 'warning', 'medium': 'warning', 'minor': 'info', 'low': 'info'}[issue.impact|lower] or 'secondary' }} impact-badge">
                    {{ issue.impact|upper }}
                </span>
            </p>
        </div>
        <div class="col-md-6">
            {% if issue.wcag_full %}
                {% for criterion in issue.wcag_full|sort %}
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-left: 3px solid #0066cc;">
                    <p style="margin: 0 0 8px 0; font-weight: bold;">
                        WCAG {{ criterion|safe }}
                    </p>
                    {% set criterion_code = criterion.split()[0] %}
                    <p style="margin: 0 0 5px 0;">
                        <a href="https://www.w3.org/WAI/WCAG22/Understanding/{{ criterion_code }}" target="_blank">
                            More about {{ criterion_code }} <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                    </p>
                    <p style="margin: 0;">
                        <a href="https://www.w3.org/WAI/WCAG22/quickref/#{{ criterion_code }}" target="_blank">
                            Ways to meet {{ criterion_code }} <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                    </p>
                </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>

    <hr>
    <div class="mb-3">
        <strong>Affected Pages ({{ issue.page_count }}):</strong>
        <div class="mt-2">
            <details>
                <summary class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-chevron-down"></i> Show all {{ issue.page_count }} page(s)
                </summary>
                <div class="mt-2 p-3 bg-light rounded">
                    {% for page_url in issue.pages %}
                    <div class="mb-2">
                        <i class="bi bi-file-earmark-text text-muted"></i> <code>{{ page_url }}</code>
                    </div>
                    {% endfor %}
                </div>
            </details>
        </div>
    </div>

    {% if issue.element or issue.xpath %}
    <hr>
    <h6 class="text-{{ alert_type }} mb-2">Element Details:</h6>
    {% if issue.element %}
    <p><strong>Element:</strong> <code>{{ issue.element }}</code></p>
    {% endif %}
    {% if issue.xpath %}
    <p><strong>XPath:</strong></p>
    <div class="bg-light p-2 rounded" style="font-family: monospace; font-size: 0.875rem; overflow-x: auto;">
        {{ issue.xpath }}
    </div>
    {% endif %}
    {% endif %}
{% endmacro %}

{% block extra_css %}
<style>
    .touchpoint-header {
        background-color: #f8f9fa;
        padding: 8px;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
        padding-left: 0.5rem;
    }

    .impact-badge {
        min-width: 75px;
        display: inline-block;
        text-align: center;
    }

    .accordion-button {
        padding-left: 2.5rem;
        padding-right: 1.25rem;
    }

    .accordion-button::after {
        position: absolute;
        left: 1rem;
        right: auto;
        transform: rotate(-90deg);
        transition: transform 0.2s ease-in-out;
    }

    .accordion-button:not(.collapsed)::after {
        transform: rotate(0deg);
    }

    .accordion-button > * {
        margin-left: 0.5rem;
    }

    .accordion-button > *:first-child {
        margin-left: 0;
    }

    .breadcrumb {
        background-color: #f8f9fa;
        padding: 0.75rem 1rem;
        border-radius: 0.375rem;
    }

    .card {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }

    .card-body {
        padding: 1rem;
    }

    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 0.75rem 1rem;
    }

    /* Filter Panel Styling */
    .filter-panel {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .filter-group {
        margin-bottom: 1rem;
    }

    .filter-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .filter-chip {
        padding: 0.25rem 0.75rem;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.875rem;
    }

    .filter-chip:hover {
        background: #e9ecef;
    }

    .filter-chip.active {
        background: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }

    .active-filters {
        padding: 1rem;
        background: #e7f3ff;
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .active-filter-tag {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        background: #0d6efd;
        color: white;
        border-radius: 15px;
        margin: 0.25rem;
        font-size: 0.875rem;
    }

    .active-filter-tag .remove-filter {
        margin-left: 0.5rem;
        cursor: pointer;
    }

    .filter-stats {
        padding: 0.75rem;
        background: white;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        margin-bottom: 1rem;
    }

    .issue-item {
        transition: opacity 0.3s;
    }

    .issue-item.filtered-out {
        display: none;
    }

    .test-results-card {
        margin-bottom: 2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Page Navigation -->
    <nav aria-label="breadcrumb" class="mb-3 no-print">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="../index.html">Index</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">{{ page.title|default('Untitled Page') }}</li>
        </ol>
    </nav>

    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2">{{ page.title|default('Untitled Page') }}</h1>
            <p class="text-muted">
                <a href="{{ page.url }}" target="_blank">
                    {{ page.url }} <i class="bi bi-box-arrow-up-right"></i>
                </a>
            </p>
        </div>
    </div>

    <!-- Page Status Cards -->
    <div class="row mb-4 g-3">
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Status</h6>
                    <p class="mb-0">
                        <span class="badge bg-success">Tested</span>
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Last Tested</h6>
                    <p class="mb-0">
                        {{ page.test_date|default('Recently') }}
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Issues Found</h6>
                    <p class="mb-0">
                        <span class="text-danger fw-bold">{{ errors_count|default(0) }}</span> errors,
                        <span class="text-warning fw-bold">{{ warnings_count|default(0) }}</span> warnings
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Score</h6>
                    <p class="mb-0">
                        {% set score = page.score|default(0) %}
                        <span class="fw-bold {% if score >= 90 %}text-success{% elif score >= 70 %}text-warning{% else %}text-danger{% endif %}">
                            {{ "%.0f"|format(score) }}%
                        </span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Accessibility & Compliance Scores -->
    {% if page.score is defined %}
    <div class="row mb-4">
        <!-- Accessibility Score Card -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body text-center">
                    {% set score = page.score|default(0) %}
                    <h6 class="card-title">Full Page Accessibility Score</h6>
                    <div class="display-4 fw-bold {% if score >= 90 %}text-success{% elif score >= 70 %}text-warning{% else %}text-danger{% endif %}">
                        {{ "%.1f"|format(score) }}%
                    </div>
                    <p class="text-muted small mb-0">All issues (full page)</p>
                </div>
            </div>
        </div>

        <!-- Deduplicated Score Card -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body text-center">
                    {% set dscore = dedup_score|default(0) %}
                    <h6 class="card-title">Non-Component Issues Score</h6>
                    <div class="display-4 fw-bold {% if dscore >= 90 %}text-success{% elif dscore >= 70 %}text-warning{% else %}text-danger{% endif %}">
                        {{ "%.1f"|format(dscore) }}%
                    </div>
                    <p class="text-muted small mb-0">Issues not in common components</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <!-- Compliance Score Card -->
        <div class="col-md-12">
            <div class="card h-100">
                <div class="card-body text-center">
                    <h6 class="card-title">Compliance Score</h6>
                    {% if compliance_score %}
                    <div class="display-4 fw-bold {% if compliance_score.score >= 90 %}text-success{% elif compliance_score.score >= 70 %}text-warning{% else %}text-danger{% endif %}">
                        {{ "%.1f"|format(compliance_score.score) }}%
                    </div>
                    <p class="text-muted small mb-0">{{ compliance_score.passed_tests }} / {{ compliance_score.total_tests }} tests passed</p>
                    {% else %}
                    <div class="display-4 fw-bold text-muted">N/A</div>
                    <p class="text-muted small mb-0">No data available</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Issue Breakdown -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-bug"></i> Issues Found (Non-Component Issues Only)</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-6 col-lg-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-x-circle text-danger me-2 fs-4"></i>
                        <div>
                            <div class="fw-bold">{{ errors_count|default(0) }}</div>
                            <small class="text-muted">Errors</small>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle text-warning me-2 fs-4"></i>
                        <div>
                            <div class="fw-bold">{{ warnings_count|default(0) }}</div>
                            <small class="text-muted">Warnings</small>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-info-circle text-info me-2 fs-4"></i>
                        <div>
                            <div class="fw-bold">{{ info_count|default(0) }}</div>
                            <small class="text-muted">Info</small>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-search" style="color: #6f42c1;" class="me-2 fs-4"></i>
                        <div>
                            <div class="fw-bold">{{ discovery_count|default(0) }}</div>
                            <small class="text-muted">Discovery</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Filter Panel -->
    {% if violations or warnings or info or discovery %}
    <div class="filter-panel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> Filter Test Results</h5>
            <button class="btn btn-sm btn-outline-secondary" id="clearFilters">
                <i class="bi bi-x-circle"></i> Clear All Filters
            </button>
        </div>

        <!-- Active Filters Display -->
        <div id="activeFilters" class="active-filters" style="display: none;">
            <strong>Active Filters:</strong>
            <div id="activeFilterTags"></div>
        </div>

        <!-- Filter Statistics -->
        <div class="filter-stats">
            <strong>Showing:</strong>
            <span id="visibleCount">0</span> of <span id="totalCount">0</span> items
            | <span id="filterSummary"></span>
        </div>

        <!-- Filter Groups -->
        <div class="row">
            <!-- Issue Type Filter -->
            <div class="col-md-3">
                <div class="filter-group">
                    <label class="form-label fw-bold">Issue Type</label>
                    <div class="filter-chips">
                        {% if violations %}
                        <div class="filter-chip" data-filter-type="type" data-filter-value="error">
                            Errors ({{ violations|length }})
                        </div>
                        {% endif %}
                        {% if warnings %}
                        <div class="filter-chip" data-filter-type="type" data-filter-value="warning">
                            Warnings ({{ warnings|length }})
                        </div>
                        {% endif %}
                        {% if info %}
                        <div class="filter-chip" data-filter-type="type" data-filter-value="info">
                            Info ({{ info|length }})
                        </div>
                        {% endif %}
                        {% if discovery %}
                        <div class="filter-chip" data-filter-type="type" data-filter-value="discovery">
                            Discovery ({{ discovery|length }})
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Impact Level Filter -->
            <div class="col-md-3">
                <div class="filter-group">
                    <label class="form-label fw-bold">Impact Level</label>
                    <div class="filter-chips">
                        <div class="filter-chip" data-filter-type="impact" data-filter-value="high">
                            <span class="badge bg-danger me-1">High</span>
                            <span id="highImpactCount">0</span>
                        </div>
                        <div class="filter-chip" data-filter-type="impact" data-filter-value="medium">
                            <span class="badge bg-warning text-dark me-1">Medium</span>
                            <span id="mediumImpactCount">0</span>
                        </div>
                        <div class="filter-chip" data-filter-type="impact" data-filter-value="low">
                            <span class="badge bg-info me-1">Low</span>
                            <span id="lowImpactCount">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Touchpoint Filter -->
            <div class="col-md-6">
                <div class="filter-group">
                    <label class="form-label fw-bold">Issue Touchpoint</label>
                    <select class="form-select form-select-sm" id="touchpointFilter" multiple size="3">
                        <option value="">All Touchpoints</option>
                        {% set all_issues = violations + warnings + info + discovery %}
                        {% set touchpoints = all_issues|map(attribute='touchpoint')|unique|sort %}
                        {% for touchpoint in touchpoints %}
                        <option value="{{ touchpoint }}">{{ touchpoint|replace('_', ' ')|title if touchpoint else 'General' }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- Quick Search -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="quickSearch"
                           placeholder="Search in issue descriptions, error codes, or XPaths...">
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Test Results -->
    <div class="card test-results-card mt-4">
        <div class="card-header">
            <h5 class="mb-0">Non-Component Issues for This Page</h5>
            <small class="text-muted">Issues not part of common components</small>
        </div>
        <div class="card-body">

    <!-- Violations -->
    {% if violations %}
    <h6 class="text-danger mb-3">
        <i class="bi bi-x-circle"></i> Errors ({{ violations|length }})
    </h6>
    <div class="accordion mb-4" id="violationsAccordion">
        {% set viol_counter = namespace(value=0) %}
        {% for touchpoint, touchpoint_violations in violations|groupby('touchpoint') %}
            <div class="touchpoint-header mt-3 mb-2 ps-2" style="border-left: 4px solid #dc3545;">
                <strong>{{ touchpoint|replace('_', ' ')|title if touchpoint else 'General' }}</strong>
            </div>

            {% for error_code, description_group in touchpoint_violations|groupby('id') %}
                {% set group_list = description_group|list %}
                {% set viol_counter.value = viol_counter.value + 1 %}
                {% set first_violation = group_list[0] %}
                {% set impact_text = first_violation.impact|string|replace('IMPACT_LEVEL.', '')|replace('ImpactLevel.', '') %}

                <div class="accordion-item mb-2 issue-item"
                     data-type="error"
                     data-impact="{{ impact_text|lower }}"
                     data-touchpoint="{{ touchpoint|lower }}"
                     data-id="{{ error_code }}"
                     data-description="{{ first_violation.metadata.what_generic|lower if first_violation.metadata and first_violation.metadata.what_generic else first_violation.description|lower }}"
                     data-xpath="{{ first_violation.xpath|lower if first_violation.xpath else '' }}">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#viol-{{ viol_counter.value }}">
                            {% if group_list|length > 1 %}
                            <span class="badge bg-{{ {'high': 'danger', 'serious': 'danger', 'critical': 'danger', 'medium': 'warning', 'moderate': 'warning', 'low': 'info', 'minor': 'info'}[impact_text|lower] or 'secondary' }} me-2">{{ group_list|length }}</span>
                            {% endif %}
                            <span class="badge bg-{{ {'high': 'danger', 'serious': 'danger', 'critical': 'danger', 'medium': 'warning', 'moderate': 'warning', 'low': 'info', 'minor': 'info'}[impact_text|lower] or 'secondary' }} me-2 impact-badge">
                                {{ impact_text|upper }}
                            </span>
                            <code class="me-2">{{ error_code }}</code>
                            {{ first_violation.metadata.what_generic if first_violation.metadata and first_violation.metadata.what_generic else first_violation.description }}
                        </button>
                    </h2>
                    <div id="viol-{{ viol_counter.value }}" class="accordion-collapse collapse" data-bs-parent="#violationsAccordion">
                        <div class="accordion-body">
                            {% if group_list|length > 1 %}
                            <!-- Multiple instances - show nested accordion -->
                            <div class="accordion" id="viol_instances_{{ viol_counter.value }}">
                                {% for instance in group_list %}
                                {{ render_instance_accordion(instance, 'viol_inst_' ~ viol_counter.value ~ '_' ~ loop.index, 'viol_instances_' ~ viol_counter.value, 'danger', loop.index) }}
                                {% endfor %}
                            </div>
                            {% else %}
                            <!-- Single instance - show details directly -->
                            {{ render_violation_details(first_violation, 'danger') }}
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
    </div>
    {% endif %}

    <!-- Warnings -->
    {% if warnings %}
    <h6 class="text-warning mb-3">
        <i class="bi bi-exclamation-triangle"></i> Warnings ({{ warnings|length }})
    </h6>
    <div class="accordion mb-4" id="warningsAccordion">
        {% set warn_counter = namespace(value=0) %}
        {% for touchpoint, touchpoint_warnings in warnings|groupby('touchpoint') %}
            <div class="touchpoint-header mt-3 mb-2 ps-2" style="border-left: 4px solid #ffc107;">
                <strong>{{ touchpoint|replace('_', ' ')|title if touchpoint else 'General' }}</strong>
            </div>

            {% for warning_code, description_group in touchpoint_warnings|groupby('id') %}
                {% set group_list = description_group|list %}
                {% set warn_counter.value = warn_counter.value + 1 %}
                {% set first_warning = group_list[0] %}
                {% set impact_text = first_warning.impact|string|replace('IMPACT_LEVEL.', '')|replace('ImpactLevel.', '') %}

                <div class="accordion-item mb-2 issue-item"
                     data-type="warning"
                     data-impact="{{ impact_text|lower }}"
                     data-touchpoint="{{ touchpoint|lower }}"
                     data-id="{{ warning_code }}"
                     data-description="{{ first_warning.metadata.what_generic|lower if first_warning.metadata and first_warning.metadata.what_generic else first_warning.description|lower }}"
                     data-xpath="{{ first_warning.xpath|lower if first_warning.xpath else '' }}">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#warn-{{ warn_counter.value }}">
                            {% if group_list|length > 1 %}
                            <span class="badge bg-{{ {'high': 'danger', 'serious': 'danger', 'critical': 'danger', 'medium': 'warning', 'moderate': 'warning', 'low': 'info', 'minor': 'info'}[impact_text|lower] or 'warning' }} me-2">{{ group_list|length }}</span>
                            {% endif %}
                            <span class="badge bg-{{ {'high': 'danger', 'serious': 'danger', 'critical': 'danger', 'medium': 'warning', 'moderate': 'warning', 'low': 'info', 'minor': 'info'}[impact_text|lower] or 'warning' }} me-2 impact-badge">
                                {{ impact_text|upper }}
                            </span>
                            <code class="me-2">{{ warning_code }}</code>
                            {{ first_warning.metadata.what_generic if first_warning.metadata and first_warning.metadata.what_generic else first_warning.description }}
                        </button>
                    </h2>
                    <div id="warn-{{ warn_counter.value }}" class="accordion-collapse collapse" data-bs-parent="#warningsAccordion">
                        <div class="accordion-body">
                            {% if group_list|length > 1 %}
                            <!-- Multiple instances - show nested accordion -->
                            <div class="accordion" id="warn_instances_{{ warn_counter.value }}">
                                {% for instance in group_list %}
                                {{ render_instance_accordion(instance, 'warn_inst_' ~ warn_counter.value ~ '_' ~ loop.index, 'warn_instances_' ~ warn_counter.value, 'warning', loop.index) }}
                                {% endfor %}
                            </div>
                            {% else %}
                            <!-- Single instance - show details directly -->
                            {{ render_violation_details(first_warning, 'warning') }}
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
    </div>
    {% endif %}

    <!-- Info -->
    {% if info %}
    <h6 class="text-info mb-3">
        <i class="bi bi-info-circle"></i> Informational ({{ info|length }})
    </h6>
    <div class="accordion mb-4" id="infoAccordion">
        {% set info_counter = namespace(value=0) %}
        {% for touchpoint, touchpoint_info in info|groupby('touchpoint') %}
            <div class="touchpoint-header mt-3 mb-2 ps-2" style="border-left: 4px solid #0dcaf0;">
                <strong>{{ touchpoint|replace('_', ' ')|title if touchpoint else 'General' }}</strong>
            </div>

            {% for info_code, description_group in touchpoint_info|groupby('id') %}
                {% set group_list = description_group|list %}
                {% set info_counter.value = info_counter.value + 1 %}
                {% set first_info = group_list[0] %}
                {% set impact_text = first_info.impact|string|replace('IMPACT_LEVEL.', '')|replace('ImpactLevel.', '') if first_info.impact else '' %}

                <div class="accordion-item mb-2 issue-item"
                     data-type="info"
                     data-impact="{{ impact_text|lower }}"
                     data-touchpoint="{{ touchpoint|lower }}"
                     data-id="{{ info_code }}"
                     data-description="{{ first_info.metadata.what_generic|lower if first_info.metadata and first_info.metadata.what_generic else first_info.description|lower }}"
                     data-xpath="{{ first_info.xpath|lower if first_info.xpath else '' }}">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#info-{{ info_counter.value }}">
                            {% if group_list|length > 1 %}
                            <span class="badge bg-{{ {'high': 'danger', 'serious': 'danger', 'critical': 'danger', 'medium': 'warning', 'moderate': 'warning', 'low': 'info', 'minor': 'info'}[impact_text|lower] or 'secondary' }} me-2">{{ group_list|length }}</span>
                            {% endif %}
                            {% if impact_text %}
                            <span class="badge bg-{{ {'high': 'danger', 'serious': 'danger', 'critical': 'danger', 'medium': 'warning', 'moderate': 'warning', 'low': 'info', 'minor': 'info'}[impact_text|lower] or 'info' }} me-2 impact-badge">
                                {{ impact_text|upper }}
                            </span>
                            {% endif %}
                            <code class="me-2">{{ info_code }}</code>
                            {{ first_info.metadata.what_generic if first_info.metadata and first_info.metadata.what_generic else first_info.description }}
                        </button>
                    </h2>
                    <div id="info-{{ info_counter.value }}" class="accordion-collapse collapse" data-bs-parent="#infoAccordion">
                        <div class="accordion-body">
                            {% if group_list|length > 1 %}
                            <!-- Multiple instances - show nested accordion -->
                            <div class="accordion" id="info_instances_{{ info_counter.value }}">
                                {% for instance in group_list %}
                                {{ render_instance_accordion(instance, 'info_inst_' ~ info_counter.value ~ '_' ~ loop.index, 'info_instances_' ~ info_counter.value, 'info', loop.index) }}
                                {% endfor %}
                            </div>
                            {% else %}
                            <!-- Single instance - show details directly -->
                            {{ render_violation_details(first_info, 'info') }}
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
    </div>
    {% endif %}

    <!-- Discovery -->
    {% if discovery %}
    <h6 class="mb-3" style="color: #6f42c1;">
        <i class="bi bi-search"></i> Discovery ({{ discovery|length }})
    </h6>
    <div class="accordion mb-4" id="discoveryAccordion">
        {% set disco_counter = namespace(value=0) %}
        {% for touchpoint, touchpoint_discovery in discovery|groupby('touchpoint') %}
            <div class="touchpoint-header mt-3 mb-2 ps-2" style="border-left: 4px solid #6f42c1;">
                <strong>{{ touchpoint|replace('_', ' ')|title if touchpoint else 'General' }}</strong>
            </div>

            {% for disco_code, description_group in touchpoint_discovery|groupby('id') %}
                {% set group_list = description_group|list %}
                {% set disco_counter.value = disco_counter.value + 1 %}
                {% set first_disco = group_list[0] %}

                <div class="accordion-item mb-2 issue-item"
                     data-type="discovery"
                     data-impact=""
                     data-touchpoint="{{ touchpoint|lower }}"
                     data-id="{{ disco_code }}"
                     data-description="{{ first_disco.metadata.what_generic|lower if first_disco.metadata and first_disco.metadata.what_generic else first_disco.description|lower }}"
                     data-xpath="{{ first_disco.xpath|lower if first_disco.xpath else '' }}">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#disco-{{ disco_counter.value }}">
                            {% if group_list|length > 1 %}
                            <span class="badge me-2" style="background-color: #6f42c1;">{{ group_list|length }}</span>
                            {% endif %}
                            <span class="badge me-2 impact-badge" style="background-color: #6f42c1;">
                                DISCOVERY
                            </span>
                            <code class="me-2">{{ disco_code }}</code>
                            {{ first_disco.metadata.what_generic if first_disco.metadata and first_disco.metadata.what_generic else first_disco.description }}
                        </button>
                    </h2>
                    <div id="disco-{{ disco_counter.value }}" class="accordion-collapse collapse" data-bs-parent="#discoveryAccordion">
                        <div class="accordion-body">
                            {% if group_list|length > 1 %}
                            <!-- Multiple instances - show nested accordion -->
                            <div class="accordion" id="disco_instances_{{ disco_counter.value }}">
                                {% for instance in group_list %}
                                {{ render_instance_accordion(instance, 'disco_inst_' ~ disco_counter.value ~ '_' ~ loop.index, 'disco_instances_' ~ disco_counter.value, 'primary', loop.index) }}
                                {% endfor %}
                            </div>
                            {% else %}
                            <!-- Single instance - show details directly -->
                            {{ render_violation_details(first_disco, 'primary') }}
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
    </div>
    {% endif %}

        </div><!-- End card-body -->
    </div><!-- End card -->
</div><!-- End container -->
{% endblock %}
