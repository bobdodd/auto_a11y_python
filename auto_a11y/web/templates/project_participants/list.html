{% extends "base.html" %}

{% block title %}{{ _('Testing Participants') }} - {{ project.name }} - Auto A11y{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{{ url_for('projects.view_project', project_id=project.id) }}">{{ project.name }}</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">{{ _('Testing Participants') }}</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2">
                <i class="bi bi-people"></i> {{ _('Testing Participants') }}
            </h1>
            <p class="text-muted">{{ _('Manage lived experience testers and test supervisors for %(name)s', name=project.name) }}</p>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Info Box -->
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i>
        <strong>{{ _('Testing Participants:') }}</strong>
        {{ _('These are the actual people involved in lived experience testing - the testers who have disabilities and use assistive technologies, and the supervisors who oversee the testing process. These participants are referenced in lived experience recordings.') }}
    </div>

    <!-- Lived Experience Testers -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-person-badge"></i> {{ _('Lived Experience Testers') }}
                    <span class="badge bg-light text-dark">{{ testers|length }}</span>
                </h5>
                <a href="{{ url_for('project_participants.create_tester', project_id=project.id) }}" class="btn btn-light btn-sm">
                    <i class="bi bi-plus-circle"></i> {{ _('Add Tester') }}
                </a>
            </div>
        </div>
        <div class="card-body">
            {% if testers %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>{{ _('Name') }}</th>
                            <th>{{ _('Disability Type') }}</th>
                            <th>{{ _('Assistive Technologies') }}</th>
                            <th>{{ _('Email') }}</th>
                            <th>{{ _('Actions') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tester in testers %}
                        <tr>
                            <td>
                                <strong>{{ tester.name }}</strong>
                                {% if tester.notes %}
                                <br><small class="text-muted">{{ tester.notes }}</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if tester.disability_type %}
                                <span class="badge bg-info">{{ tester.disability_type }}</span>
                                {% else %}
                                <span class="text-muted">{{ _('Not specified') }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if tester.assistive_tech %}
                                    {% for tech in tester.assistive_tech %}
                                    <span class="badge bg-secondary">{{ tech }}</span>
                                    {% endfor %}
                                {% else %}
                                <span class="text-muted">{{ _('None specified') }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if tester.email %}
                                <a href="mailto:{{ tester.email }}">{{ tester.email }}</a>
                                {% else %}
                                <span class="text-muted">{{ _('No email') }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{{ url_for('project_participants.edit_tester', project_id=project.id, tester_id=tester.id) }}"
                                       class="btn btn-outline-secondary" title="{{ _('Edit') }}">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <button type="button" class="btn btn-outline-danger"
                                            onclick="deleteTester('{{ tester.id }}')" title="{{ _('Delete') }}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="bi bi-person-badge" style="font-size: 3rem; color: #ddd;"></i>
                <p class="text-muted mt-3">{{ _('No lived experience testers yet') }}</p>
                <a href="{{ url_for('project_participants.create_tester', project_id=project.id) }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> {{ _('Add Your First Tester') }}
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Test Supervisors -->
    <div class="card">
        <div class="card-header bg-success text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-person-check"></i> {{ _('Test Supervisors') }}
                    <span class="badge bg-light text-dark">{{ supervisors|length }}</span>
                </h5>
                <a href="{{ url_for('project_participants.create_supervisor', project_id=project.id) }}" class="btn btn-light btn-sm">
                    <i class="bi bi-plus-circle"></i> {{ _('Add Supervisor') }}
                </a>
            </div>
        </div>
        <div class="card-body">
            {% if supervisors %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>{{ _('Name') }}</th>
                            <th>{{ _('Role') }}</th>
                            <th>{{ _('Organization') }}</th>
                            <th>{{ _('Email') }}</th>
                            <th>{{ _('Actions') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for supervisor in supervisors %}
                        <tr>
                            <td>
                                <strong>{{ supervisor.name }}</strong>
                                {% if supervisor.notes %}
                                <br><small class="text-muted">{{ supervisor.notes }}</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if supervisor.role %}
                                <span class="badge bg-primary">{{ supervisor.role }}</span>
                                {% else %}
                                <span class="text-muted">{{ _('Not specified') }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if supervisor.organization %}
                                {{ supervisor.organization }}
                                {% else %}
                                <span class="text-muted">{{ _('Not specified') }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if supervisor.email %}
                                <a href="mailto:{{ supervisor.email }}">{{ supervisor.email }}</a>
                                {% else %}
                                <span class="text-muted">{{ _('No email') }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{{ url_for('project_participants.edit_supervisor', project_id=project.id, supervisor_id=supervisor.id) }}"
                                       class="btn btn-outline-secondary" title="{{ _('Edit') }}">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <button type="button" class="btn btn-outline-danger"
                                            onclick="deleteSupervisor('{{ supervisor.id }}')" title="{{ _('Delete') }}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="bi bi-person-check" style="font-size: 3rem; color: #ddd;"></i>
                <p class="text-muted mt-3">{{ _('No test supervisors yet') }}</p>
                <a href="{{ url_for('project_participants.create_supervisor', project_id=project.id) }}" class="btn btn-success">
                    <i class="bi bi-plus-circle"></i> {{ _('Add Your First Supervisor') }}
                </a>
            </div>
            {% endif %}
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
function deleteTester(testerId) {
    if (!confirm("{{ _('Are you sure you want to delete this tester? This action cannot be undone.') }}")) return;

    fetch(`/projects/{{ project.id }}/participants/testers/${testerId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            window.location.href = data.redirect;
        } else {
            alert("{{ _('Error: %s') }}".replace('%s', data.error || "{{ _('Unknown error') }}"));
        }
    })
    .catch(err => {
        alert("{{ _('Error deleting tester: %s') }}".replace('%s', err));
    });
}

function deleteSupervisor(supervisorId) {
    if (!confirm("{{ _('Are you sure you want to delete this supervisor? This action cannot be undone.') }}")) return;

    fetch(`/projects/{{ project.id }}/participants/supervisors/${supervisorId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            window.location.href = data.redirect;
        } else {
            alert("{{ _('Error: %s') }}".replace('%s', data.error || "{{ _('Unknown error') }}"));
        }
    })
    .catch(err => {
        alert("{{ _('Error deleting supervisor: %s') }}".replace('%s', err));
    });
}
</script>
{% endblock %}
