{% extends "base.html" %}

{# NOTE: Due to template complexity, instance HTML rendering is duplicated in two places below.
   Search for "INSTANCE_HTML_START" to find both locations. Keep them in sync. #}

{% block title %}{{ page.title or page.url }} - Auto A11y{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/help-system.css') }}">
<style>
    .impact-badge {
        min-width: 75px;
        display: inline-block;
        text-align: center;
    }
    
    /* Move accordion indicators to the left for accessibility */
    .accordion-button {
        padding-left: 2.5rem;
        padding-right: 1.25rem;
    }
    
    .accordion-button::after {
        position: absolute;
        left: 1rem;
        right: auto;
        transform: rotate(-90deg);
        transition: transform 0.2s ease-in-out;
    }
    
    .accordion-button:not(.collapsed)::after {
        transform: rotate(0deg);
    }
    
    /* Ensure proper spacing for content */
    .accordion-button > * {
        margin-left: 0.5rem;
    }
    
    .accordion-button > *:first-child {
        margin-left: 0;
    }

    /* State selector button text contrast */
    .state-selector.btn-outline-primary.active small,
    .state-selector.btn-outline-primary:hover small,
    .state-selector.btn-outline-primary:focus small,
    .state-selector.btn-outline-primary:active small {
        color: white !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{{ url_for('projects.view_project', project_id=project.id) }}">{{ project.name }}</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{{ url_for('websites.view_website', website_id=website.id) }}">{{ website.display_name }}</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">{{ page.title or 'Page' }}</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2">{{ page.title or 'Untitled Page' }}</h1>
            <p class="text-muted">
                <a href="{{ page.url }}" target="_blank">
                    {{ page.url }} <i class="bi bi-box-arrow-up-right"></i>
                </a>
            </p>
        </div>
        <div id="page-actions">
            {% if page.status.value in ['queued', 'testing'] %}
            <button class="btn btn-danger" onclick="cancelPageTest('{{ page.id }}')" id="cancel-test-btn">
                <i class="bi bi-x-circle"></i> Cancel Test
            </button>
            {% else %}
            {% if website_users %}
            <select class="form-select form-select-sm d-inline-block me-2" id="test-user-select" style="width: auto;">
                <option value="">Test as guest (no login)</option>
                {% for user in website_users %}
                <option value="{{ user.id }}">{{ user.name_display }} {% if user.roles %}({{ user.roles|join(', ') }}){% endif %}</option>
                {% endfor %}
            </select>
            {% endif %}
            <button class="btn btn-primary" onclick="testPage('{{ page.id }}')" id="run-test-btn">
                <i class="bi bi-play"></i> Run Test
            </button>
            {% endif %}
            <a href="{{ url_for('pages.edit_page', page_id=page.id) }}" class="btn btn-outline-primary">
                <i class="bi bi-pencil"></i> Edit
            </a>
            <a href="{{ url_for('scripts.list_page_scripts', page_id=page.id) }}" class="btn btn-outline-success">
                <i class="bi bi-code-square"></i> Scripts
            </a>
        </div>
    </div>

    <!-- Test Progress Alert (shown during testing) -->
    <div id="test-progress-alert" class="alert alert-info d-none" role="alert">
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            <div>
                <strong>Test in Progress</strong> - The page will automatically refresh when testing completes.
            </div>
        </div>
    </div>
    
    <!-- Page Status -->
    <div class="row mb-4 g-3">
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Status</h6>
                    <p class="mb-0" id="page-status-container">
                        {% if page.status.value == 'discovered' %}
                            <span class="badge bg-secondary">Discovered</span>
                        {% elif page.status.value == 'queued' %}
                            <span class="badge bg-warning">
                                <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                Queued
                            </span>
                        {% elif page.status.value == 'testing' %}
                            <span class="badge bg-info">
                                <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                Testing
                            </span>
                        {% elif page.status.value == 'tested' %}
                            <span class="badge bg-success">Tested</span>
                        {% elif page.status.value == 'error' %}
                            <span class="badge bg-danger">Error</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ page.status.value|title }}</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Priority</h6>
                    <p class="mb-0">
                        {% if page.priority == 'critical' %}
                            <span class="badge bg-danger">Critical</span>
                        {% elif page.priority == 'high' %}
                            <span class="badge bg-warning">High</span>
                        {% elif page.priority == 'normal' %}
                            <span class="badge bg-info">Normal</span>
                        {% elif page.priority == 'low' %}
                            <span class="badge bg-secondary">Low</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ page.priority|title }}</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Last Tested</h6>
                    <p class="mb-0">
                        {{ page.last_tested.strftime('%Y-%m-%d %H:%M') if page.last_tested else 'Never' }}
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Test Duration</h6>
                    <p class="mb-0">
                        {% if page.test_duration_ms %}
                            {{ "%.2f"|format(page.test_duration_ms / 1000) }}s
                        {% else %}
                            N/A
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Page Screenshot</h6>
                    {% if page.screenshot_path %}
                    {% set page_screenshot_filename = page.screenshot_path.split('/')[-1] %}
                    <a href="#" onclick="showScreenshot('{{ url_for('serve_screenshot', filename=page_screenshot_filename) }}', '{{ page.url }}'); return false;">
                        <img src="{{ url_for('serve_screenshot', filename=page_screenshot_filename) }}"
                             alt="Screenshot of {{ page.url }}"
                             style="width: 120px; height: auto; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <span style="display: none; font-size: 0.9em; color: #999;">No screenshot available</span>
                    </a>
                    {% else %}
                    <span style="font-size: 0.9em; color: #999;">No screenshot available</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Accessibility & Compliance Scores (if available) -->
    {% if page.status.value == 'tested' and latest_result and score_data %}
    <div class="row mb-4">
        <!-- Accessibility Score Card -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-body text-center">
                    {% set score = score_data.score|default(0) %}
                    <h6 class="card-title">Accessibility Score <button class="help-icon" data-help="scoring.accessibility_score" aria-label="Get help about accessibility score">?</button></h6>
                    <div class="display-4 fw-bold
                        {% if score >= 90 %}text-success
                        {% elif score >= 70 %}text-warning
                        {% else %}text-danger{% endif %}">
                        {{ score|round(1) }}%
                    </div>
                    <p class="text-muted small mb-0">{{ score_data.passed_checks|default(0) }} / {{ score_data.applicable_checks|default(0) }} checks passed</p>
                </div>
            </div>
        </div>

        <!-- Compliance Score Card -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="card-title">Compliance Score <button class="help-icon" data-help="scoring.compliance_score" aria-label="Get help about compliance score">?</button></h6>
                    {% if compliance_score %}
                    <div class="display-4 fw-bold
                        {% if compliance_score.score >= 90 %}text-success
                        {% elif compliance_score.score >= 70 %}text-warning
                        {% else %}text-danger{% endif %}">
                        {{ compliance_score.score|round(1) }}%
                    </div>
                    <p class="text-muted small mb-0">{{ compliance_score.passed_tests }} / {{ compliance_score.total_tests }} tests passed</p>
                    {% else %}
                    <div class="display-4 fw-bold text-muted">N/A</div>
                    <p class="text-muted small mb-0">No data available</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Test Results Summary -->
    {% if page.status.value == 'tested' %}
    <!-- Two-section layout for clarity -->
    <div class="mb-4">
        <!-- Section 1: Issue Types Found -->
        <div class="card mb-3">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="bi bi-bug"></i> Accessibility Issues Found
                    <button type="button" class="btn btn-sm btn-link p-0 ms-2" data-bs-toggle="tooltip" data-bs-placement="right"
                            title="Number of unique issue types discovered. Each type may have multiple instances throughout the page.">
                        <i class="bi bi-question-circle"></i>
                    </button>
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-6 col-md-3">
                        <div class="text-center">
                            <h6 class="text-danger mb-1">
                                <i class="bi bi-x-circle"></i> Errors
                            </h6>
                            <p class="display-6 mb-0 text-danger">{{ page.violation_count }}</p>
                            <small class="text-muted">types found</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="text-center">
                            <h6 class="text-warning mb-1">
                                <i class="bi bi-exclamation-triangle"></i> Warnings
                            </h6>
                            <p class="display-6 mb-0 text-warning">{{ page.warning_count }}</p>
                            <small class="text-muted">types found</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="text-center">
                            <h6 class="text-info mb-1">
                                <i class="bi bi-info-circle"></i> Info
                            </h6>
                            <p class="display-6 mb-0 text-info">{{ page.info_count|default(0) }}</p>
                            <small class="text-muted">types found</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="text-center">
                            <h6 class="mb-1" style="color: #6f42c1;">
                                <i class="bi bi-search"></i> Discovery
                            </h6>
                            <p class="display-6 mb-0" style="color: #6f42c1;">{{ page.discovery_count|default(0) }}</p>
                            <small class="text-muted">types found</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Section 2: Test Checks Performance -->
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="bi bi-check2-square"></i> Accessibility Checks Performance
                    <button type="button" class="btn btn-sm btn-link p-0 ms-2" data-bs-toggle="tooltip" data-bs-placement="right"
                            title="Total individual checks performed on all page elements. High pass rate is good but doesn't guarantee full compliance if critical issues exist.">
                        <i class="bi bi-question-circle"></i>
                    </button>
                </h5>
            </div>
            <div class="card-body">
                {# Calculate actual totals from metadata if available, otherwise use page counts #}
                {% if score_data %}
                    {# Use calculated score_data (most reliable) #}
                    {% set actual_passed = score_data.passed_checks|default(0) %}
                    {% set actual_failed = score_data.failed_checks|default(0) %}
                    {% set actual_na = score_data.not_applicable_count|default(0) %}
                    {% set total_tested = score_data.applicable_checks|default(0) %}
                    {% set pass_rate = score_data.score|default(0) %}
                    {% set data_source = "score_data" %}
                {% elif latest_result and latest_result.metadata and latest_result.metadata.checks %}
                    {# Use the accurate check counts from metadata #}
                    {% set actual_passed = latest_result.metadata.checks | map(attribute='passed') | map('default', 0) | sum %}
                    {% set actual_failed = latest_result.metadata.checks | map(attribute='failed') | map('default', 0) | sum %}
                    {% set actual_na = latest_result.metadata.checks | selectattr('total', 'equalto', 0) | list | length %}
                    {% set total_tested = actual_passed + actual_failed %}
                    {% set pass_rate = (actual_passed / total_tested * 100) if total_tested > 0 else 0 %}
                    {% set data_source = "checks" %}
                {% elif latest_result and latest_result.metadata %}
                    {# Use metadata counts if available (more accurate than page counts) #}
                    {% set actual_passed = latest_result.metadata.get('passed_checks', 0) %}
                    {% set actual_failed = latest_result.metadata.get('failed_checks', 0) %}
                    {% set actual_na = latest_result.metadata.get('not_applicable_tests', []) | length %}
                    {% set total_tested = actual_passed + actual_failed %}
                    {% set pass_rate = (actual_passed / total_tested * 100) if total_tested > 0 else 0 %}
                    {% set data_source = "metadata" %}
                {% else %}
                    {# Last resort: use page-level counts (least accurate - counts elements not checks) #}
                    {% set actual_passed = page.pass_count %}
                    {% set actual_failed = page.violation_count + page.warning_count + page.info_count|default(0) + page.discovery_count|default(0) %}
                    {% set actual_na = 0 %}
                    {% set total_tested = actual_passed + actual_failed %}
                    {% set pass_rate = (actual_passed / total_tested * 100) if total_tested > 0 else 0 %}
                    {% set data_source = "page" %}
                {% endif %}
                
                
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <!-- Progress bar visualization -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span><strong>Overall Pass Rate</strong> <button class="help-icon" data-help="scoring.accessibility_score" aria-label="Get help about overall pass rate">?</button></span>
                                <span class="{% if pass_rate >= 90 %}text-success{% elif pass_rate >= 70 %}text-warning{% else %}text-danger{% endif %}">
                                    <strong>{{ "%.1f"|format(pass_rate) }}%</strong>
                                </span>
                            </div>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar {% if pass_rate >= 90 %}bg-success{% elif pass_rate >= 70 %}bg-warning{% else %}bg-danger{% endif %}" 
                                     role="progressbar" style="width: {{ pass_rate }}%">
                                    {{ actual_passed }} passed
                                </div>
                                {% if actual_failed > 0 %}
                                <div class="progress-bar bg-secondary" role="progressbar" 
                                     style="width: {{ 100 - pass_rate }}%">
                                    {{ actual_failed }} failed
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row text-center">
                            <div class="col">
                                <h6 class="text-success">✓ Passed</h6>
                                <p class="mb-0 fs-4">{{ actual_passed }}</p>
                            </div>
                            <div class="col">
                                <h6 class="text-danger">✗ Failed</h6>
                                <p class="mb-0 fs-4">{{ actual_failed }}</p>
                            </div>
                            {% if actual_na > 0 %}
                            <div class="col">
                                <h6 class="text-secondary">N/A</h6>
                                <p class="mb-0 fs-4">{{ actual_na }}</p>
                                <small class="text-muted">tests</small>
                            </div>
                            {% endif %}
                            <div class="col">
                                <h6 class="text-muted">Total Tested</h6>
                                <p class="mb-0 fs-4">{{ total_tested }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-info mb-0">
                            <h6 class="alert-heading"><i class="bi bi-lightbulb"></i> Understanding the Numbers</h6>
                            <small>
                                <strong>Example:</strong> 95% pass rate (475/500 passed) might still mean critical issues exist. 
                                Those 25 failed checks could all be "missing alt text" affecting every image on the page.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Check Results Detail (if available) -->
    {% if latest_result and latest_result.metadata and latest_result.metadata.checks %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Test Check Details</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Test</th>
                            <th>Check</th>
                            <th>WCAG</th>
                            <th class="text-center">Tested</th>
                            <th class="text-center">Passed</th>
                            <th class="text-center">Failed</th>
                            <th class="text-end">Pass Rate</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for check in latest_result.metadata.checks %}
                        <tr>
                            <td>{{ check.test_name }}</td>
                            <td>{{ check.description }}</td>
                            <td>
                                {% for criterion in check.wcag %}
                                <span class="badge bg-secondary">{{ criterion }}</span>
                                {% endfor %}
                            </td>
                            <td class="text-center">{{ check.total }}</td>
                            <td class="text-center text-success">{{ check.passed }}</td>
                            <td class="text-center text-danger">{{ check.failed }}</td>
                            <td class="text-end">
                                {% if check.total > 0 %}
                                    {% set pass_rate = (check.passed / check.total * 100)|round(1) %}
                                    <span class="badge 
                                        {% if pass_rate == 100 %}bg-success
                                        {% elif pass_rate >= 80 %}bg-warning
                                        {% else %}bg-danger{% endif %}">
                                        {{ pass_rate }}%
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">N/A</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <th colspan="3">Totals</th>
                            {% set total_passed = latest_result.metadata.checks | map(attribute='passed') | map('default', 0) | sum %}
                            {% set total_failed = latest_result.metadata.checks | map(attribute='failed') | map('default', 0) | sum %}
                            {% set total_na = latest_result.metadata.checks | selectattr('total', 'equalto', 0) | list | length %}
                            {% set total_tested = total_passed + total_failed %}
                            {% set total_elements = latest_result.metadata.checks | map(attribute='total') | map('default', 0) | sum %}
                            <th class="text-center">
                                {{ total_tested }}
                                {% if total_na > 0 %}
                                    <br><small class="text-muted">({{ total_na }} N/A checks)</small>
                                {% endif %}
                                {% if total_elements != total_tested %}
                                    <br><small class="text-muted">({{ total_elements - total_tested }} skipped)</small>
                                {% endif %}
                            </th>
                            <th class="text-center text-success">{{ total_passed }}</th>
                            <th class="text-center text-danger">{{ total_failed }}</th>
                            <th class="text-end">
                                {% if total_tested > 0 %}
                                    {% set overall_rate = (total_passed / total_tested * 100)|round(1) %}
                                    <span class="badge 
                                        {% if overall_rate >= 90 %}bg-success
                                        {% elif overall_rate >= 70 %}bg-warning
                                        {% else %}bg-danger{% endif %}">
                                        {{ overall_rate }}%
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">N/A</span>
                                {% endif %}
                            </th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Test Results Detail -->
    {% if latest_results_per_user %}
    {% set latest_result = latest_results_per_user[0] if not selected_user_id else latest_result %}
    {% set screenshot_filename = latest_result.screenshot_path.split('/')[-1] if latest_result and latest_result.screenshot_path else none %}
    <div class="card test-results-card" data-filterable="true">
        <div class="card-header">
            <h5 class="mb-0">Latest Test Results</h5>
            <small class="text-muted">
                {% if latest_result %}
                Tested on {{ latest_result.test_date.strftime('%Y-%m-%d %H:%M:%S') }}
                {% if latest_result.metadata and latest_result.metadata.get('authenticated_user') %}
                    | <i class="bi bi-person-fill"></i>
                    <strong>{{ latest_result.metadata.authenticated_user.display_name }}</strong>
                    {% if latest_result.metadata.authenticated_user.roles %}
                        ({{ latest_result.metadata.authenticated_user.roles|join(', ') }})
                    {% endif %}
                {% else %}
                    | <i class="bi bi-person"></i> <strong>Guest</strong> (no login)
                {% endif %}
                {% endif %}
            </small>
        </div>

        <!-- User Filter -->
        {% if latest_results_per_user|length > 1 %}
        <div class="card-body border-bottom bg-light">
            <h6 class="mb-3"><i class="bi bi-people-fill"></i> Filter by Test User</h6>
            <p class="text-muted small mb-3">
                This page has been tested with multiple users. Select a user to view their test results.
            </p>
            <div class="btn-group flex-wrap" role="group" aria-label="Test users">
                {% for user_result in latest_results_per_user %}
                    {% set user_data = user_result.metadata.get('authenticated_user') if user_result.metadata else None %}
                    {% set user_id = user_data.user_id if user_data else 'guest' %}
                    {% set user_display = user_data.display_name if user_data else 'Guest' %}
                    {% set user_roles = user_data.roles|join(', ') if user_data and user_data.roles else 'no login' %}
                    {% set is_active = (selected_user_id == user_id) or (not selected_user_id and loop.first) %}
                    <a href="{{ url_for('pages.view_page', page_id=page.id, user_id=user_id) }}"
                       class="btn btn-outline-primary {% if is_active %}active{% endif %}">
                        <i class="bi bi-person{% if user_data %}-fill{% endif %}"></i>
                        {{ user_display }}
                        <br>
                        <small class="{% if is_active %}text-white{% else %}text-muted{% endif %}">
                            {{ user_roles }}{% if user_result.violations %} | Errors: {{ user_result.violations|length }}{% endif %}
                        </small>
                    </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Multi-State Selector -->
        {% if state_results and state_results|length > 1 %}
        <div class="card-body border-bottom bg-light">
            <h6 class="mb-3"><i class="bi bi-layers"></i> Page States Tested</h6>
            <p class="text-muted small mb-3">
                This page was tested in multiple states. Select a state below to view its test results.
            </p>
            <div class="btn-group" role="group" aria-label="Page states">
                {% for state_result in state_results %}
                    {% set state_desc = state_result.page_state.description if state_result.page_state else ("State " ~ state_result.state_sequence) %}
                    {% set is_active = (loop.index0 == selected_state_index) %}
                    <button type="button"
                            class="btn btn-outline-primary state-selector {% if is_active %}active{% endif %}"
                            data-state-index="{{ loop.index0 }}"
                            onclick="showState({{ loop.index0 }})">
                        <i class="bi bi-circle-fill" style="font-size: 8px;"></i>
                        {{ state_desc }}
                        <br>
                        <small class="{% if is_active %}text-white{% else %}text-muted{% endif %}">
                            Errors: {{ state_result.violations|length }} | Warnings: {{ state_result.warnings|length }}
                        </small>
                    </button>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="card-body">
            <!-- Errors (Violations) -->
            {% if latest_result.violations %}
            <h6 class="text-danger mb-3">
                <i class="bi bi-x-circle"></i> Errors ({{ latest_result.violations|length }})
            </h6>
            <div class="accordion mb-4" id="violationsAccordion">
                {% set viol_counter = namespace(value=0) %}
                {% for touchpoint, touchpoint_violations in latest_result.violations|groupby('touchpoint') %}
                    <div class="touchpoint-header mt-3 mb-2 ps-2" style="background-color: #f8f9fa; padding: 8px; border-left: 4px solid #dc3545;">
                        <strong>{{ touchpoint|replace('_', ' ')|title }}</strong>
                    </div>
                    
                    {% for error_code, description_group in touchpoint_violations|groupby('id') %}
                        {% set group_list = description_group|list %}
                        {% set viol_counter.value = viol_counter.value + 1 %}
                        {% if group_list|length > 1 %}
                            <!-- Multiple instances - create sub-accordion -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#viol-group-{{ viol_counter.value }}">
                                        {% set first_violation = group_list[0] %}
                                        <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[first_violation.impact.value|lower if first_violation.impact.value else first_violation.impact|lower] or 'secondary' }} me-2">{{ group_list|length }}</span>
                                        <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[first_violation.impact.value|lower if first_violation.impact.value else first_violation.impact|lower] or 'secondary' }} me-2 impact-badge">
                                            {{ first_violation.impact.value|upper if first_violation.impact.value else first_violation.impact|upper }}
                                        </span>
                                        <code class="me-2">{{ error_code|error_code_only }}</code>
                                        {% if group_list|length > 1 %}
                                            {# For grouped issues, use generic description from catalog (never specific description from instance) #}
                                            {{ first_violation.metadata.what_generic if first_violation.metadata and first_violation.metadata.what_generic else (first_violation.metadata.what if first_violation.metadata and first_violation.metadata.what else error_code|error_code_only) }}
                                        {% else %}
                                            {# For single issues, show full specific description #}
                                            {% if first_violation.metadata and first_violation.metadata.title %}
                                                {{ first_violation.metadata.title }}
                                            {% elif first_violation.metadata and first_violation.metadata.what %}
                                                {{ first_violation.metadata.what }}
                                            {% else %}
                                                {{ first_violation.description }}
                                            {% endif %}
                                        {% endif %}
                                    </button>
                                </h2>
                                <div id="viol-group-{{ viol_counter.value }}"
                                     class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        {% set has_breakpoints = group_list[0].metadata and group_list[0].metadata.get('breakpoint') is not none %}

                                        {% if has_breakpoints %}
                                            {# Group by breakpoint for contrast violations #}
                                            {% set breakpoint_groups = group_list|groupby('metadata.breakpoint') %}
                                            <div class="accordion" id="viol-group-breakpoints-{{ viol_counter.value }}">
                                            {% for breakpoint, breakpoint_violations in breakpoint_groups %}
                                                {% set breakpoint_list = breakpoint_violations|list %}
                                                {% set breakpoint_id = viol_counter.value ~ '-bp-' ~ (breakpoint if breakpoint else 'none') %}
                                                <div class="accordion-item">
                                                    <h2 class="accordion-header">
                                                        <button class="accordion-button collapsed" type="button"
                                                                data-bs-toggle="collapse"
                                                                data-bs-target="#viol-breakpoint-{{ breakpoint_id }}">
                                                            <span class="badge bg-info me-2">{{ breakpoint_list|length }}</span>
                                                            <strong>Breakpoint: {{ breakpoint }}px width</strong>
                                                        </button>
                                                    </h2>
                                                    <div id="viol-breakpoint-{{ breakpoint_id }}"
                                                         class="accordion-collapse collapse"
                                                         data-bs-parent="#viol-group-breakpoints-{{ viol_counter.value }}">
                                                        <div class="accordion-body">
                                                            <div class="accordion" id="viol-breakpoint-instances-{{ breakpoint_id }}">
                                                            {% for violation in breakpoint_list %}
                                                            {% set instance_id = breakpoint_id ~ '-' ~ loop.index %}
                                                            {# INSTANCE_HTML_START - Keep in sync with non-breakpoint path #}
                                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed" type="button"
                                                            data-bs-toggle="collapse"
                                                            data-bs-target="#viol-instance-{{ instance_id }}">
                                                        <strong>Instance {{ loop.index }}:</strong>
                                                        {% if violation.metadata and violation.metadata.authenticated_user %}
                                                            <span class="badge bg-secondary ms-2">
                                                                <i class="bi bi-person-fill"></i> {{ violation.metadata.authenticated_user.display_name }}
                                                                {% if violation.metadata.authenticated_user.roles %}
                                                                    ({{ violation.metadata.authenticated_user.roles|join(', ') }})
                                                                {% endif %}
                                                            </span>
                                                        {% else %}
                                                            <span class="badge bg-secondary ms-2">
                                                                <i class="bi bi-person"></i> Guest
                                                            </span>
                                                        {% endif %}
                                                        {% if 'ErrDuplicateNavNames' in violation.id and violation.metadata and violation.metadata.duplicateName %}
                                                        <span class="ms-2">{{ violation.metadata.duplicateName }}</span>
                                                        {% elif 'DiscoFontFound' in violation.id and violation.metadata.fontName %}
                                                        <span class="ms-2">Font '{{ violation.metadata.fontName }}' at {{ violation.metadata.sizeCount }} size{{ 's' if violation.metadata.sizeCount != 1 else '' }}: {{ violation.metadata.fontSizes|join(', ') }}</span>
                                                        {% elif violation.xpath %}
                                                        <code class="ms-2">{{ violation.xpath }}</code>
                                                        {% endif %}
                                                    </button>
                                                </h2>
                                                <div id="viol-instance-{{ instance_id }}" 
                                                     class="accordion-collapse collapse"
                                                     data-bs-parent="#viol-group-instances-{{ viol_counter.value }}">
                                                    <div class="accordion-body">
                                                        <!-- Full violation details as before -->
                                                        {% if violation.metadata and violation.metadata.title %}
                                                        <!-- Enhanced description available -->
                                                        <div class="alert alert-danger mb-3">
                                                            <h6 class="alert-heading">{{ violation.description }}</h6>
                                                        </div>
                                                        
                                                        <h6 class="text-danger mb-2">About this issue:</h6>
                                                        
                                                        <div class="mb-3">
                                                            <strong>What the issue is:</strong>
                                                            {% if 'ErrLinkAccessibleNameMismatch' in violation.id and violation.description %}
                                                            <p>{{ violation.description }}</p>
                                                            {% else %}
                                                            <p>{{ violation.metadata.what|default(violation.description) }}</p>
                                                            {% endif %}
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <strong>Why this is important:</strong>
                                                            <p>{{ violation.metadata.why }}</p>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <strong>Who it affects:</strong>
                                                            <p>{{ violation.metadata.who }}</p>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <strong>How to remediate:</strong>
                                                            <div class="bg-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace;">{{ violation.metadata.full_remediation|default(violation.failure_summary) }}</div>
                                                        </div>

                                                        {% if violation.metadata.wcag_full or violation.wcag_criteria %}
                                                        <h6 class="text-danger mb-2 mt-4">Relevant test criteria:</h6>
                                                        <div class="mb-3">
                                                            {% if violation.metadata.wcag_full %}
                                                            <strong>WCAG Success Criteria:</strong>
                                                            <ul>
                                                            {% for criterion in violation.metadata.wcag_full %}
                                                                <li>{{ criterion|safe }}</li>
                                                            {% endfor %}
                                                            </ul>
                                                            {% elif violation.wcag_criteria %}
                                                            <strong>WCAG Success Criteria:</strong>
                                                            <ul>
                                                            {% for criterion in violation.wcag_criteria %}
                                                                <li>
                                                                    <a href="https://www.w3.org/WAI/WCAG21/Understanding/" target="_blank" class="text-decoration-none">
                                                                        {{ criterion }}
                                                                    </a>
                                                                </li>
                                                            {% endfor %}
                                                            </ul>
                                                            {% endif %}
                                                        </div>
                                                        {% endif %}
                                                        {% else %}
                                                        <!-- Standard description -->
                                                        <p><strong>Rule:</strong> {{ violation.rule_id|default(violation.id) }}</p>
                                                        <p><strong>Help:</strong> {{ violation.help_text|default(violation.description) }}</p>
                                                        {% if violation.failure_summary %}
                                                        <p><strong>How to fix:</strong> {{ violation.failure_summary }}</p>
                                                        {% endif %}
                                                        {% endif %}
                                                        
                                                        <hr>
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <p><strong>Touchpoint:</strong> {{ violation.touchpoint|default('General') }}</p>
                                                                <p><strong>Impact:</strong> 
                                                                    <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[violation.impact.value|lower if violation.impact.value else violation.impact|lower] or 'secondary' }} impact-badge">
                                                                        {{ violation.impact.value|upper if violation.impact.value else violation.impact|upper }}
                                                                    </span>
                                                                </p>
                                                            </div>
                                                            <div class="col-md-6">
                                                                {% if violation.metadata.wcag_full %}
                                                                    {% for criterion in violation.metadata.wcag_full|sort %}
                                                                    <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-left: 3px solid #0066cc;">
                                                                        <p style="margin: 0 0 8px 0; font-weight: bold;">
                                                                            WCAG {{ criterion|safe }}
                                                                        </p>
                                                                        
                                                                        <p style="margin: 0 0 5px 0;">
                                                                            <a href="{{ criterion.split()[0] | wcag_understanding_url }}" target="_blank">
                                                                                More about {{ criterion | wcag_name }} <i class="bi bi-box-arrow-up-right"></i>
                                                                            </a>
                                                                        </p>
                                                                        <p style="margin: 0;">
                                                                            <a href="{{ criterion.split()[0] | wcag_quickref_url }}" target="_blank">
                                                                                Ways to meet {{ criterion | wcag_name }} <i class="bi bi-box-arrow-up-right"></i>
                                                                            </a>
                                                                        </p>
                                                                        
                                                                    </div>
                                                                    {% endfor %}
                                                                {% elif violation.wcag_criteria %}
                                                                    {% for wcag_criterion in violation.wcag_criteria|sort %}
                                                                    <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-left: 3px solid #0066cc;">
                                                                        <p style="margin: 0 0 8px 0; font-weight: bold;">
                                                                            WCAG {{ wcag_criterion }}
                                                                        </p>
                                                                        
                                                                        <p style="margin: 0 0 5px 0;">
                                                                            <a href="{{ wcag_criterion | wcag_understanding_url }}" target="_blank">
                                                                                More about {{ wcag_criterion | wcag_name }} <i class="bi bi-box-arrow-up-right"></i>
                                                                            </a>
                                                                        </p>
                                                                        <p style="margin: 0;">
                                                                            <a href="{{ wcag_criterion | wcag_quickref_url }}" target="_blank">
                                                                                Ways to meet {{ wcag_criterion | wcag_name }} <i class="bi bi-box-arrow-up-right"></i>
                                                                            </a>
                                                                        </p>
                                                                        
                                                                    </div>
                                                                    {% endfor %}
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        
                                                        {% if (violation.selector or violation.xpath) and 'ErrDuplicateNavNames' not in violation.id %}
                                                        <p>
                                                            <strong>Location:</strong> <code>{{ violation.selector|default(violation.xpath) }}</code>
                                                            <button class="btn btn-sm btn-link p-0 ms-2" onclick="copyXpathToClipboard('{{ violation.selector|default(violation.xpath)|e }}', this)" title="Copy XPath to clipboard">
                                                                <i class="bi bi-clipboard"></i>
                                                            </button>
                                                        </p>
                                                        {% endif %}

                                                        {% if violation.metadata and violation.metadata.pseudoclass %}
                                                        <p>
                                                            <strong>CSS State:</strong>
                                                            {% if '@' in violation.metadata.pseudoclass %}
                                                                {% set parts = violation.metadata.pseudoclass.split('@') %}
                                                                <span class="badge bg-warning">{{ parts[0] }}</span>
                                                                <span class="badge bg-secondary">{{ parts[1] }}</span>
                                                            {% else %}
                                                                <span class="badge bg-warning">{{ violation.metadata.pseudoclass }}</span>
                                                            {% endif %}
                                                        </p>
                                                        {% endif %}

                                                        {% if violation.html %}
                                                        <h6 class="mt-3">Code Snippet</h6>
                                                        {% if 'ErrSkippedHeadingLevel' in violation.id and violation.metadata and 'previousHeadingHtml' in violation.metadata %}
                                                        <p class="mb-2"><strong>Previous heading (h{{ violation.metadata.skippedFrom }}):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ violation.metadata.previousHeadingHtml|e }}</code></pre>
                                                        <p class="mb-2"><strong>Current heading (h{{ violation.metadata.skippedTo }}) - skipped h{{ violation.metadata.expectedLevel }}:</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded"><code>{{ violation.html|e }}</code></pre>
                                                        {% elif 'ErrContentObscuring' in violation.id and violation.metadata and 'obscuredElements' in violation.metadata %}
                                                        <p class="mb-2"><strong>Obscuring element (dialog/overlay):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ violation.html|e }}</code></pre>
                                                        <h6 class="mt-4">{{ violation.metadata.obscuredCount }} Interactive element(s) being obscured:</h6>
                                                        {% for element in violation.metadata.obscuredElements %}
                                                        <div class="mb-3 border-start border-warning border-3 ps-3">
                                                            <p class="mb-1"><strong>&lt;{{ element.element }}&gt;:</strong> "{{ element.text }}"</p>
                                                            <p class="mb-1 small text-muted">
                                                            Location: <code>{{element.xpath}}</code>
                                                            <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyXpathToClipboard('{{element.xpath|e}}', this)" title="Copy XPath to clipboard" style="font-size: 0.875rem;">
                                                                <i class="bi bi-clipboard"></i>
                                                            </button>
                                                        </p>
                                                        </div>
                                                        {% endfor %}
                                                        {% elif 'ErrMultipleH1' in violation.id and violation.metadata and 'allH1s' in violation.metadata %}
                                                        <h6 class="mt-3">All {{ violation.metadata.count }} H1 elements found on page:</h6>
                                                        {% for h1 in violation.metadata.allH1s %}
                                                        <div class="mb-3">
                                                            <p class="mb-1"><strong>H1 #{{ h1.index }}:</strong> {{ h1.text }}</p>
                                                            <p class="mb-1 small text-muted">
                                                            Location: <code>{{h1.xpath}}</code>
                                                            <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyXpathToClipboard('{{h1.xpath|e}}', this)" title="Copy XPath to clipboard" style="font-size: 0.875rem;">
                                                                <i class="bi bi-clipboard"></i>
                                                            </button>
                                                        </p>
                                                            <pre class="bg-dark text-light p-2 rounded"><code>{{ h1.html|e }}</code></pre>
                                                        </div>
                                                        {% endfor %}
                                                        {% elif 'ErrFakeListImplementation' in violation.id and violation.metadata and 'sampleItems' in violation.metadata %}
                                                        <p class="mb-2"><strong>Detected pattern:</strong> {{ violation.metadata.pattern }}</p>
                                                        <p class="mb-2"><strong>Number of items found:</strong> {{ violation.metadata.itemCount }}</p>
                                                        {% if violation.metadata.sampleItems %}
                                                        <h6 class="mt-4">Sample list items detected:</h6>
                                                        {% for item in violation.metadata.sampleItems %}
                                                        <div class="mb-2 border-start border-info border-3 ps-3">
                                                            <p class="mb-0"><strong>Item {{ item.index }}:</strong> {{ item.text }}</p>
                                                        </div>
                                                        {% endfor %}
                                                        {% if violation.metadata.itemCount > 5 %}
                                                        <p class="text-muted small mt-2">...and {{ violation.metadata.itemCount - 5 }} more items</p>
                                                        {% endif %}
                                                        {% endif %}
                                                        <p class="mb-2 mt-3"><strong>Container element:</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded"><code>{{ violation.html|e }}</code></pre>
                                                        {% elif 'ErrDuplicateLandmarkWithoutName' in violation.id and violation.metadata and 'allInstances' in violation.metadata %}
                                                        <p class="mb-2"><strong>This instance (missing accessible name):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ violation.html|e }}</code></pre>
                                                        <h6 class="mt-4">All {{ violation.metadata.totalCount }} {{ violation.metadata.role }} landmarks on page:</h6>
                                                        {% for instance in violation.metadata.allInstances %}
                                                        <div class="mb-3">
                                                            <p class="mb-1"><strong>Instance {{ instance.index }}:</strong> {{ instance.name }}</p>
                                                            <p class="mb-1 small text-muted">
                                                            Location: <code>{{instance.xpath}}</code>
                                                            <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyXpathToClipboard('{{instance.xpath|e}}', this)" title="Copy XPath to clipboard" style="font-size: 0.875rem;">
                                                                <i class="bi bi-clipboard"></i>
                                                            </button>
                                                        </p>
                                                            <pre class="bg-dark text-light p-2 rounded"><code>{{ instance.html|e }}</code></pre>
                                                        </div>
                                                        {% endfor %}
                                                        {% elif 'ErrDuplicateNavNames' in violation.id and violation.metadata and 'allInstances' in violation.metadata %}
                                                        <h6 class="mt-3">All {{ violation.metadata.totalCount }} navigation elements with the name "{{ violation.metadata.duplicateName }}":</h6>
                                                        {% for instance in violation.metadata.allInstances %}
                                                        <div class="mb-3">
                                                            <p class="mb-1"><strong>Navigation {{ instance.index }}:</strong></p>
                                                            <p class="mb-1 small text-muted">
                                                            Location: <code>{{instance.xpath}}</code>
                                                            <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyXpathToClipboard('{{instance.xpath|e}}', this)" title="Copy XPath to clipboard" style="font-size: 0.875rem;">
                                                                <i class="bi bi-clipboard"></i>
                                                            </button>
                                                        </p>
                                                            <pre class="bg-dark text-light p-2 rounded"><code>{{ instance.html|e }}</code></pre>
                                                        </div>
                                                        {% endfor %}
                                                        {% elif 'ErrSmallText' in violation.id and violation.metadata and violation.metadata.get('allInstances') %}
                                                        <h6 class="mt-3">{{ violation.metadata.allInstances|length }} element(s) with text smaller than 16px:</h6>
                                                        {% for instance in violation.metadata.allInstances %}
                                                        <div class="mb-3">
                                                            <p class="mb-1"><strong>Instance {{ instance.index }}:</strong> &lt;{{ instance.element }}&gt; element - Text size: <span class="badge bg-warning">{{ instance.fontSize }}px</span></p>
                                                            <p class="mb-1 small">Text preview: "{{ instance.text }}"</p>
                                                            <p class="mb-1 small text-muted">
                                                            Location: <code>{{instance.xpath}}</code>
                                                            <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyXpathToClipboard('{{instance.xpath|e}}', this)" title="Copy XPath to clipboard" style="font-size: 0.875rem;">
                                                                <i class="bi bi-clipboard"></i>
                                                            </button>
                                                        </p>
                                                            <pre class="bg-dark text-light p-2 rounded"><code>{{ instance.html|e }}</code></pre>
                                                        </div>
                                                        {% endfor %}
                                                        {% elif 'ErrAnchorTargetTabindex' in violation.id and violation.metadata and violation.metadata.anchorLinksCount %}
                                                        <h6 class="mt-3">Link target (needs tabindex="-1"):</h6>
                                                        <p class="mb-2"><strong>Target element:</strong> &lt;{{ violation.element }}&gt; with id="{{ violation.metadata.targetId }}"</p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ violation.html|e }}</code></pre>
                                                        <h6 class="mt-4">{{ violation.metadata.anchorLinksCount }} anchor link(s) pointing to this target:</h6>
                                                        {% for anchor in violation.metadata.anchorLinks %}
                                                        <div class="mb-3">
                                                            <p class="mb-1"><strong>Link {{ anchor.index }}:</strong> "{{ anchor.text }}"</p>
                                                            <p class="mb-1 small text-muted">
                                                            Location: <code>{{anchor.xpath}}</code>
                                                            <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyXpathToClipboard('{{anchor.xpath|e}}', this)" title="Copy XPath to clipboard" style="font-size: 0.875rem;">
                                                                <i class="bi bi-clipboard"></i>
                                                            </button>
                                                        </p>
                                                            <pre class="bg-dark text-light p-2 rounded"><code>{{ anchor.html|e }}</code></pre>
                                                        </div>
                                                        {% endfor %}
                                                        {% elif 'ErrTabOrderViolation' in violation.id and violation.metadata and 'previousElement' in violation.metadata %}
                                                        <p class="mb-2"><strong>This element (comes later in tab order but appears visually left):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ violation.html|e }}</code></pre>
                                                        <p class="mb-2"><strong>Previous element in tab order (visually to the right):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ violation.metadata.previousElement.html|e }}</code></pre>
                                                        <div class="alert alert-info">
                                                            <p class="mb-1"><strong>Visual positions:</strong></p>
                                                            <p class="mb-1">• This element: x={{ violation.metadata.currentElement.position.x }}, y={{ violation.metadata.currentElement.position.y }} (tab stop #{{ violation.metadata.currentElement.tabIndex }})</p>
                                                            <p class="mb-0">• Previous element: x={{ violation.metadata.previousElement.position.x }}, y={{ violation.metadata.previousElement.position.y }} (tab stop #{{ violation.metadata.previousElement.tabIndex }})</p>
                                                        </div>
                                                        {% else %}
                                                        <pre class="bg-dark text-light p-3 rounded"><code>{{ violation.html|e }}</code></pre>
                                                        {% endif %}
                                                        {% endif %}

                                                        <!-- Thumbnail of the page at time of test -->
                                                        {% if screenshot_filename %}
                                                        <h6 class="mt-4">Page Thumbnail (at time of test)</h6>
                                                        <a href="#" onclick="showScreenshot('{{ url_for('serve_screenshot', filename=screenshot_filename) }}', '{{ page.url }}'); return false;">
                                                            <img src="{{ url_for('serve_screenshot', filename=screenshot_filename) }}"
                                                                 alt="Thumbnail of {{ page.url }}"
                                                                 class="img-thumbnail"
                                                                 style="max-width: 300px; height: auto; cursor: pointer;"
                                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                                            <span style="display: none; font-size: 0.9em; color: #999;">Thumbnail not available</span>
                                                        </a>
                                                        <p class="text-muted small mt-1">Click to view full size</p>
                                                        {% endif %}

                                                        {% if violation.metadata.ai_detected %}
                                                        <div class="alert alert-info mt-3">
                                                            <i class="bi bi-robot"></i> <strong>AI Detection Note:</strong>
                                                            <p class="mb-0">This issue was detected through visual analysis.</p>
                                                            {% if violation.metadata.ai_confidence %}
                                                            <p><strong>Confidence:</strong> {{ (violation.metadata.ai_confidence * 100)|round }}%</p>
                                                            {% endif %}
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            {# INSTANCE_HTML_END #}
                                            {% endfor %}
                                                            </div> {# Close viol-breakpoint-instances #}
                                                        </div> {# Close accordion-body #}
                                                    </div> {# Close viol-breakpoint collapse #}
                                                </div> {# Close accordion-item #}
                                            {% endfor %} {# End breakpoint loop #}
                                            </div> {# Close viol-group-breakpoints #}
                                        {% else %}
                                            {# No breakpoints - render instances directly #}
                                            <div class="accordion" id="viol-group-instances-{{ viol_counter.value }}">
                                            {% for violation in group_list %}
                                            {% set instance_id = viol_counter.value ~ '-' ~ loop.index %}
                                            {# INSTANCE_HTML_START - Keep in sync with breakpoint path #}
                                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed" type="button"
                                                            data-bs-toggle="collapse"
                                                            data-bs-target="#viol-instance-{{ instance_id }}">
                                                        <strong>Instance {{ loop.index }}:</strong>
                                                        {% if violation.metadata and violation.metadata.authenticated_user %}
                                                            <span class="badge bg-secondary ms-2">
                                                                <i class="bi bi-person-fill"></i> {{ violation.metadata.authenticated_user.display_name }}
                                                                {% if violation.metadata.authenticated_user.roles %}
                                                                    ({{ violation.metadata.authenticated_user.roles|join(', ') }})
                                                                {% endif %}
                                                            </span>
                                                        {% else %}
                                                            <span class="badge bg-secondary ms-2">
                                                                <i class="bi bi-person"></i> Guest
                                                            </span>
                                                        {% endif %}
                                                        {% if 'ErrDuplicateNavNames' in violation.id and violation.metadata and violation.metadata.duplicateName %}
                                                        <span class="ms-2">{{ violation.metadata.duplicateName }}</span>
                                                        {% elif 'DiscoFontFound' in violation.id and violation.metadata.fontName %}
                                                        <span class="ms-2">Font '{{ violation.metadata.fontName }}' at {{ violation.metadata.sizeCount }} size{{ 's' if violation.metadata.sizeCount != 1 else '' }}: {{ violation.metadata.fontSizes|join(', ') }}</span>
                                                        {% elif violation.xpath %}
                                                        <code class="ms-2">{{ violation.xpath }}</code>
                                                        {% endif %}
                                                    </button>
                                                </h2>
                                                <div id="viol-instance-{{ instance_id }}" 
                                                     class="accordion-collapse collapse"
                                                     data-bs-parent="#viol-group-instances-{{ viol_counter.value }}">
                                                    <div class="accordion-body">
                                                        <!-- Full violation details as before -->
                                                        {% if violation.metadata and violation.metadata.title %}
                                                        <!-- Enhanced description available -->
                                                        <div class="alert alert-danger mb-3">
                                                            <h6 class="alert-heading">{{ violation.description }}</h6>
                                                        </div>
                                                        
                                                        <h6 class="text-danger mb-2">About this issue:</h6>
                                                        
                                                        <div class="mb-3">
                                                            <strong>What the issue is:</strong>
                                                            {% if 'ErrLinkAccessibleNameMismatch' in violation.id and violation.description %}
                                                            <p>{{ violation.description }}</p>
                                                            {% else %}
                                                            <p>{{ violation.metadata.what|default(violation.description) }}</p>
                                                            {% endif %}
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <strong>Why this is important:</strong>
                                                            <p>{{ violation.metadata.why }}</p>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <strong>Who it affects:</strong>
                                                            <p>{{ violation.metadata.who }}</p>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <strong>How to remediate:</strong>
                                                            <div class="bg-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace;">{{ violation.metadata.full_remediation|default(violation.failure_summary) }}</div>
                                                        </div>

                                                        {% if violation.metadata.wcag_full or violation.wcag_criteria %}
                                                        <h6 class="text-danger mb-2 mt-4">Relevant test criteria:</h6>
                                                        <div class="mb-3">
                                                            {% if violation.metadata.wcag_full %}
                                                            <strong>WCAG Success Criteria:</strong>
                                                            <ul>
                                                            {% for criterion in violation.metadata.wcag_full %}
                                                                <li>{{ criterion|safe }}</li>
                                                            {% endfor %}
                                                            </ul>
                                                            {% elif violation.wcag_criteria %}
                                                            <strong>WCAG Success Criteria:</strong>
                                                            <ul>
                                                            {% for criterion in violation.wcag_criteria %}
                                                                <li>
                                                                    <a href="https://www.w3.org/WAI/WCAG21/Understanding/" target="_blank" class="text-decoration-none">
                                                                        {{ criterion }}
                                                                    </a>
                                                                </li>
                                                            {% endfor %}
                                                            </ul>
                                                            {% endif %}
                                                        </div>
                                                        {% endif %}
                                                        {% else %}
                                                        <!-- Standard description -->
                                                        <p><strong>Rule:</strong> {{ violation.rule_id|default(violation.id) }}</p>
                                                        <p><strong>Help:</strong> {{ violation.help_text|default(violation.description) }}</p>
                                                        {% if violation.failure_summary %}
                                                        <p><strong>How to fix:</strong> {{ violation.failure_summary }}</p>
                                                        {% endif %}
                                                        {% endif %}
                                                        
                                                        <hr>
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <p><strong>Touchpoint:</strong> {{ violation.touchpoint|default('General') }}</p>
                                                                <p><strong>Impact:</strong> 
                                                                    <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[violation.impact.value|lower if violation.impact.value else violation.impact|lower] or 'secondary' }} impact-badge">
                                                                        {{ violation.impact.value|upper if violation.impact.value else violation.impact|upper }}
                                                                    </span>
                                                                </p>
                                                            </div>
                                                            <div class="col-md-6">
                                                                {% if violation.metadata.wcag_full %}
                                                                    {% for criterion in violation.metadata.wcag_full|sort %}
                                                                    <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-left: 3px solid #0066cc;">
                                                                        <p style="margin: 0 0 8px 0; font-weight: bold;">
                                                                            WCAG {{ criterion|safe }}
                                                                        </p>
                                                                        
                                                                        <p style="margin: 0 0 5px 0;">
                                                                            <a href="{{ criterion.split()[0] | wcag_understanding_url }}" target="_blank">
                                                                                More about {{ criterion | wcag_name }} <i class="bi bi-box-arrow-up-right"></i>
                                                                            </a>
                                                                        </p>
                                                                        <p style="margin: 0;">
                                                                            <a href="{{ criterion.split()[0] | wcag_quickref_url }}" target="_blank">
                                                                                Ways to meet {{ criterion | wcag_name }} <i class="bi bi-box-arrow-up-right"></i>
                                                                            </a>
                                                                        </p>
                                                                        
                                                                    </div>
                                                                    {% endfor %}
                                                                {% elif violation.wcag_criteria %}
                                                                    {% for wcag_criterion in violation.wcag_criteria|sort %}
                                                                    <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-left: 3px solid #0066cc;">
                                                                        <p style="margin: 0 0 8px 0; font-weight: bold;">
                                                                            WCAG {{ wcag_criterion }}
                                                                        </p>
                                                                        
                                                                        <p style="margin: 0 0 5px 0;">
                                                                            <a href="{{ wcag_criterion | wcag_understanding_url }}" target="_blank">
                                                                                More about {{ wcag_criterion | wcag_name }} <i class="bi bi-box-arrow-up-right"></i>
                                                                            </a>
                                                                        </p>
                                                                        <p style="margin: 0;">
                                                                            <a href="{{ wcag_criterion | wcag_quickref_url }}" target="_blank">
                                                                                Ways to meet {{ wcag_criterion | wcag_name }} <i class="bi bi-box-arrow-up-right"></i>
                                                                            </a>
                                                                        </p>
                                                                        
                                                                    </div>
                                                                    {% endfor %}
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        
                                                        {% if (violation.selector or violation.xpath) and 'ErrDuplicateNavNames' not in violation.id %}
                                                        <p>
                                                            <strong>Location:</strong> <code>{{ violation.selector|default(violation.xpath) }}</code>
                                                            <button class="btn btn-sm btn-link p-0 ms-2" onclick="copyXpathToClipboard('{{ violation.selector|default(violation.xpath)|e }}', this)" title="Copy XPath to clipboard">
                                                                <i class="bi bi-clipboard"></i>
                                                            </button>
                                                        </p>
                                                        {% endif %}

                                                        {% if violation.metadata and violation.metadata.pseudoclass %}
                                                        <p>
                                                            <strong>CSS State:</strong>
                                                            {% if '@' in violation.metadata.pseudoclass %}
                                                                {% set parts = violation.metadata.pseudoclass.split('@') %}
                                                                <span class="badge bg-warning">{{ parts[0] }}</span>
                                                                <span class="badge bg-secondary">{{ parts[1] }}</span>
                                                            {% else %}
                                                                <span class="badge bg-warning">{{ violation.metadata.pseudoclass }}</span>
                                                            {% endif %}
                                                        </p>
                                                        {% endif %}

                                                        {% if violation.html %}
                                                        <h6 class="mt-3">Code Snippet</h6>
                                                        {% if 'ErrSkippedHeadingLevel' in violation.id and violation.metadata and 'previousHeadingHtml' in violation.metadata %}
                                                        <p class="mb-2"><strong>Previous heading (h{{ violation.metadata.skippedFrom }}):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ violation.metadata.previousHeadingHtml|e }}</code></pre>
                                                        <p class="mb-2"><strong>Current heading (h{{ violation.metadata.skippedTo }}) - skipped h{{ violation.metadata.expectedLevel }}:</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded"><code>{{ violation.html|e }}</code></pre>
                                                        {% elif 'ErrContentObscuring' in violation.id and violation.metadata and 'obscuredElements' in violation.metadata %}
                                                        <p class="mb-2"><strong>Obscuring element (dialog/overlay):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ violation.html|e }}</code></pre>
                                                        <h6 class="mt-4">{{ violation.metadata.obscuredCount }} Interactive element(s) being obscured:</h6>
                                                        {% for element in violation.metadata.obscuredElements %}
                                                        <div class="mb-3 border-start border-warning border-3 ps-3">
                                                            <p class="mb-1"><strong>&lt;{{ element.element }}&gt;:</strong> "{{ element.text }}"</p>
                                                            <p class="mb-1 small text-muted">
                                                            Location: <code>{{element.xpath}}</code>
                                                            <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyXpathToClipboard('{{element.xpath|e}}', this)" title="Copy XPath to clipboard" style="font-size: 0.875rem;">
                                                                <i class="bi bi-clipboard"></i>
                                                            </button>
                                                        </p>
                                                        </div>
                                                        {% endfor %}
                                                        {% elif 'ErrMultipleH1' in violation.id and violation.metadata and 'allH1s' in violation.metadata %}
                                                        <h6 class="mt-3">All {{ violation.metadata.count }} H1 elements found on page:</h6>
                                                        {% for h1 in violation.metadata.allH1s %}
                                                        <div class="mb-3">
                                                            <p class="mb-1"><strong>H1 #{{ h1.index }}:</strong> {{ h1.text }}</p>
                                                            <p class="mb-1 small text-muted">
                                                            Location: <code>{{h1.xpath}}</code>
                                                            <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyXpathToClipboard('{{h1.xpath|e}}', this)" title="Copy XPath to clipboard" style="font-size: 0.875rem;">
                                                                <i class="bi bi-clipboard"></i>
                                                            </button>
                                                        </p>
                                                            <pre class="bg-dark text-light p-2 rounded"><code>{{ h1.html|e }}</code></pre>
                                                        </div>
                                                        {% endfor %}
                                                        {% elif 'ErrFakeListImplementation' in violation.id and violation.metadata and 'sampleItems' in violation.metadata %}
                                                        <p class="mb-2"><strong>Detected pattern:</strong> {{ violation.metadata.pattern }}</p>
                                                        <p class="mb-2"><strong>Number of items found:</strong> {{ violation.metadata.itemCount }}</p>
                                                        {% if violation.metadata.sampleItems %}
                                                        <h6 class="mt-4">Sample list items detected:</h6>
                                                        {% for item in violation.metadata.sampleItems %}
                                                        <div class="mb-2 border-start border-info border-3 ps-3">
                                                            <p class="mb-0"><strong>Item {{ item.index }}:</strong> {{ item.text }}</p>
                                                        </div>
                                                        {% endfor %}
                                                        {% if violation.metadata.itemCount > 5 %}
                                                        <p class="text-muted small mt-2">...and {{ violation.metadata.itemCount - 5 }} more items</p>
                                                        {% endif %}
                                                        {% endif %}
                                                        <p class="mb-2 mt-3"><strong>Container element:</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded"><code>{{ violation.html|e }}</code></pre>
                                                        {% elif 'ErrDuplicateLandmarkWithoutName' in violation.id and violation.metadata and 'allInstances' in violation.metadata %}
                                                        <p class="mb-2"><strong>This instance (missing accessible name):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ violation.html|e }}</code></pre>
                                                        <h6 class="mt-4">All {{ violation.metadata.totalCount }} {{ violation.metadata.role }} landmarks on page:</h6>
                                                        {% for instance in violation.metadata.allInstances %}
                                                        <div class="mb-3">
                                                            <p class="mb-1"><strong>Instance {{ instance.index }}:</strong> {{ instance.name }}</p>
                                                            <p class="mb-1 small text-muted">
                                                            Location: <code>{{instance.xpath}}</code>
                                                            <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyXpathToClipboard('{{instance.xpath|e}}', this)" title="Copy XPath to clipboard" style="font-size: 0.875rem;">
                                                                <i class="bi bi-clipboard"></i>
                                                            </button>
                                                        </p>
                                                            <pre class="bg-dark text-light p-2 rounded"><code>{{ instance.html|e }}</code></pre>
                                                        </div>
                                                        {% endfor %}
                                                        {% elif 'ErrDuplicateNavNames' in violation.id and violation.metadata and 'allInstances' in violation.metadata %}
                                                        <h6 class="mt-3">All {{ violation.metadata.totalCount }} navigation elements with the name "{{ violation.metadata.duplicateName }}":</h6>
                                                        {% for instance in violation.metadata.allInstances %}
                                                        <div class="mb-3">
                                                            <p class="mb-1"><strong>Navigation {{ instance.index }}:</strong></p>
                                                            <p class="mb-1 small text-muted">
                                                            Location: <code>{{instance.xpath}}</code>
                                                            <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyXpathToClipboard('{{instance.xpath|e}}', this)" title="Copy XPath to clipboard" style="font-size: 0.875rem;">
                                                                <i class="bi bi-clipboard"></i>
                                                            </button>
                                                        </p>
                                                            <pre class="bg-dark text-light p-2 rounded"><code>{{ instance.html|e }}</code></pre>
                                                        </div>
                                                        {% endfor %}
                                                        {% elif 'ErrSmallText' in violation.id and violation.metadata and violation.metadata.get('allInstances') %}
                                                        <h6 class="mt-3">{{ violation.metadata.allInstances|length }} element(s) with text smaller than 16px:</h6>
                                                        {% for instance in violation.metadata.allInstances %}
                                                        <div class="mb-3">
                                                            <p class="mb-1"><strong>Instance {{ instance.index }}:</strong> &lt;{{ instance.element }}&gt; element - Text size: <span class="badge bg-warning">{{ instance.fontSize }}px</span></p>
                                                            <p class="mb-1 small">Text preview: "{{ instance.text }}"</p>
                                                            <p class="mb-1 small text-muted">
                                                            Location: <code>{{instance.xpath}}</code>
                                                            <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyXpathToClipboard('{{instance.xpath|e}}', this)" title="Copy XPath to clipboard" style="font-size: 0.875rem;">
                                                                <i class="bi bi-clipboard"></i>
                                                            </button>
                                                        </p>
                                                            <pre class="bg-dark text-light p-2 rounded"><code>{{ instance.html|e }}</code></pre>
                                                        </div>
                                                        {% endfor %}
                                                        {% elif 'ErrAnchorTargetTabindex' in violation.id and violation.metadata and violation.metadata.anchorLinksCount %}
                                                        <h6 class="mt-3">Link target (needs tabindex="-1"):</h6>
                                                        <p class="mb-2"><strong>Target element:</strong> &lt;{{ violation.element }}&gt; with id="{{ violation.metadata.targetId }}"</p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ violation.html|e }}</code></pre>
                                                        <h6 class="mt-4">{{ violation.metadata.anchorLinksCount }} anchor link(s) pointing to this target:</h6>
                                                        {% for anchor in violation.metadata.anchorLinks %}
                                                        <div class="mb-3">
                                                            <p class="mb-1"><strong>Link {{ anchor.index }}:</strong> "{{ anchor.text }}"</p>
                                                            <p class="mb-1 small text-muted">
                                                            Location: <code>{{anchor.xpath}}</code>
                                                            <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyXpathToClipboard('{{anchor.xpath|e}}', this)" title="Copy XPath to clipboard" style="font-size: 0.875rem;">
                                                                <i class="bi bi-clipboard"></i>
                                                            </button>
                                                        </p>
                                                            <pre class="bg-dark text-light p-2 rounded"><code>{{ anchor.html|e }}</code></pre>
                                                        </div>
                                                        {% endfor %}
                                                        {% elif 'ErrTabOrderViolation' in violation.id and violation.metadata and 'previousElement' in violation.metadata %}
                                                        <p class="mb-2"><strong>This element (comes later in tab order but appears visually left):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ violation.html|e }}</code></pre>
                                                        <p class="mb-2"><strong>Previous element in tab order (visually to the right):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ violation.metadata.previousElement.html|e }}</code></pre>
                                                        <div class="alert alert-info">
                                                            <p class="mb-1"><strong>Visual positions:</strong></p>
                                                            <p class="mb-1">• This element: x={{ violation.metadata.currentElement.position.x }}, y={{ violation.metadata.currentElement.position.y }} (tab stop #{{ violation.metadata.currentElement.tabIndex }})</p>
                                                            <p class="mb-0">• Previous element: x={{ violation.metadata.previousElement.position.x }}, y={{ violation.metadata.previousElement.position.y }} (tab stop #{{ violation.metadata.previousElement.tabIndex }})</p>
                                                        </div>
                                                        {% else %}
                                                        <pre class="bg-dark text-light p-3 rounded"><code>{{ violation.html|e }}</code></pre>
                                                        {% endif %}
                                                        {% endif %}

                                                        <!-- Thumbnail of the page at time of test -->
                                                        {% if screenshot_filename %}
                                                        <h6 class="mt-4">Page Thumbnail (at time of test)</h6>
                                                        <a href="#" onclick="showScreenshot('{{ url_for('serve_screenshot', filename=screenshot_filename) }}', '{{ page.url }}'); return false;">
                                                            <img src="{{ url_for('serve_screenshot', filename=screenshot_filename) }}"
                                                                 alt="Thumbnail of {{ page.url }}"
                                                                 class="img-thumbnail"
                                                                 style="max-width: 300px; height: auto; cursor: pointer;"
                                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                                            <span style="display: none; font-size: 0.9em; color: #999;">Thumbnail not available</span>
                                                        </a>
                                                        <p class="text-muted small mt-1">Click to view full size</p>
                                                        {% endif %}

                                                        {% if violation.metadata.ai_detected %}
                                                        <div class="alert alert-info mt-3">
                                                            <i class="bi bi-robot"></i> <strong>AI Detection Note:</strong>
                                                            <p class="mb-0">This issue was detected through visual analysis.</p>
                                                            {% if violation.metadata.ai_confidence %}
                                                            <p><strong>Confidence:</strong> {{ (violation.metadata.ai_confidence * 100)|round }}%</p>
                                                            {% endif %}
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            {# INSTANCE_HTML_END #}
                                            {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <!-- Single instance - show as before -->
                            {% for violation in group_list %}
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#viol-single-{{ viol_counter.value }}">
                                        <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[violation.impact.value|lower if violation.impact.value else violation.impact|lower] or 'secondary' }} me-2 impact-badge">{{ violation.impact.value|upper if violation.impact.value else violation.impact|upper }}</span>
                                        {% if violation.metadata.ai_detected %}
                                        <span class="badge bg-info me-2" title="Detected by AI analysis">
                                            <i class="bi bi-robot"></i> AI
                                        </span>
                                        {% endif %}
                                        {% if violation.metadata and violation.metadata.authenticated_user %}
                                            <span class="badge bg-secondary me-2">
                                                <i class="bi bi-person-fill"></i> {{ violation.metadata.authenticated_user.display_name }}
                                                {% if violation.metadata.authenticated_user.roles %}
                                                    ({{ violation.metadata.authenticated_user.roles|join(', ') }})
                                                {% endif %}
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary me-2">
                                                <i class="bi bi-person"></i> Guest
                                            </span>
                                        {% endif %}
                                        <code class="me-2">{{ error_code|error_code_only }}</code>
                                        {% if 'DiscoFontFound' in violation.id and violation.metadata.fontName %}
                                            Font '{{ violation.metadata.fontName }}' at {{ violation.metadata.sizeCount }} size{{ 's' if violation.metadata.sizeCount != 1 else '' }}: {{ violation.metadata.fontSizes|join(', ') }}
                                        {% elif violation.metadata and violation.metadata.title %}
                                            {{ violation.metadata.title }}
                                        {% elif violation.metadata and violation.metadata.what and violation.metadata.what != "Accessibility issue: " + violation.id.split('_')[1] %}
                                            {{ violation.metadata.what }}
                                        {% else %}
                                            {{ violation.description }}
                                        {% endif %}
                                        {% if violation.xpath %}
                                            <span class="text-muted ms-2" style="font-size: 0.9em;">• {{ violation.xpath }}</span>
                                        {% endif %}
                                    </button>
                                </h2>
                                <div id="viol-single-{{ viol_counter.value }}" 
                         class="accordion-collapse collapse" 
                         data-bs-parent="#violationsAccordion">
                        <div class="accordion-body">
                            {% if violation.metadata and violation.metadata.title %}
                            <!-- Enhanced description available -->
                            <div class="alert alert-danger mb-3">
                                <h6 class="alert-heading">{{ violation.metadata.title }}</h6>
                            </div>
                            
                            <h6 class="text-danger mb-2">About this issue:</h6>
                            
                            <div class="mb-3">
                                <strong>What the issue is:</strong>
                                {% if 'ErrLinkAccessibleNameMismatch' in violation.id and violation.description %}
                                <p>{{ violation.description }}</p>
                                {% else %}
                                <p>{{ violation.metadata.what|default(violation.description) }}</p>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                <strong>Why this is important:</strong>
                                <p>{{ violation.metadata.why }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Who it affects:</strong>
                                <p>{{ violation.metadata.who }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>How to remediate:</strong>
                                <div class="bg-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace;">{{ violation.metadata.full_remediation|default(violation.failure_summary) }}</div>
                            </div>

                            {% if violation.metadata.wcag_full or violation.wcag_criteria %}
                            <h6 class="text-danger mb-2 mt-4">Relevant test criteria:</h6>
                            <div class="mb-3">
                                {% if violation.metadata.wcag_full %}
                                <strong>WCAG Success Criteria:</strong>
                                <ul>
                                {% for criterion in violation.metadata.wcag_full %}
                                    <li>{{ criterion|safe }}</li>
                                {% endfor %}
                                </ul>
                                {% elif violation.wcag_criteria %}
                                <strong>WCAG Success Criteria:</strong>
                                <ul>
                                {% for criterion in violation.wcag_criteria %}
                                    <li>
                                        <a href="https://www.w3.org/WAI/WCAG21/Understanding/" target="_blank" class="text-decoration-none">
                                            {{ criterion }}
                                        </a>
                                    </li>
                                {% endfor %}
                                </ul>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% else %}
                            <!-- Standard description -->
                            <p><strong>Rule:</strong> {{ violation.rule_id|default(violation.id) }}</p>
                            <p><strong>Help:</strong> {{ violation.help_text|default(violation.description) }}</p>
                            {% if violation.failure_summary %}
                            <p><strong>How to fix:</strong> {{ violation.failure_summary }}</p>
                            {% endif %}
                            {% endif %}
                            
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Touchpoint:</strong> {{ violation.touchpoint|default('General') }}</p>
                                    <p><strong>Impact:</strong> 
                                        <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[violation.impact.value|lower if violation.impact.value else violation.impact|lower] or 'secondary' }} impact-badge">
                                            {{ violation.impact.value|upper if violation.impact.value else violation.impact|upper }}
                                        </span>
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    {% if violation.metadata.wcag_full %}
                                        {% for criterion in violation.metadata.wcag_full|sort %}
                                        <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-left: 3px solid #0066cc;">
                                            <p style="margin: 0 0 8px 0; font-weight: bold;">
                                                WCAG {{ criterion|safe }}
                                            </p>
                                            
                                            <p style="margin: 0 0 5px 0;">
                                                <a href="{{ criterion.split()[0] | wcag_understanding_url }}" target="_blank">
                                                    More about {{ criterion | wcag_name }} <i class="bi bi-box-arrow-up-right"></i>
                                                </a>
                                            </p>
                                            <p style="margin: 0;">
                                                <a href="{{ criterion.split()[0] | wcag_quickref_url }}" target="_blank">
                                                    Ways to meet {{ criterion | wcag_name }} <i class="bi bi-box-arrow-up-right"></i>
                                                </a>
                                            </p>
                                            
                                        </div>
                                        {% endfor %}
                                    {% elif violation.wcag_criteria %}
                                        {% for wcag_criterion in violation.wcag_criteria|sort %}
                                        <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-left: 3px solid #0066cc;">
                                            <p style="margin: 0 0 8px 0; font-weight: bold;">
                                                WCAG {{ wcag_criterion }}
                                            </p>
                                            
                                            <p style="margin: 0 0 5px 0;">
                                                <a href="{{ wcag_criterion | wcag_understanding_url }}" target="_blank">
                                                    More about {{ wcag_criterion | wcag_name }} <i class="bi bi-box-arrow-up-right"></i>
                                                </a>
                                            </p>
                                            <p style="margin: 0;">
                                                <a href="{{ wcag_criterion | wcag_quickref_url }}" target="_blank">
                                                    Ways to meet {{ wcag_criterion | wcag_name }} <i class="bi bi-box-arrow-up-right"></i>
                                                </a>
                                            </p>
                                            
                                        </div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                            
                            {% if (violation.selector or violation.xpath) and 'ErrDuplicateNavNames' not in violation.id %}
                            <p>
                                <strong>Location:</strong> <code>{{violation.selector|default(violation.xpath)}}</code>
                                <button class="btn btn-sm btn-link p-0 ms-2" onclick="copyXpathToClipboard('{{violation.selector|default(violation.xpath)|e}}', this)" title="Copy XPath to clipboard">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </p>
                            {% endif %}

                            {% if violation.metadata and violation.metadata.breakpoint %}
                            <p>
                                <strong>Responsive Breakpoint:</strong> <span class="badge bg-info">{{ violation.metadata.breakpoint }}px width</span>
                            </p>
                            {% endif %}

                            {% if violation.metadata and violation.metadata.pseudoclass %}
                            <p>
                                <strong>CSS State:</strong>
                                {% if '@' in violation.metadata.pseudoclass %}
                                    {% set parts = violation.metadata.pseudoclass.split('@') %}
                                    <span class="badge bg-warning">{{ parts[0] }}</span>
                                    <span class="badge bg-secondary">{{ parts[1] }}</span>
                                {% else %}
                                    <span class="badge bg-warning">{{ violation.metadata.pseudoclass }}</span>
                                {% endif %}
                            </p>
                            {% endif %}

                            {% if violation.html %}
                            <div class="mt-3">
                                <h6>Code Snippet</h6>
                                {% if 'ErrSkippedHeadingLevel' in violation.id and violation.metadata and 'previousHeadingHtml' in violation.metadata %}
                                <p class="mb-2"><strong>Previous heading (h{{ violation.metadata.skippedFrom }}):</strong></p>
                                <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ violation.metadata.previousHeadingHtml|e }}</code></pre>
                                <p class="mb-2"><strong>Current heading (h{{ violation.metadata.skippedTo }}) - skipped h{{ violation.metadata.expectedLevel }}:</strong></p>
                                <pre class="bg-dark text-light p-3 rounded"><code>{{ violation.html|e }}</code></pre>
                                {% elif 'ErrContentObscuring' in violation.id and violation.metadata and 'obscuredElements' in violation.metadata %}
                                <p class="mb-2"><strong>Obscuring element (dialog/overlay):</strong></p>
                                <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ violation.html|e }}</code></pre>
                                <h6 class="mt-4">{{ violation.metadata.obscuredCount }} Interactive element(s) being obscured:</h6>
                                {% for element in violation.metadata.obscuredElements %}
                                <div class="mb-3 border-start border-warning border-3 ps-3">
                                    <p class="mb-1"><strong>&lt;{{ element.element }}&gt;:</strong> "{{ element.text }}"</p>
                                    <p class="mb-1 small text-muted">
                                                            Location: <code>{{element.xpath}}</code>
                                                            <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyXpathToClipboard('{{element.xpath|e}}', this)" title="Copy XPath to clipboard" style="font-size: 0.875rem;">
                                                                <i class="bi bi-clipboard"></i>
                                                            </button>
                                                        </p>
                                </div>
                                {% endfor %}
                                {% elif 'ErrMultipleH1' in violation.id and violation.metadata and 'allH1s' in violation.metadata %}
                                <h6 class="mt-3">All {{ violation.metadata.count }} H1 elements found on page:</h6>
                                {% for h1 in violation.metadata.allH1s %}
                                <div class="mb-3">
                                    <p class="mb-1"><strong>H1 #{{ h1.index }}:</strong> {{ h1.text }}</p>
                                    <p class="mb-1 small text-muted">
                                                            Location: <code>{{h1.xpath}}</code>
                                                            <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyXpathToClipboard('{{h1.xpath|e}}', this)" title="Copy XPath to clipboard" style="font-size: 0.875rem;">
                                                                <i class="bi bi-clipboard"></i>
                                                            </button>
                                                        </p>
                                    <pre class="bg-dark text-light p-2 rounded"><code>{{ h1.html|e }}</code></pre>
                                </div>
                                {% endfor %}
                                {% elif 'ErrFakeListImplementation' in violation.id and violation.metadata and 'sampleItems' in violation.metadata %}
                                <p class="mb-2"><strong>Detected pattern:</strong> {{ violation.metadata.pattern }}</p>
                                <p class="mb-2"><strong>Number of items found:</strong> {{ violation.metadata.itemCount }}</p>
                                {% if violation.metadata.sampleItems %}
                                <h6 class="mt-4">Sample list items detected:</h6>
                                {% for item in violation.metadata.sampleItems %}
                                <div class="mb-2 border-start border-info border-3 ps-3">
                                    <p class="mb-0"><strong>Item {{ item.index }}:</strong> {{ item.text }}</p>
                                </div>
                                {% endfor %}
                                {% if violation.metadata.itemCount > 5 %}
                                <p class="text-muted small mt-2">...and {{ violation.metadata.itemCount - 5 }} more items</p>
                                {% endif %}
                                {% endif %}
                                <p class="mb-2 mt-3"><strong>Container element:</strong></p>
                                <pre class="bg-dark text-light p-3 rounded"><code>{{ violation.html|e }}</code></pre>
                                {% elif 'ErrDuplicateLandmarkWithoutName' in violation.id and violation.metadata and 'allInstances' in violation.metadata %}
                                <p class="mb-2"><strong>This instance (missing accessible name):</strong></p>
                                <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ violation.html|e }}</code></pre>
                                <h6 class="mt-4">All {{ violation.metadata.totalCount }} {{ violation.metadata.role }} landmarks on page:</h6>
                                {% for instance in violation.metadata.allInstances %}
                                <div class="mb-3">
                                    <p class="mb-1"><strong>Instance {{ instance.index }}:</strong> {{ instance.name }}</p>
                                    <p class="mb-1 small text-muted">
                                                            Location: <code>{{instance.xpath}}</code>
                                                            <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyXpathToClipboard('{{instance.xpath|e}}', this)" title="Copy XPath to clipboard" style="font-size: 0.875rem;">
                                                                <i class="bi bi-clipboard"></i>
                                                            </button>
                                                        </p>
                                    <pre class="bg-dark text-light p-2 rounded"><code>{{ instance.html|e }}</code></pre>
                                </div>
                                {% endfor %}
                                {% elif 'ErrDuplicateNavNames' in violation.id and violation.metadata and 'allInstances' in violation.metadata %}
                                <h6 class="mt-3">All {{ violation.metadata.totalCount }} navigation elements with the name "{{ violation.metadata.duplicateName }}":</h6>
                                {% for instance in violation.metadata.allInstances %}
                                <div class="mb-3">
                                    <p class="mb-1"><strong>Navigation {{ instance.index }}:</strong></p>
                                    <p class="mb-1 small text-muted">
                                                            Location: <code>{{instance.xpath}}</code>
                                                            <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyXpathToClipboard('{{instance.xpath|e}}', this)" title="Copy XPath to clipboard" style="font-size: 0.875rem;">
                                                                <i class="bi bi-clipboard"></i>
                                                            </button>
                                                        </p>
                                    <pre class="bg-dark text-light p-2 rounded"><code>{{ instance.html|e }}</code></pre>
                                </div>
                                {% endfor %}
                                {% elif 'ErrSmallText' in violation.id and violation.metadata and violation.metadata.get('allInstances') %}
                                <h6 class="mt-3">{{ violation.metadata.allInstances|length }} element(s) with text smaller than 16px:</h6>
                                {% for instance in violation.metadata.allInstances %}
                                <div class="mb-3">
                                    <p class="mb-1"><strong>Instance {{ instance.index }}:</strong> &lt;{{ instance.element }}&gt; element - Text size: <span class="badge bg-warning">{{ instance.fontSize }}px</span></p>
                                    <p class="mb-1 small">Text preview: "{{ instance.text }}"</p>
                                    <p class="mb-1 small text-muted">
                                    Location: <code>{{instance.xpath}}</code>
                                    <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyXpathToClipboard('{{instance.xpath|e}}', this)" title="Copy XPath to clipboard" style="font-size: 0.875rem;">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </p>
                                    <pre class="bg-dark text-light p-2 rounded"><code>{{ instance.html|e }}</code></pre>
                                </div>
                                {% endfor %}
                                {% elif 'ErrAnchorTargetTabindex' in violation.id and violation.metadata and violation.metadata.anchorLinksCount %}
                                <h6 class="mt-3">Link target (needs tabindex="-1"):</h6>
                                <p class="mb-2"><strong>Target element:</strong> &lt;{{ violation.element }}&gt; with id="{{ violation.metadata.targetId }}"</p>
                                <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ violation.html|e }}</code></pre>
                                <h6 class="mt-4">{{ violation.metadata.anchorLinksCount }} anchor link(s) pointing to this target:</h6>
                                {% for anchor in violation.metadata.anchorLinks %}
                                <div class="mb-3">
                                    <p class="mb-1"><strong>Link {{ anchor.index }}:</strong> "{{ anchor.text }}"</p>
                                    <p class="mb-1 small text-muted">
                                    Location: <code>{{anchor.xpath}}</code>
                                    <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyXpathToClipboard('{{anchor.xpath|e}}', this)" title="Copy XPath to clipboard" style="font-size: 0.875rem;">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </p>
                                    <pre class="bg-dark text-light p-2 rounded"><code>{{ anchor.html|e }}</code></pre>
                                </div>
                                {% endfor %}
                                                        {% elif 'ErrTabOrderViolation' in violation.id and violation.metadata and 'previousElement' in violation.metadata %}
                                                        <p class="mb-2"><strong>This element (comes later in tab order but appears visually left):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ violation.html|e }}</code></pre>
                                                        <p class="mb-2"><strong>Previous element in tab order (visually to the right):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ violation.metadata.previousElement.html|e }}</code></pre>
                                                        <div class="alert alert-info">
                                                            <p class="mb-1"><strong>Visual positions:</strong></p>
                                                            <p class="mb-1">• This element: x={{ violation.metadata.currentElement.position.x }}, y={{ violation.metadata.currentElement.position.y }} (tab stop #{{ violation.metadata.currentElement.tabIndex }})</p>
                                                            <p class="mb-0">• Previous element: x={{ violation.metadata.previousElement.position.x }}, y={{ violation.metadata.previousElement.position.y }} (tab stop #{{ violation.metadata.previousElement.tabIndex }})</p>
                                                        </div>
                                                        {% else %}
                                <pre class="bg-dark text-light p-3 rounded"><code>{{ violation.html|e }}</code></pre>
                                {% endif %}
                            </div>
                            {% endif %}

                            <!-- Thumbnail of the page at time of test -->
                            {% if screenshot_filename %}
                            <h6 class="mt-4">Page Thumbnail (at time of test)</h6>
                            <a href="#" onclick="showScreenshot('{{ url_for('serve_screenshot', filename=screenshot_filename) }}', '{{ page.url }}'); return false;">
                                <img src="{{ url_for('serve_screenshot', filename=screenshot_filename) }}"
                                     alt="Thumbnail of {{ page.url }}"
                                     class="img-thumbnail"
                                     style="max-width: 300px; height: auto; cursor: pointer;"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <span style="display: none; font-size: 0.9em; color: #999;">Thumbnail not available</span>
                            </a>
                            <p class="text-muted small mt-1">Click to view full size</p>
                            {% endif %}

                            {% if violation.metadata.ai_detected %}
                            <div class="mt-3">
                                <h6><i class="bi bi-robot"></i> AI Detection Details</h6>
                                <div class="small text-muted">
                                    {% if violation.metadata.visual_location %}
                                    <p><strong>Visual Location:</strong> {{ violation.metadata.visual_location }}</p>
                                    {% endif %}
                                    {% if violation.metadata.element_class %}
                                    <p><strong>CSS Classes:</strong> <code>{{ violation.metadata.element_class }}</code></p>
                                    {% endif %}
                                    {% if violation.metadata.element_id %}
                                    <p><strong>Element ID:</strong> <code>{{ violation.metadata.element_id }}</code></p>
                                    {% endif %}
                                    {% if violation.metadata.ai_confidence %}
                                    <p><strong>Confidence:</strong> {{ (violation.metadata.ai_confidence * 100)|round }}%</p>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            </div>
            {% endif %}

            <!-- Warnings -->
            {% if latest_result.warnings %}
            <h6 class="text-warning mb-3">
                <i class="bi bi-exclamation-triangle"></i> Warnings ({{ latest_result.warnings|length }})
            </h6>
            <div class="accordion mb-4" id="warningsAccordion">
                {% set warn_counter = namespace(value=0) %}
                {% for touchpoint, touchpoint_warnings in latest_result.warnings|groupby('touchpoint') %}
                    <div class="touchpoint-header mt-3 mb-2 ps-2" style="background-color: #f8f9fa; padding: 8px; border-left: 4px solid #ffc107;">
                        <strong>{{ touchpoint|replace('_', ' ')|title }}</strong>
                    </div>
                    
                    {% for error_code, description_group in touchpoint_warnings|groupby('id') %}
                        {% set group_list = description_group|list %}
                        {% set warn_counter.value = warn_counter.value + 1 %}
                        {% if group_list|length > 1 %}
                            <!-- Multiple instances - create sub-accordion -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#warn-group-{{ warn_counter.value }}">
                                        {% set first_warning = group_list[0] %}
                                        <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[first_warning.impact.value|lower if first_warning.impact.value else first_warning.impact|lower] or 'secondary' }} me-2">{{ group_list|length }}</span>
                                        <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[first_warning.impact.value|lower if first_warning.impact.value else first_warning.impact|lower] or 'secondary' }} me-2 impact-badge">
                                            {{ first_warning.impact.value|upper if first_warning.impact.value else first_warning.impact|upper }}
                                        </span>
                                        <code class="me-2">{{ error_code|error_code_only }}</code>
                                        {% if group_list|length > 1 %}
                                            {# For grouped warnings, use generic description from catalog (never specific description from instance) #}
                                            {{ first_warning.metadata.what_generic if first_warning.metadata and first_warning.metadata.what_generic else (first_warning.metadata.what if first_warning.metadata and first_warning.metadata.what else error_code|error_code_only) }}
                                        {% else %}
                                            {# For single warnings, show full specific description #}
                                            {% if first_warning.metadata and first_warning.metadata.title %}
                                                {{ first_warning.metadata.title }}
                                            {% elif first_warning.metadata and first_warning.metadata.what %}
                                                {{ first_warning.metadata.what }}
                                            {% else %}
                                                {{ first_warning.description }}
                                            {% endif %}
                                        {% endif %}
                                    </button>
                                </h2>
                                <div id="warn-group-{{ warn_counter.value }}" 
                                     class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <div class="accordion" id="warn-instances-{{ warn_counter.value }}">
                                            {% for warning in group_list %}
                                            {% set warn_instance_id = warn_counter.value ~ '-' ~ loop.index %}
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed" type="button" 
                                                            data-bs-toggle="collapse" 
                                                            data-bs-target="#warn-instance-{{ warn_instance_id }}">
                                                        <strong>Instance {{ loop.index }}:</strong>
                                                        {% if warning.xpath %}
                                                        <code class="ms-2">{{ warning.xpath }}</code>
                                                        {% endif %}
                                                    </button>
                                                </h2>
                                                <div id="warn-instance-{{ warn_instance_id }}" 
                                                     class="accordion-collapse collapse"
                                                     data-bs-parent="#warn-instances-{{ warn_counter.value }}">
                                                    <div class="accordion-body">
                                                        <!-- Full warning details as before -->
                                                        {% if warning.metadata and warning.metadata.title %}
                                                        <!-- Enhanced description available -->
                                                        <div class="alert alert-warning mb-3">
                                                            <h6 class="alert-heading">{{ warning.description }}</h6>
                                                        </div>
                                                        
                                                        <h6 class="text-warning mb-2">About this issue:</h6>
                                                        
                                                        <div class="mb-3">
                                                            <strong>What the issue is:</strong>
                                                            <p>{{ warning.metadata.what|default(warning.description) }}</p>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <strong>Why this is important:</strong>
                                                            <p>{{ warning.metadata.why }}</p>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <strong>Who it affects:</strong>
                                                            <p>{{ warning.metadata.who }}</p>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <strong>How to remediate:</strong>
                                                            <div class="bg-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace;">{{ warning.metadata.full_remediation|default(warning.failure_summary) }}</div>
                                                        </div>

                                                        {% if warning.metadata.wcag_full or warning.wcag_criteria %}
                                                        <h6 class="text-warning mb-2 mt-4">Relevant test criteria:</h6>
                                                        <div class="mb-3">
                                                            {% if warning.metadata.wcag_full %}
                                                            <strong>WCAG Success Criteria:</strong>
                                                            <ul>
                                                            {% for criterion in warning.metadata.wcag_full %}
                                                                <li>{{ criterion|safe }}</li>
                                                            {% endfor %}
                                                            </ul>
                                                            {% elif warning.wcag_criteria %}
                                                            <strong>WCAG Success Criteria:</strong>
                                                            <ul>
                                                            {% for criterion in warning.wcag_criteria %}
                                                                <li>
                                                                    <a href="https://www.w3.org/WAI/WCAG21/Understanding/" target="_blank" class="text-decoration-none">
                                                                        {{ criterion }}
                                                                    </a>
                                                                </li>
                                                            {% endfor %}
                                                            </ul>
                                                            {% endif %}
                                                        </div>
                                                        {% endif %}
                                                        {% else %}
                                                        <!-- Standard description -->
                                                        <p><strong>Rule:</strong> {{ warning.rule_id|default(warning.id) }}</p>
                                                        <p><strong>Help:</strong> {{ warning.help_text|default(warning.description) }}</p>
                                                        {% if warning.failure_summary %}
                                                        <p><strong>How to fix:</strong> {{ warning.failure_summary }}</p>
                                                        {% endif %}
                                                        {% endif %}

                                                        <hr>
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <p><strong>Touchpoint:</strong> {{ warning.touchpoint|default('General') }}</p>
                                                                <p><strong>Impact:</strong>
                                                                    <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[warning.impact.value|lower if warning.impact.value else warning.impact|lower] or 'secondary' }} impact-badge">
                                                                        {{ warning.impact.value|upper if warning.impact.value else warning.impact|upper }}
                                                                    </span>
                                                                </p>
                                                            </div>
                                                            <div class="col-md-6">
                                                                {% if warning.metadata.wcag_full %}
                                                                    {% for criterion in warning.metadata.wcag_full|sort %}
                                                                    <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-left: 3px solid #ffc107;">
                                                                        <p style="margin: 0 0 8px 0; font-weight: bold;">
                                                                            WCAG {{ criterion|safe }}
                                                                        </p>
                                                                        
                                                                        <p style="margin: 0 0 5px 0;">
                                                                            <a href="{{ criterion.split()[0] | wcag_understanding_url }}" target="_blank">
                                                                                More about {{ criterion | wcag_name }} <i class="bi bi-box-arrow-up-right"></i>
                                                                            </a>
                                                                        </p>
                                                                        <p style="margin: 0;">
                                                                            <a href="{{ criterion.split()[0] | wcag_quickref_url }}" target="_blank">
                                                                                Ways to meet {{ criterion | wcag_name }} <i class="bi bi-box-arrow-up-right"></i>
                                                                            </a>
                                                                        </p>
                                                                        
                                                                    </div>
                                                                    {% endfor %}
                                                                {% elif warning.wcag_criteria %}
                                                                    {% for wcag_criterion in warning.wcag_criteria|sort %}
                                                                    <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-left: 3px solid #ffc107;">
                                                                        <p style="margin: 0 0 8px 0; font-weight: bold;">
                                                                            WCAG {{ wcag_criterion }}
                                                                        </p>
                                                                        
                                                                        <p style="margin: 0 0 5px 0;">
                                                                            <a href="{{ wcag_criterion | wcag_understanding_url }}" target="_blank">
                                                                                More about {{ wcag_criterion | wcag_name }} <i class="bi bi-box-arrow-up-right"></i>
                                                                            </a>
                                                                        </p>
                                                                        <p style="margin: 0;">
                                                                            <a href="{{ wcag_criterion | wcag_quickref_url }}" target="_blank">
                                                                                Ways to meet {{ wcag_criterion | wcag_name }} <i class="bi bi-box-arrow-up-right"></i>
                                                                            </a>
                                                                        </p>
                                                                        
                                                                    </div>
                                                                    {% endfor %}
                                                                {% endif %}
                                                            </div>
                                                        </div>

                                                        {% if warning.xpath %}
                                                        <p>
                                <strong>Location:</strong> <code>{{warning.xpath}}</code>
                                <button class="btn btn-sm btn-link p-0 ms-2" onclick="copyXpathToClipboard('{{warning.xpath|e}}', this)" title="Copy XPath to clipboard">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </p>
                                                        {% endif %}
                                                        {% if warning.html %}
                                                        <h6 class="mt-3">Code Snippet</h6>
                                                        {% if 'ErrSkippedHeadingLevel' in warning.id and warning.metadata and 'previousHeadingHtml' in warning.metadata %}
                                                        <p class="mb-2"><strong>Previous heading (h{{ warning.metadata.skippedFrom }}):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ warning.metadata.previousHeadingHtml|e }}</code></pre>
                                                        <p class="mb-2"><strong>Current heading (h{{ warning.metadata.skippedTo }}) - skipped h{{ warning.metadata.expectedLevel }}:</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded"><code>{{ warning.html|e }}</code></pre>
                                                        {% elif 'ErrDuplicateLandmarkWithoutName' in warning.id and warning.metadata and 'allInstances' in warning.metadata %}
                                                        <p class="mb-2"><strong>This instance (missing accessible name):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ warning.html|e }}</code></pre>
                                                        <h6 class="mt-4">All {{ warning.metadata.totalCount }} {{ warning.metadata.role }} landmarks on page:</h6>
                                                        {% for instance in warning.metadata.allInstances %}
                                                        <div class="mb-3">
                                                            <p class="mb-1"><strong>Instance {{ instance.index }}:</strong> {{ instance.name }}</p>
                                                            <p class="mb-1 small text-muted">
                                                            Location: <code>{{instance.xpath}}</code>
                                                            <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyXpathToClipboard('{{instance.xpath|e}}', this)" title="Copy XPath to clipboard" style="font-size: 0.875rem;">
                                                                <i class="bi bi-clipboard"></i>
                                                            </button>
                                                        </p>
                                                            <pre class="bg-dark text-light p-2 rounded"><code>{{ instance.html|e }}</code></pre>
                                                        </div>
                                                        {% endfor %}
                                                        {% elif 'ErrTabOrderViolation' in warning.id and warning.metadata and 'previousElement' in warning.metadata %}
                                                        <p class="mb-2"><strong>This element (comes later in tab order but appears visually left):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ warning.html|e }}</code></pre>
                                                        <p class="mb-2"><strong>Previous element in tab order (visually to the right):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ warning.metadata.previousElement.html|e }}</code></pre>
                                                        <div class="alert alert-info">
                                                            <p class="mb-1"><strong>Visual positions:</strong></p>
                                                            <p class="mb-1">• This element: x={{ warning.metadata.currentElement.position.x }}, y={{ warning.metadata.currentElement.position.y }} (tab stop #{{ warning.metadata.currentElement.tabIndex }})</p>
                                                            <p class="mb-0">• Previous element: x={{ warning.metadata.previousElement.position.x }}, y={{ warning.metadata.previousElement.position.y }} (tab stop #{{ warning.metadata.previousElement.tabIndex }})</p>
                                                        </div>
                                                        {% else %}
                                                        <pre class="bg-dark text-light p-3 rounded"><code>{{ warning.html|e }}</code></pre>
                                                        {% endif %}
                                                        {% endif %}

                                                        <!-- Thumbnail of the page at time of test -->
                                                        {% if screenshot_filename %}
                                                        <h6 class="mt-4">Page Thumbnail (at time of test)</h6>
                                                        <a href="#" onclick="showScreenshot('{{ url_for('serve_screenshot', filename=screenshot_filename) }}', '{{ page.url }}'); return false;">
                                                            <img src="{{ url_for('serve_screenshot', filename=screenshot_filename) }}"
                                                                 alt="Thumbnail of {{ page.url }}"
                                                                 class="img-thumbnail"
                                                                 style="max-width: 300px; height: auto; cursor: pointer;"
                                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                                            <span style="display: none; font-size: 0.9em; color: #999;">Thumbnail not available</span>
                                                        </a>
                                                        <p class="text-muted small mt-1">Click to view full size</p>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <!-- Single instance - show as before -->
                            {% for warning in group_list %}
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#warn-single-{{ warn_counter.value }}">
                                        <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[warning.impact.value|lower if warning.impact.value else warning.impact|lower] or 'warning' }} me-2 impact-badge">
                                            {{ warning.impact.value|upper if warning.impact.value else warning.impact|upper }}
                                        </span>
                                        {% if warning.metadata.ai_detected %}
                                        <span class="badge bg-info me-2" title="Detected by AI analysis">
                                            <i class="bi bi-robot"></i> AI
                                        </span>
                                        {% endif %}
                                        <code class="me-2">{{ error_code|error_code_only }}</code>
                                        {% if warning.metadata and warning.metadata.title %}
                                            {{ warning.metadata.title }}
                                        {% elif warning.metadata and warning.metadata.what and warning.metadata.what != "Accessibility issue: " + warning.id.split('_')[1] %}
                                            {{ warning.metadata.what }}
                                        {% else %}
                                            {{ warning.description }}
                                        {% endif %}
                                        {% if warning.xpath %}
                                            <span class="text-muted ms-2" style="font-size: 0.9em;">• {{ warning.xpath }}</span>
                                        {% endif %}
                                    </button>
                                </h2>
                                <div id="warn-single-{{ warn_counter.value }}" 
                         class="accordion-collapse collapse" 
                         data-bs-parent="#warningsAccordion">
                        <div class="accordion-body">
                            {% if warning.metadata and warning.metadata.title %}
                            <!-- Enhanced description available -->
                            <div class="alert alert-warning mb-3">
                                <h6 class="alert-heading">{{ warning.metadata.title }}</h6>
                            </div>
                            
                            <h6 class="text-warning mb-2">About this issue:</h6>
                            
                            <div class="mb-3">
                                <strong>What the issue is:</strong>
                                <p>{{ warning.metadata.what|default(warning.description) }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Why this is important:</strong>
                                <p>{{ warning.metadata.why }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Who it affects:</strong>
                                <p>{{ warning.metadata.who }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>How to remediate:</strong>
                                <div class="bg-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace;">{{ warning.metadata.full_remediation|default(warning.failure_summary) }}</div>
                            </div>

                            {% if warning.metadata.wcag_full or warning.wcag_criteria %}
                            <h6 class="text-warning mb-2 mt-4">Relevant test criteria:</h6>
                            <div class="mb-3">
                                {% if warning.metadata.wcag_full %}
                                <strong>WCAG Success Criteria:</strong>
                                <ul>
                                {% for criterion in warning.metadata.wcag_full %}
                                    <li>{{ criterion|safe }}</li>
                                {% endfor %}
                                </ul>
                                {% elif warning.wcag_criteria %}
                                <strong>WCAG Success Criteria:</strong>
                                <ul>
                                {% for criterion in warning.wcag_criteria %}
                                    <li>
                                        <a href="https://www.w3.org/WAI/WCAG21/Understanding/" target="_blank" class="text-decoration-none">
                                            {{ criterion }}
                                        </a>
                                    </li>
                                {% endfor %}
                                </ul>
                                {% endif %}
                            </div>
                            {% endif %}

                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Touchpoint:</strong> {{ warning.touchpoint }}</p>
                                    <p><strong>Impact:</strong>
                                        <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[warning.impact.value|lower if warning.impact.value else warning.impact|lower] or 'secondary' }} impact-badge">
                                            {{ warning.impact.value|upper if warning.impact.value else warning.impact|upper }}
                                        </span>
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    {% if warning.metadata.wcag_full %}
                                        {% for criterion in warning.metadata.wcag_full|sort %}
                                        <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-left: 3px solid #ffc107;">
                                            <p style="margin: 0 0 8px 0; font-weight: bold;">
                                                WCAG {{ criterion|safe }}
                                            </p>
                                            
                                            <p style="margin: 0 0 5px 0;">
                                                <a href="{{ criterion.split()[0] | wcag_understanding_url }}" target="_blank">
                                                    More about {{ criterion | wcag_name }} <i class="bi bi-box-arrow-up-right"></i>
                                                </a>
                                            </p>
                                            <p style="margin: 0;">
                                                <a href="{{ criterion.split()[0] | wcag_quickref_url }}" target="_blank">
                                                    Ways to meet {{ criterion | wcag_name }} <i class="bi bi-box-arrow-up-right"></i>
                                                </a>
                                            </p>
                                            
                                        </div>
                                        {% endfor %}
                                    {% elif warning.wcag_criteria %}
                                        {% for wcag_criterion in warning.wcag_criteria|sort %}
                                        <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-left: 3px solid #ffc107;">
                                            <p style="margin: 0 0 8px 0; font-weight: bold;">
                                                WCAG {{ wcag_criterion }}
                                            </p>
                                            
                                            <p style="margin: 0 0 5px 0;">
                                                <a href="{{ wcag_criterion | wcag_understanding_url }}" target="_blank">
                                                    More about {{ wcag_criterion | wcag_name }} <i class="bi bi-box-arrow-up-right"></i>
                                                </a>
                                            </p>
                                            <p style="margin: 0;">
                                                <a href="{{ wcag_criterion | wcag_quickref_url }}" target="_blank">
                                                    Ways to meet {{ wcag_criterion | wcag_name }} <i class="bi bi-box-arrow-up-right"></i>
                                                </a>
                                            </p>
                                            
                                        </div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>

                            {% if warning.xpath %}
                            <p>
                                <strong>Location:</strong> <code>{{warning.xpath}}</code>
                                <button class="btn btn-sm btn-link p-0 ms-2" onclick="copyXpathToClipboard('{{warning.xpath|e}}', this)" title="Copy XPath to clipboard">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </p>
                            {% endif %}
                            {% if warning.html %}
                            <div class="mt-3">
                                <h6>Code Snippet</h6>
                                {% if 'ErrSkippedHeadingLevel' in warning.id and warning.metadata and 'previousHeadingHtml' in warning.metadata %}
                                <p class="mb-2"><strong>Previous heading (h{{ warning.metadata.skippedFrom }}):</strong></p>
                                <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ warning.metadata.previousHeadingHtml|e }}</code></pre>
                                <p class="mb-2"><strong>Current heading (h{{ warning.metadata.skippedTo }}) - skipped h{{ warning.metadata.expectedLevel }}:</strong></p>
                                <pre class="bg-dark text-light p-3 rounded"><code>{{ warning.html|e }}</code></pre>
                                {% elif 'ErrDuplicateLandmarkWithoutName' in warning.id and warning.metadata and 'allInstances' in warning.metadata %}
                                                        <p class="mb-2"><strong>This instance (missing accessible name):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ warning.html|e }}</code></pre>
                                                        <h6 class="mt-4">All {{ warning.metadata.totalCount }} {{ warning.metadata.role }} landmarks on page:</h6>
                                                        {% for instance in warning.metadata.allInstances %}
                                                        <div class="mb-3">
                                                            <p class="mb-1"><strong>Instance {{ instance.index }}:</strong> {{ instance.name }}</p>
                                                            <p class="mb-1 small text-muted">
                                                            Location: <code>{{instance.xpath}}</code>
                                                            <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyXpathToClipboard('{{instance.xpath|e}}', this)" title="Copy XPath to clipboard" style="font-size: 0.875rem;">
                                                                <i class="bi bi-clipboard"></i>
                                                            </button>
                                                        </p>
                                                            <pre class="bg-dark text-light p-2 rounded"><code>{{ instance.html|e }}</code></pre>
                                                        </div>
                                                        {% endfor %}
                                                        {% elif 'ErrTabOrderViolation' in warning.id and warning.metadata and 'previousElement' in warning.metadata %}
                                                        <p class="mb-2"><strong>This element (comes later in tab order but appears visually left):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ warning.html|e }}</code></pre>
                                                        <p class="mb-2"><strong>Previous element in tab order (visually to the right):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ warning.metadata.previousElement.html|e }}</code></pre>
                                                        <div class="alert alert-info">
                                                            <p class="mb-1"><strong>Visual positions:</strong></p>
                                                            <p class="mb-1">• This element: x={{ warning.metadata.currentElement.position.x }}, y={{ warning.metadata.currentElement.position.y }} (tab stop #{{ warning.metadata.currentElement.tabIndex }})</p>
                                                            <p class="mb-0">• Previous element: x={{ warning.metadata.previousElement.position.x }}, y={{ warning.metadata.previousElement.position.y }} (tab stop #{{ warning.metadata.previousElement.tabIndex }})</p>
                                                        </div>
                                                        {% else %}
                                                        <pre class="bg-dark text-light p-3 rounded"><code>{{ warning.html|e }}</code></pre>
                                                        {% endif %}
                            </div>
                            {% endif %}

                            <!-- Thumbnail of the page at time of test -->
                            {% if screenshot_filename %}
                            <h6 class="mt-4">Page Thumbnail (at time of test)</h6>
                            <a href="#" onclick="showScreenshot('{{ url_for('serve_screenshot', filename=screenshot_filename) }}', '{{ page.url }}'); return false;">
                                <img src="{{ url_for('serve_screenshot', filename=screenshot_filename) }}"
                                     alt="Thumbnail of {{ page.url }}"
                                     class="img-thumbnail"
                                     style="max-width: 300px; height: auto; cursor: pointer;"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <span style="display: none; font-size: 0.9em; color: #999;">Thumbnail not available</span>
                            </a>
                            <p class="text-muted small mt-1">Click to view full size</p>
                            {% endif %}
                            {% else %}
                            <!-- Standard description -->
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Touchpoint:</strong> {{ warning.touchpoint }}</p>
                                    <p><strong>Impact:</strong>
                                        <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[warning.impact.value|lower if warning.impact.value else warning.impact|lower] or 'secondary' }} impact-badge">
                                            {{ warning.impact.value|upper if warning.impact.value else warning.impact|upper }}
                                        </span>
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    {% if warning.wcag_criteria %}
                            {% for wcag_criterion in warning.wcag_criteria|sort %}
                            <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-left: 3px solid #ffc107;">
                                <p style="margin: 0 0 8px 0; font-weight: bold;">
                                    WCAG {{ wcag_criterion }}
                                </p>
                                
                                <p style="margin: 0 0 5px 0;">
                                    <a href="{{ wcag_criterion | wcag_understanding_url }}" target="_blank">
                                        More about {{ wcag_criterion | wcag_name }} <i class="bi bi-box-arrow-up-right"></i>
                                    </a>
                                </p>
                                <p style="margin: 0;">
                                    <a href="{{ wcag_criterion | wcag_quickref_url }}" target="_blank">
                                        Ways to meet {{ wcag_criterion | wcag_name }} <i class="bi bi-box-arrow-up-right"></i>
                                    </a>
                                </p>
                                
                            </div>
                            {% endfor %}
                                    {% endif %}
                                </div>
                            </div>

                            {% if warning.xpath %}
                            <p><strong>XPath:</strong> <code>{{ warning.xpath }}</code></p>
                            {% endif %}
                            {% if warning.html %}
                            <pre><code>{{ warning.html|e }}</code></pre>
                            {% endif %}

                            <!-- Thumbnail of the page at time of test -->
                            {% if screenshot_filename %}
                            <h6 class="mt-4">Page Thumbnail (at time of test)</h6>
                            <a href="#" onclick="showScreenshot('{{ url_for('serve_screenshot', filename=screenshot_filename) }}', '{{ page.url }}'); return false;">
                                <img src="{{ url_for('serve_screenshot', filename=screenshot_filename) }}"
                                     alt="Thumbnail of {{ page.url }}"
                                     class="img-thumbnail"
                                     style="max-width: 300px; height: auto; cursor: pointer;"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <span style="display: none; font-size: 0.9em; color: #999;">Thumbnail not available</span>
                            </a>
                            <p class="text-muted small mt-1">Click to view full size</p>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            </div>
            {% endif %}

            <!-- Info Notes -->
            {% if latest_result.info %}
            <h6 class="text-info mb-3">
                <i class="bi bi-info-circle"></i> Info Notes ({{ latest_result.info|length }})
            </h6>
            <div class="accordion mb-4" id="infoAccordion">
                {% set info_counter = namespace(value=0) %}
                {% for touchpoint, touchpoint_infos in latest_result.info|groupby('touchpoint') %}
                    <div class="touchpoint-header mt-3 mb-2 ps-2" style="background-color: #f8f9fa; padding: 8px; border-left: 4px solid #0dcaf0;">
                        <strong>{{ touchpoint|replace('_', ' ')|title }}</strong>
                    </div>
                    
                    {% for error_code, description_group in touchpoint_infos|groupby('id') %}
                        {% set group_list = description_group|list %}
                        {% set info_counter.value = info_counter.value + 1 %}
                        {% if group_list|length > 1 %}
                            <!-- Multiple instances - create sub-accordion -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#info-group-{{ info_counter.value }}">
                                        {% set first_info = group_list[0] %}
                                        <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[first_info.impact.value|lower if first_info.impact.value else first_info.impact|lower] or 'info' }} me-2">{{ group_list|length }}</span>
                                        {% if first_info.impact %}
                                        <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[first_info.impact.value|lower if first_info.impact.value else first_info.impact|lower] or 'info' }} me-2 impact-badge">
                                            {{ first_info.impact.value|upper if first_info.impact.value else first_info.impact|upper }}
                                        </span>
                                        {% endif %}
                                        <code class="me-2">{{ error_code|error_code_only }}</code>
                                        {# For grouped info items, use generic description from catalog (never specific description from instance) #}
                                        {{ first_info.metadata.what_generic if first_info.metadata and first_info.metadata.what_generic else (first_info.metadata.what if first_info.metadata and first_info.metadata.what else error_code|error_code_only) }}
                                    </button>
                                </h2>
                                <div id="info-group-{{ info_counter.value }}" 
                                     class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <div class="accordion" id="info-instances-{{ info_counter.value }}">
                                            {% for info in group_list %}
                                            {% set info_instance_id = info_counter.value ~ '-' ~ loop.index %}
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed" type="button" 
                                                            data-bs-toggle="collapse" 
                                                            data-bs-target="#info-instance-{{ info_instance_id }}">
                                                        <strong>Instance {{ loop.index }}:</strong>
                                                        {% if info.xpath %}
                                                        <code class="ms-2">{{ info.xpath }}</code>
                                                        {% endif %}
                                                    </button>
                                                </h2>
                                                <div id="info-instance-{{ info_instance_id }}" 
                                                     class="accordion-collapse collapse"
                                                     data-bs-parent="#info-instances-{{ info_counter.value }}">
                                                    <div class="accordion-body">
                                                        <!-- Full info details -->
                                                        {% if info.metadata and info.metadata.title %}
                                                        <!-- Enhanced description available -->
                                                        <div class="alert alert-info mb-3">
                                                            <h6 class="alert-heading">{{ info.description }}</h6>
                                                        </div>
                                                        
                                                        <h6 class="text-info mb-2">About this issue:</h6>
                                                        
                                                        <div class="mb-3">
                                                            <strong>What the issue is:</strong>
                                                            <p>{{ info.metadata.what|default(info.description) }}</p>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <strong>Why this is important:</strong>
                                                            <p>{{ info.metadata.why }}</p>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <strong>Who it affects:</strong>
                                                            <p>{{ info.metadata.who }}</p>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <strong>How to remediate:</strong>
                                                            <div class="bg-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace;">{{ info.metadata.full_remediation|default(info.failure_summary) }}</div>
                                                        </div>

                                                        {% if info.metadata.wcag_full or info.wcag_criteria %}
                                                        <h6 class="text-info mb-2 mt-4">Relevant test criteria:</h6>
                                                        <div class="mb-3">
                                                            {% if info.metadata.wcag_full %}
                                                            <strong>WCAG Success Criteria:</strong>
                                                            <ul>
                                                            {% for criterion in info.metadata.wcag_full %}
                                                                <li>{{ criterion|safe }}</li>
                                                            {% endfor %}
                                                            </ul>
                                                            {% elif info.wcag_criteria %}
                                                            <strong>WCAG Success Criteria:</strong>
                                                            <ul>
                                                            {% for criterion in info.wcag_criteria %}
                                                                <li>
                                                                    <a href="https://www.w3.org/WAI/WCAG21/Understanding/" target="_blank" class="text-decoration-none">
                                                                        {{ criterion }}
                                                                    </a>
                                                                </li>
                                                            {% endfor %}
                                                            </ul>
                                                            {% endif %}
                                                        </div>
                                                        {% endif %}
                                                        {% else %}
                                                        <!-- Standard description -->
                                                        <p><strong>Touchpoint:</strong> {{ info.touchpoint|default('General') }}</p>
                                                        <p class="text-muted">
                                                            <i class="bi bi-info-circle"></i> This is an informational note.
                                                        </p>
                                                        {% endif %}
                                                        
                                                        {% if info.xpath %}
                                                        <p>
                                <strong>Location:</strong> <code>{{info.xpath}}</code>
                                <button class="btn btn-sm btn-link p-0 ms-2" onclick="copyXpathToClipboard('{{info.xpath|e}}', this)" title="Copy XPath to clipboard">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </p>
                                                        {% endif %}
                                                        {% if info.html %}
                                                        <h6 class="mt-3">Code Snippet</h6>
                                                        {% if 'ErrSkippedHeadingLevel' in info.id and info.metadata and 'previousHeadingHtml' in info.metadata %}
                                                        <p class="mb-2"><strong>Previous heading (h{{ info.metadata.skippedFrom }}):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ info.metadata.previousHeadingHtml|e }}</code></pre>
                                                        <p class="mb-2"><strong>Current heading (h{{ info.metadata.skippedTo }}) - skipped h{{ info.metadata.expectedLevel }}:</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded"><code>{{ info.html|e }}</code></pre>
                                                        {% elif 'ErrDuplicateLandmarkWithoutName' in info.id and info.metadata and 'allInstances' in info.metadata %}
                                                        <p class="mb-2"><strong>This instance (missing accessible name):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ info.html|e }}</code></pre>
                                                        <h6 class="mt-4">All {{ info.metadata.totalCount }} {{ info.metadata.role }} landmarks on page:</h6>
                                                        {% for instance in info.metadata.allInstances %}
                                                        <div class="mb-3">
                                                            <p class="mb-1"><strong>Instance {{ instance.index }}:</strong> {{ instance.name }}</p>
                                                            <p class="mb-1 small text-muted">
                                                            Location: <code>{{instance.xpath}}</code>
                                                            <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyXpathToClipboard('{{instance.xpath|e}}', this)" title="Copy XPath to clipboard" style="font-size: 0.875rem;">
                                                                <i class="bi bi-clipboard"></i>
                                                            </button>
                                                        </p>
                                                            <pre class="bg-dark text-light p-2 rounded"><code>{{ instance.html|e }}</code></pre>
                                                        </div>
                                                        {% endfor %}
                                                        {% elif 'ErrTabOrderViolation' in info.id and info.metadata and 'previousElement' in info.metadata %}
                                                        <p class="mb-2"><strong>This element (comes later in tab order but appears visually left):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ info.html|e }}</code></pre>
                                                        <p class="mb-2"><strong>Previous element in tab order (visually to the right):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ info.metadata.previousElement.html|e }}</code></pre>
                                                        <div class="alert alert-info">
                                                            <p class="mb-1"><strong>Visual positions:</strong></p>
                                                            <p class="mb-1">• This element: x={{ info.metadata.currentElement.position.x }}, y={{ info.metadata.currentElement.position.y }} (tab stop #{{ info.metadata.currentElement.tabIndex }})</p>
                                                            <p class="mb-0">• Previous element: x={{ info.metadata.previousElement.position.x }}, y={{ info.metadata.previousElement.position.y }} (tab stop #{{ info.metadata.previousElement.tabIndex }})</p>
                                                        </div>
                                                        {% else %}
                                                        <pre class="bg-dark text-light p-3 rounded"><code>{{ info.html|e }}</code></pre>
                                                        {% endif %}
                                                        {% endif %}

                                                        <!-- Thumbnail of the page at time of test -->
                                                        {% if screenshot_filename %}
                                                        <h6 class="mt-4">Page Thumbnail (at time of test)</h6>
                                                        <a href="#" onclick="showScreenshot('{{ url_for('serve_screenshot', filename=screenshot_filename) }}', '{{ page.url }}'); return false;">
                                                            <img src="{{ url_for('serve_screenshot', filename=screenshot_filename) }}"
                                                                 alt="Thumbnail of {{ page.url }}"
                                                                 class="img-thumbnail"
                                                                 style="max-width: 300px; height: auto; cursor: pointer;"
                                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                                            <span style="display: none; font-size: 0.9em; color: #999;">Thumbnail not available</span>
                                                        </a>
                                                        <p class="text-muted small mt-1">Click to view full size</p>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <!-- Single instance - show as before -->
                            {% for info in group_list %}
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#info-single-{{ info_counter.value }}">
                            <code class="me-2">{{ error_code|error_code_only }}</code>
                            {% if info.metadata and info.metadata.title %}
                                {{ info.metadata.title }}
                            {% elif info.metadata and info.metadata.what and info.metadata.what != "Accessibility issue: " + info.id.split('_')[1] %}
                                {{ info.metadata.what }}
                            {% else %}
                                {{ info.description }}
                            {% endif %}
                            {% if info.xpath %}
                                <span class="text-muted ms-2" style="font-size: 0.9em;">• {{ info.xpath }}</span>
                            {% endif %}
                                    </button>
                                </h2>
                                <div id="info-single-{{ info_counter.value }}" 
                         class="accordion-collapse collapse" 
                         data-bs-parent="#infoAccordion">
                        <div class="accordion-body">
                            {% if info.metadata and info.metadata.title %}
                            <!-- Enhanced description available -->
                            <div class="alert alert-info mb-3">
                                <h6 class="alert-heading">{{ info.metadata.title }}</h6>
                            </div>
                            
                            <h6 class="text-info mb-2">About this issue:</h6>
                            
                            <div class="mb-3">
                                <strong>What the issue is:</strong>
                                <p>{{ info.metadata.what|default(info.description) }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Why this is important:</strong>
                                <p>{{ info.metadata.why }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Who it affects:</strong>
                                <p>{{ info.metadata.who }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>How to remediate:</strong>
                                <div class="bg-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace;">{{ info.metadata.full_remediation|default(info.failure_summary) }}</div>
                            </div>

                            {% if info.metadata.wcag_full or info.wcag_criteria %}
                            <h6 class="text-info mb-2 mt-4">Relevant test criteria:</h6>
                            <div class="mb-3">
                                {% if info.metadata.wcag_full %}
                                <strong>WCAG Success Criteria:</strong>
                                <ul>
                                {% for criterion in info.metadata.wcag_full %}
                                    <li>{{ criterion|safe }}</li>
                                {% endfor %}
                                </ul>
                                {% elif info.wcag_criteria %}
                                <strong>WCAG Success Criteria:</strong>
                                <ul>
                                {% for criterion in info.wcag_criteria %}
                                    <li>
                                        <a href="https://www.w3.org/WAI/WCAG21/Understanding/" target="_blank" class="text-decoration-none">
                                            {{ criterion }}
                                        </a>
                                    </li>
                                {% endfor %}
                                </ul>
                                {% endif %}
                            </div>
                            {% endif %}

                            <hr>
                            <p><strong>Touchpoint:</strong> {{ info.touchpoint }}</p>
                            {% if info.xpath %}
                            <p>
                                <strong>Location:</strong> <code>{{info.xpath}}</code>
                                <button class="btn btn-sm btn-link p-0 ms-2" onclick="copyXpathToClipboard('{{info.xpath|e}}', this)" title="Copy XPath to clipboard">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </p>
                            {% endif %}
                            {% if info.html %}
                            <div class="mt-3">
                                <h6>Code Snippet</h6>
                                {% if 'ErrSkippedHeadingLevel' in info.id and info.metadata and 'previousHeadingHtml' in info.metadata %}
                                <p class="mb-2"><strong>Previous heading (h{{ info.metadata.skippedFrom }}):</strong></p>
                                <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ info.metadata.previousHeadingHtml|e }}</code></pre>
                                <p class="mb-2"><strong>Current heading (h{{ info.metadata.skippedTo }}) - skipped h{{ info.metadata.expectedLevel }}:</strong></p>
                                <pre class="bg-dark text-light p-3 rounded"><code>{{ info.html|e }}</code></pre>
                                {% elif 'ErrDuplicateLandmarkWithoutName' in info.id and info.metadata and 'allInstances' in info.metadata %}
                                                        <p class="mb-2"><strong>This instance (missing accessible name):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ info.html|e }}</code></pre>
                                                        <h6 class="mt-4">All {{ info.metadata.totalCount }} {{ info.metadata.role }} landmarks on page:</h6>
                                                        {% for instance in info.metadata.allInstances %}
                                                        <div class="mb-3">
                                                            <p class="mb-1"><strong>Instance {{ instance.index }}:</strong> {{ instance.name }}</p>
                                                            <p class="mb-1 small text-muted">
                                                            Location: <code>{{instance.xpath}}</code>
                                                            <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyXpathToClipboard('{{instance.xpath|e}}', this)" title="Copy XPath to clipboard" style="font-size: 0.875rem;">
                                                                <i class="bi bi-clipboard"></i>
                                                            </button>
                                                        </p>
                                                            <pre class="bg-dark text-light p-2 rounded"><code>{{ instance.html|e }}</code></pre>
                                                        </div>
                                                        {% endfor %}
                                                        {% elif 'ErrTabOrderViolation' in info.id and info.metadata and 'previousElement' in info.metadata %}
                                                        <p class="mb-2"><strong>This element (comes later in tab order but appears visually left):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ info.html|e }}</code></pre>
                                                        <p class="mb-2"><strong>Previous element in tab order (visually to the right):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ info.metadata.previousElement.html|e }}</code></pre>
                                                        <div class="alert alert-info">
                                                            <p class="mb-1"><strong>Visual positions:</strong></p>
                                                            <p class="mb-1">• This element: x={{ info.metadata.currentElement.position.x }}, y={{ info.metadata.currentElement.position.y }} (tab stop #{{ info.metadata.currentElement.tabIndex }})</p>
                                                            <p class="mb-0">• Previous element: x={{ info.metadata.previousElement.position.x }}, y={{ info.metadata.previousElement.position.y }} (tab stop #{{ info.metadata.previousElement.tabIndex }})</p>
                                                        </div>
                                                        {% else %}
                                                        <pre class="bg-dark text-light p-3 rounded"><code>{{ info.html|e }}</code></pre>
                                                        {% endif %}

                                                        <!-- Thumbnail of the page at time of test -->
                                                        {% if screenshot_filename %}
                                                        <h6 class="mt-4">Page Thumbnail (at time of test)</h6>
                                                        <a href="#" onclick="showScreenshot('{{ url_for('serve_screenshot', filename=screenshot_filename) }}', '{{ page.url }}'); return false;">
                                                            <img src="{{ url_for('serve_screenshot', filename=screenshot_filename) }}"
                                                                 alt="Thumbnail of {{ page.url }}"
                                                                 class="img-thumbnail"
                                                                 style="max-width: 300px; height: auto; cursor: pointer;"
                                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                                            <span style="display: none; font-size: 0.9em; color: #999;">Thumbnail not available</span>
                                                        </a>
                                                        <p class="text-muted small mt-1">Click to view full size</p>
                                                        {% endif %}
                            </div>
                            {% endif %}
                            {% else %}
                            <!-- Standard description -->
                            <p><strong>Touchpoint:</strong> {{ info.touchpoint }}</p>
                            {% if info.wcag_criteria %}
                            {% for wcag_criterion in info.wcag_criteria|sort %}
                            <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-left: 3px solid #17a2b8;">
                                <p style="margin: 0 0 8px 0; font-weight: bold;">
                                    WCAG {{ wcag_criterion }}
                                </p>
                                
                                <p style="margin: 0 0 5px 0;">
                                    <a href="{{ wcag_criterion | wcag_understanding_url }}" target="_blank">
                                        More about {{ wcag_criterion | wcag_name }} <i class="bi bi-box-arrow-up-right"></i>
                                    </a>
                                </p>
                                <p style="margin: 0;">
                                    <a href="{{ wcag_criterion | wcag_quickref_url }}" target="_blank">
                                        Ways to meet {{ wcag_criterion | wcag_name }} <i class="bi bi-box-arrow-up-right"></i>
                                    </a>
                                </p>
                                
                            </div>
                            {% endfor %}
                            {% endif %}
                            {% if info.xpath %}
                            <p><strong>XPath:</strong> <code>{{ info.xpath }}</code></p>
                            {% endif %}
                            {% if info.html %}
                            <pre><code>{{ info.html|e }}</code></pre>
                            {% endif %}

                            <!-- Thumbnail of the page at time of test -->
                            {% if screenshot_filename %}
                            <h6 class="mt-4">Page Thumbnail (at time of test)</h6>
                            <a href="#" onclick="showScreenshot('{{ url_for('serve_screenshot', filename=screenshot_filename) }}', '{{ page.url }}'); return false;">
                                <img src="{{ url_for('serve_screenshot', filename=screenshot_filename) }}"
                                     alt="Thumbnail of {{ page.url }}"
                                     class="img-thumbnail"
                                     style="max-width: 300px; height: auto; cursor: pointer;"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <span style="display: none; font-size: 0.9em; color: #999;">Thumbnail not available</span>
                            </a>
                            <p class="text-muted small mt-1">Click to view full size</p>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            </div>
            {% endif %}

            <!-- Discovery Items -->
            {% if latest_result.discovery %}
            <h6 class="mb-3" style="color: #6f42c1;">
                <i class="bi bi-search"></i> Discovery Items ({{ latest_result.discovery|length }})
            </h6>
            <div class="accordion mb-4" id="discoveryAccordion">
                {% set disc_counter = namespace(value=0) %}
                {% for touchpoint, touchpoint_discoveries in latest_result.discovery|groupby('touchpoint') %}
                    <div class="touchpoint-header mt-3 mb-2 ps-2" style="background-color: #f8f9fa; padding: 8px; border-left: 4px solid #6f42c1;">
                        <strong>{{ touchpoint|replace('_', ' ')|title }}</strong>
                    </div>
                    
                    {% for error_code, description_group in touchpoint_discoveries|groupby('id') %}
                        {% set group_list = description_group|list %}
                        {% set disc_counter.value = disc_counter.value + 1 %}
                        {% if group_list|length > 1 %}
                            <!-- Multiple instances - create sub-accordion -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#disc-group-{{ disc_counter.value }}">
                                        {% set first_discovery = group_list[0] %}
                                        <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[first_discovery.impact.value|lower if first_discovery.impact.value else first_discovery.impact|lower] or 'secondary' }} me-2">{{ group_list|length }}</span>
                                        {% if first_discovery.impact %}
                                        <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[first_discovery.impact.value|lower if first_discovery.impact.value else first_discovery.impact|lower] or 'secondary' }} me-2 impact-badge">
                                            {{ first_discovery.impact.value|upper if first_discovery.impact.value else first_discovery.impact|upper }}
                                        </span>
                                        {% endif %}
                                        <code class="me-2">{{ error_code|error_code_only }}</code>
                                        {# For grouped discoveries, use generic description from catalog (never specific description from instance) #}
                                        {{ first_discovery.metadata.what_generic if first_discovery.metadata and first_discovery.metadata.what_generic else (first_discovery.metadata.what if first_discovery.metadata and first_discovery.metadata.what else error_code|error_code_only) }}
                                    </button>
                                </h2>
                                <div id="disc-group-{{ disc_counter.value }}" 
                                     class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <div class="accordion" id="disc-instances-{{ disc_counter.value }}">
                                            {% for discovery in group_list %}
                                            {% set disc_instance_id = disc_counter.value ~ '-' ~ loop.index %}
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed" type="button" 
                                                            data-bs-toggle="collapse" 
                                                            data-bs-target="#disc-instance-{{ disc_instance_id }}">
                                                        <strong>Instance {{ loop.index }}:</strong>
                                                        {% if discovery.xpath %}
                                                        <code class="ms-2">{{ discovery.xpath }}</code>
                                                        {% endif %}
                                                        {% if 'DiscoFontFound' in discovery.id and discovery.metadata.fontName %}
                                                        <span class="ms-2">Font '{{ discovery.metadata.fontName }}' at {{ discovery.metadata.sizeCount }} size{{ 's' if discovery.metadata.sizeCount != 1 else '' }}: {{ discovery.metadata.fontSizes|join(', ') }}</span>
                                                        {% elif 'DiscoFormOnPage' in discovery.id and discovery.metadata.formSignature %}
                                                        <span class="ms-2">Form (signature: {{ discovery.metadata.formSignature }}){% if discovery.metadata.searchContext and 'search' in discovery.metadata.searchContext %} with {{ discovery.metadata.fieldCount }} {{ 'field' if discovery.metadata.fieldCount == 1 else 'fields' }} - {{ discovery.metadata.searchContext }}{% else %} with {{ discovery.metadata.fieldCount }} {{ 'field' if discovery.metadata.fieldCount == 1 else 'fields' }}{% endif %}</span>
                                                        {% endif %}
                                                    </button>
                                                </h2>
                                                <div id="disc-instance-{{ disc_instance_id }}" 
                                                     class="accordion-collapse collapse"
                                                     data-bs-parent="#disc-instances-{{ disc_counter.value }}">
                                                    <div class="accordion-body">
                                                        <!-- Full discovery details -->
                                                        {% if discovery.metadata and discovery.metadata.title %}
                                                        <!-- Enhanced description available -->
                                                        <div class="alert mb-3" style="background-color: #f3f0ff; border-color: #6f42c1;">
                                                            <h6 class="alert-heading" style="color: #6f42c1;">{{ discovery.description }}</h6>
                                                        </div>
                                                        
                                                        <h6 style="color: #6f42c1;" class="mb-2">About this discovery item:</h6>
                                                        
                                                        <div class="mb-3">
                                                            <strong>What was found:</strong>
                                                            <p>{{ discovery.metadata.what|default(discovery.description) }}</p>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <strong>Why manual review is needed:</strong>
                                                            <p>{{ discovery.metadata.why }}</p>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <strong>Who could be affected:</strong>
                                                            <p>{{ discovery.metadata.who }}</p>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <strong>What to check manually:</strong>
                                                            <div class="bg-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace;">{{ discovery.metadata.full_remediation|default(discovery.failure_summary) }}</div>
                                                        </div>

                                                        {% if discovery.metadata.wcag_full or discovery.wcag_criteria %}
                                                        <h6 style="color: #6f42c1;" class="mb-2 mt-4">Relevant test criteria:</h6>
                                                        <div class="mb-3">
                                                            {% if discovery.metadata.wcag_full %}
                                                            <strong>WCAG Success Criteria:</strong>
                                                            <ul>
                                                            {% for criterion in discovery.metadata.wcag_full %}
                                                                <li>{{ criterion|safe }}</li>
                                                            {% endfor %}
                                                            </ul>
                                                            {% elif discovery.wcag_criteria %}
                                                            <strong>WCAG Success Criteria:</strong>
                                                            <ul>
                                                            {% for criterion in discovery.wcag_criteria %}
                                                                <li>
                                                                    <a href="https://www.w3.org/WAI/WCAG21/Understanding/" target="_blank" class="text-decoration-none">
                                                                        {{ criterion }}
                                                                    </a>
                                                                </li>
                                                            {% endfor %}
                                                            </ul>
                                                            {% endif %}
                                                        </div>
                                                        {% endif %}
                                                        {% else %}
                                                        <!-- Standard description -->
                                                        <p><strong>Touchpoint:</strong> {{ discovery.touchpoint }}</p>
                                                        <p class="text-muted">
                                                            <i class="bi bi-info-circle"></i> This item requires manual inspection.
                                                        </p>
                                                        {% endif %}
                                                        
                                                        <hr>
                                                        <p><strong>Touchpoint:</strong> {{ discovery.touchpoint }}</p>
                                                        {% if discovery.xpath %}
                                                        <p>
                                <strong>Location:</strong> <code>{{discovery.xpath}}</code>
                                <button class="btn btn-sm btn-link p-0 ms-2" onclick="copyXpathToClipboard('{{discovery.xpath|e}}', this)" title="Copy XPath to clipboard">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </p>
                                                        {% endif %}
                                                        {% if discovery.html %}
                                                        <h6 class="mt-3">Code Snippet</h6>
                                                        {% if 'ErrSkippedHeadingLevel' in discovery.id and discovery.metadata and 'previousHeadingHtml' in discovery.metadata %}
                                                        <p class="mb-2"><strong>Previous heading (h{{ discovery.metadata.skippedFrom }}):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ discovery.metadata.previousHeadingHtml|e }}</code></pre>
                                                        <p class="mb-2"><strong>Current heading (h{{ discovery.metadata.skippedTo }}) - skipped h{{ discovery.metadata.expectedLevel }}:</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded"><code>{{ discovery.html|e }}</code></pre>
                                                        {% elif 'ErrDuplicateLandmarkWithoutName' in discovery.id and discovery.metadata and 'allInstances' in discovery.metadata %}
                                                        <p class="mb-2"><strong>This instance (missing accessible name):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ discovery.html|e }}</code></pre>
                                                        <h6 class="mt-4">All {{ discovery.metadata.totalCount }} {{ discovery.metadata.role }} landmarks on page:</h6>
                                                        {% for instance in discovery.metadata.allInstances %}
                                                        <div class="mb-3">
                                                            <p class="mb-1"><strong>Instance {{ instance.index }}:</strong> {{ instance.name }}</p>
                                                            <p class="mb-1 small text-muted">
                                                            Location: <code>{{instance.xpath}}</code>
                                                            <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyXpathToClipboard('{{instance.xpath|e}}', this)" title="Copy XPath to clipboard" style="font-size: 0.875rem;">
                                                                <i class="bi bi-clipboard"></i>
                                                            </button>
                                                        </p>
                                                            <pre class="bg-dark text-light p-2 rounded"><code>{{ instance.html|e }}</code></pre>
                                                        </div>
                                                        {% endfor %}
                                                        {% elif 'ErrStyleAttrColorFont' in discovery.id and discovery.metadata and 'styleContent' in discovery.metadata %}
                                                        <p class="mb-2"><strong>Element with inline color/font style:</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ discovery.html|e }}</code></pre>
                                                        <p class="mb-2"><strong>Inline style attribute:</strong></p>
                                                        <pre class="bg-danger text-light p-3 rounded"><code>{{ discovery.metadata.styleContent|e }}</code></pre>
                                                        <div class="alert alert-danger">
                                                            <p class="mb-0"><strong>Error:</strong> Inline color and font styles prevent users from customizing colors and fonts to their needs. Move these styles to a CSS file to support user preferences and accessibility features.</p>
                                                        </div>
                                                        {% elif 'WarnStyleAttrOther' in discovery.id and discovery.metadata and 'styleContent' in discovery.metadata %}
                                                        <p class="mb-2"><strong>Element with inline layout style:</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ discovery.html|e }}</code></pre>
                                                        <p class="mb-2"><strong>Inline style attribute:</strong></p>
                                                        <pre class="bg-warning text-dark p-3 rounded"><code>{{ discovery.metadata.styleContent|e }}</code></pre>
                                                        <div class="alert alert-warning">
                                                            <p class="mb-0"><strong>Warning:</strong> While layout styles are less critical than color/font styles, it's better to move these styles to a CSS class for better maintainability and separation of concerns.</p>
                                                        </div>
                                                        {% elif 'ErrTabOrderViolation' in discovery.id and discovery.metadata and 'previousElement' in discovery.metadata %}
                                                        <p class="mb-2"><strong>This element (comes later in tab order but appears visually left):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ discovery.html|e }}</code></pre>
                                                        <p class="mb-2"><strong>Previous element in tab order (visually to the right):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ discovery.metadata.previousElement.html|e }}</code></pre>
                                                        <div class="alert alert-info">
                                                            <p class="mb-1"><strong>Visual positions:</strong></p>
                                                            <p class="mb-1">• This element: x={{ discovery.metadata.currentElement.position.x }}, y={{ discovery.metadata.currentElement.position.y }} (tab stop #{{ discovery.metadata.currentElement.tabIndex }})</p>
                                                            <p class="mb-0">• Previous element: x={{ discovery.metadata.previousElement.position.x }}, y={{ discovery.metadata.previousElement.position.y }} (tab stop #{{ discovery.metadata.previousElement.tabIndex }})</p>
                                                        </div>
                                                        {% else %}
                                                        <pre class="bg-dark text-light p-3 rounded"><code>{{ discovery.html|e }}</code></pre>
                                                        {% endif %}
                                                        {% endif %}

                                                        <!-- Thumbnail of the page at time of test -->
                                                        {% if screenshot_filename %}
                                                        <h6 class="mt-4">Page Thumbnail (at time of test)</h6>
                                                        <a href="#" onclick="showScreenshot('{{ url_for('serve_screenshot', filename=screenshot_filename) }}', '{{ page.url }}'); return false;">
                                                            <img src="{{ url_for('serve_screenshot', filename=screenshot_filename) }}"
                                                                 alt="Thumbnail of {{ page.url }}"
                                                                 class="img-thumbnail"
                                                                 style="max-width: 300px; height: auto; cursor: pointer;"
                                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                                            <span style="display: none; font-size: 0.9em; color: #999;">Thumbnail not available</span>
                                                        </a>
                                                        <p class="text-muted small mt-1">Click to view full size</p>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <!-- Single instance - show as before -->
                            {% for discovery in group_list %}
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#disc-single-{{ disc_counter.value }}">
                            <code class="me-2">{{ error_code|error_code_only }}</code>
                            {% if 'DiscoFontFound' in discovery.id and discovery.metadata.fontName %}
                                Font '{{ discovery.metadata.fontName }}' at {{ discovery.metadata.sizeCount }} size{{ 's' if discovery.metadata.sizeCount != 1 else '' }}: {{ discovery.metadata.fontSizes|join(', ') }}
                            {% elif discovery.metadata and discovery.metadata.title %}
                                {{ discovery.metadata.title }}
                            {% elif discovery.metadata and discovery.metadata.what and discovery.metadata.what != "Accessibility issue: " + discovery.id.split('_')[1] %}
                                {{ discovery.metadata.what }}
                            {% else %}
                                {{ discovery.description }}
                            {% endif %}
                            {% if discovery.xpath %}
                                <span class="text-muted ms-2" style="font-size: 0.9em;">• {{ discovery.xpath }}</span>
                            {% endif %}
                                    </button>
                                </h2>
                                <div id="disc-single-{{ disc_counter.value }}" 
                         class="accordion-collapse collapse" 
                         data-bs-parent="#discoveryAccordion">
                        <div class="accordion-body">
                            {% if discovery.metadata and discovery.metadata.title %}
                            <!-- Enhanced description available -->
                            <div class="alert mb-3" style="background-color: #f3f0ff; border-color: #6f42c1;">
                                <h6 class="alert-heading" style="color: #6f42c1;">{{ discovery.metadata.title }}</h6>
                            </div>
                            
                            <h6 style="color: #6f42c1;" class="mb-2">About this discovery item:</h6>
                            
                            <div class="mb-3">
                                <strong>What was found:</strong>
                                <p>{{ discovery.metadata.what|default(discovery.description) }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Why manual review is needed:</strong>
                                <p>{{ discovery.metadata.why }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Who could be affected:</strong>
                                <p>{{ discovery.metadata.who }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>What to check manually:</strong>
                                <div class="bg-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace;">{{ discovery.metadata.full_remediation|default(discovery.failure_summary) }}</div>
                            </div>

                            {% if discovery.metadata.wcag_full or discovery.wcag_criteria %}
                            <h6 style="color: #6f42c1;" class="mb-2 mt-4">Relevant test criteria:</h6>
                            <div class="mb-3">
                                {% if discovery.metadata.wcag_full %}
                                <strong>WCAG Success Criteria:</strong>
                                <ul>
                                {% for criterion in discovery.metadata.wcag_full %}
                                    <li>{{ criterion|safe }}</li>
                                {% endfor %}
                                </ul>
                                {% elif discovery.wcag_criteria %}
                                <strong>WCAG Success Criteria:</strong>
                                <ul>
                                {% for criterion in discovery.wcag_criteria %}
                                    <li>
                                        <a href="https://www.w3.org/WAI/WCAG21/Understanding/" target="_blank" class="text-decoration-none">
                                            {{ criterion }}
                                        </a>
                                    </li>
                                {% endfor %}
                                </ul>
                                {% endif %}
                            </div>
                            {% endif %}

                            <hr>
                            <p><strong>Touchpoint:</strong> {{ discovery.touchpoint }}</p>
                            <p class="text-muted">
                                <i class="bi bi-info-circle"></i> This item requires manual inspection to ensure accessibility.
                            </p>
                            {% if discovery.xpath %}
                            <p>
                                <strong>Location:</strong> <code>{{discovery.xpath}}</code>
                                <button class="btn btn-sm btn-link p-0 ms-2" onclick="copyXpathToClipboard('{{discovery.xpath|e}}', this)" title="Copy XPath to clipboard">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </p>
                            {% endif %}
                            {% if discovery.html %}
                            <div class="mt-3">
                                <h6>Code Snippet</h6>
                                {% if 'ErrSkippedHeadingLevel' in discovery.id and discovery.metadata and 'previousHeadingHtml' in discovery.metadata %}
                                <p class="mb-2"><strong>Previous heading (h{{ discovery.metadata.skippedFrom }}):</strong></p>
                                <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ discovery.metadata.previousHeadingHtml|e }}</code></pre>
                                <p class="mb-2"><strong>Current heading (h{{ discovery.metadata.skippedTo }}) - skipped h{{ discovery.metadata.expectedLevel }}:</strong></p>
                                <pre class="bg-dark text-light p-3 rounded"><code>{{ discovery.html|e }}</code></pre>
                                {% elif 'ErrDuplicateLandmarkWithoutName' in discovery.id and discovery.metadata and 'allInstances' in discovery.metadata %}
                                                        <p class="mb-2"><strong>This instance (missing accessible name):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ discovery.html|e }}</code></pre>
                                                        <h6 class="mt-4">All {{ discovery.metadata.totalCount }} {{ discovery.metadata.role }} landmarks on page:</h6>
                                                        {% for instance in discovery.metadata.allInstances %}
                                                        <div class="mb-3">
                                                            <p class="mb-1"><strong>Instance {{ instance.index }}:</strong> {{ instance.name }}</p>
                                                            <p class="mb-1 small text-muted">
                                                            Location: <code>{{instance.xpath}}</code>
                                                            <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyXpathToClipboard('{{instance.xpath|e}}', this)" title="Copy XPath to clipboard" style="font-size: 0.875rem;">
                                                                <i class="bi bi-clipboard"></i>
                                                            </button>
                                                        </p>
                                                            <pre class="bg-dark text-light p-2 rounded"><code>{{ instance.html|e }}</code></pre>
                                                        </div>
                                                        {% endfor %}
                                                        {% elif 'ErrStyleAttrColorFont' in discovery.id and discovery.metadata and 'styleContent' in discovery.metadata %}
                                                        <p class="mb-2"><strong>Element with inline color/font style:</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ discovery.html|e }}</code></pre>
                                                        <p class="mb-2"><strong>Inline style attribute:</strong></p>
                                                        <pre class="bg-danger text-light p-3 rounded"><code>{{ discovery.metadata.styleContent|e }}</code></pre>
                                                        <div class="alert alert-danger">
                                                            <p class="mb-0"><strong>Error:</strong> Inline color and font styles prevent users from customizing colors and fonts to their needs. Move these styles to a CSS file to support user preferences and accessibility features.</p>
                                                        </div>
                                                        {% elif 'WarnStyleAttrOther' in discovery.id and discovery.metadata and 'styleContent' in discovery.metadata %}
                                                        <p class="mb-2"><strong>Element with inline layout style:</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ discovery.html|e }}</code></pre>
                                                        <p class="mb-2"><strong>Inline style attribute:</strong></p>
                                                        <pre class="bg-warning text-dark p-3 rounded"><code>{{ discovery.metadata.styleContent|e }}</code></pre>
                                                        <div class="alert alert-warning">
                                                            <p class="mb-0"><strong>Warning:</strong> While layout styles are less critical than color/font styles, it's better to move these styles to a CSS class for better maintainability and separation of concerns.</p>
                                                        </div>
                                                        {% elif 'ErrTabOrderViolation' in discovery.id and discovery.metadata and 'previousElement' in discovery.metadata %}
                                                        <p class="mb-2"><strong>This element (comes later in tab order but appears visually left):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ discovery.html|e }}</code></pre>
                                                        <p class="mb-2"><strong>Previous element in tab order (visually to the right):</strong></p>
                                                        <pre class="bg-dark text-light p-3 rounded mb-3"><code>{{ discovery.metadata.previousElement.html|e }}</code></pre>
                                                        <div class="alert alert-info">
                                                            <p class="mb-1"><strong>Visual positions:</strong></p>
                                                            <p class="mb-1">• This element: x={{ discovery.metadata.currentElement.position.x }}, y={{ discovery.metadata.currentElement.position.y }} (tab stop #{{ discovery.metadata.currentElement.tabIndex }})</p>
                                                            <p class="mb-0">• Previous element: x={{ discovery.metadata.previousElement.position.x }}, y={{ discovery.metadata.previousElement.position.y }} (tab stop #{{ discovery.metadata.previousElement.tabIndex }})</p>
                                                        </div>
                                                        {% else %}
                                                        <pre class="bg-dark text-light p-3 rounded"><code>{{ discovery.html|e }}</code></pre>
                                                        {% endif %}
                            </div>
                            {% endif %}

                            <!-- Thumbnail of the page at time of test -->
                            {% if screenshot_filename %}
                            <h6 class="mt-4">Page Thumbnail (at time of test)</h6>
                            <a href="#" onclick="showScreenshot('{{ url_for('serve_screenshot', filename=screenshot_filename) }}', '{{ page.url }}'); return false;">
                                <img src="{{ url_for('serve_screenshot', filename=screenshot_filename) }}"
                                     alt="Thumbnail of {{ page.url }}"
                                     class="img-thumbnail"
                                     style="max-width: 300px; height: auto; cursor: pointer;"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <span style="display: none; font-size: 0.9em; color: #999;">Thumbnail not available</span>
                            </a>
                            <p class="text-muted small mt-1">Click to view full size</p>
                            {% endif %}
                            {% else %}
                            <!-- Standard description -->
                            <p><strong>Touchpoint:</strong> {{ discovery.touchpoint }}</p>
                            <p class="text-muted">
                                <i class="bi bi-info-circle"></i> This item requires manual inspection to ensure accessibility.
                            </p>
                            {% if discovery.wcag_criteria %}
                            {% for wcag_criterion in discovery.wcag_criteria|sort %}
                            <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-left: 3px solid #6c757d;">
                                <p style="margin: 0 0 8px 0; font-weight: bold;">
                                    WCAG {{ wcag_criterion }}
                                </p>
                                
                                <p style="margin: 0 0 5px 0;">
                                    <a href="{{ wcag_criterion | wcag_understanding_url }}" target="_blank">
                                        More about {{ wcag_criterion | wcag_name }} <i class="bi bi-box-arrow-up-right"></i>
                                    </a>
                                </p>
                                <p style="margin: 0;">
                                    <a href="{{ wcag_criterion | wcag_quickref_url }}" target="_blank">
                                        Ways to meet {{ wcag_criterion | wcag_name }} <i class="bi bi-box-arrow-up-right"></i>
                                    </a>
                                </p>
                                
                            </div>
                            {% endfor %}
                            {% endif %}
                            {% if discovery.xpath %}
                            <p><strong>XPath:</strong> <code>{{ discovery.xpath }}</code></p>
                            {% endif %}
                            {% if discovery.html %}
                            <pre><code>{{ discovery.html|e }}</code></pre>
                            {% endif %}

                            <!-- Thumbnail of the page at time of test -->
                            {% if screenshot_filename %}
                            <h6 class="mt-4">Page Thumbnail (at time of test)</h6>
                            <a href="#" onclick="showScreenshot('{{ url_for('serve_screenshot', filename=screenshot_filename) }}', '{{ page.url }}'); return false;">
                                <img src="{{ url_for('serve_screenshot', filename=screenshot_filename) }}"
                                     alt="Thumbnail of {{ page.url }}"
                                     class="img-thumbnail"
                                     style="max-width: 300px; height: auto; cursor: pointer;"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <span style="display: none; font-size: 0.9em; color: #999;">Thumbnail not available</span>
                            </a>
                            <p class="text-muted small mt-1">Click to view full size</p>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            </div>
            {% endif %}

            <!-- AI findings are now integrated into violations/warnings/info above -->

            <!-- Summary Stats -->
            <div class="row text-center">
                <div class="col">
                    <small class="text-muted">
                        Test completed in {{ "%.2f"|format(latest_result.duration_ms / 1000) }} seconds
                        {% if latest_result.screenshot_path %}
                        | <a href="{{ url_for('static', filename='screenshots/' ~ latest_result.screenshot_path) }}" target="_blank">
                            View Screenshot <i class="bi bi-image"></i>
                        </a>
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
    </div>
    {% elif page.status.value != 'tested' %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> This page has not been tested yet. Click "Run Test" to start accessibility testing.
    </div>
    {% endif %}

    <!-- Test History -->
    {% if test_history %}
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0">Test History</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>User</th>
                            <th>Errors</th>
                            <th>Warnings</th>
                            <th>Info</th>
                            <th>Discovery</th>
                            <th>Passed</th>
                            <th>Duration</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in test_history %}
                        <tr>
                            <td>{{ result.test_date.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                {% if result.metadata and result.metadata.get('authenticated_user') %}
                                    <i class="bi bi-person-fill"></i> {{ result.metadata.authenticated_user.display_name }}
                                    {% if result.metadata.authenticated_user.roles %}
                                        <br><small class="text-muted">{{ result.metadata.authenticated_user.roles|join(', ') }}</small>
                                    {% endif %}
                                {% else %}
                                    <i class="bi bi-person"></i> Guest
                                {% endif %}
                            </td>
                            <td><span class="badge bg-danger">{{ result.violation_count }}</span></td>
                            <td><span class="badge bg-warning text-dark">{{ result.warning_count }}</span></td>
                            <td><span class="badge bg-info">{{ result.info_count|default(0) }}</span></td>
                            <td><span class="badge" style="background-color: #6f42c1;">{{ result.discovery_count|default(0) }}</span></td>
                            <td><span class="badge bg-success">{{ result.pass_count }}</span></td>
                            <td>{{ "%.2f"|format(result.duration_ms / 1000) }}s</td>
                            <td>
                                <a href="{{ url_for('testing.view_result', result_id=result.id) }}"
                                   class="btn btn-sm btn-primary">
                                    <i class="bi bi-eye"></i> View
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Screenshot Modal -->
<div class="modal fade" id="screenshotModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="screenshotModalTitle">Page Screenshot</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="screenshotModalImage" src="" alt="Screenshot" style="max-width: 100%; height: auto;">
            </div>
            <div class="modal-footer">
                <a id="screenshotModalLink" href="" target="_blank" class="btn btn-primary">
                    <i class="bi bi-box-arrow-up-right"></i> Open in New Tab
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Test Page Modal -->
<div class="modal fade" id="testModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Running Test</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Testing...</span>
                </div>
                <p>Running accessibility tests on this page...</p>
                <p class="text-muted">This may take a moment.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function showScreenshot(screenshotUrl, pageUrl) {
    $('#screenshotModalTitle').text('Screenshot: ' + pageUrl);
    $('#screenshotModalImage').attr('src', screenshotUrl);
    $('#screenshotModalLink').attr('href', screenshotUrl);
    $('#screenshotModal').modal('show');
}

let statusPollInterval = null;
let testInProgress = false;

function updateStatusBadge(status) {
    const container = document.getElementById('page-status-container');
    const progressAlert = document.getElementById('test-progress-alert');
    let badgeHtml = '';
    
    switch(status) {
        case 'discovered':
            badgeHtml = '<span class="badge bg-secondary">Discovered</span>';
            progressAlert.classList.add('d-none');
            break;
        case 'queued':
            badgeHtml = '<span class="badge bg-warning"><span class="spinner-border spinner-border-sm me-1" role="status"></span>Queued</span>';
            progressAlert.classList.remove('d-none');
            break;
        case 'testing':
            badgeHtml = '<span class="badge bg-info"><span class="spinner-border spinner-border-sm me-1" role="status"></span>Testing</span>';
            progressAlert.classList.remove('d-none');
            break;
        case 'tested':
            badgeHtml = '<span class="badge bg-success">Tested</span>';
            progressAlert.classList.add('d-none');
            break;
        case 'error':
            badgeHtml = '<span class="badge bg-danger">Error</span>';
            progressAlert.classList.add('d-none');
            break;
        default:
            badgeHtml = `<span class="badge bg-secondary">${status.charAt(0).toUpperCase() + status.slice(1)}</span>`;
            progressAlert.classList.add('d-none');
    }
    
    container.innerHTML = badgeHtml;
}

function startStatusPolling(pageId) {
    let previousStatus = null;
    
    // Poll every 2 seconds
    statusPollInterval = setInterval(() => {
        $.get(`/pages/${pageId}/test-status`, function(data) {
            updateStatusBadge(data.status);
            
            // Check if test just completed (transitioned to tested/error)
            if ((data.status === 'tested' || data.status === 'error') && 
                previousStatus !== null && 
                previousStatus !== 'tested' && 
                previousStatus !== 'error') {
                
                // Test just completed - reload page to show new results
                stopStatusPolling();
                
                // Show notification before reload
                if (window.showNotification) {
                    showNotification('Test Complete', 'Refreshing page to show results...', 'success');
                }
                
                // Reload after a short delay to show the notification
                setTimeout(() => location.reload(), 1500);
            }
            // Stop polling if already in final state
            else if (data.status === 'tested' || data.status === 'error') {
                stopStatusPolling();
            }
            
            previousStatus = data.status;
        }).fail(function() {
            console.error('Failed to check test status');
        });
    }, 2000);
}

function stopStatusPolling() {
    if (statusPollInterval) {
        clearInterval(statusPollInterval);
        statusPollInterval = null;
    }
    testInProgress = false;
}

function updateActionButtons(mode) {
    const actionsDiv = document.getElementById('page-actions');
    if (!actionsDiv) return;
    
    const editBtn = actionsDiv.querySelector('a[href*="edit"]');
    
    if (mode === 'cancel') {
        // Replace with cancel button
        actionsDiv.innerHTML = `
            <button class="btn btn-danger" onclick="cancelPageTest('{{ page.id }}')" id="cancel-test-btn">
                <i class="bi bi-x-circle"></i> Cancel Test
            </button>
            ${editBtn ? editBtn.outerHTML : ''}
        `;
    } else if (mode === 'run') {
        // Replace with run test button
        actionsDiv.innerHTML = `
            <button class="btn btn-primary" onclick="testPage('{{ page.id }}')" id="run-test-btn">
                <i class="bi bi-play"></i> Run Test
            </button>
            ${editBtn ? editBtn.outerHTML : ''}
        `;
    }
}

function cancelPageTest(pageId) {
    const cancelBtn = document.getElementById('cancel-test-btn');
    if (cancelBtn) {
        cancelBtn.disabled = true;
        cancelBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Cancelling...';
    }
    
    const postData = {};
    if (window.currentTestJobId) {
        postData.job_id = window.currentTestJobId;
    }
    
    $.post(`/pages/${pageId}/cancel-test`, postData, function(data) {
        if (data.success) {
            // Stop polling
            stopStatusPolling();
            
            // Update status badge
            updateStatusBadge(data.new_status || 'discovered');
            
            // Replace Cancel button with Run Test button
            updateActionButtons('run');
            
            // Clear job ID
            window.currentTestJobId = null;
            
            // Remove from global tracking if available
            if (typeof TestTracker !== 'undefined') {
                TestTracker.removeTest(`test_page_${pageId}`);
            }
            
            // Show notification
            if (window.showNotification) {
                showNotification('Test Cancelled', 'The page test has been cancelled.', 'warning');
            }
        } else {
            alert('Failed to cancel test: ' + (data.message || 'Unknown error'));
            
            // Re-enable button
            if (cancelBtn) {
                cancelBtn.disabled = false;
                cancelBtn.innerHTML = '<i class="bi bi-x-circle"></i> Cancel Test';
            }
        }
    }).fail(function() {
        alert('Failed to cancel test');
        if (cancelBtn) {
            cancelBtn.disabled = false;
            cancelBtn.innerHTML = '<i class="bi bi-x-circle"></i> Cancel Test';
        }
    });
}

function testPage(pageId) {
    // Disable test button
    const testBtn = document.getElementById('run-test-btn');
    if (testBtn) {
        testBtn.disabled = true;
        testBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span> Starting Test...';
    }

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('testModal'));
    modal.show();

    testInProgress = true;

    // Get selected user if any
    const userSelect = document.getElementById('test-user-select');
    const websiteUserId = userSelect ? userSelect.value : null;

    // Prepare test data
    const testData = {};
    if (websiteUserId) {
        testData.website_user_id = websiteUserId;
    }

    // Run test
    $.ajax({
        url: `/pages/${pageId}/test`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(testData),
        success: function(data) {
            if (data.success) {
                // Store job ID for potential cancellation
                window.currentTestJobId = data.job_id;

                // Hide modal
                modal.hide();

                // Update status immediately
                updateStatusBadge('queued');

                // Replace Run Test button with Cancel button
                updateActionButtons('cancel');

                // Add to global tracking
                const pageTitle = '{{ page.title or page.url }}';
                if (typeof trackPageTest !== 'undefined') {
                    trackPageTest(pageId, pageTitle);
                }

                // Start polling for status updates
                startStatusPolling(pageId);

                // Show progress notification
                if (window.showNotification) {
                    showNotification('Test started', 'The accessibility test is running. The page will refresh when complete.', 'info');
                }
            } else {
                modal.hide();
                alert('Test failed: ' + (data.error || 'Unknown error'));

                // Re-enable button
                if (testBtn) {
                    testBtn.disabled = false;
                    testBtn.innerHTML = '<i class="bi bi-play"></i> Run Test';
                }
            }
        }
    }).fail(function() {
        modal.hide();
        alert('Failed to start test');
        
        // Re-enable button
        if (testBtn) {
            testBtn.disabled = false;
            testBtn.innerHTML = '<i class="bi bi-play"></i> Run Test';
        }
    });
}

// Check if page is currently testing on load
document.addEventListener('DOMContentLoaded', function() {
    const pageStatus = '{{ page.status.value }}';
    const pageId = '{{ page.id }}';
    
    // Initialize Bootstrap tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // If page is queued or testing, start polling
    if (pageStatus === 'queued' || pageStatus === 'testing') {
        console.log('Page is currently being tested, starting status polling...');
        // Show the progress alert
        document.getElementById('test-progress-alert').classList.remove('d-none');
        startStatusPolling(pageId);
    }
});

// Clean up on page unload
window.addEventListener('beforeunload', function() {
    stopStatusPolling();
});

// Multi-state result switcher
function showState(stateIndex) {
    // Reload page with state parameter
    const url = new URL(window.location.href);
    url.searchParams.set('state', stateIndex);
    window.location.href = url.toString();
}

// Copy xpath to clipboard
function copyXpathToClipboard(xpath, button) {
    navigator.clipboard.writeText(xpath).then(function() {
        // Show temporary success feedback
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="bi bi-check text-success"></i>';
        button.classList.add('text-success');

        // Reset after 2 seconds
        setTimeout(function() {
            button.innerHTML = originalHTML;
            button.classList.remove('text-success');
        }, 2000);
    }).catch(function(err) {
        console.error('Failed to copy xpath: ', err);
        // Show error feedback
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="bi bi-x text-danger"></i>';
        button.classList.add('text-danger');

        setTimeout(function() {
            button.innerHTML = originalHTML;
            button.classList.remove('text-danger');
        }, 2000);
    });
}
</script>

<!-- Include the issue filtering script -->
<script src="{{ url_for('static', filename='js/issue-filters.js') }}"></script>
<!-- Include the help system -->
<script src="{{ url_for('static', filename='js/help-system.js') }}"></script>
{% endblock %}