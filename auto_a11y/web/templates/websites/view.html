{% extends "base.html" %}

{% block title %}{{ website.display_name }} - Auto A11y{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('projects.list_projects') }}">Projects</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('projects.view_project', project_id=project.id) }}">{{ project.name }}</a></li>
            <li class="breadcrumb-item active">{{ website.display_name }}</li>
        </ol>
    </nav>

    <!-- Website Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2">{{ website.display_name }}</h1>
            <p class="text-muted">
                <a href="{{ website.url }}" target="_blank">
                    {{ website.url }} <i class="bi bi-box-arrow-up-right"></i>
                </a>
            </p>
        </div>
        <div>
            <button class="btn btn-success me-2" id="discoverBtn">
                <i class="bi bi-search"></i> Discover Pages
            </button>
            <!-- Prominent cancel button that appears during discovery -->
            <button class="btn btn-danger me-2" id="cancelDiscoveryBtn" style="display: none;">
                <i class="bi bi-stop-circle-fill"></i> ABORT DISCOVERY
            </button>
            {% if website_users %}
            <div class="btn-group me-2" role="group">
                <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" id="userSelectionBtn">
                    <i class="bi bi-person-check"></i> Test Users: <span id="userSelectionCount">Guest</span>
                </button>
                <ul class="dropdown-menu p-2" style="min-width: 280px;">
                    <li class="px-2 mb-2">
                        <strong>Select users to test:</strong>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li class="px-2">
                        <div class="form-check">
                            <input class="form-check-input batch-test-user-checkbox" type="checkbox" value="" id="user-guest" checked>
                            <label class="form-check-label" for="user-guest">
                                <strong>Guest</strong> (no login)
                            </label>
                        </div>
                    </li>
                    {% for user in website_users %}
                    <li class="px-2">
                        <div class="form-check">
                            <input class="form-check-input batch-test-user-checkbox" type="checkbox" value="{{ user.id }}" id="user-{{ user.id }}">
                            <label class="form-check-label" for="user-{{ user.id }}">
                                <strong>{{ user.name_display }}</strong>
                                {% if user.roles %}<br><small class="text-muted">{{ user.roles|join(', ') }}</small>{% endif %}
                            </label>
                        </div>
                    </li>
                    {% endfor %}
                    <li><hr class="dropdown-divider"></li>
                    <li class="px-2">
                        <button class="btn btn-sm btn-link p-0" onclick="selectAllTestUsers()">Select All</button> |
                        <button class="btn btn-sm btn-link p-0" onclick="clearAllTestUsers()">Clear All</button>
                    </li>
                </ul>
            </div>
            {% endif %}
            <button class="btn btn-primary me-2" id="testAllBtn">
                <i class="bi bi-play-fill"></i> Test All Pages
            </button>
            <!-- Cancel testing button that appears during testing -->
            <button class="btn btn-warning me-2" id="cancelTestingBtn" style="display: none;">
                <i class="bi bi-stop-circle"></i> Cancel Testing
            </button>
            <a href="{{ url_for('websites.view_discovery_history', website_id=website.id) }}" class="btn btn-outline-info me-2">
                <i class="bi bi-clock-history"></i> Discovery History
            </a>
            <a href="{{ url_for('websites.view_documents', website_id=website.id) }}" class="btn btn-outline-info me-2">
                <i class="bi bi-file-earmark"></i> Documents
            </a>
            <a href="{{ url_for('scripts.create_website_script', website_id=website.id) }}" class="btn btn-outline-primary me-2">
                <i class="bi bi-code-square"></i> Setup Scripts
            </a>
            <a href="{{ url_for('website_users.list_users', website_id=website.id) }}" class="btn btn-outline-success me-2">
                <i class="bi bi-people"></i> Test Users
            </a>
            <div class="btn-group me-2">
                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="bi bi-file-earmark-text"></i> Reports
                </button>
                <ul class="dropdown-menu">
                    <li><h6 class="dropdown-header">Site Structure</h6></li>
                    <li><a class="dropdown-item" href="#" onclick="generateSiteStructureReport('html')">
                        <i class="bi bi-filetype-html"></i> HTML</a></li>
                    <li><a class="dropdown-item" href="#" onclick="generateSiteStructureReport('json')">
                        <i class="bi bi-filetype-json"></i> JSON</a></li>
                    <li><a class="dropdown-item" href="#" onclick="generateSiteStructureReport('csv')">
                        <i class="bi bi-filetype-csv"></i> CSV</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><h6 class="dropdown-header">Accessibility Report</h6></li>
                    <li><a class="dropdown-item" href="#" onclick="generateAccessibilityReport('html')">
                        <i class="bi bi-filetype-html"></i> HTML</a></li>
                    <li><a class="dropdown-item" href="#" onclick="generateAccessibilityReport('xlsx')">
                        <i class="bi bi-filetype-xlsx"></i> Excel</a></li>
                </ul>
            </div>
            <a href="{{ url_for('websites.edit_website', website_id=website.id) }}" class="btn btn-outline-primary">
                <i class="bi bi-pencil"></i> Edit
            </a>
        </div>
    </div>

    <!-- Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Total Pages</h5>
                    <p class="display-6">{{ stats.total_pages }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Tested</h5>
                    <p class="display-6">{{ stats.tested_pages }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Violations</h5>
                    <p class="display-6 text-danger">{{ stats.total_violations }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Warnings</h5>
                    <p class="display-6 text-warning">{{ stats.total_warnings }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Discovery Summary (if there are failed pages) -->
    {% set failed_pages = pages | selectattr('status.value', 'equalto', 'discovery_failed') | list %}
    {% if failed_pages %}
    <div class="alert alert-warning mb-3">
        <h6 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Discovery Issues</h6>
        <p class="mb-2">{{ failed_pages|length }} page(s) could not be discovered:</p>
        {% if failed_pages|length <= 5 %}
        <ul class="mb-0">
            {% for page in failed_pages %}
            <li><strong>{{ page.url }}</strong>: {{ page.error_reason }}</li>
            {% endfor %}
        </ul>
        {% else %}
        <ul class="mb-0">
            {% for page in failed_pages[:5] %}
            <li><strong>{{ page.url }}</strong>: {{ page.error_reason }}</li>
            {% endfor %}
        </ul>
        <details class="mt-2">
            <summary style="cursor: pointer; color: var(--bs-link-color);">Show {{ failed_pages|length - 5 }} more failed pages...</summary>
            <ul class="mt-2" style="max-height: 300px; overflow-y: auto;">
                {% for page in failed_pages[5:] %}
                <li><strong>{{ page.url }}</strong>: {{ page.error_reason }}</li>
                {% endfor %}
            </ul>
        </details>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Discovery History -->
    {% if website.discovery_history %}
    <div class="card mb-3">
        <div class="card-header" data-bs-toggle="collapse" data-bs-target="#discoveryHistory" style="cursor: pointer;">
            <h6 class="mb-0">
                <i class="bi bi-clock-history"></i> Discovery History 
                <small class="text-muted">({{ website.discovery_history|length }} attempts)</small>
                <i class="bi bi-chevron-down float-end"></i>
            </h6>
        </div>
        <div id="discoveryHistory" class="collapse">
            <div class="card-body">
                <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Pages Found</th>
                                <th>Failed</th>
                                <th>Duration</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for attempt in website.discovery_history|reverse %}
                            <tr>
                                <td>{{ attempt.started_at.strftime('%Y-%m-%d %H:%M') if attempt.started_at else 'Unknown' }}</td>
                                <td>
                                    <span class="badge bg-{{ {'completed': 'success', 'failed': 'danger', 'running': 'warning'}[attempt.status] }}">
                                        {{ attempt.status|title }}
                                    </span>
                                </td>
                                <td>{{ attempt.pages_discovered|default(0) }}</td>
                                <td>{{ attempt.pages_failed|default(0) }}</td>
                                <td>
                                    {% if attempt.completed_at and attempt.started_at %}
                                        {{ ((attempt.completed_at - attempt.started_at).total_seconds())|int }}s
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if attempt.error %}
                                        <span class="text-danger" title="{{ attempt.error }}" data-bs-toggle="tooltip">
                                            <i class="bi bi-exclamation-circle"></i> Error
                                        </span>
                                    {% else %}
                                        <span class="text-muted">Max: {{ attempt.max_pages }} pages, {{ attempt.max_depth }} depth</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Pages Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Pages ({{ pagination.total_items if pagination else stats.total_pages }})</h5>
            <div>
                {% if pagination and pagination.total_pages > 1 %}
                <span class="text-muted me-3">
                    Showing {{ pagination.start_item }}-{{ pagination.end_item }} of {{ pagination.total_items }}
                </span>
                {% endif %}
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addPageModal">
                    <i class="bi bi-plus-circle"></i> Add Page
                </button>
            </div>
        </div>
        <div class="card-body">
            {% if pagination and pagination.total_pages > 1 %}
            <!-- Pagination Controls - Top -->
            <nav aria-label="Page navigation" class="mb-3">
                <ul class="pagination pagination-sm justify-content-center mb-0">
                    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('websites.view_website', website_id=website.id, page=1) }}" aria-label="First">
                            <span aria-hidden="true">&laquo;&laquo;</span>
                        </a>
                    </li>
                    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('websites.view_website', website_id=website.id, page=pagination.page - 1) }}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>

                    {% if pagination.start_page > 1 %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}

                    {% for page_num in range(pagination.start_page, pagination.end_page + 1) %}
                    <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('websites.view_website', website_id=website.id, page=page_num) }}">{{ page_num }}</a>
                    </li>
                    {% endfor %}

                    {% if pagination.end_page < pagination.total_pages %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}

                    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('websites.view_website', website_id=website.id, page=pagination.page + 1) }}" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('websites.view_website', website_id=website.id, page=pagination.total_pages) }}" aria-label="Last">
                            <span aria-hidden="true">&raquo;&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>
            {% endif %}

            {% if pages %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th style="width: 80px;">Screenshot</th>
                            <th>URL</th>
                            <th>Status</th>
                            <th>Violations</th>
                            <th>Warnings</th>
                            <th>Last Tested</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for page in pages %}
                        <tr>
                            <td>
                                {% if page.screenshot_path %}
                                <a href="#" onclick="showScreenshot('{{ url_for('serve_screenshot', filename=page.screenshot_path) }}', '{{ page.url }}'); return false;">
                                    <img src="{{ url_for('serve_screenshot', filename=page.screenshot_path) }}"
                                         alt="Screenshot of {{ page.url }}"
                                         style="width: 60px; height: auto; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <span style="display: none; font-size: 0.8em; color: #999;">No image</span>
                                </a>
                                {% else %}
                                <span style="font-size: 0.8em; color: #999;">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ page.url }}" target="_blank">
                                    {{ page.url }}
                                </a>
                            </td>
                            <td class="page-status" data-page-id="{{ page.id }}">
                                <span class="badge bg-{{ {
                                    'discovered': 'secondary',
                                    'queued': 'info',
                                    'testing': 'warning',
                                    'tested': 'success',
                                    'error': 'danger',
                                    'skipped': 'secondary',
                                    'discovery_failed': 'dark'
                                }[page.status.value] }}"
                                {% if page.error_reason %}title="{{ page.error_reason }}" data-bs-toggle="tooltip"{% endif %}>
                                    {% if page.status.value == 'queued' %}
                                        <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                    {% elif page.status.value == 'testing' %}
                                        <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                    {% elif page.status.value == 'discovery_failed' %}
                                        <i class="bi bi-exclamation-triangle"></i>
                                    {% endif %}
                                    {{ page.status.value|replace('_', ' ')|title }}
                                </span>
                            </td>
                            <td>
                                {% if page.violation_count > 0 %}
                                    <span class="text-danger">{{ page.violation_count }}</span>
                                {% else %}
                                    <span class="text-success">0</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if page.warning_count > 0 %}
                                    <span class="text-warning">{{ page.warning_count }}</span>
                                {% else %}
                                    <span class="text-muted">0</span>
                                {% endif %}
                            </td>
                            <td>
                                {{ page.last_tested.strftime('%Y-%m-%d %H:%M') if page.last_tested else 'Never' }}
                            </td>
                            <td>
                                <a href="{{ url_for('pages.view_page', page_id=page.id) }}"
                                   class="btn btn-sm btn-primary"
                                   title="View Details">
                                    <i class="bi bi-eye"></i>
                                </a>
                                {% if page.status.value in ['queued', 'testing'] %}
                                <button class="btn btn-sm btn-danger page-test-btn" data-page-id="{{ page.id }}" onclick="cancelPageTest('{{ page.id }}')"
                                        title="Cancel Test">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                                {% else %}
                                <button class="btn btn-sm btn-success page-test-btn" data-page-id="{{ page.id }}" onclick="testPage('{{ page.id }}')"
                                        title="Run Test">
                                    <i class="bi bi-play"></i>
                                </button>
                                {% endif %}
                                <button class="btn btn-sm btn-outline-danger" onclick="deletePage('{{ page.id }}', '{{ page.url }}')"
                                        title="Delete Page">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if pagination and pagination.total_pages > 1 %}
            <!-- Pagination Controls - Bottom -->
            <nav aria-label="Page navigation" class="mt-3">
                <ul class="pagination pagination-sm justify-content-center mb-0">
                    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('websites.view_website', website_id=website.id, page=1) }}" aria-label="First">
                            <span aria-hidden="true">&laquo;&laquo;</span>
                        </a>
                    </li>
                    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('websites.view_website', website_id=website.id, page=pagination.page - 1) }}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>

                    {% if pagination.start_page > 1 %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}

                    {% for page_num in range(pagination.start_page, pagination.end_page + 1) %}
                    <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('websites.view_website', website_id=website.id, page=page_num) }}">{{ page_num }}</a>
                    </li>
                    {% endfor %}

                    {% if pagination.end_page < pagination.total_pages %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}

                    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('websites.view_website', website_id=website.id, page=pagination.page + 1) }}" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('websites.view_website', website_id=website.id, page=pagination.total_pages) }}" aria-label="Last">
                            <span aria-hidden="true">&raquo;&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>
            {% endif %}

            {% else %}
            <p class="text-muted">No pages discovered yet. Click "Discover Pages" to find pages automatically.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Discovery Options Modal -->
<div class="modal fade" id="discoveryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Discovery Options</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="discoveryForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="maxPages" class="form-label">Maximum Pages to Discover</label>
                        <input type="number" class="form-control" id="maxPages" min="1" max="9999999"
                               placeholder="Leave empty for unlimited discovery">
                        <small class="text-muted">Limit the number of pages to discover. Default is unlimited (up to 1 million pages).</small>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Discovery will crawl your website starting from the home page, following links to find all accessible pages.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-search"></i> Start Discovery
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Page Modal -->
<div class="modal fade" id="addPageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Page Manually</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addPageForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="pageUrl" class="form-label">Page URL *</label>
                        <input type="url" class="form-control" id="pageUrl" required 
                               placeholder="https://example.com/page">
                    </div>
                    <div class="mb-3">
                        <label for="priority" class="form-label">Priority</label>
                        <select class="form-select" id="priority">
                            <option value="normal">Normal</option>
                            <option value="high">High</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Page</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Screenshot Modal -->
<div class="modal fade" id="screenshotModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="screenshotModalTitle">Screenshot</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="screenshotModalImage" src="" alt="Screenshot" style="max-width: 100%; height: auto;">
            </div>
            <div class="modal-footer">
                <a id="screenshotModalLink" href="" target="_blank" class="btn btn-primary">
                    <i class="bi bi-box-arrow-up-right"></i> Open in New Tab
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function showScreenshot(screenshotUrl, pageUrl) {
    $('#screenshotModalTitle').text('Screenshot: ' + pageUrl);
    $('#screenshotModalImage').attr('src', screenshotUrl);
    $('#screenshotModalLink').attr('href', screenshotUrl);
    $('#screenshotModal').modal('show');
}
</script>
<script>
// Initialize Bootstrap tooltips for error messages
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

let websiteStatusInterval = null;
let testingInProgress = false;
let testingJobId = null;
let discoveryStatusInterval = null;
let discoveryJobId = null;

// Multi-user selection functions
function updateUserSelectionDisplay() {
    const checkboxes = document.querySelectorAll('.batch-test-user-checkbox:checked');
    const count = checkboxes.length;
    const countSpan = document.getElementById('userSelectionCount');

    if (count === 0) {
        countSpan.textContent = 'None';
    } else if (count === 1) {
        const checkbox = checkboxes[0];
        if (checkbox.value === '') {
            countSpan.textContent = 'Guest';
        } else {
            const label = checkbox.nextElementSibling.querySelector('strong').textContent;
            countSpan.textContent = label;
        }
    } else {
        countSpan.textContent = `${count} users`;
    }
}

function selectAllTestUsers() {
    document.querySelectorAll('.batch-test-user-checkbox').forEach(cb => cb.checked = true);
    updateUserSelectionDisplay();
}

function clearAllTestUsers() {
    document.querySelectorAll('.batch-test-user-checkbox').forEach(cb => cb.checked = false);
    updateUserSelectionDisplay();
}

// Update display when checkboxes change
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.batch-test-user-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateUserSelectionDisplay);
    });
});

function updatePageStatus(pageId, status) {
    const statusCell = document.querySelector(`td[data-page-id="${pageId}"]`);
    if (!statusCell) return;
    
    let badgeClass = 'secondary';
    let spinner = '';
    
    switch(status) {
        case 'discovered':
            badgeClass = 'secondary';
            break;
        case 'queued':
            badgeClass = 'info';
            spinner = '<span class="spinner-border spinner-border-sm me-1" role="status"></span>';
            break;
        case 'testing':
            badgeClass = 'warning';
            spinner = '<span class="spinner-border spinner-border-sm me-1" role="status"></span>';
            break;
        case 'tested':
            badgeClass = 'success';
            break;
        case 'error':
            badgeClass = 'danger';
            break;
    }
    
    statusCell.innerHTML = `<span class="badge bg-${badgeClass}">${spinner}${status.charAt(0).toUpperCase() + status.slice(1)}</span>`;
}

function startWebsiteStatusPolling() {
    if (websiteStatusInterval) return;
    
    const websiteId = '{{ website.id }}';
    testingInProgress = true;
    console.log('Starting website status polling for website:', websiteId);
    
    // Do an immediate check
    checkWebsiteStatus();
    
    // Then poll for status updates
    websiteStatusInterval = setInterval(() => {
        checkWebsiteStatus();
    }, 2000); // Poll every 2 seconds
}

function checkWebsiteStatus() {
    const websiteId = '{{ website.id }}';
    
    $.get(`/websites/${websiteId}/test-status`, function(data) {
        console.log('Website status:', data);
        
        // Update progress in UI
        const testBtn = document.getElementById('testAllBtn');
        if (testBtn && testingInProgress) {
            testBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Testing: ${data.tested_pages}/${data.total_pages}`;
        }
        
        // Check each page status
        document.querySelectorAll('.page-status').forEach(cell => {
            const pageId = cell.getAttribute('data-page-id');
            // Check individual page status
            $.get(`/pages/${pageId}/test-status`, function(pageData) {
                const currentBadge = cell.querySelector('.badge');
                let currentStatus = '';
                
                if (currentBadge) {
                    // Extract just the status text, ignoring any spinner
                    const badgeText = currentBadge.textContent.trim().toLowerCase();
                    // Remove any leading/trailing whitespace and get the last word (the status)
                    const words = badgeText.split(/\s+/);
                    currentStatus = words[words.length - 1];
                }
                
                // Update if status changed
                if (pageData.status !== currentStatus) {
                    console.log(`Page ${pageId} status changed from ${currentStatus} to ${pageData.status}`);
                    updatePageStatus(pageId, pageData.status);
                }
            }).fail(function(error) {
                console.error(`Failed to check status for page ${pageId}:`, error);
            });
        });
        
        // Check if all complete
        if (data.all_complete) {
            console.log('All pages complete, stopping polling...');
            stopWebsiteStatusPolling();
            
            // Show notification
            if (window.showNotification) {
                showNotification('Testing Complete', 'All pages have been tested. Refreshing...', 'success');
            }
            
            // Reload page to show updated results
            setTimeout(() => location.reload(), 1500);
        }
    }).fail(function() {
        console.error('Failed to check website test status');
    });
}

function stopWebsiteStatusPolling() {
    if (websiteStatusInterval) {
        clearInterval(websiteStatusInterval);
        websiteStatusInterval = null;
    }
    testingInProgress = false;
    
    // Re-enable test button
    const testBtn = document.getElementById('testAllBtn');
    if (testBtn) {
        testBtn.disabled = false;
        testBtn.innerHTML = '<i class="bi bi-play-fill"></i> Test All Pages';
    }
}

$(document).ready(function() {
    // Check if discovery is running from localStorage
    const activeActivities = TestTracker.getActiveTests();
    let discoveryRunning = false;
    let storedJobId = null;
    
    for (const key in activeActivities) {
        const activity = activeActivities[key];
        if (activity.type === 'discovery' && activity.id === '{{ website.id }}') {
            discoveryRunning = true;
            storedJobId = activity.job_id;  // Get the stored job ID
            console.log('Found active discovery on page load for website {{ website.id }} with job_id:', storedJobId);
            break;
        }
    }
    
    if (discoveryRunning && storedJobId) {
        console.log('Discovery is running, restoring job_id and showing abort button...');
        discoveryJobId = storedJobId;  // Restore the job ID
        
        // Check discovery status with the job ID
        $.get(`{{ url_for('websites.discovery_status', website_id=website.id) }}?job_id=${storedJobId}`, function(data) {
            if (data.status === 'running') {
                // Start polling with the restored job ID
                startDiscoveryPolling();
            } else {
                // Discovery is not running (completed, failed, or stale)
                console.log('Discovery not running anymore, cleaning up. Status:', data.status);
                TestTracker.removeTest('discovery', '{{ website.id }}');
                
                // If we just learned it completed, show a message
                if (data.status === 'completed') {
                    if (window.showNotification) {
                        showNotification('Discovery Complete', 'The discovery process has finished.', 'info');
                    }
                }
            }
        }).fail(function() {
            // If the status check fails, assume discovery is dead and clean up
            console.log('Failed to check discovery status, cleaning up stale entry');
            TestTracker.removeTest('discovery', '{{ website.id }}');
        });
    }
    
    // Check if any pages are currently testing on page load
    let hasTestingPages = false;
    document.querySelectorAll('.page-status .badge').forEach(badge => {
        const text = badge.textContent.trim().toLowerCase();
        if (text.includes('testing') || text.includes('queued')) {
            hasTestingPages = true;
        }
    });
    
    if (hasTestingPages) {
        console.log('Found pages in testing/queued state, starting polling...');
        startWebsiteStatusPolling();
    }
    
    // Wire up the cancel discovery button
    $('#cancelDiscoveryBtn').click(function() {
        if (confirm('Are you sure you want to abort the discovery process?')) {
            cancelDiscovery();
        }
    });
    
    // Show discovery modal when discover button clicked
    $('#discoverBtn').click(function() {
        // Check if discovery is already running
        if (discoveryStatusInterval) {
            if (confirm('Discovery is already running. Do you want to cancel it?')) {
                cancelDiscovery();
            }
            return;
        }
        
        // Show the modal for options
        $('#discoveryModal').modal('show');
    });
    
    // Handle discovery form submission
    $('#discoveryForm').submit(function(e) {
        e.preventDefault();
        
        const maxPages = $('#maxPages').val();
        const btn = $('#discoverBtn');
        
        // Hide modal
        $('#discoveryModal').modal('hide');
        
        // Prepare request data
        const requestData = {};
        if (maxPages && maxPages > 0) {
            requestData.max_pages = parseInt(maxPages);
        }
        
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Starting discovery...');
        
        // Show the cancel button
        $('#cancelDiscoveryBtn').show();
        
        $.post("{{ url_for('websites.discover_pages', website_id=website.id) }}", requestData, function(data) {
            if (data.success) {
                discoveryJobId = data.job_id;
                
                // Add to global tracking if available
                if (typeof TestTracker !== 'undefined') {
                    let description = 'Discovering pages for {{ website.display_name }}';
                    if (data.max_pages) {
                        description += ` (max ${data.max_pages} pages)`;
                    }
                    // Store with website ID but also save job_id in the data
                    const tests = TestTracker.getActiveTests();
                    tests['discovery_{{ website.id }}'] = {
                        type: 'discovery',
                        id: '{{ website.id }}',
                        job_id: data.job_id,  // Store the actual job ID
                        description: description,
                        startTime: Date.now()
                    };
                    localStorage.setItem(TestTracker.STORAGE_KEY, JSON.stringify(tests));
                    TestTracker.startTracking();
                }
                
                if (window.showNotification) {
                    showNotification('Discovery Started', data.message, 'info');
                } else {
                    alert(data.message);
                }
                
                // Start polling for discovery progress
                startDiscoveryPolling();
            } else {
                btn.prop('disabled', false).html('<i class="bi bi-search"></i> Discover Pages');
                $('#cancelDiscoveryBtn').hide();
                alert(data.message || 'Failed to start discovery');
            }
        }).fail(function() {
            btn.prop('disabled', false).html('<i class="bi bi-search"></i> Discover Pages');
            $('#cancelDiscoveryBtn').hide();
            alert('Failed to start page discovery');
        });
    });
    
    $('#testAllBtn').click(function() {
        // Get selected users
        const selectedUserIds = [];
        document.querySelectorAll('.batch-test-user-checkbox:checked').forEach(checkbox => {
            selectedUserIds.push(checkbox.value); // empty string for guest, user ID for authenticated
        });

        if (selectedUserIds.length === 0) {
            alert('Please select at least one test user (or Guest) to continue.');
            return;
        }

        // Create confirmation message
        let confirmMsg = `Test all pages with ${selectedUserIds.length} user${selectedUserIds.length > 1 ? 's' : ''}?\n\n`;
        confirmMsg += `This will run tests for each selected user. This may take some time.`;

        if (!confirm(confirmMsg)) return;

        const btn = $(this);
        const cancelBtn = $('#cancelTestingBtn');

        // Prepare test data with multiple users
        const testData = {
            website_user_ids: selectedUserIds
        };

        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Starting...');

        $.ajax({
            url: "{{ url_for('websites.test_all_pages', website_id=website.id) }}",
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(testData),
            success: function(data) {
            console.log('Test all response:', data);
            
            if (data.success) {
                testingJobId = data.job_id;
                
                // Show cancel button
                cancelBtn.show();
                
                // Add to global tracking if available
                if (typeof TestTracker !== 'undefined') {
                    const tests = TestTracker.getActiveTests();
                    tests['testing_{{ website.id }}'] = {
                        type: 'testing',
                        id: '{{ website.id }}',
                        job_id: data.job_id,
                        description: `Testing ${data.pages_queued} pages for {{ website.display_name }}`,
                        startTime: Date.now()
                    };
                    localStorage.setItem(TestTracker.STORAGE_KEY, JSON.stringify(tests));
                    TestTracker.startTracking();
                }
                
                if (window.showNotification) {
                    showNotification('Testing Started', `Queued ${data.pages_queued} pages for testing`, 'info');
                } else {
                    alert(data.message);
                }
                
                // Update button to show it's testing
                btn.html(`<span class="spinner-border spinner-border-sm"></span> Testing: 0/${data.pages_queued}`);
                
                // Start polling for status immediately
                console.log('Starting testing status polling with job_id:', testingJobId);
                startTestingStatusPolling();
                
            } else {
                alert(data.message || 'Failed to queue tests');
                btn.prop('disabled', false).html('<i class="bi bi-play-fill"></i> Test All Pages');
            }
        }).fail(function(error) {
            console.error('Failed to start testing:', error);
            alert('Failed to start testing');
            btn.prop('disabled', false).html('<i class="bi bi-play-fill"></i> Test All Pages');
        });
    });
    
    // Wire up the cancel testing button
    $('#cancelTestingBtn').click(function() {
        if (confirm('Are you sure you want to cancel the testing process?')) {
            cancelTesting();
        }
    });
    
    $('#addPageForm').submit(function(e) {
        e.preventDefault();
        
        $.post("{{ url_for('websites.add_page', website_id=website.id) }}", {
            url: $('#pageUrl').val(),
            priority: $('#priority').val()
        }, function(data) {
            if (data.success) {
                $('#addPageModal').modal('hide');
                location.reload();
            } else {
                alert(data.error || 'Failed to add page');
            }
        });
    });
});

function testPage(pageId) {
    const btn = event.target.closest('button');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    
    $.post(`/pages/${pageId}/test`, function(data) {
        if (data.success) {
            // Store job ID for potential cancellation
            if (!window.pageTestJobs) {
                window.pageTestJobs = {};
            }
            window.pageTestJobs[pageId] = data.job_id;
            
            // Add to global tracking if available
            if (typeof trackPageTest !== 'undefined') {
                trackPageTest(pageId, 'Page');
            }
            
            // Update status immediately
            updatePageStatus(pageId, 'queued');
            
            // Change button to cancel
            btn.classList.remove('btn-success');
            btn.classList.add('btn-danger');
            btn.onclick = function() { cancelPageTest(pageId); };
            btn.innerHTML = '<i class="bi bi-x-circle"></i>';
            btn.disabled = false;
            
            if (window.showNotification) {
                showNotification('Test Started', 'Page queued for testing', 'info');
            }
            
            // Start polling if not already running
            if (!websiteStatusInterval) {
                startWebsiteStatusPolling();
            }
        } else {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-play"></i>';
            alert('Failed to start test');
        }
    }).fail(function() {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-play"></i>';
        alert('Failed to start test');
    });
}

function cancelPageTest(pageId) {
    const btn = event.target ? event.target.closest('button') : document.querySelector(`button[data-page-id="${pageId}"]`);
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    }
    
    const postData = {};
    if (window.pageTestJobs && window.pageTestJobs[pageId]) {
        postData.job_id = window.pageTestJobs[pageId];
    }
    
    $.post(`/pages/${pageId}/cancel-test`, postData, function(data) {
        if (data.success) {
            // Update status
            updatePageStatus(pageId, data.new_status || 'discovered');
            
            // Change button back to test
            if (btn) {
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-success');
                btn.onclick = function() { testPage(pageId); };
                btn.innerHTML = '<i class="bi bi-play"></i>';
                btn.disabled = false;
            }
            
            // Clear job ID
            if (window.pageTestJobs) {
                delete window.pageTestJobs[pageId];
            }
            
            // Remove from global tracking if available
            if (typeof TestTracker !== 'undefined') {
                TestTracker.removeTest(`test_page_${pageId}`);
            }
            
            if (window.showNotification) {
                showNotification('Test Cancelled', 'Page test has been cancelled', 'warning');
            }
        } else {
            alert('Failed to cancel test: ' + (data.message || 'Unknown error'));
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-x-circle"></i>';
            }
        }
    }).fail(function() {
        alert('Failed to cancel test');
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-x-circle"></i>';
        }
    });
}

function deletePage(pageId, pageUrl) {
    if (!confirm(`Are you sure you want to delete this page?\n\n${pageUrl}\n\nThis will also delete all test results for this page.`)) {
        return;
    }

    const btn = event.target ? event.target.closest('button') : document.querySelector(`button[onclick*="${pageId}"]`);
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    }

    $.post(`/pages/${pageId}/delete`, function(data) {
        if (window.showNotification) {
            showNotification('Page Deleted', 'Page has been deleted successfully', 'success');
        }
        // Reload page to show updated list
        location.reload();
    }).fail(function(xhr) {
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-trash"></i>';
        }
        alert('Failed to delete page: ' + (xhr.responseJSON?.error || 'Unknown error'));
    });
}

function cancelDiscovery() {
    if (!discoveryJobId) {
        alert('No discovery job to cancel');
        return;
    }
    
    const btn = $('#discoverBtn');
    const cancelBtn = $('#cancelDiscoveryBtn');
    
    // Disable cancel button and update discover button
    cancelBtn.prop('disabled', true);
    btn.html('<span class="spinner-border spinner-border-sm"></span> Cancelling...');
    
    $.post(`{{ url_for('websites.cancel_discovery', website_id=website.id) }}`, 
        { job_id: discoveryJobId }, 
        function(data) {
            if (data.success) {
                stopDiscoveryPolling();
                
                // Hide cancel button and reset discover button
                cancelBtn.hide().prop('disabled', false);
                btn.prop('disabled', false).html('<i class="bi bi-search"></i> Discover Pages');
                
                // Remove from global tracking
                if (typeof TestTracker !== 'undefined') {
                    TestTracker.removeTest('discovery', '{{ website.id }}');
                }
                
                if (window.showNotification) {
                    showNotification('Discovery Cancelled', data.message, 'warning');
                } else {
                    alert(data.message);
                }
            } else {
                // Re-enable cancel button on failure
                cancelBtn.prop('disabled', false);
                btn.html('<span class="spinner-border spinner-border-sm"></span> Discovery Running...');
                alert('Failed to cancel discovery: ' + (data.message || 'Unknown error'));
            }
        }
    ).fail(function(xhr, status, error) {
        // Re-enable cancel button on failure
        cancelBtn.prop('disabled', false);
        btn.html('<span class="spinner-border spinner-border-sm"></span> Discovery Running...');
        console.error('Cancel discovery failed:', status, error);
        console.error('Response:', xhr.responseText);
        
        // Try to parse error message
        let errorMsg = 'Failed to cancel discovery';
        try {
            const response = JSON.parse(xhr.responseText);
            if (response.error) {
                errorMsg += ': ' + response.error;
            }
        } catch(e) {
            // If not JSON, show the raw error
            if (xhr.responseText) {
                errorMsg += ': ' + xhr.responseText.substring(0, 200);
            }
        }
        alert(errorMsg);
    });
}

function startDiscoveryPolling() {
    if (discoveryStatusInterval) return;
    
    const btn = $('#discoverBtn');
    const cancelBtn = $('#cancelDiscoveryBtn');
    
    // Show the prominent cancel button
    cancelBtn.show();
    
    // Change discover button to show it's running
    btn.prop('disabled', true)
       .html('<span class="spinner-border spinner-border-sm"></span> Discovery Running...');
    
    discoveryStatusInterval = setInterval(() => {
        const url = discoveryJobId 
            ? `{{ url_for('websites.discovery_status', website_id=website.id) }}?job_id=${discoveryJobId}`
            : `{{ url_for('websites.discovery_status', website_id=website.id) }}`;
            
        $.get(url, function(data) {
            console.log('Discovery status:', data);
            
            if (data.status === 'running') {
                // Update discover button with progress
                const message = data.message || `Found ${data.pages_found} pages...`;
                btn.html(`<span class="spinner-border spinner-border-sm"></span> ${message}`);
                
                // Update page count in statistics if available
                const pageCountElement = document.querySelector('.card-title:contains("Total Pages") + .display-6');
                if (pageCountElement) {
                    pageCountElement.textContent = data.pages_found;
                }
            } else if (data.status === 'completed') {
                stopDiscoveryPolling();
                
                // Update buttons
                btn.prop('disabled', false)
                   .removeClass('btn-danger')
                   .addClass('btn-success')
                   .html('<i class="bi bi-check-circle"></i> Discovery Complete');
                
                // Remove from global tracking if available
                if (typeof TestTracker !== 'undefined') {
                    TestTracker.removeTest('discovery', '{{ website.id }}');
                }
                
                // Show completion notification
                if (window.showNotification) {
                    showNotification('Discovery Complete', `Found ${data.pages_found} pages. Refreshing...`, 'success');
                }
                
                // Refresh page to show new pages
                setTimeout(() => location.reload(), 2000);
            } else if (data.status === 'failed') {
                stopDiscoveryPolling();
                
                // Update buttons
                btn.prop('disabled', false)
                   .removeClass('btn-danger')
                   .addClass('btn-warning')
                   .html('<i class="bi bi-x-circle"></i> Discovery Failed');
                
                // Remove from global tracking
                if (typeof TestTracker !== 'undefined') {
                    TestTracker.removeTest('discovery', '{{ website.id }}');
                }
                
                // Show error
                alert('Discovery failed: ' + (data.error || 'Unknown error'));
                
                // Reset button after delay
                setTimeout(() => {
                    btn.removeClass('btn-warning')
                       .addClass('btn-success')
                       .html('<i class="bi bi-search"></i> Discover Pages');
                }, 3000);
            }
        }).fail(function() {
            console.error('Failed to check discovery status');
        });
    }, 2000); // Poll every 2 seconds
}

function stopDiscoveryPolling() {
    if (discoveryStatusInterval) {
        clearInterval(discoveryStatusInterval);
        discoveryStatusInterval = null;
    }
    discoveryJobId = null;
    
    // Hide the cancel button
    $('#cancelDiscoveryBtn').hide();
    
    // Reset discover button to its original state after a short delay
    setTimeout(() => {
        $('#discoverBtn')
            .prop('disabled', false)
            .removeClass('btn-danger btn-warning')
            .addClass('btn-success')
            .html('<i class="bi bi-search"></i> Discover Pages');
    }, 3000);
}

function startTestingStatusPolling() {
    if (websiteStatusInterval) return;
    
    const btn = $('#testAllBtn');
    const cancelBtn = $('#cancelTestingBtn');
    
    testingInProgress = true;
    
    websiteStatusInterval = setInterval(() => {
        const url = testingJobId 
            ? `{{ url_for('websites.test_status', website_id=website.id) }}?job_id=${testingJobId}`
            : `{{ url_for('websites.test_status', website_id=website.id) }}`;
            
        $.get(url, function(data) {
            console.log('Testing status:', data);
            
            if (data.status === 'running') {
                // Update button with progress
                const tested = data.pages_tested || 0;
                const total = data.total_pages || 0;
                btn.html(`<span class="spinner-border spinner-border-sm"></span> Testing: ${tested}/${total}`);
                
                // Update current page if available
                if (data.current_page) {
                    btn.attr('title', `Currently testing: ${data.current_page}`);
                }
            } else if (data.status === 'completed') {
                stopTestingStatusPolling();
                
                // Update button
                btn.prop('disabled', false)
                   .html('<i class="bi bi-check-circle"></i> Testing Complete');
                
                // Remove from global tracking
                if (typeof TestTracker !== 'undefined') {
                    TestTracker.removeTest('testing', '{{ website.id }}');
                }
                
                // Show completion notification
                if (window.showNotification) {
                    const message = `Tested ${data.pages_tested} pages: ${data.pages_passed} passed, ${data.pages_failed} failed`;
                    showNotification('Testing Complete', message, 'success');
                }
                
                // Refresh page to show results
                setTimeout(() => location.reload(), 2000);
            } else if (data.status === 'cancelled') {
                stopTestingStatusPolling();
                
                // Update button
                btn.prop('disabled', false)
                   .html('<i class="bi bi-x-circle"></i> Testing Cancelled');
                
                // Remove from global tracking
                if (typeof TestTracker !== 'undefined') {
                    TestTracker.removeTest('testing', '{{ website.id }}');
                }
                
                // Show cancellation notification
                if (window.showNotification) {
                    showNotification('Testing Cancelled', data.message || 'Testing was cancelled', 'warning');
                }
                
                // Reset button after delay
                setTimeout(() => {
                    btn.html('<i class="bi bi-play-fill"></i> Test All Pages');
                }, 3000);
            } else if (data.status === 'failed') {
                stopTestingStatusPolling();
                
                // Update button
                btn.prop('disabled', false)
                   .html('<i class="bi bi-x-circle"></i> Testing Failed');
                
                // Remove from global tracking
                if (typeof TestTracker !== 'undefined') {
                    TestTracker.removeTest('testing', '{{ website.id }}');
                }
                
                // Show error
                alert('Testing failed: ' + (data.error || 'Unknown error'));
                
                // Reset button after delay
                setTimeout(() => {
                    btn.html('<i class="bi bi-play-fill"></i> Test All Pages');
                }, 3000);
            }
        }).fail(function() {
            console.error('Failed to check testing status');
        });
    }, 2000); // Poll every 2 seconds
}

function stopTestingStatusPolling() {
    if (websiteStatusInterval) {
        clearInterval(websiteStatusInterval);
        websiteStatusInterval = null;
    }
    testingInProgress = false;
    testingJobId = null;
    
    // Hide the cancel button
    $('#cancelTestingBtn').hide();
    
    // Re-enable test button
    const testBtn = $('#testAllBtn');
    if (testBtn) {
        testBtn.prop('disabled', false).removeAttr('title');
    }
}

function cancelTesting() {
    if (!testingJobId) {
        alert('No testing job to cancel');
        return;
    }
    
    const btn = $('#testAllBtn');
    const cancelBtn = $('#cancelTestingBtn');
    
    // Disable cancel button and update test button
    cancelBtn.prop('disabled', true);
    btn.html('<span class="spinner-border spinner-border-sm"></span> Cancelling...');
    
    $.post(`{{ url_for('websites.cancel_testing', website_id=website.id) }}`, 
        { job_id: testingJobId }, 
        function(data) {
            if (data.success) {
                stopTestingStatusPolling();
                
                // Hide cancel button and reset test button
                cancelBtn.hide().prop('disabled', false);
                btn.prop('disabled', false).html('<i class="bi bi-play-fill"></i> Test All Pages');
                
                // Remove from global tracking
                if (typeof TestTracker !== 'undefined') {
                    TestTracker.removeTest('testing', '{{ website.id }}');
                }
                
                if (window.showNotification) {
                    showNotification('Testing Cancelled', data.message, 'warning');
                } else {
                    alert(data.message);
                }
            } else {
                // Re-enable cancel button on failure
                cancelBtn.prop('disabled', false);
                btn.html('<span class="spinner-border spinner-border-sm"></span> Testing...');
                alert('Failed to cancel testing: ' + (data.message || 'Unknown error'));
            }
        }
    ).fail(function(xhr, status, error) {
        // Re-enable cancel button on failure
        cancelBtn.prop('disabled', false);
        btn.html('<span class="spinner-border spinner-border-sm"></span> Testing...');
        console.error('Cancel testing failed:', status, error);
        alert('Failed to cancel testing');
    });
}

// Report generation functions
function generateSiteStructureReport(format) {
    // Create a form to submit the report request
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `{{ url_for('reports.generate_page_structure_report', website_id=website.id) }}`;
    
    const formatInput = document.createElement('input');
    formatInput.type = 'hidden';
    formatInput.name = 'format';
    formatInput.value = format;
    form.appendChild(formatInput);
    
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
    
    if (window.showNotification) {
        showNotification('Report Generation', `Generating site structure report in ${format.toUpperCase()} format...`, 'info');
    }
}

function generateAccessibilityReport(format) {
    // Create a form to submit the report request
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `{{ url_for('reports.generate_website_report', website_id=website.id) }}`;
    
    const formatInput = document.createElement('input');
    formatInput.type = 'hidden';
    formatInput.name = 'format';
    formatInput.value = format;
    form.appendChild(formatInput);
    
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
    
    if (window.showNotification) {
        showNotification('Report Generation', `Generating accessibility report in ${format.toUpperCase()} format...`, 'info');
    }
}

// Clean up on page unload
window.addEventListener('beforeunload', function() {
    stopWebsiteStatusPolling();
    stopTestingStatusPolling();
    stopDiscoveryPolling();
});
</script>
{% endblock %}