{% extends "base.html" %}

{% block title %}{{ project.name }} - Auto A11y{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Project Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2">
                {{ project.name }}
                <span class="badge bg-{{ {'active': 'success', 'paused': 'warning', 'completed': 'info', 'archived': 'secondary'}[project.status.value] }}">
                    {{ project.status.value|title }}
                </span>
            </h1>
            <p class="text-muted">{{ project.description or 'No description' }}</p>
        </div>
        <div>
            <a href="{{ url_for('projects.edit_project', project_id=project.id) }}" class="btn btn-outline-primary">
                <i class="bi bi-pencil"></i> Edit
            </a>
            <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                <i class="bi bi-trash"></i> Delete
            </button>
        </div>
    </div>

    <!-- Statistics -->
    <div class="row mb-4 g-3">
        <div class="col-6 col-sm-6 col-md-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <h5 class="card-title fs-6">Websites</h5>
                    <p class="display-6">{{ stats.website_count }}</p>
                </div>
            </div>
        </div>
        <div class="col-6 col-sm-6 col-md-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <h5 class="card-title fs-6">Pages</h5>
                    <p class="display-6">{{ stats.total_pages }}</p>
                </div>
            </div>
        </div>
        <div class="col-6 col-sm-6 col-md-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <h5 class="card-title fs-6">Tested</h5>
                    <p class="display-6">{{ stats.tested_pages }}</p>
                    <small class="text-muted">{{ "%.1f"|format(stats.test_coverage) }}% coverage</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-sm-6 col-md-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <h5 class="card-title fs-6">Issues</h5>
                    <p class="display-6 text-danger">{{ stats.total_violations }}</p>
                    <small class="text-warning">{{ stats.total_warnings }} warnings</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Websites -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Websites</h5>
            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addWebsiteModal">
                <i class="bi bi-plus-circle"></i> Add Website
            </button>
        </div>
        <div class="card-body">
            {% if websites %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>URL</th>
                            <th>Pages</th>
                            <th>Last Tested</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for website in websites %}
                        <tr>
                            <td>{{ website.display_name }}</td>
                            <td>
                                <a href="{{ website.url }}" target="_blank">
                                    {{ website.url }} <i class="bi bi-box-arrow-up-right"></i>
                                </a>
                            </td>
                            <td>{{ website.page_count }}</td>
                            <td class="website-status" data-website-id="{{ website.id }}">
                                <span class="status-content">
                                    {{ website.last_tested.strftime('%Y-%m-%d %H:%M') if website.last_tested else 'Never' }}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <a href="{{ url_for('websites.view_website', website_id=website.id) }}" 
                                       class="btn btn-sm btn-primary" title="View website">
                                        <i class="bi bi-eye"></i>
                                        <span class="d-none d-lg-inline"> View</span>
                                    </a>
                                    <button class="btn btn-sm btn-success" onclick="discoverPages('{{ website.id }}')" title="Discover pages">
                                        <i class="bi bi-search"></i>
                                        <span class="d-none d-lg-inline"> Discover</span>
                                    </button>
                                    <button class="btn btn-sm btn-info" onclick="testWebsite('{{ website.id }}')" title="Test website">
                                        <i class="bi bi-play"></i>
                                        <span class="d-none d-lg-inline"> Test</span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">No websites added yet. Add a website to start testing.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Website Modal -->
<div class="modal fade" id="addWebsiteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Website</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('projects.add_website', project_id=project.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="url" class="form-label">Website URL *</label>
                        <input type="url" class="form-control" id="url" name="url" required 
                               placeholder="https://example.com">
                    </div>
                    <div class="mb-3">
                        <label for="name" class="form-label">Name (Optional)</label>
                        <input type="text" class="form-control" id="name" name="name" 
                               placeholder="Main Website">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Website</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Project Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Project</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the project "{{ project.name }}"?</p>
                <p class="text-danger">This will permanently delete all websites, pages, and test results associated with this project.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{{ url_for('projects.delete_project', project_id=project.id) }}" style="display: inline;">
                    <button type="submit" class="btn btn-danger">Delete Project</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let statusPollingIntervals = {};
let websitesBeingTested = new Set();

function updateWebsiteStatus(websiteId, statusHtml) {
    const statusCell = document.querySelector(`td[data-website-id="${websiteId}"] .status-content`);
    if (statusCell) {
        statusCell.innerHTML = statusHtml;
    }
}

function startWebsiteStatusPolling(websiteId) {
    // Don't start multiple pollers for the same website
    if (statusPollingIntervals[websiteId]) {
        return;
    }
    
    // Show testing status immediately
    updateWebsiteStatus(websiteId, '<span class="badge bg-info"><span class="spinner-border spinner-border-sm me-1" role="status"></span>Testing...</span>');
    websitesBeingTested.add(websiteId);
    
    // Poll for website testing status
    statusPollingIntervals[websiteId] = setInterval(() => {
        // Check website pages status
        $.get(`/websites/${websiteId}/test-status`, function(data) {
            if (data.all_complete) {
                // Testing complete - stop polling and refresh
                stopWebsiteStatusPolling(websiteId);
                
                // Update with completion time
                if (data.last_tested) {
                    updateWebsiteStatus(websiteId, data.last_tested);
                } else {
                    updateWebsiteStatus(websiteId, 'Just completed');
                }
                
                // Refresh the page after a short delay to update all statistics
                setTimeout(() => location.reload(), 2000);
            } else {
                // Still testing - show progress
                const progressText = `Testing: ${data.tested_pages}/${data.total_pages} pages`;
                updateWebsiteStatus(websiteId, 
                    `<span class="badge bg-info"><span class="spinner-border spinner-border-sm me-1" role="status"></span>${progressText}</span>`
                );
            }
        }).fail(function() {
            // On error, just show generic testing message
            updateWebsiteStatus(websiteId, 
                '<span class="badge bg-info"><span class="spinner-border spinner-border-sm me-1" role="status"></span>Testing...</span>'
            );
        });
    }, 3000); // Poll every 3 seconds
}

function stopWebsiteStatusPolling(websiteId) {
    if (statusPollingIntervals[websiteId]) {
        clearInterval(statusPollingIntervals[websiteId]);
        delete statusPollingIntervals[websiteId];
        websitesBeingTested.delete(websiteId);
    }
}

function stopAllPolling() {
    for (const websiteId in statusPollingIntervals) {
        stopWebsiteStatusPolling(websiteId);
    }
}

function discoverPages(websiteId) {
    const btn = event.target.closest('button');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span> Discovering...';
    
    $.post(`/websites/${websiteId}/discover`, function(data) {
        if (data.success) {
            // Show success message
            if (window.showNotification) {
                showNotification('Discovery Started', 'Page discovery is running. The page will refresh when complete.', 'info');
            } else {
                alert('Page discovery started. This may take a few minutes.');
            }
            
            // Refresh page after delay to show discovered pages
            setTimeout(() => location.reload(), 5000);
        } else {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-search"></i><span class="d-none d-lg-inline"> Discover</span>';
            alert(data.message || 'Failed to start discovery');
        }
    }).fail(function() {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-search"></i><span class="d-none d-lg-inline"> Discover</span>';
        alert('Failed to start page discovery');
    });
}

function testWebsite(websiteId) {
    const btn = event.target.closest('button');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span> Starting...';
    
    // Get website name for tracking
    const websiteRow = btn.closest('tr');
    const websiteName = websiteRow ? websiteRow.querySelector('td:first-child').textContent.trim() : 'website';
    
    $.post(`/websites/${websiteId}/test-all`, function(data) {
        if (data.success) {
            // Add to global tracking
            if (typeof trackWebsiteTest !== 'undefined') {
                trackWebsiteTest(websiteId, websiteName);
            }
            
            // Show notification
            if (window.showNotification) {
                showNotification('Testing Started', `Testing ${data.pages_queued} pages. The page will refresh when complete.`, 'info');
            } else {
                alert(`Testing queued for ${data.pages_queued} pages.`);
            }
            
            // Start polling for this website
            startWebsiteStatusPolling(websiteId);
            
            // Re-enable button but change text
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i><span class="d-none d-lg-inline"> Testing...</span>';
        } else {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-play"></i><span class="d-none d-lg-inline"> Test</span>';
            alert(data.message);
        }
    }).fail(function() {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-play"></i><span class="d-none d-lg-inline"> Test</span>';
        alert('Failed to start testing');
    });
}

// Clean up on page unload
window.addEventListener('beforeunload', function() {
    stopAllPolling();
});
</script>
{% endblock %}