<!DOCTYPE html>
<html lang="{{ language }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title|default('Issues Not in Common Components') }} - Deduplicated Report</title>
    <style>
/* Bootstrap CSS */
{{ bootstrap_css|safe }}
</style>
    <style>
/* Bootstrap Icons CSS */
{{ bootstrap_icons_css|safe }}
</style>
    <style>
    .touchpoint-header {
        background-color: #f8f9fa;
        padding: 8px;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
        padding-left: 0.5rem;
    }

    .impact-badge {
        min-width: 75px;
        display: inline-block;
        text-align: center;
    }

    .accordion-button {
        padding-left: 2.5rem;
        padding-right: 1.25rem;
    }

    .accordion-button::after {
        position: absolute;
        left: 1rem;
        right: auto;
        transform: rotate(-90deg);
        transition: transform 0.2s ease-in-out;
    }

    .accordion-button:not(.collapsed)::after {
        transform: rotate(0deg);
    }

    .accordion-button > * {
        margin-left: 0.5rem;
    }

    .accordion-button > *:first-child {
        margin-left: 0;
    }

    .breadcrumb {
        background-color: #f8f9fa;
        padding: 0.75rem 1rem;
        border-radius: 0.375rem;
    }

    .card {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }

    .card-body {
        padding: 1rem;
    }

    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 0.75rem 1rem;
    }

    /* Filter Panel Styling */
    .filter-panel {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .filter-group {
        margin-bottom: 1rem;
    }

    .filter-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .filter-chip {
        padding: 0.25rem 0.75rem;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.875rem;
    }

    .filter-chip:hover {
        background: #e9ecef;
    }

    .filter-chip.active {
        background: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }

    .active-filters {
        padding: 1rem;
        background: #e7f3ff;
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .active-filter-tag {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        background: #0d6efd;
        color: white;
        border-radius: 15px;
        margin: 0.25rem;
        font-size: 0.875rem;
    }

    .active-filter-tag .remove-filter {
        margin-left: 0.5rem;
        cursor: pointer;
    }

    .filter-stats {
        padding: 0.75rem;
        background: white;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        margin-bottom: 1rem;
    }

    .issue-item {
        transition: opacity 0.3s;
    }

    .issue-item.filtered-out {
        display: none;
    }

    .test-results-card {
        margin-bottom: 2rem;
    }

    .lang-switcher {
        display: inline-flex;
        background: #f8f9fa;
        border-radius: 6px;
        padding: 4px;
        gap: 4px;
    }

    .lang-switcher button {
        padding: 6px 14px;
        border: none;
        background: transparent;
        cursor: pointer;
        border-radius: 4px;
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.2s;
        color: #6c757d;
    }

    .lang-switcher button:hover {
        background: #e9ecef;
        color: #495057;
    }

    .lang-switcher button.active {
        background: #0d6efd;
        color: white;
    }

    .lang-inactive {
        display: none !important;
    }

    .lang-active {
        display: block;
    }

    span.lang-active {
        display: inline;
    }

    /* WCAG AA Contrast Overrides */
    .bg-warning {
        background-color: #ffc107 !important;
        color: #212529 !important; /* Dark text on yellow background */
    }
    .badge.bg-warning {
        background-color: #ffc107 !important;
        color: #212529 !important;
    }
</style>
</head>
<body>

{# Macro for rendering violation details - defined at top so it's available throughout #}
{% macro render_violation_details(violation, alert_type) %}
<!-- Issue Details -->
{% if violation.metadata and (violation.metadata.what_en or violation.metadata.what_fr) %}
<!-- Enhanced description available -->
<div class="alert alert-{{ alert_type }} mb-3">
    <h6 class="alert-heading">
        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ violation.description_en }}</span>
        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ violation.description_fr }}</span>
    </h6>
</div>

<h6 class="text-{{ alert_type }} mb-2" data-i18n="about_this_issue">{{ t.get('about_this_issue', 'About this issue:') }}</h6>

<div class="mb-3">
    <strong data-i18n="what_the_issue_is">{{ t.get('what_the_issue_is', 'What the issue is:') }}</strong>
    {% if violation.metadata.what_en %}<p data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ violation.metadata.what_en }}</p>{% endif %}
    {% if violation.metadata.what_fr %}<p data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ violation.metadata.what_fr }}</p>{% endif %}
</div>

{% if violation.metadata.why_en or violation.metadata.why_fr %}
<div class="mb-3">
    <strong data-i18n="why_this_is_important">{{ t.get('why_this_is_important', 'Why this is important:') }}</strong>
    {% if violation.metadata.why_en %}<p data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ violation.metadata.why_en }}</p>{% endif %}
    {% if violation.metadata.why_fr %}<p data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ violation.metadata.why_fr }}</p>{% endif %}
</div>
{% endif %}

{% if violation.metadata.who_en or violation.metadata.who_fr %}
<div class="mb-3">
    <strong data-i18n="who_it_affects">{{ t.get('who_it_affects', 'Who it affects:') }}</strong>
    {% if violation.metadata.who_en %}<p data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ violation.metadata.who_en }}</p>{% endif %}
    {% if violation.metadata.who_fr %}<p data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ violation.metadata.who_fr }}</p>{% endif %}
</div>
{% endif %}

{% if violation.metadata.full_remediation_en or violation.metadata.full_remediation_fr %}
<div class="mb-3">
    <strong data-i18n="how_to_remediate">{{ t.get('how_to_remediate', 'How to remediate:') }}</strong>
    {% if violation.metadata.full_remediation_en %}<div class="bg-light p-3 rounded {{ 'lang-active' if language == 'en' else 'lang-inactive' }}" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace;" data-lang="en">{{ violation.metadata.full_remediation_en }}</div>{% endif %}
    {% if violation.metadata.full_remediation_fr %}<div class="bg-light p-3 rounded {{ 'lang-active' if language == 'fr' else 'lang-inactive' }}" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace;" data-lang="fr">{{ violation.metadata.full_remediation_fr }}</div>{% endif %}
</div>
{% endif %}

{% if violation.metadata.wcag_full %}
<h6 class="text-{{ alert_type }} mb-2 mt-4" data-i18n="relevant_test_criteria">{{ t.get('relevant_test_criteria', 'Relevant test criteria:') }}</h6>
<div class="mb-3">
    <strong>WCAG <span data-i18n="success_criteria">{{ t.get('success_criteria', 'Success Criteria:') }}</span></strong>
    <ul>
    {% for criterion in violation.metadata.wcag_full %}
        <li>
            <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ criterion|translate_wcag('en')|safe }}</span>
            <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ criterion|translate_wcag('fr')|safe }}</span>
        </li>
    {% endfor %}
    </ul>
</div>
{% endif %}
{% else %}
<!-- Standard description -->
<p><strong data-i18n="rule">{{ t.get('rule', 'Rule:') }}</strong> {{ violation.id }}</p>
<p><strong data-i18n="help">{{ t.get('help', 'Help:') }}</strong> {{ violation.description }}</p>
{% if violation.failure_summary %}
<p><strong data-i18n="how_to_fix">{{ t.get('how_to_fix', 'How to fix:') }}</strong> {{ violation.failure_summary }}</p>
{% endif %}
{% endif %}

<hr>
<div class="row">
    <div class="col-md-6">
        <p><strong data-i18n="touchpoint">{{ t.get('touchpoint', 'Touchpoint:') }}</strong>
            <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get(violation.touchpoint|lower, violation.touchpoint|replace('_', ' ')|title) }}</span>
            <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get(violation.touchpoint|lower, violation.touchpoint|replace('_', ' ')|title) }}</span>
        </p>
        <p><strong data-i18n="impact">{{ t.get('impact', 'Impact:') }}</strong>
            {% set impact_clean = violation.impact|string|replace('IMPACT_LEVEL.', '')|replace('ImpactLevel.', '') %}
            <span class="badge bg-{{ {'high': 'danger', 'serious': 'danger', 'critical': 'danger', 'medium': 'warning', 'moderate': 'warning', 'low': 'info', 'minor': 'info'}[impact_clean|lower] or 'secondary' }} impact-badge">
                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get(impact_clean|lower, impact_clean|upper) }}</span>
                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get(impact_clean|lower, impact_clean|upper) }}</span>
            </span>
        </p>
    </div>
    <div class="col-md-6">
        {% if violation.metadata and violation.metadata.wcag_full %}
            {% for criterion in violation.metadata.wcag_full|sort %}
            <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-left: 3px solid #0066cc;">
                <p style="margin: 0 0 8px 0; font-weight: bold;">
                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">WCAG {{ criterion|translate_wcag('en')|safe }}</span>
                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">WCAG {{ criterion|translate_wcag('fr')|safe }}</span>
                </p>

                {% set criterion_code = criterion.split()[0] %}
                <p style="margin: 0 0 5px 0;">
                    <a href="{{ criterion_code|wcag_understanding_url }}" target="_blank">
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">
                            {{ translations_en.get('more_about', 'More about') }} {{ criterion_code }}
                        </span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">
                            {{ translations_fr.get('more_about', 'En savoir plus sur') }} {{ criterion_code }} (en anglais)
                        </span>
                        <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                </p>
                <p style="margin: 0;">
                    <a href="{{ criterion_code|wcag_quickref_url }}" target="_blank">
                        <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">
                            {{ translations_en.get('ways_to_meet', 'Ways to meet') }} {{ criterion_code }}
                        </span>
                        <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">
                            {{ translations_fr.get('ways_to_meet', 'Comment satisfaire') }} {{ criterion_code }} (en anglais)
                        </span>
                        <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                </p>
            </div>
            {% endfor %}
        {% endif %}
    </div>
</div>

{% if violation.xpath %}
<p class="mt-3">
    <strong data-i18n="location">{{ t.get('location', 'Location:') }}</strong>
    <code>{{ violation.xpath }}</code>
</p>
{% endif %}

{% if violation.metadata and violation.metadata.breakpoint %}
<p>
    <strong data-i18n="responsive_breakpoint">{{ t.get('responsive_breakpoint', 'Responsive Breakpoint:') }}</strong> <span class="badge bg-info">{{ violation.metadata.breakpoint }}px width</span>
</p>
{% endif %}

{% if violation.metadata and violation.metadata.pseudoclass %}
<p>
    <strong data-i18n="css_state">{{ t.get('css_state', 'CSS State:') }}</strong>
    {% if '@' in violation.metadata.pseudoclass %}
        {% set parts = violation.metadata.pseudoclass.split('@') %}
        <span class="badge bg-warning">{{ parts[0] }}</span>
        <span class="badge bg-secondary">{{ parts[1] }}</span>
    {% else %}
        <span class="badge bg-warning">{{ violation.metadata.pseudoclass }}</span>
    {% endif %}
</p>
{% endif %}

{% if violation.html_snippet %}
<h6 class="mt-3" data-i18n="code_snippet">{{ t.get('code_snippet', 'Code Snippet') }}</h6>
<pre class="bg-dark text-light p-3 rounded"><code>{{ violation.html_snippet|e }}</code></pre>
{% endif %}
{% endmacro %}

<div class="container py-4">
    <!-- Page Navigation -->
    <nav aria-label="breadcrumb" class="mb-3 no-print">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="../index.html" data-i18n="index">{{ t['index'] }}</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">{{ page.title|default('Untitled Page') }}</li>
        </ol>
    </nav>

    <!-- Page Header with Language Switcher -->
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h1 class="h2">{{ page.title|default('Untitled Page') }}</h1>
            <p class="text-muted">
                <a href="{{ page.url }}" target="_blank">
                    {{ page.url }} <i class="bi bi-box-arrow-up-right"></i>
                </a>
            </p>
        </div>
        <div class="lang-switcher">
            <button onclick="switchLanguage('en')" id="lang-en" class="{{ 'active' if language == 'en' else '' }}" aria-label="Switch to English">EN</button>
            <button onclick="switchLanguage('fr')" id="lang-fr" class="{{ 'active' if language == 'fr' else '' }}" aria-label="Switch to French">FR</button>
        </div>
    </div>

    <!-- Page Status Cards -->
    <div class="row mb-4 g-3">
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted" data-i18n="status">{{ t['status'] }}</h6>
                    <p class="mb-0">
                        <span class="badge bg-success" data-i18n="tested">{{ t['tested'] }}</span>
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted" data-i18n="last_tested">{{ t['last_tested'] }}</h6>
                    <p class="mb-0">
                        {{ page.test_date|default('Recently') }}
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted" data-i18n="issues_found">{{ t['issues_found'] }}</h6>
                    <p class="mb-0">
                        <span class="text-danger fw-bold">{{ errors_count|default(0) }}</span> <span data-i18n="errors">{{ t['errors'] }}</span>,
                        <span class="text-warning fw-bold">{{ warnings_count|default(0) }}</span> <span data-i18n="warnings">{{ t['warnings'] }}</span>
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted" data-i18n="score">{{ t['score'] }}</h6>
                    <p class="mb-0">
                        {% set score = page.score|default(0) %}
                        <span class="fw-bold {% if score >= 90 %}text-success{% elif score >= 70 %}text-warning{% else %}text-danger{% endif %}">
                            {{ "%.0f"|format(score) }}%
                        </span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Accessibility & Compliance Scores -->
    {% if page.score is defined %}
    <div class="row mb-4">
        <!-- Accessibility Score Card -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body text-center">
                    {% set score = page.score|default(0) %}
                    <h6 class="card-title" data-i18n="full_page_accessibility_score">{{ t['full_page_accessibility_score'] }}</h6>
                    <div class="display-4 fw-bold {% if score >= 90 %}text-success{% elif score >= 70 %}text-warning{% else %}text-danger{% endif %}">
                        {{ "%.1f"|format(score) }}%
                    </div>
                    <p class="text-muted small mb-0" data-i18n="all_issues_full_page">{{ t.get('all_issues_full_page', 'All issues (full page)') }}</p>
                </div>
            </div>
        </div>

        <!-- Deduplicated Score Card -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body text-center">
                    {% set dscore = dedup_score|default(0) %}
                    <h6 class="card-title" data-i18n="non_component_issues_score">{{ t.get('non_component_issues_score', 'Non-Component Issues Score') }}</h6>
                    <div class="display-4 fw-bold {% if dscore >= 90 %}text-success{% elif dscore >= 70 %}text-warning{% else %}text-danger{% endif %}">
                        {{ "%.1f"|format(dscore) }}%
                    </div>
                    <p class="text-muted small mb-0" data-i18n="issues_not_in_common_components">{{ t.get('issues_not_in_common_components', 'Issues not in common components') }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <!-- Compliance Score Card -->
        <div class="col-md-12">
            <div class="card h-100">
                <div class="card-body text-center">
                    <h6 class="card-title" data-i18n="compliance_score">{{ t['compliance_score'] }}</h6>
                    {% if compliance_score %}
                    <div class="display-4 fw-bold {% if compliance_score.score >= 90 %}text-success{% elif compliance_score.score >= 70 %}text-warning{% else %}text-danger{% endif %}">
                        {{ "%.1f"|format(compliance_score.score) }}%
                    </div>
                    <p class="text-muted small mb-0">{{ compliance_score.passed_tests }} / {{ compliance_score.total_tests }} <span data-i18n="tests_passed">{{ t['tests_passed'] }}</span></p>
                    {% else %}
                    <div class="display-4 fw-bold text-muted">N/A</div>
                    <p class="text-muted small mb-0" data-i18n="no_data_available">{{ t.get('no_data_available', 'No data available') }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Issue Breakdown -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-bug"></i>
                <span data-i18n="issues_found">{{ t['issues_found'] }}</span>
                (<span data-i18n="non_component_issues_only">{{ t.get('non_component_issues_only', 'Non-Component Issues Only') }}</span>)
            </h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-6 col-lg-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-x-circle text-danger me-2 fs-4"></i>
                        <div>
                            <div class="fw-bold">{{ errors_count|default(0) }}</div>
                            <small class="text-muted" data-i18n="errors">{{ t['errors'] }}</small>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle text-warning me-2 fs-4"></i>
                        <div>
                            <div class="fw-bold">{{ warnings_count|default(0) }}</div>
                            <small class="text-muted" data-i18n="warnings">{{ t['warnings'] }}</small>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-info-circle text-info me-2 fs-4"></i>
                        <div>
                            <div class="fw-bold">{{ info_count|default(0) }}</div>
                            <small class="text-muted" data-i18n="info">{{ t['info'] }}</small>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-search" style="color: #6f42c1;" class="me-2 fs-4"></i>
                        <div>
                            <div class="fw-bold">{{ discovery_count|default(0) }}</div>
                            <small class="text-muted" data-i18n="discovery">{{ t['discovery'] }}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Filter Panel -->
    {% if violations or warnings or info or discovery %}
    <div class="filter-panel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> <span data-i18n="filter_test_results">{{ t.get('filter_test_results', 'Filter Test Results') }}</span></h5>
            <button class="btn btn-sm btn-outline-secondary" id="clearFilters">
                <i class="bi bi-x-circle"></i> <span data-i18n="clear_all_filters">{{ t.get('clear_all_filters', 'Clear All Filters') }}</span>
            </button>
        </div>

        <!-- Active Filters Display -->
        <div id="activeFilters" class="active-filters" style="display: none;">
            <strong data-i18n="active_filters">{{ t.get('active_filters', 'Active Filters:') }}</strong>
            <div id="activeFilterTags"></div>
        </div>

        <!-- Filter Statistics -->
        <div class="filter-stats">
            <strong data-i18n="showing">{{ t.get('showing', 'Showing:') }}</strong>
            <span id="visibleCount">0</span> <span data-i18n="of">{{ t.get('of', 'of') }}</span> <span id="totalCount">0</span> <span data-i18n="items">{{ t.get('items', 'items') }}</span>
            | <span id="filterSummary"></span>
        </div>

        <!-- Filter Groups -->
        <div class="row">
            <!-- Issue Type Filter -->
            <div class="col-md-3">
                <div class="filter-group">
                    <label class="form-label fw-bold" data-i18n="issue_type">{{ t.get('issue_type', 'Issue Type') }}</label>
                    <div class="filter-chips">
                        {% if violations %}
                        <div class="filter-chip" data-filter-type="type" data-filter-value="error">
                            <span data-i18n="errors">{{ t['errors'] }}</span> ({{ violations|length }})
                        </div>
                        {% endif %}
                        {% if warnings %}
                        <div class="filter-chip" data-filter-type="type" data-filter-value="warning">
                            <span data-i18n="warnings">{{ t['warnings'] }}</span> ({{ warnings|length }})
                        </div>
                        {% endif %}
                        {% if info %}
                        <div class="filter-chip" data-filter-type="type" data-filter-value="info">
                            <span data-i18n="info">{{ t['info'] }}</span> ({{ info|length }})
                        </div>
                        {% endif %}
                        {% if discovery %}
                        <div class="filter-chip" data-filter-type="type" data-filter-value="discovery">
                            <span data-i18n="discovery">{{ t['discovery'] }}</span> ({{ discovery|length }})
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Impact Level Filter -->
            <div class="col-md-3">
                <div class="filter-group">
                    <label class="form-label fw-bold" data-i18n="impact_level">{{ t.get('impact_level', 'Impact Level') }}</label>
                    <div class="filter-chips">
                        <div class="filter-chip" data-filter-type="impact" data-filter-value="high">
                            <span class="badge bg-danger me-1" data-i18n="high">{{ t['high'] }}</span>
                            <span id="highImpactCount">0</span>
                        </div>
                        <div class="filter-chip" data-filter-type="impact" data-filter-value="medium">
                            <span class="badge bg-warning text-dark me-1" data-i18n="medium">{{ t['medium'] }}</span>
                            <span id="mediumImpactCount">0</span>
                        </div>
                        <div class="filter-chip" data-filter-type="impact" data-filter-value="low">
                            <span class="badge bg-info me-1" data-i18n="low">{{ t['low'] }}</span>
                            <span id="lowImpactCount">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Touchpoint Filter -->
            <div class="col-md-6">
                <div class="filter-group">
                    <label class="form-label fw-bold" data-i18n="issue_touchpoint">{{ t.get('issue_touchpoint', 'Issue Touchpoint') }}</label>
                    <select class="form-select form-select-sm" id="touchpointFilter" multiple size="3">
                        <option value="" data-i18n="all_touchpoints">{{ t.get('all_touchpoints', 'All Touchpoints') }}</option>
                        {% set all_issues = violations + warnings + info + discovery %}
                        {% set touchpoints = all_issues|map(attribute='touchpoint')|unique|sort %}
                        {% for touchpoint in touchpoints %}
                        <option value="{{ touchpoint }}">{{ touchpoint|replace('_', ' ')|title if touchpoint else 'General' }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- Quick Search -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="quickSearch"
                           data-i18n-placeholder="search_placeholder"
                           placeholder="{{ t.get('search_placeholder', 'Search in issue descriptions, error codes, or XPaths...') }}">
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Test Results -->
    <div class="card test-results-card mt-4">
        <div class="card-header">
            <h5 class="mb-0">
                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">Non-Component Issues for This Page</span>
                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Problèmes hors composants pour cette page</span>
            </h5>
            <small class="text-muted">
                <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">Issues not part of common components</span>
                <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">Problèmes ne faisant pas partie des composants communs</span>
            </small>
        </div>
        <div class="card-body">

    <!-- Violations -->
    {% if violations %}
    <h6 class="text-danger mb-3">
        <i class="bi bi-x-circle"></i> <span data-i18n="errors">{{ t['errors'] }}</span> ({{ violations|length }})
    </h6>
    <div class="accordion mb-4" id="violationsAccordion">
        {% set viol_counter = namespace(value=0) %}
        {% for touchpoint, touchpoint_violations in violations|groupby('touchpoint') %}
            <div class="touchpoint-header mt-3 mb-2 ps-2" style="border-left: 4px solid #dc3545;">
                <strong>
                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get(touchpoint|lower, touchpoint|replace('_', ' ')|title if touchpoint else 'General') }}</span>
                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get(touchpoint|lower, touchpoint|replace('_', ' ')|title if touchpoint else 'General') }}</span>
                </strong>
            </div>

            {% for error_code, description_group in touchpoint_violations|groupby('id') %}
                {% set group_list = description_group|list %}
                {% set viol_counter.value = viol_counter.value + 1 %}
                {% set first_violation = group_list[0] %}
                {% set impact_text = first_violation.impact|string|replace('IMPACT_LEVEL.', '')|replace('ImpactLevel.', '') %}

                <div class="accordion-item mb-2 issue-item"
                     data-type="error"
                     data-impact="{{ impact_text|lower }}"
                     data-touchpoint="{{ touchpoint|lower }}"
                     data-id="{{ error_code }}"
                     data-instance-count="{{ group_list|length }}"
                     data-description="{{ first_violation.metadata.what_generic_en|lower if first_violation.metadata and first_violation.metadata.what_generic_en else first_violation.description_en|lower }}"
                     data-xpath="{{ first_violation.xpath|lower if first_violation.xpath else '' }}">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#viol-{{ viol_counter.value }}">
                            {% if group_list|length > 1 %}
                            <span class="badge bg-{{ {'high': 'danger', 'serious': 'danger', 'critical': 'danger', 'medium': 'warning', 'moderate': 'warning', 'low': 'info', 'minor': 'info'}[impact_text|lower] or 'secondary' }} me-2">{{ group_list|length }}</span>
                            {% endif %}
                            <span class="badge bg-{{ {'high': 'danger', 'serious': 'danger', 'critical': 'danger', 'medium': 'warning', 'moderate': 'warning', 'low': 'info', 'minor': 'info'}[impact_text|lower] or 'secondary' }} me-2 impact-badge" data-i18n="{{ impact_text|lower }}">
                                {{ translations_en.get(impact_text|lower, impact_text|upper) if language == 'en' else translations_fr.get(impact_text|lower, impact_text|upper) }}
                            </span>
                            {% if show_error_codes %}<code class="me-2">{{ error_code }}</code>{% endif %}
                            <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ first_violation.metadata.what_generic_en if first_violation.metadata and first_violation.metadata.what_generic_en else first_violation.description_en }}</span>
                            <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ first_violation.metadata.what_generic_fr if first_violation.metadata and first_violation.metadata.what_generic_fr else first_violation.description_fr }}</span>
                        </button>
                    </h2>
                    <div id="viol-{{ viol_counter.value }}" class="accordion-collapse collapse" data-bs-parent="#violationsAccordion">
                        <div class="accordion-body">
                            {% if group_list|length > 1 %}
                            <!-- Multiple instances - show nested accordion -->
                            <div class="accordion" id="viol_instances_{{ viol_counter.value }}">
                                {% for instance in group_list %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#viol_inst_{{ viol_counter.value }}_{{ loop.index }}">
                                            <strong data-i18n="instance">{{ t.get('instance', 'Instance') }}</strong> {{ loop.index }}:
                                            {% if instance.metadata and instance.metadata.authenticated_user %}
                                                <span class="badge bg-secondary ms-2">
                                                    <i class="bi bi-person-fill"></i> {{ instance.metadata.authenticated_user.display_name }}
                                                    {% if instance.metadata.authenticated_user.roles %}
                                                        ({{ instance.metadata.authenticated_user.roles|join(', ') }})
                                                    {% endif %}
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary ms-2">
                                                    <i class="bi bi-person"></i> <span data-i18n="guest">{{ t.get('guest', 'Guest') }}</span>
                                                </span>
                                            {% endif %}
                                            {% if instance.xpath %}
                                            <code class="ms-2">{{ instance.xpath }}</code>
                                            {% endif %}
                                        </button>
                                    </h2>
                                    <div id="viol_inst_{{ viol_counter.value }}_{{ loop.index }}"
                                         class="accordion-collapse collapse"
                                         data-bs-parent="#viol_instances_{{ viol_counter.value }}">
                                        <div class="accordion-body">
                                            {{ render_violation_details(instance, 'danger') }}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <!-- Single instance - show details directly -->
                            {{ render_violation_details(first_violation, 'danger') }}
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
    </div>
    {% endif %}

    <!-- Warnings -->
    {% if warnings %}
    <h6 class="text-warning mb-3">
        <i class="bi bi-exclamation-triangle"></i> <span data-i18n="warnings">{{ t['warnings'] }}</span> ({{ warnings|length }})
    </h6>
    <div class="accordion mb-4" id="warningsAccordion">
        {% set warn_counter = namespace(value=0) %}
        {% for touchpoint, touchpoint_warnings in warnings|groupby('touchpoint') %}
            <div class="touchpoint-header mt-3 mb-2 ps-2" style="border-left: 4px solid #ffc107;">
                <strong>
                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get(touchpoint|lower, touchpoint|replace('_', ' ')|title if touchpoint else 'General') }}</span>
                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get(touchpoint|lower, touchpoint|replace('_', ' ')|title if touchpoint else 'General') }}</span>
                </strong>
            </div>

            {% for warning_code, description_group in touchpoint_warnings|groupby('id') %}
                {% set group_list = description_group|list %}
                {% set warn_counter.value = warn_counter.value + 1 %}
                {% set first_warning = group_list[0] %}
                {% set impact_text = first_warning.impact|string|replace('IMPACT_LEVEL.', '')|replace('ImpactLevel.', '') %}

                <div class="accordion-item mb-2 issue-item"
                     data-type="warning"
                     data-impact="{{ impact_text|lower }}"
                     data-touchpoint="{{ touchpoint|lower }}"
                     data-id="{{ warning_code }}"
                     data-instance-count="{{ group_list|length }}"
                     data-description="{{ first_warning.metadata.what_generic_en|lower if first_warning.metadata and first_warning.metadata.what_generic_en else first_warning.description_en|lower }}"
                     data-xpath="{{ first_warning.xpath|lower if first_warning.xpath else '' }}">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#warn-{{ warn_counter.value }}">
                            {% if group_list|length > 1 %}
                            <span class="badge bg-{{ {'high': 'danger', 'serious': 'danger', 'critical': 'danger', 'medium': 'warning', 'moderate': 'warning', 'low': 'info', 'minor': 'info'}[impact_text|lower] or 'warning' }} me-2">{{ group_list|length }}</span>
                            {% endif %}
                            <span class="badge bg-{{ {'high': 'danger', 'serious': 'danger', 'critical': 'danger', 'medium': 'warning', 'moderate': 'warning', 'low': 'info', 'minor': 'info'}[impact_text|lower] or 'warning' }} me-2 impact-badge" data-i18n="{{ impact_text|lower }}">
                                {{ translations_en.get(impact_text|lower, impact_text|upper) if language == 'en' else translations_fr.get(impact_text|lower, impact_text|upper) }}
                            </span>
                            <code class="me-2">{{ warning_code }}</code>
                            <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ first_warning.metadata.what_generic_en if first_warning.metadata and first_warning.metadata.what_generic_en else first_warning.description_en }}</span>
                            <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ first_warning.metadata.what_generic_fr if first_warning.metadata and first_warning.metadata.what_generic_fr else first_warning.description_fr }}</span>
                        </button>
                    </h2>
                    <div id="warn-{{ warn_counter.value }}" class="accordion-collapse collapse" data-bs-parent="#warningsAccordion">
                        <div class="accordion-body">
                            {% if group_list|length > 1 %}
                            <!-- Multiple instances -->
                            <div class="accordion" id="warn_instances_{{ warn_counter.value }}">
                                {% for instance in group_list %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#warn_inst_{{ warn_counter.value }}_{{ loop.index }}">
                                            <strong data-i18n="instance">{{ t.get('instance', 'Instance') }}</strong> {{ loop.index }}:
                                            {% if instance.metadata and instance.metadata.authenticated_user %}
                                                <span class="badge bg-secondary ms-2">
                                                    <i class="bi bi-person-fill"></i> {{ instance.metadata.authenticated_user.display_name }}
                                                    {% if instance.metadata.authenticated_user.roles %}
                                                        ({{ instance.metadata.authenticated_user.roles|join(', ') }})
                                                    {% endif %}
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary ms-2">
                                                    <i class="bi bi-person"></i> <span data-i18n="guest">{{ t.get('guest', 'Guest') }}</span>
                                                </span>
                                            {% endif %}
                                            {% if instance.xpath %}
                                            <code class="ms-2">{{ instance.xpath }}</code>
                                            {% endif %}
                                        </button>
                                    </h2>
                                    <div id="warn_inst_{{ warn_counter.value }}_{{ loop.index }}"
                                         class="accordion-collapse collapse"
                                         data-bs-parent="#warn_instances_{{ warn_counter.value }}">
                                        <div class="accordion-body">
                                            {{ render_violation_details(instance, 'warning') }}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <!-- Single instance -->
                            {{ render_violation_details(first_warning, 'warning') }}
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
    </div>
    {% endif %}

    <!-- Info -->
    {% if info %}
    <h6 class="text-info mb-3">
        <i class="bi bi-info-circle"></i> <span data-i18n="info">{{ t['info'] }}</span> ({{ info|length }})
    </h6>
    <div class="accordion mb-4" id="infoAccordion">
        {% set info_counter = namespace(value=0) %}
        {% for touchpoint, touchpoint_info in info|groupby('touchpoint') %}
            <div class="touchpoint-header mt-3 mb-2 ps-2" style="border-left: 4px solid #0e7490;">
                <strong>
                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get(touchpoint|lower, touchpoint|replace('_', ' ')|title if touchpoint else 'General') }}</span>
                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get(touchpoint|lower, touchpoint|replace('_', ' ')|title if touchpoint else 'General') }}</span>
                </strong>
            </div>

            {% for info_code, description_group in touchpoint_info|groupby('id') %}
                {% set group_list = description_group|list %}
                {% set info_counter.value = info_counter.value + 1 %}
                {% set first_info = group_list[0] %}
                {% set impact_text = first_info.impact|string|replace('IMPACT_LEVEL.', '')|replace('ImpactLevel.', '') if first_info.impact else '' %}

                <div class="accordion-item mb-2 issue-item"
                     data-type="info"
                     data-impact="{{ impact_text|lower }}"
                     data-touchpoint="{{ touchpoint|lower }}"
                     data-id="{{ info_code }}"
                     data-instance-count="{{ group_list|length }}"
                     data-description="{{ first_info.metadata.what_generic_en|lower if first_info.metadata and first_info.metadata.what_generic_en else first_info.description_en|lower }}"
                     data-xpath="{{ first_info.xpath|lower if first_info.xpath else '' }}">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#info-{{ info_counter.value }}">
                            {% if group_list|length > 1 %}
                            <span class="badge bg-{{ {'high': 'danger', 'serious': 'danger', 'critical': 'danger', 'medium': 'warning', 'moderate': 'warning', 'low': 'info', 'minor': 'info'}[impact_text|lower] or 'secondary' }} me-2">{{ group_list|length }}</span>
                            {% endif %}
                            {% if impact_text %}
                            <span class="badge bg-{{ {'high': 'danger', 'serious': 'danger', 'critical': 'danger', 'medium': 'warning', 'moderate': 'warning', 'low': 'info', 'minor': 'info'}[impact_text|lower] or 'info' }} me-2 impact-badge" data-i18n="{{ impact_text|lower }}">
                                {{ translations_en.get(impact_text|lower, impact_text|upper) if language == 'en' else translations_fr.get(impact_text|lower, impact_text|upper) }}
                            </span>
                            {% endif %}
                            <code class="me-2">{{ info_code }}</code>
                            <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ first_info.metadata.what_generic_en if first_info.metadata and first_info.metadata.what_generic_en else first_info.description_en }}</span>
                            <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ first_info.metadata.what_generic_fr if first_info.metadata and first_info.metadata.what_generic_fr else first_info.description_fr }}</span>
                        </button>
                    </h2>
                    <div id="info-{{ info_counter.value }}" class="accordion-collapse collapse" data-bs-parent="#infoAccordion">
                        <div class="accordion-body">
                            {% if group_list|length > 1 %}
                            <!-- Multiple instances -->
                            <div class="accordion" id="info_instances_{{ info_counter.value }}">
                                {% for instance in group_list %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#info_inst_{{ info_counter.value }}_{{ loop.index }}">
                                            <strong data-i18n="instance">{{ t.get('instance', 'Instance') }}</strong> {{ loop.index }}:
                                            {% if instance.metadata and instance.metadata.authenticated_user %}
                                                <span class="badge bg-secondary ms-2">
                                                    <i class="bi bi-person-fill"></i> {{ instance.metadata.authenticated_user.display_name }}
                                                    {% if instance.metadata.authenticated_user.roles %}
                                                        ({{ instance.metadata.authenticated_user.roles|join(', ') }})
                                                    {% endif %}
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary ms-2">
                                                    <i class="bi bi-person"></i> <span data-i18n="guest">{{ t.get('guest', 'Guest') }}</span>
                                                </span>
                                            {% endif %}
                                            {% if instance.xpath %}
                                            <code class="ms-2">{{ instance.xpath }}</code>
                                            {% endif %}
                                        </button>
                                    </h2>
                                    <div id="info_inst_{{ info_counter.value }}_{{ loop.index }}"
                                         class="accordion-collapse collapse"
                                         data-bs-parent="#info_instances_{{ info_counter.value }}">
                                        <div class="accordion-body">
                                            {{ render_violation_details(instance, 'info') }}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <!-- Single instance -->
                            {{ render_violation_details(first_info, 'info') }}
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
    </div>
    {% endif %}

    <!-- Discovery -->
    {% if discovery %}
    <h6 class="mb-3" style="color: #6f42c1;">
        <i class="bi bi-search"></i> <span data-i18n="discovery">{{ t['discovery'] }}</span> ({{ discovery|length }})
    </h6>
    <div class="accordion mb-4" id="discoveryAccordion">
        {% set disco_counter = namespace(value=0) %}
        {% for touchpoint, touchpoint_discovery in discovery|groupby('touchpoint') %}
            <div class="touchpoint-header mt-3 mb-2 ps-2" style="border-left: 4px solid #6f42c1;">
                <strong>
                    <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ translations_en.get(touchpoint|lower, touchpoint|replace('_', ' ')|title if touchpoint else 'General') }}</span>
                    <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ translations_fr.get(touchpoint|lower, touchpoint|replace('_', ' ')|title if touchpoint else 'General') }}</span>
                </strong>
            </div>

            {% for disco_code, description_group in touchpoint_discovery|groupby('id') %}
                {% set group_list = description_group|list %}
                {% set disco_counter.value = disco_counter.value + 1 %}
                {% set first_disco = group_list[0] %}

                <div class="accordion-item mb-2 issue-item"
                     data-type="discovery"
                     data-impact=""
                     data-touchpoint="{{ touchpoint|lower }}"
                     data-id="{{ disco_code }}"
                     data-instance-count="{{ group_list|length }}"
                     data-description="{{ first_disco.metadata.what_generic_en|lower if first_disco.metadata and first_disco.metadata.what_generic_en else first_disco.description_en|lower }}"
                     data-xpath="{{ first_disco.xpath|lower if first_disco.xpath else '' }}">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#disco-{{ disco_counter.value }}">
                            {% if group_list|length > 1 %}
                            <span class="badge me-2" style="background-color: #6f42c1;">{{ group_list|length }}</span>
                            {% endif %}
                            <span class="badge me-2 impact-badge" style="background-color: #6f42c1;" data-i18n="discovery">
                                {{ t['discovery']|upper }}
                            </span>
                            <code class="me-2">{{ disco_code }}</code>
                            <span data-lang="en" class="{{ 'lang-active' if language == 'en' else 'lang-inactive' }}">{{ first_disco.metadata.what_generic_en if first_disco.metadata and first_disco.metadata.what_generic_en else first_disco.description_en }}</span>
                            <span data-lang="fr" class="{{ 'lang-active' if language == 'fr' else 'lang-inactive' }}">{{ first_disco.metadata.what_generic_fr if first_disco.metadata and first_disco.metadata.what_generic_fr else first_disco.description_fr }}</span>
                        </button>
                    </h2>
                    <div id="disco-{{ disco_counter.value }}" class="accordion-collapse collapse" data-bs-parent="#discoveryAccordion">
                        <div class="accordion-body">
                            {% if group_list|length > 1 %}
                            <!-- Multiple instances -->
                            <div class="accordion" id="disco_instances_{{ disco_counter.value }}">
                                {% for instance in group_list %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#disco_inst_{{ disco_counter.value }}_{{ loop.index }}">
                                            <strong data-i18n="instance">{{ t.get('instance', 'Instance') }}</strong> {{ loop.index }}:
                                            {% if instance.metadata and instance.metadata.authenticated_user %}
                                                <span class="badge bg-secondary ms-2">
                                                    <i class="bi bi-person-fill"></i> {{ instance.metadata.authenticated_user.display_name }}
                                                    {% if instance.metadata.authenticated_user.roles %}
                                                        ({{ instance.metadata.authenticated_user.roles|join(', ') }})
                                                    {% endif %}
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary ms-2">
                                                    <i class="bi bi-person"></i> <span data-i18n="guest">{{ t.get('guest', 'Guest') }}</span>
                                                </span>
                                            {% endif %}
                                            {% if instance.xpath %}
                                            <code class="ms-2">{{ instance.xpath }}</code>
                                            {% endif %}
                                        </button>
                                    </h2>
                                    <div id="disco_inst_{{ disco_counter.value }}_{{ loop.index }}"
                                         class="accordion-collapse collapse"
                                         data-bs-parent="#disco_instances_{{ disco_counter.value }}">
                                        <div class="accordion-body">
                                            {{ render_violation_details(instance, 'primary') }}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <!-- Single instance -->
                            {{ render_violation_details(first_disco, 'primary') }}
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
    </div>
    {% endif %}

        </div><!-- End card-body -->
    </div><!-- End card -->
</div><!-- End container -->

<script>
/* Bootstrap JS */
{{ bootstrap_js|safe }}
</script>

<script>
// Embedded translations
const translations = {{ translations_json|safe }};
// Check localStorage for saved language preference, fallback to server language
let currentLanguage = localStorage.getItem('reportLanguage') || '{{ language }}';

// Language switching
function switchLanguage(lang) {
    currentLanguage = lang;

    // Save preference to localStorage
    localStorage.setItem('reportLanguage', lang);

    // Update active button
    document.querySelectorAll('.lang-switcher button').forEach(btn => {
        btn.classList.remove('active');
    });
    document.getElementById(`lang-${lang}`).classList.add('active');

    // Update HTML lang attribute
    document.documentElement.lang = lang;

    // Toggle visibility of language-specific content using classes
    document.querySelectorAll('[data-lang]').forEach(element => {
        const elementLang = element.getAttribute('data-lang');
        if (elementLang === lang) {
            element.classList.remove('lang-inactive');
            element.classList.add('lang-active');
        } else {
            element.classList.remove('lang-active');
            element.classList.add('lang-inactive');
        }
    });

    // Update translatable text elements
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (translations[lang] && translations[lang][key]) {
            // Only update text content for non-input elements
            if (element.tagName !== 'INPUT' && element.tagName !== 'TEXTAREA') {
                element.textContent = translations[lang][key];
            }
        }
    });

    // Update placeholder text for input elements
    document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
        const key = element.getAttribute('data-i18n-placeholder');
        if (translations[lang] && translations[lang][key]) {
            element.placeholder = translations[lang][key];
        }
    });
}

// Apply saved language on page load
if (currentLanguage !== '{{ language }}') {
    switchLanguage(currentLanguage);
}

// Filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const filterChips = document.querySelectorAll('.filter-chip');
    const clearBtn = document.getElementById('clearFilters');
    const quickSearch = document.getElementById('quickSearch');
    const activeFiltersDiv = document.getElementById('activeFilters');
    const activeFilterTags = document.getElementById('activeFilterTags');
    const filterSummary = document.getElementById('filterSummary');
    const visibleCount = document.getElementById('visibleCount');
    const totalCount = document.getElementById('totalCount');

    let activeFilters = {
        type: [],
        impact: [],
        touchpoint: []
    };

    function updateFilters() {
        const allItems = document.querySelectorAll('.issue-item');
        const searchTerm = quickSearch.value.toLowerCase();
        let visible = 0;

        // Count impact levels (accounting for instance counts)
        let highCount = 0;
        let mediumCount = 0;
        let lowCount = 0;

        allItems.forEach(item => {
            // Count by impact level, multiplying by instance count
            const itemImpact = item.dataset.impact;
            const instanceCount = parseInt(item.dataset.instanceCount || '1', 10);

            if (itemImpact === 'high' || itemImpact === 'serious' || itemImpact === 'critical') {
                highCount += instanceCount;
            } else if (itemImpact === 'medium' || itemImpact === 'moderate') {
                mediumCount += instanceCount;
            } else if (itemImpact === 'low' || itemImpact === 'minor') {
                lowCount += instanceCount;
            }


            let show = true;

            // Type filter
            if (activeFilters.type.length > 0) {
                const itemType = item.dataset.type;
                if (!activeFilters.type.includes(itemType)) show = false;
            }

            // Impact filter
            if (activeFilters.impact.length > 0) {
                const itemImpact = item.dataset.impact;
                if (!activeFilters.impact.includes(itemImpact)) show = false;
            }

            // Touchpoint filter
            if (activeFilters.touchpoint.length > 0) {
                const itemTouchpoint = item.dataset.touchpoint;
                if (!activeFilters.touchpoint.includes(itemTouchpoint)) show = false;
            }

            // Search filter
            if (searchTerm) {
                const description = item.dataset.description || '';
                const id = item.dataset.id || '';
                const xpath = item.dataset.xpath || '';
                if (!description.includes(searchTerm) && !id.includes(searchTerm) && !xpath.includes(searchTerm)) {
                    show = false;
                }
            }

            if (show) {
                item.classList.remove('filtered-out');
                visible++;
            } else {
                item.classList.add('filtered-out');
            }
        });

        // Update counts
        visibleCount.textContent = visible;
        totalCount.textContent = allItems.length;

        // Update impact level counts
        document.getElementById('highImpactCount').textContent = highCount;
        document.getElementById('mediumImpactCount').textContent = mediumCount;
        document.getElementById('lowImpactCount').textContent = lowCount;

        // Update active filters display
        const hasActiveFilters = activeFilters.type.length > 0 || activeFilters.impact.length > 0 || activeFilters.touchpoint.length > 0 || searchTerm;
        activeFiltersDiv.style.display = hasActiveFilters ? 'block' : 'none';

        // Update filter chips active state
        filterChips.forEach(chip => {
            const filterType = chip.dataset.filterType;
            const filterValue = chip.dataset.filterValue;
            if (activeFilters[filterType] && activeFilters[filterType].includes(filterValue)) {
                chip.classList.add('active');
            } else {
                chip.classList.remove('active');
            }
        });

        // Build filter summary
        let summaryParts = [];
        if (activeFilters.type.length > 0) summaryParts.push(`Type: ${activeFilters.type.join(', ')}`);
        if (activeFilters.impact.length > 0) summaryParts.push(`Impact: ${activeFilters.impact.join(', ')}`);
        if (activeFilters.touchpoint.length > 0) summaryParts.push(`Touchpoint: ${activeFilters.touchpoint.join(', ')}`);
        if (searchTerm) summaryParts.push(`Search: "${searchTerm}"`);

        filterSummary.textContent = summaryParts.length > 0 ? summaryParts.join(' | ') : 'No filters active';
    }

    // Filter chip click
    filterChips.forEach(chip => {
        chip.addEventListener('click', function() {
            const filterType = this.dataset.filterType;
            const filterValue = this.dataset.filterValue;

            const index = activeFilters[filterType].indexOf(filterValue);
            if (index > -1) {
                activeFilters[filterType].splice(index, 1);
            } else {
                activeFilters[filterType].push(filterValue);
            }

            updateFilters();
        });
    });

    // Clear filters
    clearBtn.addEventListener('click', function() {
        activeFilters = { type: [], impact: [], touchpoint: [] };
        quickSearch.value = '';
        updateFilters();
    });

    // Quick search
    quickSearch.addEventListener('input', updateFilters);

    // Touchpoint filter
    document.getElementById('touchpointFilter').addEventListener('change', function() {
        activeFilters.touchpoint = Array.from(this.selectedOptions).map(opt => opt.value).filter(v => v);
        updateFilters();
    });

    // Initial update
    updateFilters();
});
</script>
</body>
</html>
