{% extends "base.html" %}

{% block title %}{{ page.title or page.url }} - Auto A11y{% endblock %}

{% block extra_css %}
<style>
    .impact-badge {
        min-width: 75px;
        display: inline-block;
        text-align: center;
    }
    
    /* Move accordion indicators to the left for accessibility */
    .accordion-button {
        padding-left: 2.5rem;
        padding-right: 1.25rem;
    }
    
    .accordion-button::after {
        position: absolute;
        left: 1rem;
        right: auto;
    }
    
    /* Ensure proper spacing for content */
    .accordion-button > * {
        margin-left: 0.5rem;
    }
    
    .accordion-button > *:first-child {
        margin-left: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{{ url_for('projects.view_project', project_id=project.id) }}">{{ project.name }}</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{{ url_for('websites.view_website', website_id=website.id) }}">{{ website.display_name }}</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">{{ page.title or 'Page' }}</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2">{{ page.title or 'Untitled Page' }}</h1>
            <p class="text-muted">
                <a href="{{ page.url }}" target="_blank">
                    {{ page.url }} <i class="bi bi-box-arrow-up-right"></i>
                </a>
            </p>
        </div>
        <div>
            <button class="btn btn-primary" onclick="testPage('{{ page.id }}')">
                <i class="bi bi-play"></i> Run Test
            </button>
            <a href="{{ url_for('pages.edit_page', page_id=page.id) }}" class="btn btn-outline-primary">
                <i class="bi bi-pencil"></i> Edit
            </a>
        </div>
    </div>

    <!-- Page Status -->
    <div class="row mb-4 g-3">
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Status</h6>
                    <p class="mb-0">
                        {% if page.status.value == 'discovered' %}
                            <span class="badge bg-secondary">Discovered</span>
                        {% elif page.status.value == 'testing' %}
                            <span class="badge bg-info">Testing</span>
                        {% elif page.status.value == 'tested' %}
                            <span class="badge bg-success">Tested</span>
                        {% elif page.status.value == 'error' %}
                            <span class="badge bg-danger">Error</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ page.status.value|title }}</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Priority</h6>
                    <p class="mb-0">
                        {% if page.priority == 'critical' %}
                            <span class="badge bg-danger">Critical</span>
                        {% elif page.priority == 'high' %}
                            <span class="badge bg-warning">High</span>
                        {% elif page.priority == 'normal' %}
                            <span class="badge bg-info">Normal</span>
                        {% elif page.priority == 'low' %}
                            <span class="badge bg-secondary">Low</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ page.priority|title }}</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Last Tested</h6>
                    <p class="mb-0">
                        {{ page.last_tested.strftime('%Y-%m-%d %H:%M') if page.last_tested else 'Never' }}
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Test Duration</h6>
                    <p class="mb-0">
                        {% if page.test_duration_ms %}
                            {{ "%.2f"|format(page.test_duration_ms / 1000) }}s
                        {% else %}
                            N/A
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Results Summary -->
    {% if page.status.value == 'tested' %}
    <div class="row mb-4 g-3">
        <div class="col-6 col-lg">
            <div class="card border-danger">
                <div class="card-body text-center">
                    <h5 class="card-title text-danger">Errors</h5>
                    <p class="display-6 mb-0">{{ page.violation_count }}</p>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <h5 class="card-title text-warning">Warnings</h5>
                    <p class="display-6 mb-0">{{ page.warning_count }}</p>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg">
            <div class="card border-info">
                <div class="card-body text-center">
                    <h5 class="card-title text-info">Info</h5>
                    <p class="display-6 mb-0">{{ page.info_count|default(0) }}</p>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg">
            <div class="card" style="border-color: #6f42c1;">
                <div class="card-body text-center">
                    <h5 class="card-title" style="color: #6f42c1;">Discovery</h5>
                    <p class="display-6 mb-0">{{ page.discovery_count|default(0) }}</p>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg">
            <div class="card border-success">
                <div class="card-body text-center">
                    <h5 class="card-title text-success">Passed</h5>
                    <p class="display-6 mb-0">{{ page.pass_count }}</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Test Results Detail -->
    {% if latest_result %}
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Latest Test Results</h5>
            <small class="text-muted">Tested on {{ latest_result.test_date.strftime('%Y-%m-%d %H:%M:%S') }}</small>
        </div>
        <div class="card-body">
            <!-- Errors (Violations) -->
            {% if latest_result.violations %}
            <h6 class="text-danger mb-3">
                <i class="bi bi-x-circle"></i> Errors ({{ latest_result.violations|length }})
            </h6>
            <div class="accordion mb-4" id="violationsAccordion">
                {% for violation in latest_result.violations %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="violation-heading-{{ loop.index }}">
                        <button class="accordion-button collapsed" type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#violation-{{ loop.index }}">
                            <span class="badge bg-danger me-2 impact-badge">{{ violation.impact.value|upper if violation.impact.value else violation.impact|upper }}</span>
                            {{ violation.description }}
                        </button>
                    </h2>
                    <div id="violation-{{ loop.index }}" 
                         class="accordion-collapse collapse" 
                         data-bs-parent="#violationsAccordion">
                        <div class="accordion-body">
                            {% if violation.metadata and violation.metadata.title %}
                            <!-- Enhanced description available -->
                            <div class="alert alert-danger mb-3">
                                <h6 class="alert-heading">{{ violation.metadata.title }}</h6>
                            </div>
                            
                            <h6 class="text-danger mb-2">About this issue:</h6>
                            
                            <div class="mb-3">
                                <strong>What the issue is:</strong>
                                <p>{{ violation.metadata.what|default(violation.description) }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Why this is important:</strong>
                                <p>{{ violation.metadata.why }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Who it affects:</strong>
                                <p>{{ violation.metadata.who }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>How to remediate:</strong>
                                <pre class="bg-light p-3 rounded"><code>{{ violation.metadata.full_remediation|default(violation.failure_summary) }}</code></pre>
                            </div>
                            
                            <h6 class="text-danger mb-2 mt-4">Relevant test criteria:</h6>
                            <div class="mb-3">
                                {% if violation.metadata.wcag_full %}
                                <strong>WCAG Success Criteria:</strong>
                                <ul>
                                {% for criterion in violation.metadata.wcag_full %}
                                    <li>{{ criterion }}</li>
                                {% endfor %}
                                </ul>
                                {% elif violation.wcag_criteria %}
                                <strong>WCAG Success Criteria:</strong>
                                <ul>
                                {% for criterion in violation.wcag_criteria %}
                                    <li>
                                        <a href="https://www.w3.org/WAI/WCAG21/Understanding/" target="_blank" class="text-decoration-none">
                                            {{ criterion }}
                                        </a>
                                    </li>
                                {% endfor %}
                                </ul>
                                {% endif %}
                            </div>
                            {% else %}
                            <!-- Standard description -->
                            <p><strong>Rule:</strong> {{ violation.rule_id|default(violation.id) }}</p>
                            <p><strong>Help:</strong> {{ violation.help_text|default(violation.description) }}</p>
                            {% if violation.failure_summary %}
                            <p><strong>How to fix:</strong> {{ violation.failure_summary }}</p>
                            {% endif %}
                            {% endif %}
                            
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Category:</strong> {{ violation.category|default('General') }}</p>
                                    <p><strong>Impact:</strong> 
                                        <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[violation.impact.value|lower if violation.impact.value else violation.impact|lower] or 'secondary' }} impact-badge">
                                            {{ violation.impact.value|upper if violation.impact.value else violation.impact|upper }}
                                        </span>
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    {% if violation.wcag_criteria %}
                                    <p><strong>WCAG Criteria:</strong> 
                                        {% for criterion in violation.wcag_criteria %}
                                        <a href="https://www.w3.org/WAI/WCAG21/Understanding/" target="_blank" class="badge bg-primary text-decoration-none">
                                            {{ criterion }}
                                        </a>
                                        {% endfor %}
                                    </p>
                                    {% endif %}
                                    {% if violation.help_url %}
                                    <p><strong>Learn More:</strong> 
                                        <a href="{{ violation.help_url }}" target="_blank">
                                            Documentation <i class="bi bi-box-arrow-up-right"></i>
                                        </a>
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                            
                            {% if violation.selector or violation.xpath %}
                            <p><strong>Location:</strong> <code>{{ violation.selector|default(violation.xpath) }}</code></p>
                            {% endif %}
                            
                            {% if violation.html %}
                            <div class="mt-3">
                                <h6>Code Snippet</h6>
                                <pre class="bg-dark text-light p-3 rounded"><code>{{ violation.html|e }}</code></pre>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Warnings -->
            {% if latest_result.warnings %}
            <h6 class="text-warning mb-3">
                <i class="bi bi-exclamation-triangle"></i> Warnings ({{ latest_result.warnings|length }})
            </h6>
            <div class="accordion mb-4" id="warningsAccordion">
                {% for warning in latest_result.warnings %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="warning-heading-{{ loop.index }}">
                        <button class="accordion-button collapsed" type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#warning-{{ loop.index }}">
                            <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[warning.impact.value|lower if warning.impact.value else warning.impact|lower] or 'warning' }} me-2 impact-badge">
                                {{ warning.impact.value|upper if warning.impact.value else warning.impact|upper }}
                            </span>
                            {{ warning.id }} - {{ warning.description }}
                        </button>
                    </h2>
                    <div id="warning-{{ loop.index }}" 
                         class="accordion-collapse collapse" 
                         data-bs-parent="#warningsAccordion">
                        <div class="accordion-body">
                            {% if warning.metadata and warning.metadata.title %}
                            <!-- Enhanced description available -->
                            <div class="alert alert-warning mb-3">
                                <h6 class="alert-heading">{{ warning.metadata.title }}</h6>
                            </div>
                            
                            <h6 class="text-warning mb-2">About this issue:</h6>
                            
                            <div class="mb-3">
                                <strong>What the issue is:</strong>
                                <p>{{ warning.metadata.what|default(warning.description) }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Why this is important:</strong>
                                <p>{{ warning.metadata.why }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Who it affects:</strong>
                                <p>{{ warning.metadata.who }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>How to remediate:</strong>
                                <pre class="bg-light p-3 rounded"><code>{{ warning.metadata.full_remediation|default(warning.failure_summary) }}</code></pre>
                            </div>
                            
                            <h6 class="text-warning mb-2 mt-4">Relevant test criteria:</h6>
                            <div class="mb-3">
                                {% if warning.metadata.wcag_full %}
                                <strong>WCAG Success Criteria:</strong>
                                <ul>
                                {% for criterion in warning.metadata.wcag_full %}
                                    <li>{{ criterion }}</li>
                                {% endfor %}
                                </ul>
                                {% elif warning.wcag_criteria %}
                                <strong>WCAG Success Criteria:</strong>
                                <ul>
                                {% for criterion in warning.wcag_criteria %}
                                    <li>
                                        <a href="https://www.w3.org/WAI/WCAG21/Understanding/" target="_blank" class="text-decoration-none">
                                            {{ criterion }}
                                        </a>
                                    </li>
                                {% endfor %}
                                </ul>
                                {% endif %}
                            </div>
                            
                            <hr>
                            <p><strong>Category:</strong> {{ warning.category }}</p>
                            {% if warning.xpath %}
                            <p><strong>Location:</strong> <code>{{ warning.xpath }}</code></p>
                            {% endif %}
                            {% if warning.html %}
                            <div class="mt-3">
                                <h6>Code Snippet</h6>
                                <pre class="bg-dark text-light p-3 rounded"><code>{{ warning.html|e }}</code></pre>
                            </div>
                            {% endif %}
                            {% else %}
                            <!-- Standard description -->
                            <p><strong>Category:</strong> {{ warning.category }}</p>
                            {% if warning.help_url %}
                            <p><strong>Help:</strong> <a href="{{ warning.help_url }}" target="_blank">Learn more</a></p>
                            {% endif %}
                            {% if warning.xpath %}
                            <p><strong>XPath:</strong> <code>{{ warning.xpath }}</code></p>
                            {% endif %}
                            {% if warning.html %}
                            <pre><code>{{ warning.html|e }}</code></pre>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Info Notes -->
            {% if latest_result.info %}
            <h6 class="text-info mb-3">
                <i class="bi bi-info-circle"></i> Info Notes ({{ latest_result.info|length }})
            </h6>
            <div class="accordion mb-4" id="infoAccordion">
                {% for info in latest_result.info %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="info-heading-{{ loop.index }}">
                        <button class="accordion-button collapsed" type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#info-{{ loop.index }}">
                            {{ info.id }} - {{ info.description }}
                        </button>
                    </h2>
                    <div id="info-{{ loop.index }}" 
                         class="accordion-collapse collapse" 
                         data-bs-parent="#infoAccordion">
                        <div class="accordion-body">
                            {% if info.metadata and info.metadata.title %}
                            <!-- Enhanced description available -->
                            <div class="alert alert-info mb-3">
                                <h6 class="alert-heading">{{ info.metadata.title }}</h6>
                            </div>
                            
                            <h6 class="text-info mb-2">About this issue:</h6>
                            
                            <div class="mb-3">
                                <strong>What the issue is:</strong>
                                <p>{{ info.metadata.what|default(info.description) }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Why this is important:</strong>
                                <p>{{ info.metadata.why }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Who it affects:</strong>
                                <p>{{ info.metadata.who }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>How to remediate:</strong>
                                <pre class="bg-light p-3 rounded"><code>{{ info.metadata.full_remediation|default(info.failure_summary) }}</code></pre>
                            </div>
                            
                            <h6 class="text-info mb-2 mt-4">Relevant test criteria:</h6>
                            <div class="mb-3">
                                {% if info.metadata.wcag_full %}
                                <strong>WCAG Success Criteria:</strong>
                                <ul>
                                {% for criterion in info.metadata.wcag_full %}
                                    <li>{{ criterion }}</li>
                                {% endfor %}
                                </ul>
                                {% elif info.wcag_criteria %}
                                <strong>WCAG Success Criteria:</strong>
                                <ul>
                                {% for criterion in info.wcag_criteria %}
                                    <li>
                                        <a href="https://www.w3.org/WAI/WCAG21/Understanding/" target="_blank" class="text-decoration-none">
                                            {{ criterion }}
                                        </a>
                                    </li>
                                {% endfor %}
                                </ul>
                                {% endif %}
                            </div>
                            
                            <hr>
                            <p><strong>Category:</strong> {{ info.category }}</p>
                            {% if info.xpath %}
                            <p><strong>Location:</strong> <code>{{ info.xpath }}</code></p>
                            {% endif %}
                            {% if info.html %}
                            <div class="mt-3">
                                <h6>Code Snippet</h6>
                                <pre class="bg-dark text-light p-3 rounded"><code>{{ info.html|e }}</code></pre>
                            </div>
                            {% endif %}
                            {% else %}
                            <!-- Standard description -->
                            <p><strong>Category:</strong> {{ info.category }}</p>
                            {% if info.help_url %}
                            <p><strong>Help:</strong> <a href="{{ info.help_url }}" target="_blank">Learn more</a></p>
                            {% endif %}
                            {% if info.xpath %}
                            <p><strong>XPath:</strong> <code>{{ info.xpath }}</code></p>
                            {% endif %}
                            {% if info.html %}
                            <pre><code>{{ info.html|e }}</code></pre>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Discovery Items -->
            {% if latest_result.discovery %}
            <h6 class="mb-3" style="color: #6f42c1;">
                <i class="bi bi-search"></i> Discovery Items ({{ latest_result.discovery|length }})
            </h6>
            <div class="accordion mb-4" id="discoveryAccordion">
                {% for discovery in latest_result.discovery %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="discovery-heading-{{ loop.index }}">
                        <button class="accordion-button collapsed" type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#discovery-{{ loop.index }}">
                            {{ discovery.id }} - {{ discovery.description }}
                        </button>
                    </h2>
                    <div id="discovery-{{ loop.index }}" 
                         class="accordion-collapse collapse" 
                         data-bs-parent="#discoveryAccordion">
                        <div class="accordion-body">
                            {% if discovery.metadata and discovery.metadata.title %}
                            <!-- Enhanced description available -->
                            <div class="alert mb-3" style="background-color: #f3f0ff; border-color: #6f42c1;">
                                <h6 class="alert-heading" style="color: #6f42c1;">{{ discovery.metadata.title }}</h6>
                            </div>
                            
                            <h6 style="color: #6f42c1;" class="mb-2">About this discovery item:</h6>
                            
                            <div class="mb-3">
                                <strong>What was found:</strong>
                                <p>{{ discovery.metadata.what|default(discovery.description) }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Why manual review is needed:</strong>
                                <p>{{ discovery.metadata.why }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Who could be affected:</strong>
                                <p>{{ discovery.metadata.who }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong>What to check manually:</strong>
                                <pre class="bg-light p-3 rounded"><code>{{ discovery.metadata.full_remediation|default(discovery.failure_summary) }}</code></pre>
                            </div>
                            
                            <h6 style="color: #6f42c1;" class="mb-2 mt-4">Relevant test criteria:</h6>
                            <div class="mb-3">
                                {% if discovery.metadata.wcag_full %}
                                <strong>WCAG Success Criteria:</strong>
                                <ul>
                                {% for criterion in discovery.metadata.wcag_full %}
                                    <li>{{ criterion }}</li>
                                {% endfor %}
                                </ul>
                                {% elif discovery.wcag_criteria %}
                                <strong>WCAG Success Criteria:</strong>
                                <ul>
                                {% for criterion in discovery.wcag_criteria %}
                                    <li>
                                        <a href="https://www.w3.org/WAI/WCAG21/Understanding/" target="_blank" class="text-decoration-none">
                                            {{ criterion }}
                                        </a>
                                    </li>
                                {% endfor %}
                                </ul>
                                {% endif %}
                            </div>
                            
                            <hr>
                            <p><strong>Category:</strong> {{ discovery.category }}</p>
                            <p class="text-muted">
                                <i class="bi bi-info-circle"></i> This item requires manual inspection to ensure accessibility.
                            </p>
                            {% if discovery.xpath %}
                            <p><strong>Location:</strong> <code>{{ discovery.xpath }}</code></p>
                            {% endif %}
                            {% if discovery.html %}
                            <div class="mt-3">
                                <h6>Code Snippet</h6>
                                <pre class="bg-dark text-light p-3 rounded"><code>{{ discovery.html|e }}</code></pre>
                            </div>
                            {% endif %}
                            {% else %}
                            <!-- Standard description -->
                            <p><strong>Category:</strong> {{ discovery.category }}</p>
                            <p class="text-muted">
                                <i class="bi bi-info-circle"></i> This item requires manual inspection to ensure accessibility.
                            </p>
                            {% if discovery.help_url %}
                            <p><strong>Help:</strong> <a href="{{ discovery.help_url }}" target="_blank">Learn more</a></p>
                            {% endif %}
                            {% if discovery.xpath %}
                            <p><strong>XPath:</strong> <code>{{ discovery.xpath }}</code></p>
                            {% endif %}
                            {% if discovery.html %}
                            <pre><code>{{ discovery.html|e }}</code></pre>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- AI Findings -->
            {% if latest_result.ai_findings %}
            <h6 class="text-info mb-3">
                <i class="bi bi-robot"></i> AI Analysis ({{ latest_result.ai_findings|length }})
            </h6>
            <div class="accordion mb-4" id="aiAccordion">
                {% for finding in latest_result.ai_findings %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="ai-heading-{{ loop.index }}">
                        <button class="accordion-button collapsed" type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#ai-{{ loop.index }}">
                            <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[finding.severity.value|lower if finding.severity.value else finding.severity|lower] or 'secondary' }} me-2 impact-badge">
                                {{ finding.severity.value|upper if finding.severity.value else finding.severity|upper }}
                            </span>
                            {{ finding.issue }}
                        </button>
                    </h2>
                    <div id="ai-{{ loop.index }}" 
                         class="accordion-collapse collapse" 
                         data-bs-parent="#aiAccordion">
                        <div class="accordion-body">
                            <p><strong>Category:</strong> {{ finding.category }}</p>
                            <p><strong>Description:</strong> {{ finding.description }}</p>
                            {% if finding.recommendation %}
                            <p><strong>Recommendation:</strong> {{ finding.recommendation }}</p>
                            {% endif %}
                            {% if finding.wcag_criteria %}
                            <p><strong>WCAG Criteria:</strong> {{ finding.wcag_criteria|join(', ') }}</p>
                            {% endif %}
                            {% if finding.confidence_score %}
                            <p><strong>Confidence:</strong> {{ "%.0f"|format(finding.confidence_score * 100) }}%</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Summary Stats -->
            <div class="row text-center">
                <div class="col">
                    <small class="text-muted">
                        Test completed in {{ "%.2f"|format(latest_result.duration_ms / 1000) }} seconds
                        {% if latest_result.screenshot_path %}
                        | <a href="{{ url_for('static', filename='screenshots/' ~ latest_result.screenshot_path) }}" target="_blank">
                            View Screenshot <i class="bi bi-image"></i>
                        </a>
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
    </div>
    {% elif page.status.value != 'tested' %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> This page has not been tested yet. Click "Run Test" to start accessibility testing.
    </div>
    {% endif %}

    <!-- Test History -->
    {% if test_history %}
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0">Test History</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Errors</th>
                            <th>Warnings</th>
                            <th>Info</th>
                            <th>Discovery</th>
                            <th>Passed</th>
                            <th>Duration</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in test_history %}
                        <tr>
                            <td>{{ result.test_date.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td><span class="badge bg-danger">{{ result.violation_count }}</span></td>
                            <td><span class="badge bg-warning text-dark">{{ result.warning_count }}</span></td>
                            <td><span class="badge bg-info">{{ result.info_count|default(0) }}</span></td>
                            <td><span class="badge" style="background-color: #6f42c1;">{{ result.discovery_count|default(0) }}</span></td>
                            <td><span class="badge bg-success">{{ result.pass_count }}</span></td>
                            <td>{{ "%.2f"|format(result.duration_ms / 1000) }}s</td>
                            <td>
                                <a href="{{ url_for('testing.view_result', result_id=result.id) }}" 
                                   class="btn btn-sm btn-primary">
                                    <i class="bi bi-eye"></i> View
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Test Page Modal -->
<div class="modal fade" id="testModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Running Test</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Testing...</span>
                </div>
                <p>Running accessibility tests on this page...</p>
                <p class="text-muted">This may take a moment.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function testPage(pageId) {
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('testModal'));
    modal.show();
    
    // Run test
    $.post(`/pages/${pageId}/test`, function(data) {
        if (data.success) {
            // Reload page to show results
            location.reload();
        } else {
            modal.hide();
            alert('Test failed: ' + (data.error || 'Unknown error'));
        }
    }).fail(function() {
        modal.hide();
        alert('Failed to start test');
    });
}
</script>
{% endblock %}