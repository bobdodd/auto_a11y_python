{% extends "base.html" %}

{% block title %}Create Project - Auto A11y{% endblock %}

{% block extra_css %}
<style>
    .test-disabled {
        opacity: 0.5;
        text-decoration: line-through;
    }

    .test-debug-override {
        opacity: 0.7;
    }

    .fixture-status-badge {
        font-size: 0.7rem;
        padding: 0.1rem 0.3rem;
        margin-left: 0.5rem;
    }

    .touchpoint-disabled .form-check-label {
        color: #6c757d;
    }

    .test-help-btn {
        font-size: 0.85rem;
        padding: 0.1rem 0.4rem;
        margin-left: 0.5rem;
        opacity: 0.7;
        transition: opacity 0.2s;
    }

    .test-help-btn:hover {
        opacity: 1;
    }

    .test-details-modal .modal-header {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
    }

    .test-details-section {
        margin-bottom: 1.5rem;
    }

    .test-details-section h6 {
        color: #495057;
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }

    .test-details-section p {
        margin-bottom: 0;
        line-height: 1.6;
    }

    .impact-badge {
        font-size: 0.85rem;
        padding: 0.3rem 0.6rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-10 col-lg-9 mx-auto">
            <h1 class="h2 mb-4">Create New Project</h1>
            
            <!-- Fixture Status Notice -->
            {% if debug_mode %}
            <div class="alert alert-warning mb-3">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <strong>Debug Mode Active:</strong> All tests are available regardless of fixture status.
                <a href="{{ url_for('testing.fixture_status') }}" class="alert-link float-end">View Fixture Status</a>
            </div>
            {% else %}
            <div class="alert alert-info mb-3">
                <i class="bi bi-info-circle-fill me-2"></i>
                <strong>Test Availability:</strong> Only tests that passed fixture validation are enabled.
                <a href="{{ url_for('testing.fixture_status') }}" class="alert-link float-end">View Fixture Status</a>
            </div>
            {% endif %}
            
            <div class="card">
                <div class="card-body">
                    <form method="POST" action="{{ url_for('projects.create_project') }}">
                        <div class="mb-3">
                            <label for="name" class="form-label">Project Name *</label>
                            <input type="text" class="form-control" id="name" name="name" 
                                   required autofocus maxlength="100">
                            <div class="form-text">Choose a unique name for your project</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" 
                                      rows="3" maxlength="500"></textarea>
                            <div class="form-text">Optional description of the project goals</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="wcag_level" class="form-label">WCAG Compliance Level *</label>
                            <select class="form-select" id="wcag_level" name="wcag_level" required>
                                <option value="AA" selected>Level AA (Recommended)</option>
                                <option value="AAA">Level AAA (Enhanced)</option>
                            </select>
                            <div class="form-text">
                                <strong>Level AA:</strong> Standard compliance (4.5:1 contrast for normal text, 3:1 for large text)<br>
                                <strong>Level AAA:</strong> Enhanced compliance (7:1 contrast for normal text, 4.5:1 for large text)
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="page_load_strategy" class="form-label">Page Load Strategy</label>
                            <select class="form-select" id="page_load_strategy" name="page_load_strategy">
                                <option value="networkidle2" selected>Network Idle 2 (Default - Best for most sites)</option>
                                <option value="networkidle0">Network Idle 0 (Very thorough, slowest)</option>
                                <option value="domcontentloaded">DOM Content Loaded (Fast, for sites with heavy background activity)</option>
                                <option value="load">Load Event (Middle ground)</option>
                            </select>
                            <div class="form-text">
                                Controls when testing begins after navigating to a page:<br>
                                • <strong>Network Idle 2</strong>: Wait until network has ≤2 connections (best for dynamic sites)<br>
                                • <strong>Network Idle 0</strong>: Wait until network is completely idle (very thorough but slow)<br>
                                • <strong>DOM Content Loaded</strong>: Test as soon as DOM is ready (use for BBC News, sites with continuous ads/analytics)<br>
                                • <strong>Load Event</strong>: Wait for load event (faster than network idle)
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="headless_browser" class="form-label">Browser Display Mode</label>
                            <select class="form-select" id="headless_browser" name="headless_browser">
                                <option value="true" selected>Headless (No visible browser)</option>
                                <option value="false">Visible Browser (Show Chrome window)</option>
                            </select>
                            <div class="form-text">
                                • <strong>Headless</strong>: Run browser invisibly (faster, less resource intensive)<br>
                                • <strong>Visible Browser</strong>: Show the Chrome window (useful for debugging)
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="stealth_mode" name="stealth_mode" value="true">
                                <label class="form-check-label" for="stealth_mode">
                                    Enable Stealth Mode (for Cloudflare-protected sites)
                                </label>
                            </div>
                            <div class="form-text">
                                Enables advanced bot detection bypass techniques. Use for sites protected by Cloudflare or similar services.
                                <strong>Note:</strong> Stealth mode significantly slows down page discovery and testing (~5-15 seconds per page).
                            </div>
                        </div>

                        <!-- Touchpoint Testing Configuration -->
                        <div class="mb-3">
                            <label class="form-label">Touchpoint Tests Configuration</label>
                            <div class="form-text mb-2">
                                Configure which accessibility tests to run. Tests are organized by touchpoint (testing category).
                            </div>
                            
                            <!-- Global Controls -->
                            <div class="btn-group mb-3" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllTests(true)">Enable All</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectAllTests(false)">Disable All</button>
                                <button type="button" class="btn btn-sm btn-outline-info" onclick="applyPreset('minimal')">Minimal</button>
                                <button type="button" class="btn btn-sm btn-outline-info" onclick="applyPreset('wcag-aa')">WCAG AA</button>
                            </div>
                            
                            <!-- Touchpoint Tree -->
                            <div class="touchpoint-tree border rounded p-3" style="max-height: 500px; overflow-y: auto; max-width: 100%;">
                                {% for touchpoint_id, touchpoint_name in touchpoint_names.items()|sort(attribute='1') %}
                                {% set test_ids = tests_by_touchpoint.get(touchpoint_id, []) %}
                                {% if test_ids %}
                                <div class="touchpoint-item mb-2">
                                    <div class="d-flex align-items-center">
                                        <!-- Expand/Collapse button -->
                                        <button class="btn btn-sm btn-link p-0 me-2" type="button" 
                                                data-bs-toggle="collapse" data-bs-target="#tests_{{ touchpoint_id }}"
                                                aria-expanded="false" aria-controls="tests_{{ touchpoint_id }}">
                                            <i class="bi bi-chevron-right" id="chevron_{{ touchpoint_id }}"></i>
                                        </button>
                                        
                                        <!-- Touchpoint checkbox -->
                                        <div class="form-check">
                                            <input class="form-check-input touchpoint-checkbox" type="checkbox" 
                                                   id="touchpoint_{{ touchpoint_id }}" name="touchpoint_{{ touchpoint_id }}"
                                                   checked
                                                   onchange="toggleTouchpoint('{{ touchpoint_id }}')">
                                            <label class="form-check-label fw-bold" for="touchpoint_{{ touchpoint_id }}">
                                                <i class="bi bi-folder2 me-1"></i>{{ touchpoint_name }}
                                                {% set available_count = test_ids|select('in', passing_tests)|list|length %}
                                                {% set total_count = test_ids|length %}
                                                {% if debug_mode %}
                                                    <span class="badge bg-warning ms-2" title="Debug mode - all tests available">{{ total_count }}</span>
                                                {% elif available_count == total_count %}
                                                    <span class="badge bg-success ms-2" title="All tests passed fixtures">{{ available_count }}</span>
                                                {% elif available_count == 0 %}
                                                    <span class="badge bg-danger ms-2" title="No tests available">0/{{ total_count }}</span>
                                                {% else %}
                                                    <span class="badge bg-warning ms-2" title="{{ available_count }} of {{ total_count }} tests available">{{ available_count }}/{{ total_count }}</span>
                                                {% endif %}
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- Individual tests under this touchpoint (collapsible) -->
                                    <div class="collapse ms-5 mt-1" id="tests_{{ touchpoint_id }}">
                                        {% for test_id in test_ids %}
                                        {% set test_passed = test_id in passing_tests %}
                                        {% set test_status = test_statuses.get(test_id, {}) %}
                                        {% set test_available = test_passed or debug_mode %}
                                        {% set is_debug_override = not test_passed and debug_mode %}
                                        
                                        <div class="d-flex align-items-center {% if not test_available %}test-disabled{% elif is_debug_override %}test-debug-override{% endif %}">
                                            <div class="form-check">
                                                <input class="form-check-input test-checkbox" type="checkbox"
                                                       id="test_{{ touchpoint_id }}_{{ test_id }}"
                                                       name="test_{{ touchpoint_id }}_{{ test_id }}"
                                                       data-touchpoint="{{ touchpoint_id }}"
                                                       {% if test_available %}checked{% else %}disabled{% endif %}>
                                                <label class="form-check-label small" for="test_{{ touchpoint_id }}_{{ test_id }}">
                                                    <i class="bi bi-file-earmark-code me-1"></i>
                                                    <code>{{ test_id }}</code>
                                                </label>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-info test-help-btn"
                                                    onclick="showTestDetails('{{ test_id }}')"
                                                    title="View test details">
                                                <i class="bi bi-question-circle"></i>
                                            </button>
                                            {% if not test_passed %}
                                                {% if test_status %}
                                                    <span class="badge bg-danger fixture-status-badge" title="Failed fixture test">✗</span>
                                                {% else %}
                                                    <span class="badge bg-warning fixture-status-badge" title="No fixture test">?</span>
                                                {% endif %}
                                                {% if is_debug_override %}
                                                    <span class="badge bg-info fixture-status-badge" title="Enabled in debug mode">DEBUG</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="badge bg-success fixture-status-badge" title="Passed fixture test">✓</span>
                                            {% endif %}
                                            {% set is_production_ready = production_ready_statuses.get(test_id, False) %}
                                            <div class="form-check ms-2">
                                                <input class="form-check-input" type="checkbox"
                                                       id="prod_ready_{{ test_id }}"
                                                       {% if is_production_ready %}checked{% endif %}
                                                       onclick="toggleProductionReadyInline('{{ test_id }}', this.checked)"
                                                       title="Production ready documentation">
                                                <label class="form-check-label small text-muted" for="prod_ready_{{ test_id }}" title="Production ready">
                                                    <small>Prod Ready</small>
                                                </label>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- AI Testing Configuration -->
                        <div class="mb-3">
                            <label class="form-label">AI-Assisted Testing</label>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enable_ai_testing" name="enable_ai_testing" onchange="toggleAITests()">
                                <label class="form-check-label" for="enable_ai_testing">
                                    Enable AI-assisted accessibility testing
                                </label>
                            </div>
                            <div class="form-text mb-3">
                                AI testing uses Claude to analyze screenshots and HTML for issues that automated tests might miss.
                                <strong>Note:</strong> AI testing incurs API costs based on usage.
                            </div>
                            
                            <div id="ai_tests_selection" style="display: none;">
                                <label class="form-label">Select AI Tests to Run:</label>
                                <div class="ms-3">
                                    <div class="form-check">
                                        <input class="form-check-input ai-test-checkbox" type="checkbox" id="ai_test_headings" name="ai_test_headings" value="headings">
                                        <label class="form-check-label" for="ai_test_headings">
                                            <strong>Heading Analysis</strong> - Detects visual headings not properly marked up
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input ai-test-checkbox" type="checkbox" id="ai_test_reading_order" name="ai_test_reading_order" value="reading_order">
                                        <label class="form-check-label" for="ai_test_reading_order">
                                            <strong>Reading Order</strong> - Verifies logical reading sequence matches visual layout
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input ai-test-checkbox" type="checkbox" id="ai_test_modals" name="ai_test_modals" value="modals">
                                        <label class="form-check-label" for="ai_test_modals">
                                            <strong>Modal Dialogs</strong> - Analyzes popup and overlay accessibility
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input ai-test-checkbox" type="checkbox" id="ai_test_language" name="ai_test_language" value="language">
                                        <label class="form-check-label" for="ai_test_language">
                                            <strong>Language Detection</strong> - Identifies mixed languages and missing declarations
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input ai-test-checkbox" type="checkbox" id="ai_test_animations" name="ai_test_animations" value="animations">
                                        <label class="form-check-label" for="ai_test_animations">
                                            <strong>Animations</strong> - Detects potentially problematic motion
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input ai-test-checkbox" type="checkbox" id="ai_test_interactive" name="ai_test_interactive" value="interactive">
                                        <label class="form-check-label" for="ai_test_interactive">
                                            <strong>Interactive Elements</strong> - Analyzes buttons, links, and form controls
                                        </label>
                                    </div>
                                </div>
                                <div class="form-text mt-2">
                                    <a href="#" onclick="selectAllAITests(event)">Select All</a> | 
                                    <a href="#" onclick="deselectAllAITests(event)">Deselect All</a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> Create Project
                            </button>
                            <a href="{{ url_for('projects.list_projects') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Test Details Modal -->
<div class="modal fade test-details-modal" id="testDetailsModal" tabindex="-1" aria-labelledby="testDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="testDetailsModalLabel">
                    <i class="bi bi-info-circle me-2"></i>
                    <span id="testDetailsTitle">Test Details</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="testDetailsBody">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading test details...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Handle collapse/expand chevron rotation
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(button => {
        button.addEventListener('click', function() {
            const chevron = this.querySelector('i');
            if (chevron) {
                chevron.classList.toggle('bi-chevron-right');
                chevron.classList.toggle('bi-chevron-down');
            }
        });
    });
});

// Toggle all tests within a touchpoint
function toggleTouchpoint(touchpointId) {
    const touchpointCheckbox = document.getElementById('touchpoint_' + touchpointId);
    const testCheckboxes = document.querySelectorAll(`[data-touchpoint="${touchpointId}"]`);
    
    testCheckboxes.forEach(checkbox => {
        // Only toggle if not disabled
        if (!checkbox.disabled) {
            checkbox.checked = touchpointCheckbox.checked;
        }
    });
}

// Select or deselect all tests
function selectAllTests(enable) {
    document.querySelectorAll('.touchpoint-checkbox').forEach(cb => {
        cb.checked = enable;
    });
    document.querySelectorAll('.test-checkbox').forEach(cb => {
        // Only toggle if not disabled
        if (!cb.disabled) {
            cb.checked = enable;
        }
    });
}

// Apply test presets
function applyPreset(preset) {
    // First disable all
    selectAllTests(false);
    
    if (preset === 'minimal') {
        // Enable only critical error tests
        const minimalTouchpoints = ['headings', 'images', 'forms', 'colors_contrast', 'keyboard_navigation'];
        minimalTouchpoints.forEach(tp => {
            const checkbox = document.getElementById('touchpoint_' + tp);
            if (checkbox) {
                checkbox.checked = true;
                toggleTouchpoint(tp);
            }
        });
    } else if (preset === 'wcag-aa') {
        // Enable all touchpoints for WCAG AA compliance
        selectAllTests(true);
    }
}

function toggleAITests() {
    const enabled = document.getElementById('enable_ai_testing').checked;
    const selection = document.getElementById('ai_tests_selection');
    selection.style.display = enabled ? 'block' : 'none';
    
    // If disabling, uncheck all tests
    if (!enabled) {
        document.querySelectorAll('.ai-test-checkbox').forEach(cb => {
            cb.checked = false;
        });
    }
}

function selectAllAITests(event) {
    event.preventDefault();
    document.querySelectorAll('.ai-test-checkbox').forEach(cb => {
        cb.checked = true;
    });
}

function deselectAllAITests(event) {
    event.preventDefault();
    document.querySelectorAll('.ai-test-checkbox').forEach(cb => {
        cb.checked = false;
    });
}

// Show test details in modal
function showTestDetails(testId) {
    const modal = new bootstrap.Modal(document.getElementById('testDetailsModal'));
    const titleEl = document.getElementById('testDetailsTitle');
    const bodyEl = document.getElementById('testDetailsBody');

    // Set title
    titleEl.textContent = testId;

    // Show loading state
    bodyEl.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading test details...</p>
        </div>
    `;

    // Show modal
    modal.show();

    // Fetch test details
    fetch(`/projects/api/test-details/${testId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const test = data.test;

                // Build impact badge
                let impactClass = 'secondary';
                if (test.impact === 'High' || test.impact === 'Critical') impactClass = 'danger';
                else if (test.impact === 'Medium') impactClass = 'warning';
                else if (test.impact === 'Low') impactClass = 'info';

                // Build WCAG badges
                let wcagBadges = '';
                if (test.wcag && test.wcag.length > 0) {
                    wcagBadges = test.wcag.map(w => `<span class="badge bg-primary me-1">${w}</span>`).join('');
                }

                // Build modal content
                // Build production ready toggle
                const productionReadyBadge = test.production_ready ?
                    '<span class="badge bg-success me-2"><i class="bi bi-check-circle me-1"></i>Production Ready</span>' :
                    '<span class="badge bg-warning me-2"><i class="bi bi-exclamation-circle me-1"></i>Pending Review</span>';

                bodyEl.innerHTML = `
                    <div class="mb-3">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <div>
                                <span class="badge bg-${impactClass} impact-badge me-2">${test.impact} Impact</span>
                                <span class="badge bg-secondary me-2">${test.type}</span>
                                ${wcagBadges}
                            </div>
                            <div>
                                ${productionReadyBadge}
                            </div>
                        </div>
                        ${test.wcag_full ? `<small class="text-muted">${test.wcag_full}</small>` : ''}
                    </div>

                    <div class="alert alert-${test.production_ready ? 'success' : 'warning'} alert-dismissible fade show" role="alert">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="flex-grow-1">
                                <strong>Documentation Status:</strong>
                                ${test.production_ready ?
                                    'This test has production-ready documentation.' :
                                    'This test documentation is pending review and may be incomplete.'}
                            </div>
                            <button type="button" class="btn btn-sm btn-${test.production_ready ? 'outline-warning' : 'outline-success'} ms-3"
                                    onclick="toggleProductionReady('${test.id}', ${!test.production_ready})"
                                    id="productionReadyToggle">
                                <i class="bi bi-${test.production_ready ? 'x-circle' : 'check-circle'} me-1"></i>
                                Mark as ${test.production_ready ? 'Pending' : 'Ready'}
                            </button>
                        </div>
                    </div>

                    <div class="test-details-section">
                        <h6><i class="bi bi-info-circle me-2"></i>What This Test Detects</h6>
                        <p>${test.description}</p>
                    </div>

                    ${test.why_it_matters ? `
                    <div class="test-details-section">
                        <h6><i class="bi bi-exclamation-triangle me-2"></i>Why It Matters</h6>
                        <p>${test.why_it_matters}</p>
                    </div>
                    ` : ''}

                    ${test.who_it_affects ? `
                    <div class="test-details-section">
                        <h6><i class="bi bi-people me-2"></i>Who It Affects</h6>
                        <p>${test.who_it_affects}</p>
                    </div>
                    ` : ''}

                    ${test.how_to_fix ? `
                    <div class="test-details-section">
                        <h6><i class="bi bi-wrench me-2"></i>How to Fix</h6>
                        <p>${test.how_to_fix}</p>
                    </div>
                    ` : ''}

                    ${test.message_template && (test.message_template.title || test.message_template.what) ? `
                    <div class="test-details-section bg-light border rounded p-3">
                        <h6><i class="bi bi-chat-square-text me-2"></i>Violation Message Templates</h6>
                        <p class="text-muted small mb-3">These are the actual message templates shown to users when violations are detected. Placeholders like <code>{totalCount}</code>, <code>{role}</code>, <code>{element}</code>, etc. are filled in dynamically.</p>

                        ${test.message_template.title ? `
                        <div class="mb-2">
                            <strong class="d-block mb-1">Title Template:</strong>
                            <code class="d-block bg-white p-2 rounded">${test.message_template.title}</code>
                        </div>
                        ` : ''}

                        ${test.message_template.what ? `
                        <div class="mb-2">
                            <strong class="d-block mb-1">What (Description) Template:</strong>
                            <code class="d-block bg-white p-2 rounded">${test.message_template.what}</code>
                        </div>
                        ` : ''}

                        ${test.message_template.why ? `
                        <div class="mb-2">
                            <strong class="d-block mb-1">Why (Rationale) Template:</strong>
                            <code class="d-block bg-white p-2 rounded">${test.message_template.why}</code>
                        </div>
                        ` : ''}

                        ${test.message_template.remediation ? `
                        <div>
                            <strong class="d-block mb-1">Remediation Template:</strong>
                            <code class="d-block bg-white p-2 rounded">${test.message_template.remediation}</code>
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}
                `;
            } else {
                bodyEl.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Test Information Not Available</strong>
                        <p class="mb-0 mt-2">Details for test <code>${testId}</code> are not available in the catalog.</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error fetching test details:', error);
            bodyEl.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle me-2"></i>
                    <strong>Error Loading Test Details</strong>
                    <p class="mb-0 mt-2">An error occurred while loading the test details. Please try again.</p>
                </div>
            `;
        });
}

// Toggle production ready status (from modal)
function toggleProductionReady(testId, newValue) {
    const button = document.getElementById('productionReadyToggle');
    if (!button) return;

    // Disable button during update
    button.disabled = true;
    const originalHTML = button.innerHTML;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Updating...';

    // Make API call to update status
    fetch(`/projects/api/test-details/${testId}/production-ready`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            production_ready: newValue
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the inline checkbox if it exists
            const inlineCheckbox = document.getElementById('prod_ready_' + testId);
            if (inlineCheckbox) {
                inlineCheckbox.checked = newValue;
            }

            // Refresh the modal content without creating a new modal instance
            refreshTestDetailsContent(testId);
        } else {
            alert('Error updating status: ' + (data.error || 'Unknown error'));
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    })
    .catch(error => {
        console.error('Error updating production ready status:', error);
        alert('Error updating status. Please try again.');
        button.disabled = false;
        button.innerHTML = originalHTML;
    });
}

// Refresh modal content without creating new modal instance
function refreshTestDetailsContent(testId) {
    const bodyEl = document.getElementById('testDetailsBody');
    if (!bodyEl) return;

    // Show loading state
    bodyEl.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Refreshing...</p>
        </div>
    `;

    // Fetch updated test details
    fetch(`/projects/api/test-details/${testId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const test = data.test;

                // Build impact badge
                let impactClass = 'secondary';
                if (test.impact === 'High' || test.impact === 'Critical') impactClass = 'danger';
                else if (test.impact === 'Medium') impactClass = 'warning';
                else if (test.impact === 'Low') impactClass = 'info';

                // Build WCAG badges
                let wcagBadges = '';
                if (test.wcag && test.wcag.length > 0) {
                    wcagBadges = test.wcag.map(w => `<span class="badge bg-primary me-1">${w}</span>`).join('');
                }

                // Build production ready toggle
                const productionReadyBadge = test.production_ready ?
                    '<span class="badge bg-success me-2"><i class="bi bi-check-circle me-1"></i>Production Ready</span>' :
                    '<span class="badge bg-warning me-2"><i class="bi bi-exclamation-circle me-1"></i>Pending Review</span>';

                bodyEl.innerHTML = `
                    <div class="mb-3">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <div>
                                <span class="badge bg-${impactClass} impact-badge me-2">${test.impact} Impact</span>
                                <span class="badge bg-secondary me-2">${test.type}</span>
                                ${wcagBadges}
                            </div>
                            <div>
                                ${productionReadyBadge}
                            </div>
                        </div>
                        ${test.wcag_full ? `<small class="text-muted">${test.wcag_full}</small>` : ''}
                    </div>

                    <div class="alert alert-${test.production_ready ? 'success' : 'warning'} alert-dismissible fade show" role="alert">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="flex-grow-1">
                                <strong>Documentation Status:</strong>
                                ${test.production_ready ?
                                    'This test has production-ready documentation.' :
                                    'This test documentation is pending review and may be incomplete.'}
                            </div>
                            <button type="button" class="btn btn-sm btn-${test.production_ready ? 'outline-warning' : 'outline-success'} ms-3"
                                    onclick="toggleProductionReady('${test.id}', ${!test.production_ready})"
                                    id="productionReadyToggle">
                                <i class="bi bi-${test.production_ready ? 'x-circle' : 'check-circle'} me-1"></i>
                                Mark as ${test.production_ready ? 'Pending' : 'Ready'}
                            </button>
                        </div>
                    </div>

                    <div class="test-details-section">
                        <h6><i class="bi bi-info-circle me-2"></i>What This Test Detects</h6>
                        <p>${test.description}</p>
                    </div>

                    ${test.why_it_matters ? `
                    <div class="test-details-section">
                        <h6><i class="bi bi-exclamation-triangle me-2"></i>Why It Matters</h6>
                        <p>${test.why_it_matters}</p>
                    </div>
                    ` : ''}

                    ${test.who_it_affects ? `
                    <div class="test-details-section">
                        <h6><i class="bi bi-people me-2"></i>Who It Affects</h6>
                        <p>${test.who_it_affects}</p>
                    </div>
                    ` : ''}

                    ${test.how_to_fix ? `
                    <div class="test-details-section">
                        <h6><i class="bi bi-wrench me-2"></i>How to Fix</h6>
                        <p>${test.how_to_fix}</p>
                    </div>
                    ` : ''}

                    ${test.message_template && (test.message_template.title || test.message_template.what) ? `
                    <div class="test-details-section bg-light border rounded p-3">
                        <h6><i class="bi bi-chat-square-text me-2"></i>Violation Message Templates</h6>
                        <p class="text-muted small mb-3">These are the actual message templates shown to users when violations are detected. Placeholders like <code>{totalCount}</code>, <code>{role}</code>, <code>{element}</code>, etc. are filled in dynamically.</p>

                        ${test.message_template.title ? `
                        <div class="mb-2">
                            <strong class="d-block mb-1">Title Template:</strong>
                            <code class="d-block bg-white p-2 rounded">${test.message_template.title}</code>
                        </div>
                        ` : ''}

                        ${test.message_template.what ? `
                        <div class="mb-2">
                            <strong class="d-block mb-1">What (Description) Template:</strong>
                            <code class="d-block bg-white p-2 rounded">${test.message_template.what}</code>
                        </div>
                        ` : ''}

                        ${test.message_template.why ? `
                        <div class="mb-2">
                            <strong class="d-block mb-1">Why (Rationale) Template:</strong>
                            <code class="d-block bg-white p-2 rounded">${test.message_template.why}</code>
                        </div>
                        ` : ''}

                        ${test.message_template.remediation ? `
                        <div>
                            <strong class="d-block mb-1">Remediation Template:</strong>
                            <code class="d-block bg-white p-2 rounded">${test.message_template.remediation}</code>
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}
                `;
            } else {
                bodyEl.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Test Information Not Available</strong>
                        <p class="mb-0 mt-2">Details for test <code>${testId}</code> are not available in the catalog.</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error fetching test details:', error);
            bodyEl.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle me-2"></i>
                    <strong>Error Loading Test Details</strong>
                    <p class="mb-0 mt-2">An error occurred while loading the test details. Please try again.</p>
                </div>
            `;
        });
}

// Toggle production ready status (from inline checkbox)
function toggleProductionReadyInline(testId, newValue) {
    const checkbox = document.getElementById('prod_ready_' + testId);
    if (!checkbox) return;

    // Store original state in case we need to revert
    const originalState = !newValue;

    // Make API call to update status
    fetch(`/projects/api/test-details/${testId}/production-ready`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            production_ready: newValue
        })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            // Revert checkbox on error
            checkbox.checked = originalState;
            alert('Error updating status: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error updating production ready status:', error);
        // Revert checkbox on error
        checkbox.checked = originalState;
        alert('Error updating status. Please try again.');
    });
}
</script>
{% endblock %}