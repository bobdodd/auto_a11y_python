<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page.title }} - Page Report - Auto A11y</title>

    <!-- Inlined Bootstrap CSS -->
    <style>
    {{ bootstrap_css|safe }}
    </style>

    <!-- Inlined Bootstrap Icons CSS -->
    <style>
    {{ bootstrap_icons_css|safe }}
    </style>

    <!-- Page-specific styles -->
    <style>
    /* Match online view styling exactly */
    .impact-badge {
        min-width: 75px;
        display: inline-block;
        text-align: center;
    }

    /* Move accordion indicators to the left for accessibility */
    .accordion-button {
        padding-left: 2.5rem;
        padding-right: 1.25rem;
    }

    .accordion-button::after {
        position: absolute;
        left: 1rem;
        right: auto;
        transform: rotate(-90deg);
        transition: transform 0.2s ease-in-out;
    }

    .accordion-button:not(.collapsed)::after {
        transform: rotate(0deg);
    }

    /* Ensure proper spacing for content */
    .accordion-button > * {
        margin-left: 0.5rem;
    }

    .accordion-button > *:first-child {
        margin-left: 0;
    }

    .test-results-card {
        margin-bottom: 2rem;
    }

    .touchpoint-header {
        background-color: #f8f9fa;
        padding: 8px;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
        padding-left: 0.5rem;
    }

    /* Filter Panel Styling */
    .filter-panel {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .filter-group {
        margin-bottom: 1rem;
    }

    .filter-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .filter-chip {
        padding: 0.25rem 0.75rem;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.875rem;
    }

    .filter-chip:hover {
        background: #e9ecef;
    }

    .filter-chip.active {
        background: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }

    .active-filters {
        padding: 1rem;
        background: #e7f3ff;
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .active-filter-tag {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        background: #0d6efd;
        color: white;
        border-radius: 15px;
        margin: 0.25rem;
        font-size: 0.875rem;
    }

    .active-filter-tag .remove-filter {
        margin-left: 0.5rem;
        cursor: pointer;
    }

    .filter-stats {
        padding: 0.75rem;
        background: white;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        margin-bottom: 1rem;
    }

    .issue-item {
        transition: opacity 0.3s;
    }

    .issue-item.filtered-out {
        display: none;
    }

    /* State selector button text contrast */
    .state-selector.btn-outline-primary.active .state-counts,
    .state-selector.btn-outline-primary:hover .state-counts,
    .state-selector.btn-outline-primary:focus .state-counts,
    .state-selector.btn-outline-primary:active .state-counts {
        color: white !important;
    }

    .state-selector.btn-outline-primary .state-counts {
        color: #6c757d;
    }

    .state-content {
        display: none;
    }

    .state-content.active {
        display: block;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    main {
        flex: 1;
    }

    .navbar-brand {
        font-weight: 600;
    }
    </style>
</head>
<body>

{% macro render_instance_accordion(violation, instance_id, parent_id, alert_type, loop_index) %}
<div class="accordion-item">
    <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button"
                data-bs-toggle="collapse"
                data-bs-target="#{{ instance_id }}">
            <strong>Instance {{ loop_index }}:</strong>
            {% if violation.metadata and violation.metadata.authenticated_user %}
                <span class="badge bg-secondary ms-2">
                    <i class="bi bi-person-fill"></i> {{ violation.metadata.authenticated_user.display_name }}
                    {% if violation.metadata.authenticated_user.roles %}
                        ({{ violation.metadata.authenticated_user.roles|join(', ') }})
                    {% endif %}
                </span>
            {% else %}
                <span class="badge bg-secondary ms-2">
                    <i class="bi bi-person"></i> Guest
                </span>
            {% endif %}
            {% if violation.xpath %}
            <code class="ms-2">{{ violation.xpath }}</code>
            {% endif %}
        </button>
    </h2>
    <div id="{{ instance_id }}"
         class="accordion-collapse collapse"
         data-bs-parent="#{{ parent_id }}">
        <div class="accordion-body">
            {{ render_violation_details(violation, alert_type) }}
        </div>
    </div>
</div>
{% endmacro %}

{% macro render_violation_details(violation, alert_type) %}
<!-- Issue Details - Match online view exactly -->
{% if violation.metadata and violation.metadata.what %}
<!-- Enhanced description available -->
<div class="alert alert-{{ alert_type }} mb-3">
    <h6 class="alert-heading">{{ violation.description }}</h6>
</div>

<h6 class="text-{{ alert_type }} mb-2">About this issue:</h6>

<div class="mb-3">
    <strong>What the issue is:</strong>
    <p>{{ violation.description }}</p>
</div>

{% if violation.metadata.why %}
<div class="mb-3">
    <strong>Why this is important:</strong>
    <p>{{ violation.metadata.why }}</p>
</div>
{% endif %}

{% if violation.metadata.who %}
<div class="mb-3">
    <strong>Who it affects:</strong>
    <p>{{ violation.metadata.who }}</p>
</div>
{% endif %}

{% if violation.metadata.full_remediation %}
<div class="mb-3">
    <strong>How to remediate:</strong>
    <div class="bg-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace;">{{ violation.metadata.full_remediation|default(violation.failure_summary) }}</div>
</div>
{% endif %}

{% if violation.metadata.wcag_full %}
<h6 class="text-{{ alert_type }} mb-2 mt-4">Relevant test criteria:</h6>
<div class="mb-3">
    <strong>WCAG Success Criteria:</strong>
    <ul>
    {% for criterion in violation.metadata.wcag_full %}
        <li>{{ criterion|safe }}</li>
    {% endfor %}
    </ul>
</div>
{% endif %}
{% else %}
<!-- Standard description -->
<p><strong>Rule:</strong> {{ violation.id }}</p>
<p><strong>Help:</strong> {{ violation.description }}</p>
{% if violation.failure_summary %}
<p><strong>How to fix:</strong> {{ violation.failure_summary }}</p>
{% endif %}
{% endif %}

<hr>
<div class="row">
    <div class="col-md-6">
        <p><strong>Touchpoint:</strong> {{ violation.touchpoint|replace('_', ' ')|title }}</p>
        <p><strong>Impact:</strong>
            <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[violation.impact|lower] or 'secondary' }} impact-badge">
                {{ violation.impact|upper }}
            </span>
        </p>
    </div>
    <div class="col-md-6">
        {% if violation.metadata.wcag_full %}
            {% for criterion in violation.metadata.wcag_full|sort %}
            <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-left: 3px solid #0066cc;">
                <p style="margin: 0 0 8px 0; font-weight: bold;">
                    WCAG {{ criterion|safe }}
                </p>

                {% set criterion_code = criterion.split()[0] %}
                <p style="margin: 0 0 5px 0;">
                    <a href="https://www.w3.org/WAI/WCAG22/Understanding/{{ criterion_code }}" target="_blank">
                        More about {{ criterion_code }} <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                </p>
                <p style="margin: 0;">
                    <a href="https://www.w3.org/WAI/WCAG22/quickref/#{{ criterion_code }}" target="_blank">
                        Ways to meet {{ criterion_code }} <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                </p>
            </div>
            {% endfor %}
        {% endif %}
    </div>
</div>

{% if violation.xpath %}
<p class="mt-3">
    <strong>Location:</strong>
    <code>{{ violation.xpath }}</code>
    <button class="btn btn-sm btn-link p-0 ms-2"
            onclick="copyXpathToClipboard('{{ violation.xpath|e }}', this)"
            title="Copy XPath to clipboard">
        <i class="bi bi-clipboard"></i>
    </button>
</p>
{% endif %}

{% if violation.metadata and violation.metadata.breakpoint %}
<p>
    <strong>Responsive Breakpoint:</strong> <span class="badge bg-info">{{ violation.metadata.breakpoint }}px width</span>
</p>
{% endif %}

{% if violation.metadata and violation.metadata.pseudoclass %}
<p>
    <strong>CSS State:</strong>
    {% if '@' in violation.metadata.pseudoclass %}
        {% set parts = violation.metadata.pseudoclass.split('@') %}
        <span class="badge bg-warning">{{ parts[0] }}</span>
        <span class="badge bg-secondary">{{ parts[1] }}</span>
    {% else %}
        <span class="badge bg-warning">{{ violation.metadata.pseudoclass }}</span>
    {% endif %}
</p>
{% endif %}

{% if violation.html_snippet %}
<h6 class="mt-3">Code Snippet</h6>
<pre class="bg-dark text-light p-3 rounded"><code>{{ violation.html_snippet|e }}</code></pre>
{% endif %}
{% endmacro %}

    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary no-print">
        <div class="container-fluid">
            <a class="navbar-brand" href="../index.html">
                <i class="bi bi-universal-access-circle"></i> Auto A11y Report
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">
                            <i class="bi bi-house"></i> Index
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container-fluid py-4">
<div class="container-fluid">
    <!-- Page Navigation -->
    {% if navigation %}
    <nav aria-label="breadcrumb" class="mb-3 no-print">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="../index.html">Index</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">{{ page.title }}</li>
        </ol>
    </nav>
    {% endif %}

    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2">{{ page.title|default('Untitled Page') }}</h1>
            <p class="text-muted">
                <a href="{{ page.url }}" target="_blank">
                    {{ page.url }} <i class="bi bi-box-arrow-up-right"></i>
                </a>
            </p>
        </div>
    </div>

    <!-- Page Status Cards -->
    <div class="row mb-4 g-3">
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Status</h6>
                    <p class="mb-0">
                        <span class="badge bg-success">Tested</span>
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Last Tested</h6>
                    <p class="mb-0">
                        {{ page.test_date|default('Recently') }}
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Issues Found</h6>
                    <p class="mb-0">
                        <span class="text-danger fw-bold">{{ errors_count|default(0) }}</span> errors,
                        <span class="text-warning fw-bold">{{ warnings_count|default(0) }}</span> warnings
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Score</h6>
                    <p class="mb-0">
                        {% set score = page.score|default(0) %}
                        <span class="fw-bold {% if score >= 90 %}text-success{% elif score >= 70 %}text-warning{% else %}text-danger{% endif %}">
                            {{ "%.0f"|format(score) }}%
                        </span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Accessibility & Compliance Scores -->
    {% if page.score is defined %}
    <div class="row mb-4">
        <!-- Accessibility Score Card -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body text-center">
                    {% set score = page.score|default(0) %}
                    <h6 class="card-title">Accessibility Score</h6>
                    <div class="display-4 fw-bold {% if score >= 90 %}text-success{% elif score >= 70 %}text-warning{% else %}text-danger{% endif %}">
                        {{ "%.1f"|format(score) }}%
                    </div>
                    <p class="text-muted small mb-0">Based on automated checks</p>
                </div>
            </div>
        </div>

        <!-- Compliance Score Card -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body text-center">
                    <h6 class="card-title">Compliance Score</h6>
                    {% if compliance_score %}
                    <div class="display-4 fw-bold {% if compliance_score.score >= 90 %}text-success{% elif compliance_score.score >= 70 %}text-warning{% else %}text-danger{% endif %}">
                        {{ "%.1f"|format(compliance_score.score) }}%
                    </div>
                    <p class="text-muted small mb-0">{{ compliance_score.passed_tests }} / {{ compliance_score.total_tests }} tests passed</p>
                    {% else %}
                    <div class="display-4 fw-bold text-muted">N/A</div>
                    <p class="text-muted small mb-0">No data available</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Issue Breakdown -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-bug"></i> Issues Found</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-6 col-lg-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-x-circle text-danger me-2 fs-4"></i>
                        <div>
                            <div class="fw-bold">{{ errors_count|default(0) }}</div>
                            <small class="text-muted">Errors</small>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle text-warning me-2 fs-4"></i>
                        <div>
                            <div class="fw-bold">{{ warnings_count|default(0) }}</div>
                            <small class="text-muted">Warnings</small>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-info-circle text-info me-2 fs-4"></i>
                        <div>
                            <div class="fw-bold">{{ info_count|default(0) }}</div>
                            <small class="text-muted">Info</small>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-search" style="color: #6f42c1;" class="me-2 fs-4"></i>
                        <div>
                            <div class="fw-bold">{{ discovery_count|default(0) }}</div>
                            <small class="text-muted">Discovery</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Filter Panel -->
    {% if violations or warnings or informational or discovery %}
    <div class="filter-panel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> Filter Test Results</h5>
            <button class="btn btn-sm btn-outline-secondary" id="clearFilters">
                <i class="bi bi-x-circle"></i> Clear All Filters
            </button>
        </div>

        <!-- Active Filters Display -->
        <div id="activeFilters" class="active-filters" style="display: none;">
            <strong>Active Filters:</strong>
            <div id="activeFilterTags"></div>
        </div>

        <!-- Filter Statistics -->
        <div class="filter-stats">
            <strong>Showing:</strong>
            <span id="visibleCount">0</span> of <span id="totalCount">0</span> items
            | <span id="filterSummary"></span>
        </div>

        <!-- Filter Groups -->
        <div class="row">
            <!-- Issue Type Filter -->
            <div class="col-md-3">
                <div class="filter-group">
                    <label class="form-label fw-bold">Issue Type</label>
                    <div class="filter-chips">
                        <div class="filter-chip" data-filter-type="type" data-filter-value="error">
                            Errors ({{ violations|length }})
                        </div>
                        <div class="filter-chip" data-filter-type="type" data-filter-value="warning">
                            Warnings ({{ warnings|length }})
                        </div>
                        <div class="filter-chip" data-filter-type="type" data-filter-value="info">
                            Info ({{ informational|length }})
                        </div>
                        <div class="filter-chip" data-filter-type="type" data-filter-value="discovery">
                            Discovery ({{ discovery|length }})
                        </div>
                    </div>
                </div>
            </div>

            <!-- Impact Level Filter -->
            <div class="col-md-3">
                <div class="filter-group">
                    <label class="form-label fw-bold">Impact Level</label>
                    <div class="filter-chips">
                        <div class="filter-chip" data-filter-type="impact" data-filter-value="high">
                            <span class="badge bg-danger me-1">High</span>
                            <span id="highImpactCount">0</span>
                        </div>
                        <div class="filter-chip" data-filter-type="impact" data-filter-value="medium">
                            <span class="badge bg-warning text-dark me-1">Medium</span>
                            <span id="mediumImpactCount">0</span>
                        </div>
                        <div class="filter-chip" data-filter-type="impact" data-filter-value="low">
                            <span class="badge bg-info me-1">Low</span>
                            <span id="lowImpactCount">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Touchpoint Filter -->
            <div class="col-md-6">
                <div class="filter-group">
                    <label class="form-label fw-bold">Issue Touchpoint</label>
                    <select class="form-select form-select-sm" id="touchpointFilter" multiple size="3">
                        <option value="">All Touchpoints</option>
                        {% for touchpoint in all_touchpoints %}
                        <option value="{{ touchpoint }}">{{ touchpoint|replace('_', ' ')|title }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- Quick Search -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="quickSearch"
                           placeholder="Search in issue descriptions, error codes, or XPaths...">
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Test Results Card - Match online view exactly -->
    {% if violations or warnings or informational or discovery %}
    <div class="card test-results-card">
        <div class="card-header">
            <h5 class="mb-0">Latest Test Results</h5>
            <small class="text-muted">Tested on {{ page.test_date|default('Recently') }}</small>
        </div>

        <!-- Multi-State Selector -->
        {% if page.states and page.states|length > 1 %}
        <div class="card-body border-bottom bg-light">
            <h6 class="mb-3"><i class="bi bi-layers"></i> Page States Tested</h6>
            <p class="text-muted small mb-3">
                This page was tested in multiple states. Select a state below to view its test results.
            </p>
            <div class="btn-group" role="group" aria-label="Page states">
                {% for state in page.states %}
                    <button type="button"
                            class="btn btn-outline-primary state-selector {% if loop.index0 == 0 %}active{% endif %}"
                            data-state-index="{{ loop.index0 }}"
                            onclick="showState({{ loop.index0 }})">
                        <i class="bi bi-circle-fill" style="font-size: 8px;"></i>
                        {{ state.description }}
                        <br>
                        <small class="state-counts">
                            Errors: {{ state.issues.errors }} | Warnings: {{ state.issues.warnings }}
                        </small>
                    </button>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="card-body">

            {% if page.states and page.states|length > 1 %}
                {# Multi-state: Render each state's results separately #}
                {% for state in page.states %}
                <div class="state-content {% if loop.index0 == 0 %}active{% endif %}" data-state-index="{{ loop.index0 }}">
                    <!-- Errors (Violations) for {{ state.description }} -->
                    {% if state.violations %}
                    <h6 class="text-danger mb-3">
                        <i class="bi bi-x-circle"></i> Errors ({{ state.violations|length }})
                    </h6>
                    <div class="accordion mb-4" id="violationsAccordion_{{ loop.index0 }}">
                        {% set viol_counter = namespace(value=0) %}
                        {% for touchpoint, touchpoint_violations in state.violations|groupby('touchpoint') %}
                            <div class="touchpoint-header mt-3 mb-2 ps-2" style="border-left: 4px solid #dc3545;">
                                <strong>{{ touchpoint|replace('_', ' ')|title }}</strong>
                            </div>

                            {% for error_code, description_group in touchpoint_violations|groupby('id') %}
                                {% set group_list = description_group|list %}
                                {% set viol_counter.value = viol_counter.value + 1 %}
                                {% set first_violation = group_list[0] %}

                                <div class="accordion-item issue-item"
                                     data-type="error"
                                     data-impact="{{ first_violation.impact|lower }}"
                                     data-touchpoint="{{ first_violation.touchpoint|lower }}"
                                     data-id="{{ error_code }}"
                                     data-description="{{ first_violation.metadata.what_generic|lower if first_violation.metadata.what_generic else first_violation.description|lower }}"
                                     data-xpath="{{ first_violation.xpath|lower if first_violation.xpath else '' }}">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#viol_state{{ loop.index0 }}_group_{{ viol_counter.value }}">
                                            {% if group_list|length > 1 %}
                                            <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[first_violation.impact|lower] or 'secondary' }} me-2">{{ group_list|length }}</span>
                                            {% endif %}
                                            <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[first_violation.impact|lower] or 'secondary' }} me-2 impact-badge">
                                                {{ first_violation.impact|upper }}
                                            </span>
                                            <code class="me-2">{{ error_code }}</code>
                                            {{ first_violation.metadata.what_generic if first_violation.metadata.what_generic else first_violation.description }}
                                        </button>
                                    </h2>
                                    <div id="viol_state{{ loop.index0 }}_group_{{ viol_counter.value }}"
                                         class="accordion-collapse collapse">
                                        <div class="accordion-body">
                                            <p><strong>Description:</strong> {{ first_violation.description }}</p>
                                            {% if first_violation.html_snippet %}
                                            <p><strong>HTML:</strong> <code>{{ first_violation.html_snippet }}</code></p>
                                            {% endif %}
                                            {% if first_violation.xpath %}
                                            <p><strong>XPath:</strong> <code>{{ first_violation.xpath }}</code></p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Warnings for {{ state.description }} -->
                    {% if state.warnings %}
                    <h6 class="text-warning mb-3">
                        <i class="bi bi-exclamation-triangle"></i> Warnings ({{ state.warnings|length }})
                    </h6>
                    <div class="accordion mb-4" id="warningsAccordion_{{ loop.index0 }}">
                        {% set warn_counter = namespace(value=0) %}
                        {% for touchpoint, touchpoint_warnings in state.warnings|groupby('touchpoint') %}
                            <div class="touchpoint-header mt-3 mb-2 ps-2" style="border-left: 4px solid #ffc107;">
                                <strong>{{ touchpoint|replace('_', ' ')|title }}</strong>
                            </div>

                            {% for warning_code, description_group in touchpoint_warnings|groupby('id') %}
                                {% set group_list = description_group|list %}
                                {% set warn_counter.value = warn_counter.value + 1 %}
                                {% set first_warning = group_list[0] %}

                                <div class="accordion-item issue-item"
                                     data-type="warning"
                                     data-impact="{{ first_warning.impact|lower }}"
                                     data-touchpoint="{{ first_warning.touchpoint|lower }}"
                                     data-id="{{ warning_code }}"
                                     data-description="{{ first_warning.metadata.what_generic|lower if first_warning.metadata.what_generic else first_warning.description|lower }}"
                                     data-xpath="{{ first_warning.xpath|lower if first_warning.xpath else '' }}">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#warn_state{{ loop.index0 }}_group_{{ warn_counter.value }}">
                                            {% if group_list|length > 1 %}
                                            <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[first_warning.impact|lower] or 'secondary' }} me-2">{{ group_list|length }}</span>
                                            {% endif %}
                                            <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[first_warning.impact|lower] or 'secondary' }} me-2 impact-badge">
                                                {{ first_warning.impact|upper }}
                                            </span>
                                            <code class="me-2">{{ warning_code }}</code>
                                            {{ first_warning.metadata.what_generic if first_warning.metadata.what_generic else first_warning.description }}
                                        </button>
                                    </h2>
                                    <div id="warn_state{{ loop.index0 }}_group_{{ warn_counter.value }}"
                                         class="accordion-collapse collapse">
                                        <div class="accordion-body">
                                            <p><strong>Description:</strong> {{ first_warning.description }}</p>
                                            {% if first_warning.html_snippet %}
                                            <p><strong>HTML:</strong> <code>{{ first_warning.html_snippet }}</code></p>
                                            {% endif %}
                                            {% if first_warning.xpath %}
                                            <p><strong>XPath:</strong> <code>{{ first_warning.xpath }}</code></p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if not state.violations and not state.warnings %}
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> No issues found in this state!
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                {# Single state: Render normally #}
                <!-- Errors (Violations) -->
                {% if violations %}
            <h6 class="text-danger mb-3">
                <i class="bi bi-x-circle"></i> Errors ({{ violations|length }})
            </h6>
            <div class="accordion mb-4" id="violationsAccordion">
                {% set viol_counter = namespace(value=0) %}
                {% for touchpoint, touchpoint_violations in violations|groupby('touchpoint') %}
                    <div class="touchpoint-header mt-3 mb-2 ps-2" style="border-left: 4px solid #dc3545;">
                        <strong>{{ touchpoint|replace('_', ' ')|title }}</strong>
                    </div>

                    {% for error_code, description_group in touchpoint_violations|groupby('id') %}
                        {% set group_list = description_group|list %}
                        {% set viol_counter.value = viol_counter.value + 1 %}
                        {% set first_violation = group_list[0] %}

                        <div class="accordion-item issue-item"
                             data-type="error"
                             data-impact="{{ first_violation.impact|lower }}"
                             data-touchpoint="{{ first_violation.touchpoint|lower }}"
                             data-id="{{ error_code }}"
                             data-description="{{ first_violation.metadata.what_generic|lower if first_violation.metadata.what_generic else first_violation.description|lower }}"
                             data-xpath="{{ first_violation.xpath|lower if first_violation.xpath else '' }}">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#viol-group-{{ viol_counter.value }}">
                                    {% if group_list|length > 1 %}
                                    <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[first_violation.impact|lower] or 'secondary' }} me-2">{{ group_list|length }}</span>
                                    {% endif %}
                                    <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[first_violation.impact|lower] or 'secondary' }} me-2 impact-badge">
                                        {{ first_violation.impact|upper }}
                                    </span>
                                    {% if group_list|length == 1 %}
                                        {# Show user badge for single violations #}
                                        {% if first_violation.metadata and first_violation.metadata.authenticated_user %}
                                            <span class="badge bg-secondary me-2">
                                                <i class="bi bi-person-fill"></i> {{ first_violation.metadata.authenticated_user.display_name }}
                                                {% if first_violation.metadata.authenticated_user.roles %}
                                                    ({{ first_violation.metadata.authenticated_user.roles|join(', ') }})
                                                {% endif %}
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary me-2">
                                                <i class="bi bi-person"></i> Guest
                                            </span>
                                        {% endif %}
                                    {% endif %}
                                    <code class="me-2">{{ error_code }}</code>
                                    {% if group_list|length > 1 %}
                                        {{ first_violation.metadata.what_generic if first_violation.metadata.what_generic else (first_violation.metadata.what if first_violation.metadata.what else error_code) }}
                                    {% else %}
                                        {{ first_violation.metadata.title if first_violation.metadata.title else (first_violation.metadata.what if first_violation.metadata.what else first_violation.description) }}
                                        {% if first_violation.xpath %}
                                        <span class="text-muted ms-2" style="font-size: 0.9em;"> • {{ first_violation.xpath }}</span>
                                        {% endif %}
                                    {% endif %}
                                </button>
                            </h2>
                            <div id="viol-group-{{ viol_counter.value }}"
                                 class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    {% if group_list|length > 1 %}
                                        <!-- Multiple instances - check if we should group by breakpoint -->
                                        {% set has_breakpoints = group_list[0].metadata and group_list[0].metadata.get('breakpoint') is not none %}

                                        {% if has_breakpoints %}
                                            {# Group by breakpoint for contrast violations #}
                                            {% set breakpoint_groups = group_list|groupby('metadata.breakpoint') %}
                                            <div class="accordion" id="viol-group-breakpoints-{{ viol_counter.value }}">
                                            {% for breakpoint, breakpoint_violations in breakpoint_groups %}
                                                {% set breakpoint_list = breakpoint_violations|list %}
                                                {% set breakpoint_id = viol_counter.value ~ '-bp-' ~ (breakpoint if breakpoint else 'none') %}
                                                <div class="accordion-item">
                                                    <h2 class="accordion-header">
                                                        <button class="accordion-button collapsed" type="button"
                                                                data-bs-toggle="collapse"
                                                                data-bs-target="#viol-breakpoint-{{ breakpoint_id }}">
                                                            <span class="badge bg-info me-2">{{ breakpoint_list|length }}</span>
                                                            <strong>Breakpoint: {{ breakpoint }}px width</strong>
                                                        </button>
                                                    </h2>
                                                    <div id="viol-breakpoint-{{ breakpoint_id }}"
                                                         class="accordion-collapse collapse"
                                                         data-bs-parent="#viol-group-breakpoints-{{ viol_counter.value }}">
                                                        <div class="accordion-body">
                                                            <div class="accordion" id="viol-breakpoint-instances-{{ breakpoint_id }}">
                                                            {% for violation in breakpoint_list %}
                                                            {% set instance_id = 'viol-instance-' ~ breakpoint_id ~ '-' ~ loop.index %}
                                                            {% set parent_id = 'viol-breakpoint-instances-' ~ breakpoint_id %}
                                                            {{ render_instance_accordion(violation, instance_id, parent_id, 'danger', loop.index) }}
                                                            {% endfor %}
                                                            </div> {# Close viol-breakpoint-instances #}
                                                        </div> {# Close accordion-body #}
                                                    </div> {# Close viol-breakpoint collapse #}
                                                </div> {# Close accordion-item #}
                                            {% endfor %} {# End breakpoint loop #}
                                            </div> {# Close viol-group-breakpoints #}
                                        {% else %}
                                            {# No breakpoints - use regular instance grouping #}
                                            <div class="accordion" id="viol-group-instances-{{ viol_counter.value }}">
                                            {% for violation in group_list %}
                                            {% set instance_id = 'viol-instance-' ~ viol_counter.value ~ '-' ~ loop.index %}
                                            {% set parent_id = 'viol-group-instances-' ~ viol_counter.value %}
                                            {{ render_instance_accordion(violation, instance_id, parent_id, 'danger', loop.index) }}
                                            {% endfor %}
                                            </div> {# Close viol-group-instances #}
                                        {% endif %}
                                    {% else %}
                                        <!-- Single instance - show directly -->
                                        {{ render_violation_details(group_list[0], 'danger') }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% endfor %}
            </div>
            {% endif %}

            <!-- Warnings -->
            {% if warnings %}
            <h6 class="text-warning mb-3">
                <i class="bi bi-exclamation-triangle"></i> Warnings ({{ warnings|length }})
            </h6>
            <div class="accordion mb-4" id="warningsAccordion">
                {% set warn_counter = namespace(value=0) %}
                {% for touchpoint, touchpoint_warnings in warnings|groupby('touchpoint') %}
                    <div class="touchpoint-header mt-3 mb-2 ps-2" style="border-left: 4px solid #ffc107;">
                        <strong>{{ touchpoint|replace('_', ' ')|title }}</strong>
                    </div>

                    {% for error_code, description_group in touchpoint_warnings|groupby('id') %}
                        {% set group_list = description_group|list %}
                        {% set warn_counter.value = warn_counter.value + 1 %}
                        {% set first_warning = group_list[0] %}

                        <div class="accordion-item issue-item"
                             data-type="warning"
                             data-impact="{{ first_warning.impact|lower }}"
                             data-touchpoint="{{ first_warning.touchpoint|lower }}"
                             data-id="{{ error_code }}"
                             data-description="{{ first_warning.metadata.what_generic|lower if first_warning.metadata.what_generic else first_warning.description|lower }}"
                             data-xpath="{{ first_warning.xpath|lower if first_warning.xpath else '' }}">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#warn-group-{{ warn_counter.value }}">
                                    {% if group_list|length > 1 %}
                                    <span class="badge bg-warning me-2">{{ group_list|length }}</span>
                                    {% endif %}
                                    <span class="badge bg-{{ {'high': 'danger', 'medium': 'warning', 'low': 'info'}[first_warning.impact|lower] or 'secondary' }} me-2 impact-badge">
                                        {{ first_warning.impact|upper }}
                                    </span>
                                    {% if group_list|length == 1 %}
                                        {# Show user badge for single warnings #}
                                        {% if first_warning.metadata and first_warning.metadata.authenticated_user %}
                                            <span class="badge bg-secondary me-2">
                                                <i class="bi bi-person-fill"></i> {{ first_warning.metadata.authenticated_user.display_name }}
                                                {% if first_warning.metadata.authenticated_user.roles %}
                                                    ({{ first_warning.metadata.authenticated_user.roles|join(', ') }})
                                                {% endif %}
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary me-2">
                                                <i class="bi bi-person"></i> Guest
                                            </span>
                                        {% endif %}
                                    {% endif %}
                                    <code class="me-2">{{ error_code }}</code>
                                    {% if group_list|length > 1 %}
                                        {{ first_warning.metadata.what_generic if first_warning.metadata.what_generic else (first_warning.metadata.what if first_warning.metadata.what else error_code) }}
                                    {% else %}
                                        {{ first_warning.metadata.title if first_warning.metadata.title else (first_warning.metadata.what if first_warning.metadata.what else first_warning.description) }}
                                        {% if first_warning.xpath %}
                                        <span class="text-muted ms-2" style="font-size: 0.9em;"> • {{ first_warning.xpath }}</span>
                                        {% endif %}
                                    {% endif %}
                                </button>
                            </h2>
                            <div id="warn-group-{{ warn_counter.value }}"
                                 class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    {% if group_list|length > 1 %}
                                        {% set has_breakpoints = group_list[0].metadata and group_list[0].metadata.get('breakpoint') is not none %}

                                        {% if has_breakpoints %}
                                            {# Group by breakpoint for contrast violations #}
                                            {% set breakpoint_groups = group_list|groupby('metadata.breakpoint') %}
                                            <div class="accordion" id="warn-group-breakpoints-{{ warn_counter.value }}">
                                            {% for breakpoint, breakpoint_violations in breakpoint_groups %}
                                                {% set breakpoint_list = breakpoint_violations|list %}
                                                {% set breakpoint_id = warn_counter.value ~ '-bp-' ~ (breakpoint if breakpoint else 'none') %}
                                                <div class="accordion-item">
                                                    <h2 class="accordion-header">
                                                        <button class="accordion-button collapsed" type="button"
                                                                data-bs-toggle="collapse"
                                                                data-bs-target="#warn-breakpoint-{{ breakpoint_id }}">
                                                            <span class="badge bg-info me-2">{{ breakpoint_list|length }}</span>
                                                            <strong>Breakpoint: {{ breakpoint }}px width</strong>
                                                        </button>
                                                    </h2>
                                                    <div id="warn-breakpoint-{{ breakpoint_id }}"
                                                         class="accordion-collapse collapse"
                                                         data-bs-parent="#warn-group-breakpoints-{{ warn_counter.value }}">
                                                        <div class="accordion-body">
                                                            <div class="accordion" id="warn-breakpoint-instances-{{ breakpoint_id }}">
                                                            {% for warning in breakpoint_list %}
                                                            {% set instance_id = 'warn-instance-' ~ breakpoint_id ~ '-' ~ loop.index %}
                                                            {% set parent_id = 'warn-breakpoint-instances-' ~ breakpoint_id %}
                                                            {{ render_instance_accordion(warning, instance_id, parent_id, 'warning', loop.index) }}
                                                            {% endfor %}
                                                            </div> {# Close warn-breakpoint-instances #}
                                                        </div> {# Close accordion-body #}
                                                    </div> {# Close warn-breakpoint collapse #}
                                                </div> {# Close accordion-item #}
                                            {% endfor %} {# End breakpoint loop #}
                                            </div> {# Close warn-group-breakpoints #}
                                        {% else %}
                                            {# No breakpoints - use regular instance grouping #}
                                            <div class="accordion" id="warn-group-instances-{{ warn_counter.value }}">
                                            {% for warning in group_list %}
                                            {% set instance_id = 'warn-instance-' ~ warn_counter.value ~ '-' ~ loop.index %}
                                            {% set parent_id = 'warn-group-instances-' ~ warn_counter.value %}
                                            {{ render_instance_accordion(warning, instance_id, parent_id, 'warning', loop.index) }}
                                            {% endfor %}
                                            </div> {# Close warn-group-instances #}
                                        {% endif %}
                                    {% else %}
                                        {{ render_violation_details(group_list[0], 'warning') }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% endfor %}
            </div>
            {% endif %}

            <!-- Informational -->
            {% if informational %}
            <h6 class="text-info mb-3">
                <i class="bi bi-info-circle"></i> Informational ({{ informational|length }})
            </h6>
            <div class="accordion mb-4" id="infoAccordion">
                {% set info_counter = namespace(value=0) %}
                {% for touchpoint, touchpoint_info in informational|groupby('touchpoint') %}
                    <div class="touchpoint-header mt-3 mb-2 ps-2" style="border-left: 4px solid #0dcaf0;">
                        <strong>{{ touchpoint|replace('_', ' ')|title }}</strong>
                    </div>

                    {% for error_code, description_group in touchpoint_info|groupby('id') %}
                        {% set group_list = description_group|list %}
                        {% set info_counter.value = info_counter.value + 1 %}
                        {% set first_info = group_list[0] %}

                        <div class="accordion-item issue-item"
                             data-type="info"
                             data-impact="{{ first_info.impact|lower }}"
                             data-touchpoint="{{ first_info.touchpoint|lower }}"
                             data-id="{{ error_code }}"
                             data-description="{{ first_info.metadata.what_generic|lower if first_info.metadata.what_generic else first_info.description|lower }}"
                             data-xpath="{{ first_info.xpath|lower if first_info.xpath else '' }}">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#info-group-{{ info_counter.value }}">
                                    {% if group_list|length > 1 %}
                                    <span class="badge bg-info me-2">{{ group_list|length }}</span>
                                    {% endif %}
                                    {% if group_list|length == 1 %}
                                        {# Show user badge for single info items #}
                                        {% if first_info.metadata and first_info.metadata.authenticated_user %}
                                            <span class="badge bg-secondary me-2">
                                                <i class="bi bi-person-fill"></i> {{ first_info.metadata.authenticated_user.display_name }}
                                                {% if first_info.metadata.authenticated_user.roles %}
                                                    ({{ first_info.metadata.authenticated_user.roles|join(', ') }})
                                                {% endif %}
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary me-2">
                                                <i class="bi bi-person"></i> Guest
                                            </span>
                                        {% endif %}
                                    {% endif %}
                                    <code class="me-2">{{ error_code }}</code>
                                    {% if group_list|length > 1 %}
                                        {{ first_info.metadata.what_generic if first_info.metadata.what_generic else (first_info.metadata.what if first_info.metadata.what else error_code) }}
                                    {% else %}
                                        {{ first_info.metadata.title if first_info.metadata.title else (first_info.metadata.what if first_info.metadata.what else first_info.description) }}
                                        {% if first_info.xpath %}
                                        <span class="text-muted ms-2" style="font-size: 0.9em;"> • {{ first_info.xpath }}</span>
                                        {% endif %}
                                    {% endif %}
                                </button>
                            </h2>
                            <div id="info-group-{{ info_counter.value }}"
                                 class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    {% if group_list|length > 1 %}
                                        <div class="accordion" id="info-group-instances-{{ info_counter.value }}">
                                            {% for info_item in group_list %}
                                            {% set instance_id = info_counter.value ~ '-' ~ loop.index %}
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed" type="button"
                                                            data-bs-toggle="collapse"
                                                            data-bs-target="#info-instance-{{ instance_id }}">
                                                        <strong>Instance {{ loop.index }}:</strong>
                                                        {% if info_item.metadata and info_item.metadata.authenticated_user %}
                                                            <span class="badge bg-secondary ms-2">
                                                                <i class="bi bi-person-fill"></i> {{ info_item.metadata.authenticated_user.display_name }}
                                                                {% if info_item.metadata.authenticated_user.roles %}
                                                                    ({{ info_item.metadata.authenticated_user.roles|join(', ') }})
                                                                {% endif %}
                                                            </span>
                                                        {% else %}
                                                            <span class="badge bg-secondary ms-2">
                                                                <i class="bi bi-person"></i> Guest
                                                            </span>
                                                        {% endif %}
                                                        {% if info_item.xpath %}
                                                        <code class="ms-2">{{ info_item.xpath }}</code>
                                                        {% endif %}
                                                    </button>
                                                </h2>
                                                <div id="info-instance-{{ instance_id }}"
                                                     class="accordion-collapse collapse"
                                                     data-bs-parent="#info-group-instances-{{ info_counter.value }}">
                                                    <div class="accordion-body">
                                                        {{ render_violation_details(info_item, 'info') }}
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        {{ render_violation_details(group_list[0], 'info') }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% endfor %}
            </div>
            {% endif %}

            <!-- Discovery Items -->
            {% if discovery %}
            <h6 class="text-secondary mb-3">
                <i class="bi bi-lightbulb"></i> Discovery ({{ discovery|length }})
            </h6>
            <div class="accordion mb-4" id="discoveryAccordion">
                {% set disco_counter = namespace(value=0) %}
                {% for touchpoint, touchpoint_disco in discovery|groupby('touchpoint') %}
                    <div class="touchpoint-header mt-3 mb-2 ps-2" style="border-left: 4px solid #6c757d;">
                        <strong>{{ touchpoint|replace('_', ' ')|title }}</strong>
                    </div>

                    {% for error_code, description_group in touchpoint_disco|groupby('id') %}
                        {% set group_list = description_group|list %}
                        {% set disco_counter.value = disco_counter.value + 1 %}
                        {% set first_disco = group_list[0] %}

                        <div class="accordion-item issue-item"
                             data-type="discovery"
                             data-impact="{{ first_disco.impact|lower if first_disco.impact else 'low' }}"
                             data-touchpoint="{{ first_disco.touchpoint|lower }}"
                             data-id="{{ error_code }}"
                             data-description="{{ first_disco.metadata.what_generic|lower if first_disco.metadata.what_generic else first_disco.description|lower }}"
                             data-xpath="{{ first_disco.xpath|lower if first_disco.xpath else '' }}">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#disco-group-{{ disco_counter.value }}">
                                    {% if group_list|length > 1 %}
                                    <span class="badge bg-secondary me-2">{{ group_list|length }}</span>
                                    {% endif %}
                                    {% if group_list|length == 1 %}
                                        {# Show user badge for single discovery items #}
                                        {% if first_disco.metadata and first_disco.metadata.authenticated_user %}
                                            <span class="badge bg-secondary me-2">
                                                <i class="bi bi-person-fill"></i> {{ first_disco.metadata.authenticated_user.display_name }}
                                                {% if first_disco.metadata.authenticated_user.roles %}
                                                    ({{ first_disco.metadata.authenticated_user.roles|join(', ') }})
                                                {% endif %}
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary me-2">
                                                <i class="bi bi-person"></i> Guest
                                            </span>
                                        {% endif %}
                                    {% endif %}
                                    <code class="me-2">{{ error_code }}</code>
                                    {% if group_list|length > 1 %}
                                        {{ first_disco.metadata.what_generic if first_disco.metadata.what_generic else (first_disco.metadata.what if first_disco.metadata.what else error_code) }}
                                    {% else %}
                                        {{ first_disco.metadata.title if first_disco.metadata.title else (first_disco.metadata.what if first_disco.metadata.what else first_disco.description) }}
                                        {% if first_disco.xpath %}
                                        <span class="text-muted ms-2" style="font-size: 0.9em;"> • {{ first_disco.xpath }}</span>
                                        {% endif %}
                                    {% endif %}
                                </button>
                            </h2>
                            <div id="disco-group-{{ disco_counter.value }}"
                                 class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    {% if group_list|length > 1 %}
                                        <div class="accordion" id="disco-group-instances-{{ disco_counter.value }}">
                                            {% for disco_item in group_list %}
                                            {% set instance_id = disco_counter.value ~ '-' ~ loop.index %}
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed" type="button"
                                                            data-bs-toggle="collapse"
                                                            data-bs-target="#disco-instance-{{ instance_id }}">
                                                        <strong>Instance {{ loop.index }}:</strong>
                                                        {% if disco_item.metadata and disco_item.metadata.authenticated_user %}
                                                            <span class="badge bg-secondary ms-2">
                                                                <i class="bi bi-person-fill"></i> {{ disco_item.metadata.authenticated_user.display_name }}
                                                                {% if disco_item.metadata.authenticated_user.roles %}
                                                                    ({{ disco_item.metadata.authenticated_user.roles|join(', ') }})
                                                                {% endif %}
                                                            </span>
                                                        {% else %}
                                                            <span class="badge bg-secondary ms-2">
                                                                <i class="bi bi-person"></i> Guest
                                                            </span>
                                                        {% endif %}
                                                        {% if disco_item.xpath %}
                                                        <code class="ms-2">{{ disco_item.xpath }}</code>
                                                        {% endif %}
                                                    </button>
                                                </h2>
                                                <div id="disco-instance-{{ instance_id }}"
                                                     class="accordion-collapse collapse"
                                                     data-bs-parent="#disco-group-instances-{{ disco_counter.value }}">
                                                    <div class="accordion-body">
                                                        {{ render_violation_details(disco_item, 'secondary') }}
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        {{ render_violation_details(group_list[0], 'secondary') }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% endfor %}
            </div>
            {% endif %}
            {% endif %} {# End of single-state / multi-state conditional #}

        </div>
    </div>
    {% else %}
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
            <h3 class="mt-3">No Issues Found</h3>
            <p class="text-muted">This page passed all automated accessibility tests.</p>
        </div>
    </div>
    {% endif %}

    <!-- Page Screenshot Thumbnail -->
    {% if page.screenshot_path %}
    <div class="card mt-4">
        <div class="card-body">
            <h6 class="mb-3">Page Thumbnail (at time of test)</h6>
            <a href="../assets/images/screenshots/{{ page.screenshot_path.split('/')[-1] }}" target="_blank">
                <img src="../assets/images/screenshots/{{ page.screenshot_path.split('/')[-1] }}"
                     alt="Screenshot of {{ page.url }}"
                     class="img-thumbnail"
                     style="max-width: 300px; height: auto; cursor: pointer;"
                     onerror="this.parentElement.innerHTML='<span class=\'text-muted\'>Screenshot not available</span>'">
            </a>
        </div>
    </div>
    {% endif %}
</div>

</div>
</main>

<!-- Footer -->
<footer class="mt-auto bg-light border-top py-3">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-6">
                <p class="text-muted mb-0">
                    <strong>Generated:</strong> {{ generation_date|default('N/A') }}
                </p>
                <p class="text-muted mb-0">
                    <strong>Project:</strong> {{ project_name|default('Unknown') }}
                </p>
            </div>
            <div class="col-md-6 text-md-end">
                <p class="text-muted mb-0">
                    <strong>WCAG Level:</strong> {{ wcag_level|default('AA') }}
                </p>
                <p class="text-muted mb-0">
                    Generated by <strong>Auto A11y</strong>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- Inlined Bootstrap JavaScript -->
<script>
{{ bootstrap_js|safe }}
</script>

<!-- Inlined Filters JavaScript -->
<script>
{{ filters_js|safe }}
</script>

<!-- Page-specific JavaScript -->
<script>
// Copy XPath to clipboard
function copyXpathToClipboard(xpath, button) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(xpath).then(function() {
            const icon = button.querySelector('i');
            const originalClass = icon.className;
            icon.className = 'bi bi-check';
            button.classList.add('text-success');

            setTimeout(function() {
                icon.className = originalClass;
                button.classList.remove('text-success');
            }, 2000);
        }).catch(function(err) {
            alert('Could not copy to clipboard');
        });
    } else {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = xpath;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            alert('XPath copied to clipboard');
        } catch (err) {
            alert('Could not copy to clipboard');
        }
        document.body.removeChild(textArea);
    }
}

// Multi-state result switcher
function showState(stateIndex) {
    // Hide all state content sections
    document.querySelectorAll('.state-content').forEach(function(content) {
        content.classList.remove('active');
    });

    // Show selected state content
    const selectedContent = document.querySelector(`.state-content[data-state-index="${stateIndex}"]`);
    if (selectedContent) {
        selectedContent.classList.add('active');
    }

    // Update button states
    document.querySelectorAll('.state-selector').forEach(function(btn) {
        btn.classList.remove('active');
    });
    document.querySelector(`.state-selector[data-state-index="${stateIndex}"]`)?.classList.add('active');
}

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>

</body>
</html>
