<!DOCTYPE html>
<html lang="{{ language }}" data-current-lang="{{ language }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="non_component_issues">{{ t['non_component_issues'] }}: {{ page.title|default('Untitled Page') }}</title>
    <link rel="stylesheet" href="{{ asset_path }}css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ asset_path }}css/bootstrap-icons.css">
    <style>
    .touchpoint-header {
        background-color: #f8f9fa;
        padding: 8px;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
        padding-left: 0.5rem;
    }

    .impact-badge {
        min-width: 75px;
        display: inline-block;
        text-align: center;
    }

    .accordion-button {
        padding-left: 2.5rem;
        padding-right: 1.25rem;
    }

    .accordion-button::after {
        position: absolute;
        left: 1rem;
        right: auto;
        transform: rotate(-90deg);
        transition: transform 0.2s ease-in-out;
    }

    .accordion-button:not(.collapsed)::after {
        transform: rotate(0deg);
    }

    .accordion-button > * {
        margin-left: 0.5rem;
    }

    .accordion-button > *:first-child {
        margin-left: 0;
    }

    .breadcrumb {
        background-color: #f8f9fa;
        padding: 0.75rem 1rem;
        border-radius: 0.375rem;
    }

    .card {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }

    .card-body {
        padding: 1rem;
    }

    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 0.75rem 1rem;
    }

    /* Filter Panel Styling */
    .filter-panel {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .filter-group {
        margin-bottom: 1rem;
    }

    .filter-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .filter-chip {
        padding: 0.25rem 0.75rem;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.875rem;
    }

    .filter-chip:hover {
        background: #e9ecef;
    }

    .filter-chip.active {
        background: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }

    .active-filters {
        padding: 1rem;
        background: #e7f3ff;
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .active-filter-tag {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        background: #0d6efd;
        color: white;
        border-radius: 15px;
        margin: 0.25rem;
        font-size: 0.875rem;
    }

    .active-filter-tag .remove-filter {
        margin-left: 0.5rem;
        cursor: pointer;
    }

    .filter-stats {
        padding: 0.75rem;
        background: white;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        margin-bottom: 1rem;
    }

    .issue-item {
        transition: opacity 0.3s;
    }

    .issue-item.filtered-out {
        display: none;
    }

    .test-results-card {
        margin-bottom: 2rem;
    }
    </style>
</head>
<body>
<div class="container py-4">
    <!-- Page Navigation with Language Switcher -->
    <nav aria-label="breadcrumb" class="mb-3 no-print">
        <div class="d-flex justify-content-between align-items-center">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item">
                    <a href="../index.html" data-i18n="index">{{ t['index'] }}</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">{{ page.title|default('Untitled Page') }}</li>
            </ol>
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="languageDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-translate"></i> <span data-i18n="language">{{ t['language'] }}</span>: <span id="current-lang-display">{{ language.upper() }}</span>
                </button>
                <ul class="dropdown-menu" aria-labelledby="languageDropdown">
                    <li><a class="dropdown-item" href="#" onclick="switchLanguage('en'); return false;">English</a></li>
                    <li><a class="dropdown-item" href="#" onclick="switchLanguage('fr'); return false;">Fran√ßais</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2">{{ page.title|default('Untitled Page') }}</h1>
            <p class="text-muted">
                <a href="{{ page.url }}" target="_blank">
                    {{ page.url }} <i class="bi bi-box-arrow-up-right"></i>
                </a>
            </p>
        </div>
    </div>

    <!-- Page Status Cards -->
    <div class="row mb-4 g-3">
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted" data-i18n="status">{{ t['status'] }}</h6>
                    <p class="mb-0">
                        <span class="badge bg-success" data-i18n="tested">{{ t['tested'] }}</span>
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted" data-i18n="last_tested">{{ t['last_tested'] }}</h6>
                    <p class="mb-0">
                        {{ page.test_date|default('Recently') }}
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted" data-i18n="issues_found">{{ t['issues_found'] }}</h6>
                    <p class="mb-0">
                        <span class="text-danger fw-bold">{{ errors_count|default(0) }}</span> <span data-i18n="errors">{{ t['errors'] }}</span>,
                        <span class="text-warning fw-bold">{{ warnings_count|default(0) }}</span> <span data-i18n="warnings">{{ t['warnings'] }}</span>
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted" data-i18n="score">{{ t['score'] }}</h6>
                    <p class="mb-0">
                        {% set score = page.score|default(0) %}
                        <span class="fw-bold {% if score >= 90 %}text-success{% elif score >= 70 %}text-warning{% else %}text-danger{% endif %}">
                            {{ "%.0f"|format(score) }}%
                        </span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Accessibility & Compliance Scores -->
    {% if page.score is defined %}
    <div class="row mb-4">
        <!-- Accessibility Score Card -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body text-center">
                    {% set score = page.score|default(0) %}
                    <h6 class="card-title" data-i18n="full_page_accessibility_score">{{ t['full_page_accessibility_score'] }}</h6>
                    <div class="display-4 fw-bold {% if score >= 90 %}text-success{% elif score >= 70 %}text-warning{% else %}text-danger{% endif %}">
                        {{ "%.1f"|format(score) }}%
                    </div>
                    <p class="text-muted small mb-0" data-i18n="all_issues_full_page">{{ t['all_issues_full_page'] }}</p>
                </div>
            </div>
        </div>

        <!-- Deduplicated Score Card -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body text-center">
                    {% set dscore = dedup_score|default(0) %}
                    <h6 class="card-title" data-i18n="non_component_issues_score">{{ t['non_component_issues_score'] }}</h6>
                    <div class="display-4 fw-bold {% if dscore >= 90 %}text-success{% elif dscore >= 70 %}text-warning{% else %}text-danger{% endif %}">
                        {{ "%.1f"|format(dscore) }}%
                    </div>
                    <p class="text-muted small mb-0" data-i18n="issues_not_in_components">{{ t['issues_not_in_components'] }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <!-- Compliance Score Card -->
        <div class="col-md-12">
            <div class="card h-100">
                <div class="card-body text-center">
                    <h6 class="card-title" data-i18n="compliance_score">{{ t['compliance_score'] }}</h6>
                    {% if compliance_score %}
                    <div class="display-4 fw-bold {% if compliance_score.score >= 90 %}text-success{% elif compliance_score.score >= 70 %}text-warning{% else %}text-danger{% endif %}">
                        {{ "%.1f"|format(compliance_score.score) }}%
                    </div>
                    <p class="text-muted small mb-0">{{ compliance_score.passed_tests }} / {{ compliance_score.total_tests }} <span data-i18n="tests_passed">{{ t['tests_passed'] }}</span></p>
                    {% else %}
                    <div class="display-4 fw-bold text-muted">N/A</div>
                    <p class="text-muted small mb-0" data-i18n="no_data_available">{{ t['no_data_available'] }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Issue Breakdown -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-bug"></i> <span data-i18n="issues_found_non_component_only">{{ t['issues_found_non_component_only'] }}</span></h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-6 col-lg-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-x-circle text-danger me-2 fs-4"></i>
                        <div>
                            <div class="fw-bold">{{ errors_count|default(0) }}</div>
                            <small class="text-muted" data-i18n="errors">{{ t['errors'] }}</small>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle text-warning me-2 fs-4"></i>
                        <div>
                            <div class="fw-bold">{{ warnings_count|default(0) }}</div>
                            <small class="text-muted" data-i18n="warnings">{{ t['warnings'] }}</small>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-info-circle text-info me-2 fs-4"></i>
                        <div>
                            <div class="fw-bold">{{ info_count|default(0) }}</div>
                            <small class="text-muted" data-i18n="info">{{ t['info'] }}</small>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-search" style="color: #6f42c1;" class="me-2 fs-4"></i>
                        <div>
                            <div class="fw-bold">{{ discovery_count|default(0) }}</div>
                            <small class="text-muted" data-i18n="discovery">{{ t['discovery'] }}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Filter Panel -->
    {% if violations or warnings or info or discovery %}
    <div class="filter-panel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> <span data-i18n="filter_test_results">{{ t['filter_test_results'] }}</span></h5>
            <button class="btn btn-sm btn-outline-secondary" id="clearFilters">
                <i class="bi bi-x-circle"></i> <span data-i18n="clear_all_filters">{{ t['clear_all_filters'] }}</span>
            </button>
        </div>

        <!-- Active Filters Display -->
        <div id="activeFilters" class="active-filters" style="display: none;">
            <strong data-i18n="active_filters">{{ t['active_filters'] }}</strong>
            <div id="activeFilterTags"></div>
        </div>

        <!-- Filter Statistics -->
        <div class="filter-stats">
            <strong data-i18n="showing">{{ t['showing'] }}</strong>
            <span id="visibleCount">0</span> <span data-i18n="of">{{ t['of'] }}</span> <span id="totalCount">0</span> <span data-i18n="items">{{ t['items'] }}</span>
            | <span id="filterSummary"></span>
        </div>

        <!-- Filter Groups -->
        <div class="row">
            <!-- Issue Type Filter -->
            <div class="col-md-3">
                <div class="filter-group">
                    <label class="form-label fw-bold" data-i18n="issue_type">{{ t['issue_type'] }}</label>
                    <div class="filter-chips">
                        {% if violations %}
                        <div class="filter-chip" data-filter-type="type" data-filter-value="error">
                            <span data-i18n="errors">{{ t['errors'] }}</span> ({{ violations|length }})
                        </div>
                        {% endif %}
                        {% if warnings %}
                        <div class="filter-chip" data-filter-type="type" data-filter-value="warning">
                            <span data-i18n="warnings">{{ t['warnings'] }}</span> ({{ warnings|length }})
                        </div>
                        {% endif %}
                        {% if info %}
                        <div class="filter-chip" data-filter-type="type" data-filter-value="info">
                            <span data-i18n="info">{{ t['info'] }}</span> ({{ info|length }})
                        </div>
                        {% endif %}
                        {% if discovery %}
                        <div class="filter-chip" data-filter-type="type" data-filter-value="discovery">
                            <span data-i18n="discovery">{{ t['discovery'] }}</span> ({{ discovery|length }})
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Impact Level Filter -->
            <div class="col-md-3">
                <div class="filter-group">
                    <label class="form-label fw-bold" data-i18n="impact_level">{{ t['impact_level'] }}</label>
                    <div class="filter-chips">
                        <div class="filter-chip" data-filter-type="impact" data-filter-value="high">
                            <span class="badge bg-danger me-1" data-i18n="high">{{ t['high'] }}</span>
                            <span id="highImpactCount">0</span>
                        </div>
                        <div class="filter-chip" data-filter-type="impact" data-filter-value="medium">
                            <span class="badge bg-warning text-dark me-1" data-i18n="medium">{{ t['medium'] }}</span>
                            <span id="mediumImpactCount">0</span>
                        </div>
                        <div class="filter-chip" data-filter-type="impact" data-filter-value="low">
                            <span class="badge bg-info me-1" data-i18n="low">{{ t['low'] }}</span>
                            <span id="lowImpactCount">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Touchpoint Filter -->
            <div class="col-md-6">
                <div class="filter-group">
                    <label class="form-label fw-bold" data-i18n="issue_touchpoint">{{ t['issue_touchpoint'] }}</label>
                    <select class="form-select form-select-sm" id="touchpointFilter" multiple size="3">
                        <option value="" data-i18n="all_touchpoints">{{ t['all_touchpoints'] }}</option>
                        {% set all_issues = violations + warnings + info + discovery %}
                        {% set touchpoints = all_issues|map(attribute='touchpoint')|unique|sort %}
                        {% for touchpoint in touchpoints %}
                        <option value="{{ touchpoint }}">{{ touchpoint|replace('_', ' ')|title if touchpoint else 'General' }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- Quick Search -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="quickSearch"
                           data-i18n-placeholder="search_in_issues" placeholder="{{ t['search_in_issues'] }}">
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Test Results -->
    <div class="card test-results-card mt-4">
        <div class="card-header">
            <h5 class="mb-0" data-i18n="non_component_issues_for_this_page">{{ t['non_component_issues_for_this_page'] }}</h5>
            <small class="text-muted" data-i18n="issues_not_part_of_common_components">{{ t['issues_not_part_of_common_components'] }}</small>
        </div>
        <div class="card-body">

    <!-- Violations -->
    {% if violations %}
    <h6 class="text-danger mb-3">
        <i class="bi bi-x-circle"></i> <span data-i18n="errors">{{ t['errors'] }}</span> ({{ violations|length }})
    </h6>
    <div class="accordion mb-4" id="violationsAccordion">
        {% set viol_counter = namespace(value=0) %}
        {% for touchpoint, touchpoint_violations in violations|groupby('touchpoint') %}
            <div class="touchpoint-header mt-3 mb-2 ps-2" style="border-left: 4px solid #dc3545;">
                <strong>{{ touchpoint|replace('_', ' ')|title if touchpoint else 'General' }}</strong>
            </div>

            {% for error_code, description_group in touchpoint_violations|groupby('id') %}
                {% set group_list = description_group|list %}
                {% set viol_counter.value = viol_counter.value + 1 %}
                {% set first_violation = group_list[0] %}
                {% set impact_text = first_violation.impact|string|replace('IMPACT_LEVEL.', '')|replace('ImpactLevel.', '') %}

                <div class="accordion-item mb-2 issue-item"
                     data-type="error"
                     data-impact="{{ impact_text|lower }}"
                     data-touchpoint="{{ touchpoint|lower }}"
                     data-id="{{ error_code }}"
                     data-description="{{ first_violation.metadata.what_generic|lower if first_violation.metadata and first_violation.metadata.what_generic else first_violation.description|lower }}"
                     data-xpath="{{ first_violation.xpath|lower if first_violation.xpath else '' }}">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#viol-{{ viol_counter.value }}">
                            {% if group_list|length > 1 %}
                            <span class="badge bg-{{ {'high': 'danger', 'serious': 'danger', 'critical': 'danger', 'medium': 'warning', 'moderate': 'warning', 'low': 'info', 'minor': 'info'}[impact_text|lower] or 'secondary' }} me-2">{{ group_list|length }}</span>
                            {% endif %}
                            <span class="badge bg-{{ {'high': 'danger', 'serious': 'danger', 'critical': 'danger', 'medium': 'warning', 'moderate': 'warning', 'low': 'info', 'minor': 'info'}[impact_text|lower] or 'secondary' }} me-2 impact-badge">
                                {{ impact_text|upper }}
                            </span>
                            <code class="me-2">{{ error_code }}</code>
                            {{ first_violation.metadata.what_generic if first_violation.metadata and first_violation.metadata.what_generic else first_violation.description }}
                        </button>
                    </h2>
                    <div id="viol-{{ viol_counter.value }}" class="accordion-collapse collapse" data-bs-parent="#violationsAccordion">
                        <div class="accordion-body">
                            {% if group_list|length > 1 %}
                            <!-- Multiple instances - show nested accordion -->
                            <div class="accordion" id="viol_instances_{{ viol_counter.value }}">
                                {% for instance in group_list %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#viol_inst_{{ viol_counter.value }}_{{ loop.index }}">
                                            <strong data-i18n="instance">{{ t['instance'] }}</strong> {{ loop.index }}:
                                            {% if instance.metadata and instance.metadata.authenticated_user %}
                                                <span class="badge bg-secondary ms-2">
                                                    <i class="bi bi-person-fill"></i> {{ instance.metadata.authenticated_user.display_name }}
                                                    {% if instance.metadata.authenticated_user.roles %}
                                                        ({{ instance.metadata.authenticated_user.roles|join(', ') }})
                                                    {% endif %}
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary ms-2">
                                                    <i class="bi bi-person"></i> <span data-i18n="guest">{{ t['guest'] }}</span>
                                                </span>
                                            {% endif %}
                                            {% if instance.xpath %}
                                            <code class="ms-2">{{ instance.xpath }}</code>
                                            {% endif %}
                                        </button>
                                    </h2>
                                    <div id="viol_inst_{{ viol_counter.value }}_{{ loop.index }}"
                                         class="accordion-collapse collapse"
                                         data-bs-parent="#viol_instances_{{ viol_counter.value }}">
                                        <div class="accordion-body">
                                            {% include 'static_report/violation_details.html' %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <!-- Single instance - show details directly -->
                            {% set violation = first_violation %}
                            {% set alert_type = 'danger' %}
                            {% include 'static_report/violation_details.html' %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
    </div>
    {% endif %}

    <!-- Warnings -->
    {% if warnings %}
    <h6 class="text-warning mb-3">
        <i class="bi bi-exclamation-triangle"></i> <span data-i18n="warnings">{{ t['warnings'] }}</span> ({{ warnings|length }})
    </h6>
    <div class="accordion mb-4" id="warningsAccordion">
        {% set warn_counter = namespace(value=0) %}
        {% for touchpoint, touchpoint_warnings in warnings|groupby('touchpoint') %}
            <div class="touchpoint-header mt-3 mb-2 ps-2" style="border-left: 4px solid #ffc107;">
                <strong>{{ touchpoint|replace('_', ' ')|title if touchpoint else 'General' }}</strong>
            </div>

            {% for warning_code, description_group in touchpoint_warnings|groupby('id') %}
                {% set group_list = description_group|list %}
                {% set warn_counter.value = warn_counter.value + 1 %}
                {% set first_warning = group_list[0] %}
                {% set impact_text = first_warning.impact|string|replace('IMPACT_LEVEL.', '')|replace('ImpactLevel.', '') %}

                <div class="accordion-item mb-2 issue-item"
                     data-type="warning"
                     data-impact="{{ impact_text|lower }}"
                     data-touchpoint="{{ touchpoint|lower }}"
                     data-id="{{ warning_code }}"
                     data-description="{{ first_warning.metadata.what_generic|lower if first_warning.metadata and first_warning.metadata.what_generic else first_warning.description|lower }}"
                     data-xpath="{{ first_warning.xpath|lower if first_warning.xpath else '' }}">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#warn-{{ warn_counter.value }}">
                            {% if group_list|length > 1 %}
                            <span class="badge bg-{{ {'high': 'danger', 'serious': 'danger', 'critical': 'danger', 'medium': 'warning', 'moderate': 'warning', 'low': 'info', 'minor': 'info'}[impact_text|lower] or 'warning' }} me-2">{{ group_list|length }}</span>
                            {% endif %}
                            <span class="badge bg-{{ {'high': 'danger', 'serious': 'danger', 'critical': 'danger', 'medium': 'warning', 'moderate': 'warning', 'low': 'info', 'minor': 'info'}[impact_text|lower] or 'warning' }} me-2 impact-badge">
                                {{ impact_text|upper }}
                            </span>
                            <code class="me-2">{{ warning_code }}</code>
                            {{ first_warning.metadata.what_generic if first_warning.metadata and first_warning.metadata.what_generic else first_warning.description }}
                        </button>
                    </h2>
                    <div id="warn-{{ warn_counter.value }}" class="accordion-collapse collapse" data-bs-parent="#warningsAccordion">
                        <div class="accordion-body">
                            {% if group_list|length > 1 %}
                            <!-- Multiple instances - show nested accordion -->
                            <div class="accordion" id="warn_instances_{{ warn_counter.value }}">
                                {% for instance in group_list %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#warn_inst_{{ warn_counter.value }}_{{ loop.index }}">
                                            <strong data-i18n="instance">{{ t['instance'] }}</strong> {{ loop.index }}:
                                            {% if instance.metadata and instance.metadata.authenticated_user %}
                                                <span class="badge bg-secondary ms-2">
                                                    <i class="bi bi-person-fill"></i> {{ instance.metadata.authenticated_user.display_name }}
                                                    {% if instance.metadata.authenticated_user.roles %}
                                                        ({{ instance.metadata.authenticated_user.roles|join(', ') }})
                                                    {% endif %}
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary ms-2">
                                                    <i class="bi bi-person"></i> <span data-i18n="guest">{{ t['guest'] }}</span>
                                                </span>
                                            {% endif %}
                                            {% if instance.xpath %}
                                            <code class="ms-2">{{ instance.xpath }}</code>
                                            {% endif %}
                                        </button>
                                    </h2>
                                    <div id="warn_inst_{{ warn_counter.value }}_{{ loop.index }}"
                                         class="accordion-collapse collapse"
                                         data-bs-parent="#warn_instances_{{ warn_counter.value }}">
                                        <div class="accordion-body">
                                            {% set violation = instance %}
                                            {% set alert_type = 'warning' %}
                                            {% include 'static_report/violation_details.html' %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <!-- Single instance - show details directly -->
                            {% set violation = first_warning %}
                            {% set alert_type = 'warning' %}
                            {% include 'static_report/violation_details.html' %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
    </div>
    {% endif %}

    <!-- Info -->
    {% if info %}
    <h6 class="text-info mb-3">
        <i class="bi bi-info-circle"></i> <span data-i18n="informational">{{ t['informational'] }}</span> ({{ info|length }})
    </h6>
    <div class="accordion mb-4" id="infoAccordion">
        {% set info_counter = namespace(value=0) %}
        {% for touchpoint, touchpoint_info in info|groupby('touchpoint') %}
            <div class="touchpoint-header mt-3 mb-2 ps-2" style="border-left: 4px solid #0dcaf0;">
                <strong>{{ touchpoint|replace('_', ' ')|title if touchpoint else 'General' }}</strong>
            </div>

            {% for info_code, description_group in touchpoint_info|groupby('id') %}
                {% set group_list = description_group|list %}
                {% set info_counter.value = info_counter.value + 1 %}
                {% set first_info = group_list[0] %}
                {% set impact_text = first_info.impact|string|replace('IMPACT_LEVEL.', '')|replace('ImpactLevel.', '') if first_info.impact else '' %}

                <div class="accordion-item mb-2 issue-item"
                     data-type="info"
                     data-impact="{{ impact_text|lower }}"
                     data-touchpoint="{{ touchpoint|lower }}"
                     data-id="{{ info_code }}"
                     data-description="{{ first_info.metadata.what_generic|lower if first_info.metadata and first_info.metadata.what_generic else first_info.description|lower }}"
                     data-xpath="{{ first_info.xpath|lower if first_info.xpath else '' }}">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#info-{{ info_counter.value }}">
                            {% if group_list|length > 1 %}
                            <span class="badge bg-{{ {'high': 'danger', 'serious': 'danger', 'critical': 'danger', 'medium': 'warning', 'moderate': 'warning', 'low': 'info', 'minor': 'info'}[impact_text|lower] or 'secondary' }} me-2">{{ group_list|length }}</span>
                            {% endif %}
                            {% if impact_text %}
                            <span class="badge bg-{{ {'high': 'danger', 'serious': 'danger', 'critical': 'danger', 'medium': 'warning', 'moderate': 'warning', 'low': 'info', 'minor': 'info'}[impact_text|lower] or 'info' }} me-2 impact-badge">
                                {{ impact_text|upper }}
                            </span>
                            {% endif %}
                            <code class="me-2">{{ info_code }}</code>
                            {{ first_info.metadata.what_generic if first_info.metadata and first_info.metadata.what_generic else first_info.description }}
                        </button>
                    </h2>
                    <div id="info-{{ info_counter.value }}" class="accordion-collapse collapse" data-bs-parent="#infoAccordion">
                        <div class="accordion-body">
                            {% if group_list|length > 1 %}
                            <!-- Multiple instances - show nested accordion -->
                            <div class="accordion" id="info_instances_{{ info_counter.value }}">
                                {% for instance in group_list %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#info_inst_{{ info_counter.value }}_{{ loop.index }}">
                                            <strong data-i18n="instance">{{ t['instance'] }}</strong> {{ loop.index }}:
                                            {% if instance.metadata and instance.metadata.authenticated_user %}
                                                <span class="badge bg-secondary ms-2">
                                                    <i class="bi bi-person-fill"></i> {{ instance.metadata.authenticated_user.display_name }}
                                                    {% if instance.metadata.authenticated_user.roles %}
                                                        ({{ instance.metadata.authenticated_user.roles|join(', ') }})
                                                    {% endif %}
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary ms-2">
                                                    <i class="bi bi-person"></i> <span data-i18n="guest">{{ t['guest'] }}</span>
                                                </span>
                                            {% endif %}
                                            {% if instance.xpath %}
                                            <code class="ms-2">{{ instance.xpath }}</code>
                                            {% endif %}
                                        </button>
                                    </h2>
                                    <div id="info_inst_{{ info_counter.value }}_{{ loop.index }}"
                                         class="accordion-collapse collapse"
                                         data-bs-parent="#info_instances_{{ info_counter.value }}">
                                        <div class="accordion-body">
                                            {% set violation = instance %}
                                            {% set alert_type = 'info' %}
                                            {% include 'static_report/violation_details.html' %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <!-- Single instance - show details directly -->
                            {% set violation = first_info %}
                            {% set alert_type = 'info' %}
                            {% include 'static_report/violation_details.html' %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
    </div>
    {% endif %}

    <!-- Discovery -->
    {% if discovery %}
    <h6 class="mb-3" style="color: #6f42c1;">
        <i class="bi bi-search"></i> <span data-i18n="discovery">{{ t['discovery'] }}</span> ({{ discovery|length }})
    </h6>
    <div class="accordion mb-4" id="discoveryAccordion">
        {% set disco_counter = namespace(value=0) %}
        {% for touchpoint, touchpoint_discovery in discovery|groupby('touchpoint') %}
            <div class="touchpoint-header mt-3 mb-2 ps-2" style="border-left: 4px solid #6f42c1;">
                <strong>{{ touchpoint|replace('_', ' ')|title if touchpoint else 'General' }}</strong>
            </div>

            {% for disco_code, description_group in touchpoint_discovery|groupby('id') %}
                {% set group_list = description_group|list %}
                {% set disco_counter.value = disco_counter.value + 1 %}
                {% set first_disco = group_list[0] %}

                <div class="accordion-item mb-2 issue-item"
                     data-type="discovery"
                     data-impact=""
                     data-touchpoint="{{ touchpoint|lower }}"
                     data-id="{{ disco_code }}"
                     data-description="{{ first_disco.metadata.what_generic|lower if first_disco.metadata and first_disco.metadata.what_generic else first_disco.description|lower }}"
                     data-xpath="{{ first_disco.xpath|lower if first_disco.xpath else '' }}">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#disco-{{ disco_counter.value }}">
                            {% if group_list|length > 1 %}
                            <span class="badge me-2" style="background-color: #6f42c1;">{{ group_list|length }}</span>
                            {% endif %}
                            <span class="badge me-2 impact-badge" style="background-color: #6f42c1;">
                                <span data-i18n="discovery_upper">{{ t['discovery_upper'] }}</span>
                            </span>
                            <code class="me-2">{{ disco_code }}</code>
                            {{ first_disco.metadata.what_generic if first_disco.metadata and first_disco.metadata.what_generic else first_disco.description }}
                        </button>
                    </h2>
                    <div id="disco-{{ disco_counter.value }}" class="accordion-collapse collapse" data-bs-parent="#discoveryAccordion">
                        <div class="accordion-body">
                            {% if group_list|length > 1 %}
                            <!-- Multiple instances - show nested accordion -->
                            <div class="accordion" id="disco_instances_{{ disco_counter.value }}">
                                {% for instance in group_list %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#disco_inst_{{ disco_counter.value }}_{{ loop.index }}">
                                            <strong data-i18n="instance">{{ t['instance'] }}</strong> {{ loop.index }}:
                                            {% if instance.metadata and instance.metadata.authenticated_user %}
                                                <span class="badge bg-secondary ms-2">
                                                    <i class="bi bi-person-fill"></i> {{ instance.metadata.authenticated_user.display_name }}
                                                    {% if instance.metadata.authenticated_user.roles %}
                                                        ({{ instance.metadata.authenticated_user.roles|join(', ') }})
                                                    {% endif %}
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary ms-2">
                                                    <i class="bi bi-person"></i> <span data-i18n="guest">{{ t['guest'] }}</span>
                                                </span>
                                            {% endif %}
                                            {% if instance.xpath %}
                                            <code class="ms-2">{{ instance.xpath }}</code>
                                            {% endif %}
                                        </button>
                                    </h2>
                                    <div id="disco_inst_{{ disco_counter.value }}_{{ loop.index }}"
                                         class="accordion-collapse collapse"
                                         data-bs-parent="#disco_instances_{{ disco_counter.value }}">
                                        <div class="accordion-body">
                                            {% set violation = instance %}
                                            {% set alert_type = 'primary' %}
                                            {% include 'static_report/violation_details.html' %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <!-- Single instance - show details directly -->
                            {% set violation = first_disco %}
                            {% set alert_type = 'primary' %}
                            {% include 'static_report/violation_details.html' %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
    </div>
    {% endif %}

        </div><!-- End card-body -->
    </div><!-- End card -->
</div><!-- End container -->

<script src="{{ asset_path }}js/bootstrap.bundle.min.js"></script>
<script>
// All translations embedded in the report
const translations = {{ translations_json|safe }};

// Current language
let currentLang = '{{ language }}';

function switchLanguage(lang) {
    if (lang === currentLang) return;

    currentLang = lang;

    // Update HTML lang attribute
    document.documentElement.lang = lang;
    document.documentElement.setAttribute('data-current-lang', lang);

    // Update all elements with data-i18n attribute
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (translations[lang] && translations[lang][key]) {
            element.textContent = translations[lang][key];
        }
    });

    // Update placeholders
    document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
        const key = element.getAttribute('data-i18n-placeholder');
        if (translations[lang] && translations[lang][key]) {
            element.placeholder = translations[lang][key];
        }
    });

    // Update current language display
    document.getElementById('current-lang-display').textContent = lang.toUpperCase();

    // Update document title
    if (translations[lang] && translations[lang]['non_component_issues']) {
        document.title = translations[lang]['non_component_issues'] + ': {{ page.title|default("Untitled Page") }}';
    }
}

// Filter functionality
const filterState = {
    types: new Set(),
    impacts: new Set(),
    touchpoints: new Set(),
    searchTerm: ''
};

function updateFilters() {
    const items = document.querySelectorAll('.issue-item');
    let visibleCount = 0;

    items.forEach(item => {
        const type = item.dataset.type;
        const impact = item.dataset.impact;
        const touchpoint = item.dataset.touchpoint;
        const description = item.dataset.description;
        const xpath = item.dataset.xpath;

        let visible = true;

        // Filter by type
        if (filterState.types.size > 0 && !filterState.types.has(type)) {
            visible = false;
        }

        // Filter by impact
        if (filterState.impacts.size > 0 && !filterState.impacts.has(impact)) {
            visible = false;
        }

        // Filter by touchpoint
        if (filterState.touchpoints.size > 0) {
            let touchpointMatch = false;
            filterState.touchpoints.forEach(tp => {
                if (touchpoint === tp) {
                    touchpointMatch = true;
                }
            });
            if (!touchpointMatch) {
                visible = false;
            }
        }

        // Filter by search term
        if (filterState.searchTerm) {
            const searchLower = filterState.searchTerm.toLowerCase();
            if (!description.includes(searchLower) && !xpath.includes(searchLower)) {
                visible = false;
            }
        }

        if (visible) {
            item.classList.remove('filtered-out');
            visibleCount++;
        } else {
            item.classList.add('filtered-out');
        }
    });

    // Update counts
    document.getElementById('visibleCount').textContent = visibleCount;
    document.getElementById('totalCount').textContent = items.length;

    // Show/hide active filters section
    const hasActiveFilters = filterState.types.size > 0 ||
                            filterState.impacts.size > 0 ||
                            filterState.touchpoints.size > 0 ||
                            filterState.searchTerm;
    document.getElementById('activeFilters').style.display = hasActiveFilters ? 'block' : 'none';
}

// Filter chip click handlers
document.querySelectorAll('.filter-chip').forEach(chip => {
    chip.addEventListener('click', function() {
        const filterType = this.dataset.filterType;
        const filterValue = this.dataset.filterValue;

        this.classList.toggle('active');

        if (this.classList.contains('active')) {
            filterState[filterType + 's'].add(filterValue);
        } else {
            filterState[filterType + 's'].delete(filterValue);
        }

        updateFilters();
    });
});

// Touchpoint filter
const touchpointFilter = document.getElementById('touchpointFilter');
if (touchpointFilter) {
    touchpointFilter.addEventListener('change', function() {
        filterState.touchpoints.clear();
        Array.from(this.selectedOptions).forEach(option => {
            if (option.value) {
                filterState.touchpoints.add(option.value);
            }
        });
        updateFilters();
    });
}

// Quick search
const quickSearch = document.getElementById('quickSearch');
if (quickSearch) {
    quickSearch.addEventListener('input', function() {
        filterState.searchTerm = this.value.toLowerCase();
        updateFilters();
    });
}

// Clear all filters
document.getElementById('clearFilters').addEventListener('click', function() {
    filterState.types.clear();
    filterState.impacts.clear();
    filterState.touchpoints.clear();
    filterState.searchTerm = '';

    document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.classList.remove('active');
    });

    if (touchpointFilter) {
        touchpointFilter.selectedIndex = -1;
    }

    if (quickSearch) {
        quickSearch.value = '';
    }

    updateFilters();
});

// Initialize counts
updateFilters();

// Count impact levels
const items = document.querySelectorAll('.issue-item');
let highCount = 0, mediumCount = 0, lowCount = 0;
items.forEach(item => {
    const impact = item.dataset.impact;
    if (['high', 'serious', 'critical'].includes(impact)) highCount++;
    else if (['medium', 'moderate'].includes(impact)) mediumCount++;
    else if (['low', 'minor'].includes(impact)) lowCount++;
});

document.getElementById('highImpactCount').textContent = highCount;
document.getElementById('mediumImpactCount').textContent = mediumCount;
document.getElementById('lowImpactCount').textContent = lowCount;
</script>
</body>
</html>
