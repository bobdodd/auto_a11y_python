{% extends "base.html" %}

{% block title %}{{ _('Reports') }} - Auto A11y{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">{{ _('Reports') }}</h1>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#generateReportModal">
            <i class="bi bi-plus-circle"></i> {{ _('Generate Report') }}
        </button>
    </div>

    <!-- Report Types -->
    <style>
        .report-card {
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid #dee2e6;
        }
        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .report-card .card-body {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 280px;
        }
        .report-card .icon-wrapper {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .report-card .content-wrapper {
            flex-grow: 0;
        }
        .report-card .btn-wrapper {
            margin-top: auto;
            padding-top: 15px;
        }
        /* Darker colors for better contrast (WCAG AAA compliant) */
        .icon-html { color: #b8860b !important; } /* DarkGoldenrod - darker than warning */
        .icon-pdf { color: #c82333 !important; } /* Darker red */
        .icon-excel { color: #1e7e34 !important; } /* Darker green */
        .icon-json { color: #117a8b !important; } /* Darker cyan */
        .icon-summary { color: #004085 !important; } /* Darker blue */
        
        /* Override Bootstrap button colors for accessibility */
        .btn-html { 
            color: #856404; 
            border-color: #856404;
            background-color: transparent;
        }
        .btn-html:hover, .btn-html:focus { 
            background-color: #856404; 
            border-color: #856404;
            color: white;
        }
        .btn-html:focus {
            box-shadow: 0 0 0 0.2rem rgba(133, 100, 4, 0.25);
        }
        
        .btn-json {
            color: #0c525d; /* Much darker teal for 4.5:1 contrast */
            border-color: #0c525d;
            background-color: transparent;
        }
        .btn-json:hover, .btn-json:focus {
            background-color: #0c525d;
            border-color: #0c525d;
            color: white;
        }
        .btn-json:focus {
            box-shadow: 0 0 0 0.2rem rgba(12, 82, 93, 0.25);
        }
        
        .btn-pdf {
            color: #721c24; /* Darker red for better contrast */
            border-color: #721c24;
            background-color: transparent;
        }
        .btn-pdf:hover, .btn-pdf:focus {
            background-color: #721c24;
            border-color: #721c24;
            color: white;
        }
        .btn-pdf:focus {
            box-shadow: 0 0 0 0.2rem rgba(114, 28, 36, 0.25);
        }
        
        .btn-excel {
            color: #155724; /* Darker green for better contrast */
            border-color: #155724;
            background-color: transparent;
        }
        .btn-excel:hover, .btn-excel:focus {
            background-color: #155724;
            border-color: #155724;
            color: white;
        }
        .btn-excel:focus {
            box-shadow: 0 0 0 0.2rem rgba(21, 87, 36, 0.25);
        }
        
        .btn-summary {
            color: #004085; /* Darker blue for better contrast */
            border-color: #004085;
            background-color: transparent;
        }
        .btn-summary:hover, .btn-summary:focus {
            background-color: #004085;
            border-color: #004085;
            color: white;
        }
        .btn-summary:focus {
            box-shadow: 0 0 0 0.2rem rgba(0, 64, 133, 0.25);
        }
    </style>
    
    <div class="row mb-4 g-3">
        <div class="col-md-4">
            <div class="card h-100 report-card">
                <div class="card-body text-center">
                    <div class="icon-wrapper">
                        <i class="bi bi-file-earmark-check display-3 icon-summary"></i>
                    </div>
                    <div class="content-wrapper">
                        <h5 class="card-title mt-3">{{ _('Accessibility Report') }}</h5>
                        <p class="card-text text-muted">{{ _('Comprehensive accessibility testing results') }}</p>
                    </div>
                    <div class="btn-wrapper">
                        <button class="btn btn-summary" data-bs-toggle="modal" data-bs-target="#generateReportModal">
                            <i class="bi bi-download me-2"></i>{{ _('Generate Report') }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100 report-card">
                <div class="card-body text-center">
                    <div class="icon-wrapper">
                        <i class="bi bi-search display-3 icon-html"></i>
                    </div>
                    <div class="content-wrapper">
                        <h5 class="card-title mt-3">{{ _('Discovery Report') }}</h5>
                        <p class="card-text text-muted">{{ _('Discover content requiring manual inspection') }}</p>
                    </div>
                    <div class="btn-wrapper">
                        <button class="btn btn-html" data-bs-toggle="modal" data-bs-target="#discoveryModal">
                            <i class="bi bi-search me-2"></i>{{ _('Generate Discovery Report') }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100 report-card">
                <div class="card-body text-center">
                    <div class="icon-wrapper">
                        <i class="bi bi-diagram-3 display-3 icon-summary"></i>
                    </div>
                    <div class="content-wrapper">
                        <h5 class="card-title mt-3">{{ _('Site Structure') }}</h5>
                        <p class="card-text text-muted">{{ _('Hierarchical view of website organization') }}</p>
                    </div>
                    <div class="btn-wrapper">
                        <button class="btn btn-summary" data-bs-toggle="modal" data-bs-target="#siteStructureModal">
                            <i class="bi bi-diagram-3 me-2"></i>{{ _('Generate Structure') }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Second row for Offline Reports -->
    <div class="row mb-4 g-3">
        <div class="col-md-4">
            <div class="card h-100 report-card">
                <div class="card-body text-center">
                    <div class="icon-wrapper">
                        <i class="bi bi-file-earmark-zip display-3 icon-html"></i>
                    </div>
                    <div class="content-wrapper">
                        <h5 class="card-title mt-3">{{ _('Offline Report (Static HTML)') }}</h5>
                        <p class="card-text text-muted">{{ _('Multi-page offline report with filters, scores, and full issue details (ZIP download)') }}</p>
                    </div>
                    <div class="btn-wrapper">
                        <button class="btn btn-html" data-bs-toggle="modal" data-bs-target="#staticHtmlModal">
                            <i class="bi bi-download me-2"></i>{{ _('Generate Offline Report') }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100 report-card">
                <div class="card-body text-center">
                    <div class="icon-wrapper">
                        <i class="bi bi-file-earmark-zip display-3 icon-summary"></i>
                    </div>
                    <div class="content-wrapper">
                        <h5 class="card-title mt-3">{{ _('Deduplicated Offline Report') }}</h5>
                        <p class="card-text text-muted">{{ _('Single-page offline report with issues grouped by common components (ZIP download)') }}</p>
                    </div>
                    <div class="btn-wrapper">
                        <button class="btn btn-summary" data-bs-toggle="modal" data-bs-target="#deduplicatedModal">
                            <i class="bi bi-file-earmark-zip me-2"></i>{{ _('Generate Deduplicated Report') }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100 report-card">
                <div class="card-body text-center">
                    <div class="icon-wrapper">
                        <i class="bi bi-mic display-3 icon-pdf"></i>
                    </div>
                    <div class="content-wrapper">
                        <h5 class="card-title mt-3">{{ _('Recordings Report') }}</h5>
                        <p class="card-text text-muted">{{ _('Manual accessibility audit findings from recorded testing sessions') }}</p>
                    </div>
                    <div class="btn-wrapper">
                        <button class="btn btn-pdf" data-bs-toggle="modal" data-bs-target="#recordingsModal">
                            <i class="bi bi-mic me-2"></i>{{ _('Generate Recordings Report') }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Reports -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">{{ _('Recent Reports') }}</h5>
        </div>
        <div class="card-body">
            {% if reports %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>{{ _('Report Name') }}</th>
                            <th>{{ _('Type') }}</th>
                            <th>{{ _('Project') }}</th>
                            <th>{{ _('Generated') }}</th>
                            <th>{{ _('Size') }}</th>
                            <th>{{ _('Actions') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for report in reports %}
                        <tr>
                            <td>
                                <i class="bi bi-file-earmark-{{ {'pdf': 'pdf text-danger',
                                                                 'excel': 'excel text-success',
                                                                 'xlsx': 'excel text-success',
                                                                 'json': 'code text-info',
                                                                 'html': 'text text-primary',
                                                                 'zip': 'zip text-warning'}[report.type] or 'text' }}"></i>
                                {{ report.name }}
                            </td>
                            <td>
                                <span class="badge bg-{{ {'pdf': 'danger',
                                                          'excel': 'success',
                                                          'xlsx': 'success',
                                                          'json': 'info',
                                                          'html': 'primary',
                                                          'zip': 'warning'}[report.type] or 'secondary' }}">
                                    {{ report.type|upper }}
                                </span>
                            </td>
                            <td>{{ report.project_name or _('All Projects') }}</td>
                            <td>{{ report.created_at.strftime('%Y-%m-%d %H:%M') if report.created_at else _('Unknown') }}</td>
                            <td>{{ report.size_kb|filesizeformat if report.size_kb else _('N/A') }}</td>
                            <td>
                                <div class="btn-group" role="group">
                                    <a href="{{ url_for('reports.download_report', filename=report.filename) }}"
                                       class="btn btn-sm btn-primary" title="{{ _('Download') }}">
                                        <i class="bi bi-download"></i>
                                    </a>
                                    <button class="btn btn-sm btn-danger"
                                            onclick="deleteReport('{{ report.filename }}')" title="{{ _('Delete') }}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted text-center py-4">
                {{ _('No reports generated yet. Click "Generate Report" to create your first report.') }}
            </p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Generate Report Modal -->
<div class="modal fade" id="generateReportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Generate Report') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="generateReportForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="reportName" class="form-label">{{ _('Report Name') }}</label>
                                <input type="text" class="form-control" id="reportName"
                                       placeholder="{{ _('Accessibility Report') }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="reportType" class="form-label">{{ _('Report Type') }}</label>
                                <select class="form-control" id="reportType">
                                    <option value="pdf">{{ _('PDF Report') }}</option>
                                    <option value="excel">{{ _('Excel Spreadsheet') }}</option>
                                    <option value="json">{{ _('JSON Export') }}</option>
                                    <option value="html">{{ _('HTML Report') }}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="projectSelect" class="form-label">{{ _('Project') }}</label>
                                <select class="form-control" id="projectSelect">
                                    <option value="">{{ _('All Projects') }}</option>
                                    {% for project in projects %}
                                    <option value="{{ project.id }}">{{ project.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="websiteSelect" class="form-label">{{ _('Website') }}</label>
                                <select class="form-control" id="websiteSelect" disabled>
                                    <option value="">{{ _('Select a project first...') }}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">{{ _('Date Range') }}</label>
                        <div class="row">
                            <div class="col-md-6">
                                <input type="date" class="form-control" id="startDate">
                            </div>
                            <div class="col-md-6">
                                <input type="date" class="form-control" id="endDate">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">{{ _('Include in Report') }}</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeViolations" checked>
                            <label class="form-check-label" for="includeViolations">
                                {{ _('Accessibility Violations') }}
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeWarnings" checked>
                            <label class="form-check-label" for="includeWarnings">
                                {{ _('Warnings') }}
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeAI" checked>
                            <label class="form-check-label" for="includeAI">
                                {{ _('AI Analysis Results') }}
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeScreenshots">
                            <label class="form-check-label" for="includeScreenshots">
                                {{ _('Screenshots (increases file size)') }}
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeSummary" checked>
                            <label class="form-check-label" for="includeSummary">
                                {{ _('Executive Summary') }}
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-file-earmark-arrow-down"></i> {{ _('Generate Report') }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize date inputs and report name with today's date
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    
    // Set default report name with today's date
    const reportNameInput = document.getElementById('reportName');
    if (!reportNameInput.value) {
        reportNameInput.value = {{ _("Accessibility Report") | tojson }} + ' ' + todayStr;
    }
    
    // Set date range
    document.getElementById('endDate').value = todayStr;
    
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
});

// Handle project selection change - dynamically load websites
document.getElementById('projectSelect').addEventListener('change', function() {
    const websiteSelect = document.getElementById('websiteSelect');
    const selectedProjectId = this.value;

    // Reset website selection
    websiteSelect.value = '';

    if (selectedProjectId) {
        // Load websites for selected project
        websiteSelect.innerHTML = <option value="">' +  _("Loading websites...") | tojson  + '</option>;
        websiteSelect.disabled = true;

        fetch(`/projects/api/${selectedProjectId}/websites`)
            .then(response => response.json())
            .then(data => {
                websiteSelect.innerHTML = <option value="">' +  _("All Websites") | tojson  + '</option>;

                if (data.websites && data.websites.length > 0) {
                    data.websites.forEach(website => {
                        const option = document.createElement('option');
                        option.value = website.id;
                        option.textContent = website.name;
                        websiteSelect.appendChild(option);
                    });
                    websiteSelect.disabled = false;
                } else {
                    websiteSelect.innerHTML = <option value="">' +  _("No websites in this project") | tojson  + '</option>;
                }
            })
            .catch(error => {
                console.error('Error loading websites:', error);
                websiteSelect.innerHTML = <option value="">' +  _("Error loading websites") | tojson  + '</option>;
            });
    } else {
        // Disable website select when "All Projects" is selected
        websiteSelect.innerHTML = <option value="">' +  _("Select a project first...") | tojson  + '</option>;
        websiteSelect.disabled = true;
    }
});

// Handle report generation form
document.getElementById('generateReportForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        name: document.getElementById('reportName').value,
        type: document.getElementById('reportType').value,
        project_id: document.getElementById('projectSelect').value,
        website_id: document.getElementById('websiteSelect').value,
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value,
        include_violations: document.getElementById('includeViolations').checked,
        include_warnings: document.getElementById('includeWarnings').checked,
        include_ai: document.getElementById('includeAI').checked,
        include_screenshots: document.getElementById('includeScreenshots').checked,
        include_summary: document.getElementById('includeSummary').checked
    };
    
    // Show loading state
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = <span class="spinner-border spinner-border-sm me-2"></span>' +  _("Generating...") | tojson ;
    submitBtn.disabled = true;
    
    // Submit request
    fetch('/reports/generate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal and reload page
            bootstrap.Modal.getInstance(document.getElementById('generateReportModal')).hide();
            location.reload();
        } else {
            alert({{ _("Failed to generate report: ") | tojson }} + (data.error || {{ _("Unknown error") | tojson }}));
        }
    })
    .catch(error => {
        alert({{ _("Error generating report: ") | tojson }} + error);
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

function generateReport(type) {
    document.getElementById('reportType').value = type;
    const modal = new bootstrap.Modal(document.getElementById('generateReportModal'));
    modal.show();
}

function deleteReport(reportId) {
    if (!confirm({{ _('Are you sure you want to delete this report?') | tojson }})) {
        return;
    }

    fetch(`/reports/${reportId}/delete`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert({{ _('Failed to delete report') | tojson }});
        }
    });
}

// Site Structure Report Functions
document.addEventListener('DOMContentLoaded', function() {
    // Load projects when site structure modal opens
    const siteStructureModal = document.getElementById('siteStructureModal');
    if (siteStructureModal) {
        siteStructureModal.addEventListener('show.bs.modal', function() {
            loadProjectsForStructure();
        });
    }
    
    // Handle project selection change
    const structureProject = document.getElementById('structureProject');
    if (structureProject) {
        structureProject.addEventListener('change', function() {
            const projectId = this.value;
            if (projectId) {
                loadWebsitesForProject(projectId);
            } else {
                const websiteSelect = document.getElementById('structureWebsite');
                websiteSelect.innerHTML = <option value="">' +  _("First select a project...") | tojson  + '</option>;
                websiteSelect.disabled = true;
            }
        });
    }
    
    // Handle site structure form submission
    const siteStructureForm = document.getElementById('siteStructureForm');
    if (siteStructureForm) {
        siteStructureForm.addEventListener('submit', function(e) {
            e.preventDefault();
            generateSiteStructureReport();
        });
    }
});

function loadProjectsForStructure() {
    fetch('/projects/api/list')
    .then(response => response.json())
    .then(data => {
        const select = document.getElementById('structureProject');
        select.innerHTML = <option value="">' +  _("Choose a project...") | tojson  + '</option>;

        if (data.projects && data.projects.length > 0) {
            data.projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                select.appendChild(option);
            });
        } else {
            select.innerHTML = <option value="">' +  _("No projects available") | tojson  + '</option>;
        }
    })
    .catch(error => {
        console.error('Error loading projects:', error);
        const select = document.getElementById('structureProject');
        select.innerHTML = <option value="">' +  _("Error loading projects") | tojson  + '</option>;
    });
}

function loadWebsitesForProject(projectId) {
    const websiteSelect = document.getElementById('structureWebsite');
    websiteSelect.innerHTML = <option value="">' +  _("Loading websites...") | tojson  + '</option>;
    websiteSelect.disabled = true;

    fetch(`/projects/api/${projectId}/websites`)
    .then(response => response.json())
    .then(data => {
        websiteSelect.innerHTML = <option value="">' +  _("Choose a website...") | tojson  + '</option>;

        if (data.websites && data.websites.length > 0) {
            data.websites.forEach(website => {
                const option = document.createElement('option');
                option.value = website.id;
                option.textContent = `${website.name} (${website.url})`;
                websiteSelect.appendChild(option);
            });
            websiteSelect.disabled = false;
        } else {
            websiteSelect.innerHTML = <option value="">' +  _("No websites in this project") | tojson  + '</option>;
        }
    })
    .catch(error => {
        console.error('Error loading websites:', error);
        websiteSelect.innerHTML = <option value="">' +  _("Error loading websites") | tojson  + '</option>;
    });
}

function generateSiteStructureReport() {
    const websiteId = document.getElementById('structureWebsite').value;
    const format = document.getElementById('structureFormat').value;

    if (!websiteId) {
        alert({{ _('Please select a project and website') | tojson }});
        return;
    }
    
    // Create a form to submit the report request
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/reports/generate/page-structure/${websiteId}`;
    
    const formatInput = document.createElement('input');
    formatInput.type = 'hidden';
    formatInput.name = 'format';
    formatInput.value = format;
    form.appendChild(formatInput);
    
    document.body.appendChild(form);
    form.submit();
    
    // Close the modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('siteStructureModal'));
    modal.hide();
}

// Discovery Report Functions - Initialize on DOMContentLoaded
(function() {
    // Wait for DOM to be ready
    const initDiscovery = function() {
        // Load projects when discovery modal opens
        const discoveryModal = document.getElementById('discoveryModal');
        if (discoveryModal) {
            discoveryModal.addEventListener('show.bs.modal', function() {
                loadProjectsForDiscovery();
            });
        }

        // Handle scope selection change
        const scopeRadios = document.querySelectorAll('input[name="discoveryScope"]');
        scopeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                const projectGroup = document.getElementById('discoveryProjectGroup');
                const websiteGroup = document.getElementById('discoveryWebsiteGroup');
                const helpText = document.getElementById('discoveryProjectHelpText');

                if (this.value === 'website') {
                    projectGroup.style.display = 'block';
                    websiteGroup.style.display = 'block';
                    if (helpText) {
                        helpText.textContent = {{ _('Select a project first') | tojson }};
                    }
                } else {
                    projectGroup.style.display = 'block';
                    websiteGroup.style.display = 'none';
                    if (helpText) {
                        helpText.textContent = {{ _('All websites in the project will be included') | tojson }};
                    }
                }
            });
        });

        // Handle project selection change for discovery
        const discoveryProject = document.getElementById('discoveryProject');
        if (discoveryProject) {
            discoveryProject.addEventListener('change', function() {
                const projectId = this.value;
                const scope = document.querySelector('input[name="discoveryScope"]:checked').value;

                if (scope === 'website' && projectId) {
                    loadWebsitesForDiscovery(projectId);
                }
            });
        }

        // Handle discovery form submission
        const discoveryForm = document.getElementById('discoveryForm');
        if (discoveryForm) {
            discoveryForm.addEventListener('submit', function(e) {
                e.preventDefault();
                generateDiscoveryReport();
            });
        }
    };

    // Initialize after DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initDiscovery);
    } else {
        initDiscovery();
    }
})();

function loadProjectsForDiscovery() {
    fetch('/projects/api/list')
    .then(response => response.json())
    .then(data => {
        const select = document.getElementById('discoveryProject');
        select.innerHTML = <option value="">' +  _("Choose a project...") | tojson  + '</option>;

        if (data.projects && data.projects.length > 0) {
            data.projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                select.appendChild(option);
            });
        } else {
            select.innerHTML = <option value="">' +  _("No projects available") | tojson  + '</option>;
        }
    })
    .catch(error => {
        console.error('Error loading projects:', error);
        const select = document.getElementById('discoveryProject');
        select.innerHTML = <option value="">' +  _("Error loading projects") | tojson  + '</option>;
    });
}

function loadWebsitesForDiscovery(projectId) {
    const websiteSelect = document.getElementById('discoveryWebsite');
    websiteSelect.innerHTML = <option value="">' +  _("Loading websites...") | tojson  + '</option>;
    websiteSelect.disabled = true;

    fetch(`/projects/api/${projectId}/websites`)
    .then(response => response.json())
    .then(data => {
        websiteSelect.innerHTML = <option value="">' +  _("Choose a website...") | tojson  + '</option>;

        if (data.websites && data.websites.length > 0) {
            data.websites.forEach(website => {
                const option = document.createElement('option');
                option.value = website.id;
                option.textContent = `${website.name} (${website.url})`;
                websiteSelect.appendChild(option);
            });
            websiteSelect.disabled = false;
        } else {
            websiteSelect.innerHTML = <option value="">' +  _("No websites in this project") | tojson  + '</option>;
        }
    })
    .catch(error => {
        console.error('Error loading websites:', error);
        websiteSelect.innerHTML = <option value="">' +  _("Error loading websites") | tojson  + '</option>;
    });
}

function generateDiscoveryReport() {
    const scope = document.querySelector('input[name="discoveryScope"]:checked').value;
    const projectId = document.getElementById('discoveryProject').value;
    const format = document.getElementById('discoveryFormat').value;

    if (!projectId) {
        alert({{ _('Please select a project') | tojson }});
        return;
    }

    let actionUrl;
    if (scope === 'website') {
        const websiteId = document.getElementById('discoveryWebsite').value;
        if (!websiteId) {
            alert({{ _('Please select a website') | tojson }});
            return;
        }
        actionUrl = `/reports/generate/discovery/website/${websiteId}`;
    } else {
        actionUrl = `/reports/generate/discovery/project/${projectId}`;
    }

    // Create a form to submit the report request
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = actionUrl;

    const formatInput = document.createElement('input');
    formatInput.type = 'hidden';
    formatInput.name = 'format';
    formatInput.value = format;
    form.appendChild(formatInput);

    document.body.appendChild(form);
    form.submit();

    // Close the modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('discoveryModal'));
    if (modal) {
        modal.hide();
    }
}
</script>

<!-- Site Structure Report Modal -->
<div class="modal fade" id="siteStructureModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Generate Site Structure Report') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="siteStructureForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="structureProject" class="form-label">{{ _('Select Project') }}</label>
                        <select class="form-select" id="structureProject" required>
                            <option value="">{{ _('Choose a project...') }}</option>
                        </select>
                        <small class="text-muted">{{ _('Select the project containing the website') }}</small>
                    </div>
                    <div class="mb-3">
                        <label for="structureWebsite" class="form-label">{{ _('Select Website') }}</label>
                        <select class="form-select" id="structureWebsite" required disabled>
                            <option value="">{{ _('First select a project...') }}</option>
                        </select>
                        <small class="text-muted">{{ _('Select the website to analyze its structure') }}</small>
                    </div>
                    <div class="mb-3">
                        <label for="structureFormat" class="form-label">{{ _('Export Format') }}</label>
                        <select class="form-select" id="structureFormat">
                            <option value="html">{{ _('HTML (Interactive)') }}</option>
                            <option value="json">{{ _('JSON (Data)') }}</option>
                            <option value="csv">{{ _('CSV (Spreadsheet)') }}</option>
                        </select>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> {{ _('This report will generate a hierarchical tree view of all pages in the selected website, organized by URL structure.') }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-diagram-3"></i> {{ _('Generate Structure Report') }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Discovery Report Modal -->
<div class="modal fade" id="discoveryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Generate Discovery Report') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="discoveryForm">
                <div class="modal-body">
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle"></i> {{ _('This report discovers pages with content requiring manual accessibility inspection, including:') }}
                        <ul class="mt-2 mb-0">
                            <li>{{ _('Discovery issues (content requiring human judgment)') }}</li>
                            <li>{{ _('Informational notices') }}</li>
                            <li>{{ _('Accessible name issues (forms, links, buttons)') }}</li>
                            <li>{{ _('Elements with poor or missing labels') }}</li>
                        </ul>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ _('Scope') }}</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="discoveryScope" id="discoveryScopeWebsite" value="website" checked>
                            <label class="form-check-label" for="discoveryScopeWebsite">
                                {{ _('Single Website') }}
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="discoveryScope" id="discoveryScopeProject" value="project">
                            <label class="form-check-label" for="discoveryScopeProject">
                                {{ _('Entire Project') }}
                            </label>
                        </div>
                    </div>
                    <div class="mb-3" id="discoveryProjectGroup">
                        <label for="discoveryProject" class="form-label">{{ _('Select Project') }}</label>
                        <select class="form-select" id="discoveryProject" required>
                            <option value="">{{ _('Choose a project...') }}</option>
                        </select>
                        <small class="text-muted" id="discoveryProjectHelpText">{{ _('Select a project first') }}</small>
                    </div>
                    <div class="mb-3" id="discoveryWebsiteGroup">
                        <label for="discoveryWebsite" class="form-label">{{ _('Select Website') }}</label>
                        <select class="form-select" id="discoveryWebsite" required disabled>
                            <option value="">{{ _('First select a project...') }}</option>
                        </select>
                        <small class="text-muted">{{ _('Select the specific website to analyze') }}</small>
                    </div>
                    <div class="mb-3">
                        <label for="discoveryFormat" class="form-label">{{ _('Export Format') }}</label>
                        <select class="form-select" id="discoveryFormat">
                            <option value="html">{{ _('HTML (Recommended)') }}</option>
                            <option value="pdf">{{ _('PDF') }}</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> {{ _('Generate Discovery Report') }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Static HTML Report Modal -->
<div class="modal fade" id="staticHtmlModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Generate Offline Report (Static HTML)') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="staticHtmlForm">
                <div class="modal-body">
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle"></i> {{ _('This report generates a complete offline website with:') }}
                        <ul class="mt-2 mb-0">
                            <li>{{ _('Index page with all tested pages') }}</li>
                            <li>{{ _('Summary page with statistics and charts') }}</li>
                            <li>{{ _('Individual page detail reports with full issue accordions') }}</li>
                            <li>{{ _('Client-side filters and search') }}</li>
                            <li>{{ _('All CSS, JS, and images (ZIP download)') }}</li>
                        </ul>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="staticHtmlProject" class="form-label">{{ _('Project') }}</label>
                                <select class="form-select" id="staticHtmlProject">
                                    <option value="">{{ _('All Projects') }}</option>
                                    {% for project in projects %}
                                    <option value="{{ project.id }}">{{ project.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="staticHtmlWebsite" class="form-label">{{ _('Website') }}</label>
                                <select class="form-select" id="staticHtmlWebsite" disabled>
                                    <option value="">{{ _('Select a project first...') }}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="staticHtmlWcagLevel" class="form-label">{{ _('WCAG Level') }}</label>
                        <select class="form-select" id="staticHtmlWcagLevel">
                            <option value="A">{{ _('Level A') }}</option>
                            <option value="AA" selected>{{ _('Level AA (Recommended)') }}</option>
                            <option value="AAA">{{ _('Level AAA') }}</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ _('Options') }}</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="staticHtmlIncludeScreenshots" checked>
                            <label class="form-check-label" for="staticHtmlIncludeScreenshots">
                                {{ _('Include Screenshots') }}
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="staticHtmlIncludeDiscovery" checked>
                            <label class="form-check-label" for="staticHtmlIncludeDiscovery">
                                {{ _('Include Discovery Items') }}
                            </label>
                        </div>
                    </div>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> <strong>{{ _('Note:') }}</strong> {{ _('Large reports may take several minutes to generate. The report will appear in the list below when complete.') }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-file-earmark-zip"></i> {{ _('Generate Report') }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Static HTML Modal Logic
const staticHtmlModal = document.getElementById('staticHtmlModal');
if (staticHtmlModal) {
    // Handle project selection - load websites
    document.getElementById('staticHtmlProject').addEventListener('change', function() {
        const websiteSelect = document.getElementById('staticHtmlWebsite');
        const selectedProjectId = this.value;

        websiteSelect.value = '';

        if (selectedProjectId) {
            websiteSelect.innerHTML = '<option value="">' + {{ _("Loading websites...") | tojson }} + '</option>';
            websiteSelect.disabled = true;

            fetch(`/projects/api/${selectedProjectId}/websites`)
                .then(response => response.json())
                .then(data => {
                    websiteSelect.innerHTML = '<option value="">' + {{ _("All Websites") | tojson }} + '</option>';

                    if (data.websites && data.websites.length > 0) {
                        data.websites.forEach(website => {
                            const option = document.createElement('option');
                            option.value = website.id;
                            option.textContent = website.name;
                            websiteSelect.appendChild(option);
                        });
                        websiteSelect.disabled = false;
                    } else {
                        websiteSelect.innerHTML = '<option value="">No websites in this project</option>';
                    }
                })
                .catch(error => {
                    console.error('Error loading websites:', error);
                    websiteSelect.innerHTML = '<option value="">Error loading websites</option>';
                });
        } else {
            websiteSelect.innerHTML = '<option value="">Select a project first...</option>';
            websiteSelect.disabled = true;
        }
    });

    // Handle form submission
    document.getElementById('staticHtmlForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const projectId = document.getElementById('staticHtmlProject').value;
        const websiteId = document.getElementById('staticHtmlWebsite').value;
        const wcagLevel = document.getElementById('staticHtmlWcagLevel').value;
        const includeScreenshots = document.getElementById('staticHtmlIncludeScreenshots').checked;
        const includeDiscovery = document.getElementById('staticHtmlIncludeDiscovery').checked;

        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';

        // Use FormData to submit as regular form (not JSON)
        const formDataObj = new FormData();

        // Add project_id and website_id if selected (empty string means "All")
        if (projectId) {
            formDataObj.append('project_id', projectId);
        }
        if (websiteId) {
            formDataObj.append('website_id', websiteId);
        }

        formDataObj.append('wcag_level', wcagLevel);
        formDataObj.append('include_screenshots', includeScreenshots);
        formDataObj.append('include_discovery', includeDiscovery);

        fetch('/reports/generate/static-html', {
            method: 'POST',
            body: formDataObj
        })
        .then(response => {
            // Flask will redirect, so reload the page to see the new report in the list
            window.location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            alert({{ _('Error generating report: ') | tojson }} + error.message);
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
    });
}
</script>

<!-- Deduplicated Report Modal -->
<div class="modal fade" id="deduplicatedModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Generate Deduplicated Report') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="deduplicatedForm">
                <div class="modal-body">
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle"></i> {{ _('This report generates a single-page offline HTML report with:') }}
                        <ul class="mt-2 mb-0">
                            <li>{{ _('Issues deduplicated and grouped by common components') }}</li>
                            <li>{{ _('Common components table (navigation, headers, footers, forms, etc.)') }}</li>
                            <li>{{ _('Statistics dashboard with violation, warning, and info counts') }}</li>
                            <li>{{ _('Client-side filters by component, type, and impact') }}</li>
                            <li>{{ _('Test user information for authenticated testing') }}</li>
                            <li>{{ _('All CSS, JS, and images (ZIP download)') }}</li>
                        </ul>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="deduplicatedProject" class="form-label">{{ _('Project') }}</label>
                                <select class="form-select" id="deduplicatedProject">
                                    <option value="">{{ _('All Projects') }}</option>
                                    {% for project in projects %}
                                    <option value="{{ project.id }}">{{ project.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="deduplicatedWebsite" class="form-label">{{ _('Website') }}</label>
                                <select class="form-select" id="deduplicatedWebsite" disabled>
                                    <option value="">{{ _('Select a project first...') }}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> <strong>{{ _('Note:') }}</strong> {{ _('Large reports may take several minutes to generate. The report will appear in the list below when complete.') }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-layers"></i> {{ _('Generate Report') }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Deduplicated Report Modal Logic
const deduplicatedModal = document.getElementById('deduplicatedModal');
if (deduplicatedModal) {
    // Handle project selection - load websites
    document.getElementById('deduplicatedProject').addEventListener('change', function() {
        const websiteSelect = document.getElementById('deduplicatedWebsite');
        const selectedProjectId = this.value;

        websiteSelect.value = '';

        if (selectedProjectId) {
            websiteSelect.innerHTML = '<option value="">' + {{ _("Loading websites...") | tojson }} + '</option>';
            websiteSelect.disabled = true;

            fetch(`/projects/api/${selectedProjectId}/websites`)
                .then(response => response.json())
                .then(data => {
                    websiteSelect.innerHTML = '<option value="">' + {{ _("All Websites") | tojson }} + '</option>';

                    if (data.websites && data.websites.length > 0) {
                        data.websites.forEach(website => {
                            const option = document.createElement('option');
                            option.value = website.id;
                            option.textContent = website.name;
                            websiteSelect.appendChild(option);
                        });
                        websiteSelect.disabled = false;
                    } else {
                        websiteSelect.innerHTML = '<option value="">No websites in this project</option>';
                    }
                })
                .catch(error => {
                    console.error('Error loading websites:', error);
                    websiteSelect.innerHTML = '<option value="">Error loading websites</option>';
                });
        } else {
            websiteSelect.innerHTML = '<option value="">Select a project first...</option>';
            websiteSelect.disabled = true;
        }
    });

    // Handle form submission
    document.getElementById('deduplicatedForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const projectId = document.getElementById('deduplicatedProject').value;
        const websiteId = document.getElementById('deduplicatedWebsite').value;

        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';

        // Use FormData to submit as regular form (not JSON)
        const formDataObj = new FormData();

        // Add project_id and website_id if selected (empty string means "All")
        if (projectId) {
            formDataObj.append('project_id', projectId);
        }
        if (websiteId) {
            formDataObj.append('website_id', websiteId);
        }

        fetch('/reports/generate/deduplicated', {
            method: 'POST',
            body: formDataObj
        })
        .then(response => {
            // Flask will redirect, so reload the page to see the new report in the list
            window.location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            alert({{ _('Error generating report: ') | tojson }} + error.message);
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
    });
}
</script>

<!-- Recordings Report Modal -->
<div class="modal fade" id="recordingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Generate Recordings Report') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="recordingsForm">
                <div class="modal-body">
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle"></i> {{ _('This report includes manual accessibility findings from:') }}
                        <ul class="mt-2 mb-0">
                            <li>{{ _('Accessibility audit recordings') }}</li>
                            <li>{{ _('Lived experience testing sessions') }}</li>
                            <li>{{ _('All issues organized by touchpoint and impact') }}</li>
                            <li>{{ _('Key takeaways and user painpoints') }}</li>
                            <li>{{ _('WCAG criteria mappings and remediation guidance') }}</li>
                        </ul>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="recordingsProject" class="form-label">{{ _('Project') }}</label>
                                <select class="form-select" id="recordingsProject" required>
                                    <option value="">{{ _('Choose a project...') }}</option>
                                    {% for project in projects %}
                                    <option value="{{ project.id }}">{{ project.name }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">{{ _('All recordings from this project will be included') }}</small>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="recordingsFormat" class="form-label">{{ _('Export Format') }}</label>
                        <select class="form-select" id="recordingsFormat">
                            <option value="html">{{ _('HTML (Recommended)') }}</option>
                            <option value="pdf">{{ _('PDF') }}</option>
                            <option value="xlsx">{{ _('Excel Spreadsheet') }}</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ _('Include in Report') }}</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="recordingsIncludeSummary" checked>
                            <label class="form-check-label" for="recordingsIncludeSummary">
                                {{ _('Executive Summary') }}
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="recordingsIncludeTimecodes" checked>
                            <label class="form-check-label" for="recordingsIncludeTimecodes">
                                {{ _('Timecodes') }}
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="recordingsIncludeWCAG" checked>
                            <label class="form-check-label" for="recordingsIncludeWCAG">
                                {{ _('WCAG Criteria') }}
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="recordingsGroupByTouchpoint" checked>
                            <label class="form-check-label" for="recordingsGroupByTouchpoint">
                                {{ _('Group Issues by Touchpoint') }}
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-mic"></i> {{ _('Generate Recordings Report') }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Recordings Report Modal Logic
const recordingsModal = document.getElementById('recordingsModal');
if (recordingsModal) {
    // Handle form submission
    document.getElementById('recordingsForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const projectId = document.getElementById('recordingsProject').value;

        if (!projectId) {
            alert({{ _('Please select a project') | tojson }});
            return;
        }

        const format = document.getElementById('recordingsFormat').value;
        const includeSummary = document.getElementById('recordingsIncludeSummary').checked;
        const includeTimecodes = document.getElementById('recordingsIncludeTimecodes').checked;
        const includeWCAG = document.getElementById('recordingsIncludeWCAG').checked;
        const groupByTouchpoint = document.getElementById('recordingsGroupByTouchpoint').checked;

        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>' + {{ _("Generating...") | tojson }};

        // Use FormData to submit as regular form (not JSON)
        const formDataObj = new FormData();
        formDataObj.append('project_id', projectId);
        formDataObj.append('format', format);
        formDataObj.append('include_summary', includeSummary);
        formDataObj.append('include_timecodes', includeTimecodes);
        formDataObj.append('include_wcag', includeWCAG);
        formDataObj.append('group_by_touchpoint', groupByTouchpoint);

        fetch('/reports/generate/recordings/' + projectId, {
            method: 'POST',
            body: formDataObj
        })
        .then(response => {
            if (response.ok) {
                // Flask will redirect, so reload the page to see the new report in the list
                window.location.reload();
            } else {
                throw new Error('Failed to generate report');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert({{ _('Error generating report: ') | tojson }} + error.message);
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
    });
}
</script>

{% endblock %}