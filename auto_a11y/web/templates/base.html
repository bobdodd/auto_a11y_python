<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Auto A11y{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="bi bi-universal-access-circle"></i> Auto A11y
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('dashboard') }}">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('projects.list_projects') }}">
                            <i class="bi bi-folder"></i> Projects
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('testing.testing_dashboard') }}">
                            <i class="bi bi-check2-square"></i> Testing
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('reports.reports_dashboard') }}">
                            <i class="bi bi-file-earmark-text"></i> Reports
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('help') }}">
                            <i class="bi bi-question-circle"></i> Help
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="settingsDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear"></i> Settings
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('testing.configure_testing') }}">
                                <i class="bi bi-sliders"></i> Configuration
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('testing.fixture_status') }}">
                                <i class="bi bi-check2-square"></i> Fixture Status
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Global Test Status Indicator -->
    <div id="global-test-status" class="d-none">
        <div class="container-fluid">
            <div class="alert alert-info alert-dismissible fade show mt-2" role="alert">
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    <div>
                        <strong id="global-activity-title">Activity in Progress</strong> - <span id="global-test-message">Checking status...</span>
                        <a href="#" id="global-test-link" class="ms-2">View Details</a>
                    </div>
                </div>
                <button type="button" class="btn-close btn-sm" data-bs-dismiss="alert" onclick="pauseGlobalTestTracking()"></button>
            </div>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container-fluid mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Main Content -->
    <main class="container-fluid mt-4">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="footer mt-auto py-3 bg-light">
        <div class="container text-center">
            <span class="text-muted">Auto A11y Â© 2024 | Automated Accessibility Testing</span>
        </div>
    </footer>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Global Test Tracking System -->
    <script>
    // Global activity tracking system (tests and discoveries)
    const TestTracker = {
        STORAGE_KEY: 'active_activities',  // Renamed from 'active_tests' for clarity
        LEGACY_KEY: 'active_tests',  // For migration
        CHECK_INTERVAL: 5000, // Check every 5 seconds
        pollInterval: null,
        
        // Add an activity (test or discovery) to track
        addTest: function(type, id, description) {
            const tests = this.getActiveTests();
            tests[`${type}_${id}`] = {
                type: type,
                id: id,
                description: description,
                startTime: Date.now()
            };
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(tests));
            this.startTracking();
        },
        
        // Remove a completed activity
        removeTest: function(type, id) {
            const tests = this.getActiveTests();
            delete tests[`${type}_${id}`];
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(tests));
            
            // Stop tracking if no more activities
            if (Object.keys(tests).length === 0) {
                this.stopTracking();
            }
        },
        
        // Get all active tests/discoveries
        getActiveTests: function() {
            // Migrate from old key if it exists
            const legacyData = localStorage.getItem(this.LEGACY_KEY);
            if (legacyData) {
                localStorage.setItem(this.STORAGE_KEY, legacyData);
                localStorage.removeItem(this.LEGACY_KEY);
                console.log('Migrated from active_tests to active_activities');
            }
            
            const stored = localStorage.getItem(this.STORAGE_KEY);
            const tests = stored ? JSON.parse(stored) : {};
            
            // Clean up stale entries (older than 10 minutes for discovery, 30 minutes for tests)
            const now = Date.now();
            const tenMinutesAgo = now - (10 * 60 * 1000);
            const thirtyMinutesAgo = now - (30 * 60 * 1000);
            let hasStale = false;
            
            for (const key in tests) {
                const test = tests[key];
                if (test.startTime) {
                    // Discovery jobs should complete within 10 minutes
                    if (test.type === 'discovery' && test.startTime < tenMinutesAgo) {
                        console.log(`Removing stale discovery: ${key}`);
                        delete tests[key];
                        hasStale = true;
                    }
                    // Test jobs can take longer, give them 30 minutes
                    else if (test.type !== 'discovery' && test.startTime < thirtyMinutesAgo) {
                        console.log(`Removing stale test: ${key}`);
                        delete tests[key];
                        hasStale = true;
                    }
                }
            }
            
            // Save cleaned up list if we removed any stale entries
            if (hasStale) {
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(tests));
            }
            
            return tests;
        },
        
        // Start tracking active tests
        startTracking: function() {
            // Don't start multiple trackers
            if (this.pollInterval) return;
            
            // Check immediately
            this.checkTests();
            
            // Then check periodically
            this.pollInterval = setInterval(() => this.checkTests(), this.CHECK_INTERVAL);
        },
        
        // Stop tracking
        stopTracking: function() {
            if (this.pollInterval) {
                clearInterval(this.pollInterval);
                this.pollInterval = null;
            }
            document.getElementById('global-test-status').classList.add('d-none');
        },
        
        // Check status of all active activities
        checkTests: async function() {
            const tests = this.getActiveTests();
            const testCount = Object.keys(tests).length;
            
            if (testCount === 0) {
                this.stopTracking();
                return;
            }
            
            // Show global indicator
            const statusDiv = document.getElementById('global-test-status');
            statusDiv.classList.remove('d-none');
            
            let activeCount = 0;
            let completedInThisCheck = [];
            
            // Check each test
            for (const key in tests) {
                const test = tests[key];
                
                try {
                    let statusUrl = '';
                    let detailUrl = '';
                    
                    if (test.type === 'page') {
                        statusUrl = `/pages/${test.id}/test-status`;
                        detailUrl = `/pages/${test.id}`;
                    } else if (test.type === 'website') {
                        statusUrl = `/websites/${test.id}/test-status`;
                        detailUrl = `/websites/${test.id}`;
                    } else if (test.type === 'discovery') {
                        // Check if discovery is still running
                        // If we have a job_id, check its status
                        if (test.job_id) {
                            try {
                                const discoveryStatus = await $.get(`/websites/${test.id}/discovery-status?job_id=${test.job_id}`);
                                if (discoveryStatus.status === 'running') {
                                    activeCount++;
                                } else {
                                    // Discovery is no longer running, remove it
                                    console.log(`Removing stale discovery for website ${test.id}, status: ${discoveryStatus.status}`);
                                    this.removeTest(test.type, test.id);
                                }
                            } catch (error) {
                                // If we can't check status, assume it's stale and remove it
                                console.log(`Removing stale discovery for website ${test.id}, error checking status`);
                                this.removeTest(test.type, test.id);
                            }
                        } else {
                            // No job_id, this is a stale entry
                            console.log(`Removing discovery without job_id for website ${test.id}`);
                            this.removeTest(test.type, test.id);
                        }
                        continue;
                    }
                    
                    const response = await $.get(statusUrl);
                    
                    if (test.type === 'page') {
                        // Page test - check if completed
                        if (response.status === 'tested' || response.status === 'error') {
                            completedInThisCheck.push(test);
                            this.removeTest(test.type, test.id);
                        } else {
                            activeCount++;
                        }
                    } else if (test.type === 'website') {
                        // Website test - check if all pages done
                        if (response.all_complete) {
                            completedInThisCheck.push(test);
                            this.removeTest(test.type, test.id);
                        } else {
                            activeCount++;
                            // Update progress message
                            test.progress = `${response.tested_pages}/${response.total_pages} pages`;
                        }
                    }
                } catch (error) {
                    console.error(`Failed to check status for ${test.type} ${test.id}:`, error);
                    // Keep the test in the list but mark as unknown
                    activeCount++;
                }
            }
            
            // Update UI
            if (activeCount > 0) {
                const message = document.getElementById('global-test-message');
                const link = document.getElementById('global-test-link');
                const titleElement = document.getElementById('global-activity-title');
                
                // Count different types of activities
                const allTests = this.getActiveTests();
                const discoveryCount = Object.values(allTests).filter(t => t.type === 'discovery').length;
                const testCount = Object.values(allTests).filter(t => t.type === 'page' || t.type === 'website').length;
                
                // Update title based on activity types
                if (discoveryCount > 0 && testCount === 0) {
                    titleElement.textContent = 'Discovery Running';
                } else if (discoveryCount === 0 && testCount > 0) {
                    titleElement.textContent = 'Tests Running';
                } else if (discoveryCount > 0 && testCount > 0) {
                    titleElement.textContent = 'Discovery & Tests Running';
                } else {
                    titleElement.textContent = 'Activity in Progress';
                }
                
                if (activeCount === 1) {
                    const remainingTest = Object.values(allTests)[0];
                    message.textContent = remainingTest.description + (remainingTest.progress ? ` - ${remainingTest.progress}` : '');
                    
                    if (remainingTest.type === 'page') {
                        link.href = `/pages/${remainingTest.id}`;
                    } else if (remainingTest.type === 'website' || remainingTest.type === 'discovery') {
                        link.href = `/websites/${remainingTest.id}`;
                    }
                } else {
                    // Build message based on activity types
                    let messages = [];
                    if (discoveryCount > 0) {
                        messages.push(`${discoveryCount} discover${discoveryCount > 1 ? 'ies' : 'y'}`);
                    }
                    if (testCount > 0) {
                        messages.push(`${testCount} test${testCount > 1 ? 's' : ''}`);
                    }
                    message.textContent = messages.join(' and ') + ' running';
                    link.href = '/testing';
                }
            }
            
            // Show completion notification and refresh if on relevant page
            if (completedInThisCheck.length > 0) {
                for (const test of completedInThisCheck) {
                    if (window.showNotification) {
                        const title = test.type === 'discovery' ? 'Discovery Complete' : 'Test Complete';
                        const message = test.type === 'discovery' ? `${test.description} has finished` : `${test.description} has finished testing`;
                        showNotification(title, message, 'success');
                    }
                    
                    // Refresh page if we're viewing the tested item
                    const currentPath = window.location.pathname;
                    if (currentPath.includes(`/pages/${test.id}`) || 
                        currentPath.includes(`/websites/${test.id}`) ||
                        (test.type === 'website' && currentPath.includes('/projects/'))) {
                        setTimeout(() => location.reload(), 1500);
                    }
                }
            }
        },
        
        // Initialize on page load
        init: function() {
            const tests = this.getActiveTests();
            if (Object.keys(tests).length > 0) {
                this.startTracking();
            }
        }
    };
    
    // Pause tracking (when user dismisses the notification)
    function pauseGlobalTestTracking() {
        TestTracker.stopTracking();
        // Don't clear the tests, just stop showing the notification
    }
    
    // Helper function to add a page test
    function trackPageTest(pageId, pageName) {
        TestTracker.addTest('page', pageId, `Testing ${pageName || 'page'}`);
    }
    
    // Helper function to add a website test
    function trackWebsiteTest(websiteId, websiteName) {
        TestTracker.addTest('website', websiteId, `Testing ${websiteName || 'website'}`);
    }
    
    // Show notification helper (if not already defined)
    if (typeof showNotification === 'undefined') {
        window.showNotification = function(title, message, type) {
            // Simple notification using Bootstrap toast or alert
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                <strong>${title}</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        };
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Clean up on page load - remove anything older than 10 minutes for discovery
        TestTracker.getActiveTests();  // This triggers cleanup
        TestTracker.init();
    });
    
    // Add manual clear function to window for debugging
    window.clearTestTracker = function() {
        localStorage.removeItem('active_activities');
        localStorage.removeItem('active_tests');  // Also clear legacy key
        TestTracker.stopTracking();
        const tracker = document.getElementById('global-test-tracker');
        if (tracker) {
            tracker.style.display = 'none';
        }
        console.log('Activity tracker cleared');
    };
    
    // Add function to clear specific types
    window.clearDiscoveries = function() {
        const tests = TestTracker.getActiveTests();
        let removed = 0;
        for (const key in tests) {
            if (tests[key].type === 'discovery') {
                delete tests[key];
                removed++;
            }
        }
        if (removed > 0) {
            localStorage.setItem('active_activities', JSON.stringify(tests));
            console.log(`Cleared ${removed} discovery entries`);
            location.reload();
        } else {
            console.log('No discovery entries to clear');
        }
    };
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>